<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="app-api-base" content="https://iamemanuele.pythonanywhere.com/api"/>
  <title>Finance Calendar (Simple)</title>

  <style>
    :root{
      --bg:#0b0c10; --panel:#12131a; --panel2:#0f1016;
      --text:#e8e8ee; --muted:#a7a7b3; --border:rgba(255,255,255,.10);
      --soft:rgba(255,255,255,.06);
      --btn:#1c1e28;
      --accent:rgba(80,160,255,.85);
      --danger:rgba(255,90,90,.9);
      --ok:rgba(120,255,160,.9);
      --warn:rgba(255,190,100,.95);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto}
    button,input,select,textarea{font:inherit;color:inherit}
    .topbar{
      position:sticky;top:0;z-index:10;
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:12px;border-bottom:1px solid var(--border);
      background:rgba(10,10,14,.85);backdrop-filter: blur(10px);
    }
    .left, .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .title{font-weight:900;letter-spacing:.2px}
    .pill{padding:8px 10px;border:1px solid var(--border);background:var(--soft);border-radius:999px;font-weight:800}
    .btn{
      border:1px solid var(--border);background:var(--btn);
      padding:10px 12px;border-radius:14px;cursor:pointer;font-weight:900;
    }
    .btn:hover{border-color:rgba(255,255,255,.18)}
    .btn.primary{background:rgba(80,160,255,.18);border-color:rgba(80,160,255,.45)}
    .btn.danger{background:rgba(255,90,90,.12);border-color:rgba(255,90,90,.45)}
    .search{
      min-width:240px;flex:1;
      display:flex;gap:8px;align-items:center;
      border:1px solid var(--border);background:var(--soft);
      border-radius:14px;padding:10px 12px;
    }
    .search input{border:0;outline:0;background:transparent;width:100%;font-weight:800}

    .layout{
      display:grid;gap:12px;
      grid-template-columns: 1fr 360px;
      padding:12px;
      min-height:calc(100vh - 60px);
    }
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
    }

    .card{
      border:1px solid var(--border);background:var(--panel);
      border-radius:18px;overflow:hidden;
    }
    .cardHead{
      padding:12px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      background:rgba(255,255,255,.03);
    }
    .cardHead b{font-weight:1000}
    .cardBody{padding:12px}

    /* Calendar */
    .calGrid{
      display:grid;grid-template-columns: repeat(7, 1fr);
      gap:8px;padding:12px;
    }
    .dow{font-size:12px;color:var(--muted);font-weight:900;text-align:center;padding:6px 0}
    .day{
      border:1px solid var(--border);background:var(--panel2);
      border-radius:16px;padding:10px;min-height:110px;cursor:pointer;
      display:flex;flex-direction:column;gap:8px;
    }
    .day:hover{border-color:rgba(255,255,255,.18)}
    .day.out{opacity:.45}
    .day.today{border-color:rgba(80,160,255,.55);box-shadow:0 0 0 1px rgba(80,160,255,.16) inset}
    .dayTop{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .dayNum{font-weight:1000}
    .daySum{font-size:12px;color:var(--muted);font-weight:900}
    .evtMini{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      border-radius:12px;padding:6px 8px;
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      font-weight:900;font-size:12px;
    }
    .evtMini small{color:var(--muted);font-weight:800}
    .evtMini.expense{border-color:rgba(255,90,90,.22)}
    .evtMini.income{border-color:rgba(120,255,160,.22)}

    /* Sidebar wallet */
    .wallet{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      border-radius:16px;padding:10px;
      display:flex;flex-direction:column;gap:10px;
    }
    .walletTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .walletName{font-weight:1000}
    .muted{color:var(--muted);font-size:12px;font-weight:800}
    .kpiRow{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .kpi{
      border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);
      border-radius:14px;padding:8px;
    }
    .kpi .label{font-size:12px;color:var(--muted);font-weight:900}
    .kpi .value{margin-top:6px;font-weight:1000}
    .list{display:flex;flex-direction:column;gap:6px}
    .barRow{display:flex;justify-content:space-between;gap:10px;align-items:center;font-weight:900}
    .bar{
      height:10px;border-radius:999px;background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);overflow:hidden;
    }
    .bar > i{display:block;height:100%;background:rgba(80,160,255,.55);width:0%}

    /* Modal */
    dialog{
      width:min(720px, calc(100vw - 24px));
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      border-radius:18px;
      padding:0;
    }
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .modalHead{
      padding:12px;border-bottom:1px solid var(--border);
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .modalBody{padding:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:700px){.grid2{grid-template-columns:1fr}}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .field label{font-size:12px;color:var(--muted);font-weight:900}
    .field input,.field select,.field textarea{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      border-radius:14px;padding:10px;outline:0;font-weight:800;
    }
    .actions{
      padding:12px;border-top:1px solid var(--border);
      display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;
    }
    .hint{font-size:12px;color:var(--muted);font-weight:800;line-height:1.3}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .tag{
      font-size:12px;font-weight:900;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      padding:4px 8px;border-radius:999px;color:var(--muted)
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="left">
      <div class="title">üíº Finance Calendar (Simple)</div>
      <button class="btn" id="btnPrev">‚Äπ</button>
      <div class="pill" id="monthLabel">‚Äî</div>
      <button class="btn" id="btnNext">‚Ä∫</button>
      <button class="btn" id="btnToday">Oggi</button>
    </div>

    <div class="right">
      <div class="search">
        üîé <input id="q" type="search" placeholder="Cerca eventi (titolo/categoria/note)‚Ä¶"/>
      </div>
      <button class="btn primary" id="btnNew">Ôºã Nuovo</button>
      <button class="btn" id="btnReload">Ricarica</button>
    </div>
  </header>

  <div class="layout">
    <main class="card">
      <div class="cardHead">
        <b>Calendario</b>
        <span class="tag" id="metaCount">‚Äî</span>
      </div>
      <div id="calendarHost"></div>
    </main>

    <aside class="card">
      <div class="cardHead">
        <b>Wallet (live)</b>
        <span class="tag" id="apiStatus">offline</span>
      </div>
      <div class="cardBody" id="sidebarHost"></div>
    </aside>
  </div>

  <dialog id="evtModal">
    <div class="modalHead">
      <b id="modalTitle">Nuovo evento</b>
      <button class="btn" id="btnCloseModal">‚úï</button>
    </div>

    <div class="modalBody">
      <div class="grid2">
        <div class="field">
          <label>Titolo *</label>
          <input id="fTitle" type="text" placeholder="Es. Spesa supermercato" />
        </div>

        <div class="field">
          <label>Tipo</label>
          <select id="fType">
            <option value="expense">Uscita</option>
            <option value="income">Entrata</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div class="field">
          <label>Totale *</label>
          <input id="fAmount" type="number" step="0.01" placeholder="0.00" />
        </div>

        <div class="field">
          <label>Categoria</label>
          <input id="fCategory" type="text" placeholder="Es. Food, Bills‚Ä¶" />
        </div>
      </div>

      <div class="grid2">
        <div class="field">
          <label>Wallet *</label>
          <select id="fWallet"></select>
        </div>

        <div class="field">
          <label>Quando √® ‚Äúavvenuto‚Äù (opzionale)</label>
          <input id="fOccurred" type="date" />
        </div>
      </div>

      <div class="field">
        <label>Pagamento</label>
        <select id="fScheduleMode">
          <option value="now">Subito (1 evento)</option>
          <option value="deferred">Posticipato unica soluzione</option>
          <option value="installments">Rate (serie)</option>
        </select>
        <div class="hint">La data che vedi nel calendario √® sempre la data che impatta il saldo del wallet.</div>
      </div>

      <!-- Deferred -->
      <div id="deferredBox" style="display:none">
        <div class="grid2">
          <div class="field">
            <label>Data pagamento</label>
            <input id="fPayOn" type="date" />
          </div>
          <div class="field">
            <label>Note</label>
            <input id="fNotes" type="text" placeholder="opzionale" />
          </div>
        </div>
      </div>

      <!-- Installments -->
      <div id="instBox" style="display:none">
        <div class="grid2">
          <div class="field">
            <label>Numero rate</label>
            <input id="fInstCount" type="number" min="2" step="1" value="3"/>
          </div>

          <div class="field">
            <label>Prima rata</label>
            <input id="fInstFirst" type="date" />
          </div>
        </div>

        <div class="grid2">
          <div class="field">
            <label>Importo rata (automatico)</label>
            <input id="fInstEach" type="text" disabled />
          </div>
          <div class="field">
            <label>Note</label>
            <input id="fInstNotes" type="text" placeholder="opzionale" />
          </div>
        </div>

        <div class="hint">Per ora: rate mensili uguali. Il backend creer√† N eventi con lo stesso seriesId.</div>
      </div>

      <!-- Series controls (edit) -->
      <div id="seriesBox" style="display:none; margin-top:10px;">
        <div class="row">
          <label class="row" style="font-weight:900;color:var(--muted);">
            <input id="fApplyFuture" type="checkbox"/>
            Applica modifica a questa + tutte le future (serie)
          </label>
          <span class="tag" id="seriesTag">series</span>
        </div>
        <div class="hint">Se disattivo, modifica solo questo evento.</div>
      </div>

      <div class="field" style="margin-top:6px;">
        <label>Note (evento)</label>
        <textarea id="fNotesLong" placeholder="opzionale"></textarea>
      </div>

      <div class="hint" id="editHint" style="display:none"></div>
    </div>

    <div class="actions">
      <button class="btn" id="btnCopy" style="display:none;">Copia</button>
      <button class="btn danger" id="btnDelete" style="display:none;">Elimina</button>
      <button class="btn" id="btnCancel">Annulla</button>
      <button class="btn primary" id="btnSave">Salva</button>
    </div>
  </dialog>

  <script>
    (() => {
      "use strict";

      /* -------------------------
        Utils
      ------------------------- */
      const $ = (s, r=document) => r.querySelector(s);
      const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
      const pad2 = (n) => String(n).padStart(2, "0");
      const toISO = (d) => {
        const x = (d instanceof Date) ? d : new Date(d);
        return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;
      };
      const fromISO = (iso) => {
        const [y,m,d] = String(iso||"").split("-").map(Number);
        return new Date(y, (m||1)-1, d||1);
      };
      const startOfMonth = (d) => new Date(d.getFullYear(), d.getMonth(), 1);
      const endOfMonth = (d) => new Date(d.getFullYear(), d.getMonth()+1, 0);
      const startOfWeekMon = (d) => {
        const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        const day = (x.getDay() + 6) % 7; // Monday=0
        x.setDate(x.getDate() - day);
        return new Date(x.getFullYear(), x.getMonth(), x.getDate());
      };
      const addDays = (d, n) => {
        const x = new Date(d); x.setDate(x.getDate()+n); return x;
      };
      const addMonths = (d, n) => {
        const x = new Date(d);
        const day = x.getDate();
        x.setMonth(x.getMonth() + n);
        while (x.getDate() !== day && x.getDate() > 1) x.setDate(x.getDate() - 1);
        return x;
      };
      const monthKey = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
      const money = (v, cur="EUR") => new Intl.NumberFormat("it-IT",{style:"currency",currency:cur}).format(Number(v||0));
      const humanMonth = (d) => new Intl.DateTimeFormat("it-IT",{month:"long",year:"numeric"}).format(d);

      /* -------------------------
        API
      ------------------------- */
      const API_BASE = String(document.querySelector('meta[name="app-api-base"]')?.content || "").replace(/\/+$/,"");
      const API = {
        base(){ return API_BASE || "/api"; },
        async request(path, {method="GET", body}={}){
          const url = this.base() + path;
          const res = await fetch(url, {
            method,
            headers: body ? {"Content-Type":"application/json","Accept":"application/json"} : {"Accept":"application/json"},
            body: body ? JSON.stringify(body) : undefined
          });
          const ct = res.headers.get("content-type") || "";
          const data = ct.includes("application/json") ? await res.json().catch(()=>null) : await res.text().catch(()=>null);
          if(!res.ok) throw new Error((data && data.error) ? data.error : `HTTP ${res.status}`);
          return data;
        },
        health(){ return this.request("/health"); },
        getWallets(){ return this.request("/wallets"); },
        listEvents(params){
          const qs = new URLSearchParams(params||{}).toString();
          return this.request(`/events${qs ? `?${qs}` : ""}`);
        },
        createEvent(payload){ return this.request("/events", {method:"POST", body:payload}); },
        updateEvent(id, payload){ return this.request(`/events/${encodeURIComponent(id)}`, {method:"PUT", body:payload}); },
        deleteEvent(id){ return this.request(`/events/${encodeURIComponent(id)}`, {method:"DELETE"}); },
        updateSeriesFuture(seriesId, body){
          return this.request(`/series/${encodeURIComponent(seriesId)}/future`, {method:"PUT", body});
        },
        deleteSeriesFuture(seriesId, fromISO){
          const qs = new URLSearchParams({from: fromISO}).toString();
          return this.request(`/series/${encodeURIComponent(seriesId)}/future?${qs}`, {method:"DELETE"});
        },
        deleteSeries(seriesId){
          return this.request(`/series/${encodeURIComponent(seriesId)}`, {method:"DELETE"});
        },
        dashboard(params){
          const qs = new URLSearchParams(params||{}).toString();
          return this.request(`/dashboard${qs ? `?${qs}` : ""}`);
        }
      };

      /* -------------------------
        State
      ------------------------- */
      const state = {
        apiOnline: false,
        anchorMonth: startOfMonth(new Date()),
        q: "",
        wallets: [],
        events: [],
        selectedDayISO: null,
        editingEvent: null,
        dash: null
      };

      /* -------------------------
        Data loading
      ------------------------- */
      const setStatus = (online) => {
        state.apiOnline = !!online;
        $("#apiStatus").textContent = online ? "online" : "offline";
        $("#apiStatus").style.borderColor = online ? "rgba(120,255,160,.35)" : "rgba(255,255,255,.12)";
      };

      async function loadMonthData(){
        const mStart = startOfMonth(state.anchorMonth);
        const mEnd = endOfMonth(state.anchorMonth);
        const from = toISO(mStart);
        const to = toISO(mEnd);

        try{
          await API.health();
          setStatus(true);
        }catch(_){
          setStatus(false);
        }

        // wallets + events
        try{
          const [w, e] = await Promise.all([
            API.getWallets(),
            API.listEvents({from, to, q: state.q || ""})
          ]);
          state.wallets = Array.isArray(w?.wallets) ? w.wallets : (Array.isArray(w) ? w : []);
          state.events = Array.isArray(e?.events) ? e.events : (Array.isArray(e) ? e : []);
          setStatus(true);
        }catch(err){
          // offline fallback (empty)
          state.wallets = [];
          state.events = [];
          setStatus(false);
          console.warn(err);
        }

        // dashboard (optional)
        state.dash = null;
        try{
          const asOf = toISO(new Date());
          const dash = await API.dashboard({month: monthKey(state.anchorMonth), asOf});
          state.dash = dash;
        }catch(_){
          // ok: calcoliamo client-side
          state.dash = null;
        }

        renderAll();
      }

      /* -------------------------
        Sidebar stats (client fallback)
      ------------------------- */
      function computeSidebarClient(){
        const todayISO = toISO(new Date());
        const month = monthKey(state.anchorMonth);

        const wallets = state.wallets.map(w => {
          const cur = w.currency || "EUR";
          const initial = Number(w.initialBalance || 0);
          const ev = state.events.filter(x => String(x.walletId) === String(w.id));

          let balance = initial;
          for(const x of ev){
            if(String(x.date||"") <= todayISO){
              const amt = Number(x.amount||0);
              balance += (x.type === "income") ? +amt : -amt;
            }
          }

          const monthExp = ev.filter(x => x.type === "expense" && String(x.date||"").startsWith(month));
          const spentDone = monthExp.filter(x => String(x.date||"") <= todayISO).reduce((s,x)=>s+Number(x.amount||0),0);
          const spentPlanned = monthExp.filter(x => String(x.date||"") > todayISO).reduce((s,x)=>s+Number(x.amount||0),0);

          const nextEvent = ev
            .filter(x => String(x.date||"") >= todayISO)
            .sort((a,b)=>String(a.date).localeCompare(String(b.date)))[0] || null;

          const byCat = new Map();
          for(const x of monthExp){
            const c = (x.category || "Senza categoria").trim();
            byCat.set(c, (byCat.get(c)||0) + Number(x.amount||0));
          }
          const byCategory = Array.from(byCat.entries()).map(([category, amount])=>({category, amount}))
            .sort((a,b)=>b.amount-a.amount);

          const topCategories = byCategory.slice(0,3);

          return {
            walletId: w.id,
            name: w.name,
            type: w.type,
            currency: cur,
            balance,
            spentDone,
            spentPlanned,
            nextEvent,
            topCategories,
            byCategory
          };
        });

        return { month, asOf: todayISO, wallets };
      }

      /* -------------------------
        Calendar rendering
      ------------------------- */
      function groupEventsByDay(){
        const map = new Map();
        for(const e of state.events){
          const iso = String(e.date || "");
          if(!iso) continue;
          if(!map.has(iso)) map.set(iso, []);
          map.get(iso).push(e);
        }
        for(const [k,v] of map.entries()){
          v.sort((a,b)=>String(a.title||"").localeCompare(String(b.title||"")));
        }
        return map;
      }

      function renderCalendar(){
        $("#monthLabel").textContent = humanMonth(state.anchorMonth);

        const host = $("#calendarHost");
        host.innerHTML = "";

        const grid = document.createElement("div");
        grid.className = "calGrid";

        // dows
        for(const d of ["Lun","Mar","Mer","Gio","Ven","Sab","Dom"]){
          const el = document.createElement("div");
          el.className = "dow";
          el.textContent = d;
          grid.appendChild(el);
        }

        const mStart = startOfMonth(state.anchorMonth);
        const gridStart = startOfWeekMon(mStart);
        const mEnd = endOfMonth(state.anchorMonth);
        const gridEnd = addDays(startOfWeekMon(addDays(mEnd, 6)), 6); // ensures full 6 weeks

        const byDay = groupEventsByDay();
        const todayISO = toISO(new Date());

        let cur = gridStart;
        let totalShown = 0;

        while(cur <= gridEnd){
          const iso = toISO(cur);
          const inMonth = cur.getMonth() === state.anchorMonth.getMonth();
          const events = byDay.get(iso) || [];
          totalShown += events.length;

          const day = document.createElement("div");
          day.className = "day" + (inMonth ? "" : " out") + (iso === todayISO ? " today" : "");
          day.dataset.iso = iso;

          const top = document.createElement("div");
          top.className = "dayTop";
          top.innerHTML = `<div class="dayNum">${cur.getDate()}</div>`;

          // daily sum (expense - income) optional
          let sum = 0;
          for(const e of events){
            const amt = Number(e.amount||0);
            sum += (e.type === "income") ? +amt : -amt;
          }
          const sumEl = document.createElement("div");
          sumEl.className = "daySum";
          sumEl.textContent = events.length ? `${events.length} evt` : "‚Äî";
          top.appendChild(sumEl);

          day.appendChild(top);

          // show max 2 events
          const preview = events.slice(0,2);
          for(const e of preview){
            const mini = document.createElement("div");
            mini.className = "evtMini " + (e.type || "");
            mini.innerHTML = `
              <div>
                ${e.title || "(senza titolo)"}
                <div><small>${e.category || "‚Äî"} ¬∑ ${getWalletName(e.walletId)}</small></div>
              </div>
              <div>${money(e.amount, getWalletCurrency(e.walletId))}</div>
            `;
            mini.addEventListener("click", (ev) => {
              ev.stopPropagation();
              openModalEdit(e);
            });
            day.appendChild(mini);
          }

          // click day ‚Üí quick add on that day
          day.addEventListener("click", () => openModalNew(iso));

          grid.appendChild(day);
          cur = addDays(cur, 1);
        }

        $("#metaCount").textContent = `${totalShown} eventi nel mese`;
        host.appendChild(grid);
      }

      function getWalletName(walletId){
        const w = state.wallets.find(x => String(x.id) === String(walletId));
        return w?.name || String(walletId || "‚Äî");
      }
      function getWalletCurrency(walletId){
        const w = state.wallets.find(x => String(x.id) === String(walletId));
        return w?.currency || "EUR";
      }

      /* -------------------------
        Sidebar rendering
      ------------------------- */
      function renderSidebar(){
        const host = $("#sidebarHost");
        host.innerHTML = "";

        const data = state.dash?.wallets ? state.dash : computeSidebarClient();

        if(!data.wallets.length){
          host.innerHTML = `<div class="muted">Nessun wallet disponibile. Controlla API /wallets.</div>`;
          return;
        }

        for(const w of data.wallets){
          const box = document.createElement("div");
          box.className = "wallet";

          const next = w.nextEvent;
          const nextText = next
            ? `${next.date} ¬∑ ${next.title || "Evento"} (${money(next.amount, w.currency)})`
            : "‚Äî";

          // barra spese: done vs planned
          const totExp = Number(w.spentDone||0) + Number(w.spentPlanned||0);
          const pct = totExp > 0 ? Math.round((Number(w.spentDone||0) / totExp) * 100) : 0;

          box.innerHTML = `
            <div class="walletTop">
              <div>
                <div class="walletName">${escapeHtml(w.name || w.walletId)}</div>
                <div class="muted">${escapeHtml(w.type || "")}</div>
              </div>
              <div style="font-weight:1000;text-align:right">
                ${money(w.balance, w.currency)}
                <div class="muted">saldo corrente</div>
              </div>
            </div>

            <div class="kpiRow">
              <div class="kpi">
                <div class="label">Spese mese (fatte)</div>
                <div class="value">${money(w.spentDone, w.currency)}</div>
              </div>
              <div class="kpi">
                <div class="label">Spese mese (da fare)</div>
                <div class="value">${money(w.spentPlanned, w.currency)}</div>
              </div>
            </div>

            <div class="barRow">
              <div class="muted">Progresso mese</div>
              <div style="font-weight:900">${pct}%</div>
            </div>
            <div class="bar"><i style="width:${pct}%"></i></div>

            <div class="muted" style="margin-top:4px;">Prossimo evento</div>
            <div style="font-weight:900">${escapeHtml(nextText)}</div>

            <div class="muted" style="margin-top:8px;">Top categorie</div>
            <div class="list" id="top_${cssId(w.walletId)}"></div>

            <div class="muted" style="margin-top:8px;">Dettaglio categorie</div>
            <div class="list" id="all_${cssId(w.walletId)}"></div>
          `;

          host.appendChild(box);

          // fill categories
          const topHost = $(`#top_${cssId(w.walletId)}`);
          const allHost = $(`#all_${cssId(w.walletId)}`);

          const topCats = w.topCategories || [];
          if(!topCats.length) topHost.innerHTML = `<div class="muted">‚Äî</div>`;
          else for(const c of topCats){
            const row = document.createElement("div");
            row.className = "evtMini expense";
            row.innerHTML = `<div>${escapeHtml(c.category)}</div><div>${money(c.amount, w.currency)}</div>`;
            topHost.appendChild(row);
          }

          const allCats = (w.byCategory || []).slice(0, 10);
          if(!allCats.length) allHost.innerHTML = `<div class="muted">‚Äî</div>`;
          else for(const c of allCats){
            const row = document.createElement("div");
            row.className = "evtMini expense";
            row.innerHTML = `<div>${escapeHtml(c.category)}</div><div>${money(c.amount, w.currency)}</div>`;
            allHost.appendChild(row);
          }
        }
      }

      function escapeHtml(s){
        return String(s||"").replace(/[&<>"']/g, c => ({
          "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
        }[c]));
      }
      function cssId(s){
        return String(s||"").replace(/[^a-z0-9\-_]/gi, "_");
      }

      /* -------------------------
        Modal (create / edit)
      ------------------------- */
      function fillWalletSelect(){
        const sel = $("#fWallet");
        sel.innerHTML = "";
        for(const w of state.wallets){
          const opt = document.createElement("option");
          opt.value = w.id;
          opt.textContent = w.name;
          sel.appendChild(opt);
        }
      }

      function syncScheduleUI(){
        const mode = $("#fScheduleMode").value;
        $("#deferredBox").style.display = (mode === "deferred") ? "" : "none";
        $("#instBox").style.display = (mode === "installments") ? "" : "none";

        // rate: calcola importo rata stimato
        if(mode === "installments"){
          const total = Number($("#fAmount").value || 0);
          const n = Math.max(2, Number($("#fInstCount").value || 2));
          const each = total > 0 ? (total / n) : 0;
          $("#fInstEach").value = each ? money(each) : "‚Äî";
        }
      }

      function openModalNew(dayISO){
        state.editingEvent = null;

        fillWalletSelect();

        $("#modalTitle").textContent = "Nuovo evento";
        $("#btnCopy").style.display = "none";
        $("#btnDelete").style.display = "none";
        $("#seriesBox").style.display = "none";
        $("#editHint").style.display = "none";

        const todayISO = toISO(new Date());
        const defaultISO = dayISO || todayISO;

        $("#fTitle").value = "";
        $("#fType").value = "expense";
        $("#fAmount").value = "";
        $("#fCategory").value = "";
        $("#fOccurred").value = defaultISO;

        // schedule defaults
        $("#fScheduleMode").value = "now";
        $("#fPayOn").value = defaultISO;
        $("#fInstCount").value = 3;
        $("#fInstFirst").value = addMonths(fromISO(defaultISO), 1) ? toISO(addMonths(fromISO(defaultISO), 1)) : defaultISO;
        $("#fNotes").value = "";
        $("#fInstNotes").value = "";
        $("#fNotesLong").value = "";

        syncScheduleUI();
        $("#evtModal").showModal();
      }

      function openModalEdit(evt){
        state.editingEvent = evt;

        fillWalletSelect();

        $("#modalTitle").textContent = "Modifica evento";
        $("#btnCopy").style.display = "";
        $("#btnDelete").style.display = "";
        $("#editHint").style.display = "";

        $("#fTitle").value = evt.title || "";
        $("#fType").value = evt.type || "expense";
        $("#fAmount").value = String(evt.amount ?? "");
        $("#fCategory").value = evt.category || "";
        $("#fWallet").value = evt.walletId || "";
        $("#fOccurred").value = evt.occurredOn || evt.date || toISO(new Date());

        // editing: schedule boxes hidden (editing modifies single event OR future series via checkbox)
        $("#fScheduleMode").value = "now";
        $("#deferredBox").style.display = "none";
        $("#instBox").style.display = "none";

        if(evt.seriesId){
          $("#seriesBox").style.display = "";
          $("#seriesTag").textContent = `series: ${evt.seriesId}`;
          $("#fApplyFuture").checked = false;
          $("#editHint").textContent = "Questo evento fa parte di una serie (rate/ricorrenza).";
        } else {
          $("#seriesBox").style.display = "none";
          $("#editHint").textContent = "";
        }
        $("#editHint").style.display = evt.seriesId ? "" : "none";

        $("#fNotesLong").value = evt.notes || "";

        $("#evtModal").showModal();
      }

      function closeModal(){
        $("#evtModal").close();
        state.editingEvent = null;
      }

      /* -------------------------
        Save / Delete / Copy
      ------------------------- */
      async function onSave(){
        const editing = state.editingEvent;

        const title = $("#fTitle").value.trim();
        const type = $("#fType").value;
        const walletId = $("#fWallet").value;
        const total = Number($("#fAmount").value || 0);
        const category = $("#fCategory").value.trim() || "Senza categoria";
        const occurredOn = $("#fOccurred").value || toISO(new Date());
        const notesLong = $("#fNotesLong").value || "";

        if(!title){ alert("Titolo obbligatorio"); return; }
        if(!walletId){ alert("Wallet obbligatorio"); return; }
        if(!(total > 0)){ alert("Importo non valido"); return; }

        try{
          if(editing){
            // edit single OR future series
            const applyFuture = !!$("#fApplyFuture").checked;
            if(applyFuture && editing.seriesId){
              await API.updateSeriesFuture(editing.seriesId, {
                from: editing.date,
                patch: { title, type, walletId, amount: total, category, notes: notesLong }
              });
            } else {
              await API.updateEvent(editing.id, {
                title, type, walletId, amount: total, category,
                date: editing.date, // non spostiamo la data qui (se vuoi, aggiungiamo campo date edit)
                occurredOn,
                notes: notesLong
              });
            }
          } else {
            // create with schedule
            const scheduleMode = $("#fScheduleMode").value;

            let payload = {
              title, type,
              walletId,
              totalAmount: total,
              category,
              occurredOn,
              notes: notesLong,
              schedule: { mode: scheduleMode }
            };

            if(scheduleMode === "now"){
              payload.schedule = { mode:"now", payOn: occurredOn };
            }

            if(scheduleMode === "deferred"){
              const payOn = $("#fPayOn").value || occurredOn;
              payload.schedule = { mode:"deferred", payOn };
            }

            if(scheduleMode === "installments"){
              const count = Math.max(2, Number($("#fInstCount").value || 2));
              const firstPayOn = $("#fInstFirst").value || occurredOn;
              // rate uguali (backend pu√≤ calcolarle, oppure le passiamo noi)
              const each = Number((total / count).toFixed(2));
              const amounts = Array.from({length:count}).map(()=>each);
              payload.schedule = {
                mode:"installments",
                installments:{
                  count,
                  firstPayOn,
                  interval:"monthly",
                  amounts
                }
              };
            }

            await API.createEvent(payload);
          }

          closeModal();
          await loadMonthData();
        }catch(err){
          alert(err?.message || "Errore salvataggio");
        }
      }

      async function onDelete(){
        const e = state.editingEvent;
        if(!e) return;

        if(e.seriesId){
          const choice = prompt(
            "Evento in serie.\nScrivi:\n1 = elimina SOLO questo\n2 = elimina questo + FUTURI\n3 = elimina TUTTA la serie",
            "1"
          );
          if(choice === "2"){
            if(!confirm("Confermi elimina da questo in poi?")) return;
            await API.deleteSeriesFuture(e.seriesId, e.date);
          } else if(choice === "3"){
            if(!confirm("Confermi elimina tutta la serie?")) return;
            await API.deleteSeries(e.seriesId);
          } else {
            if(!confirm("Confermi elimina solo questo evento?")) return;
            await API.deleteEvent(e.id);
          }
        } else {
          if(!confirm("Eliminare questo evento?")) return;
          await API.deleteEvent(e.id);
        }

        closeModal();
        await loadMonthData();
      }

      async function onCopy(){
        const e = state.editingEvent;
        if(!e) return;
        // copia semplice: crea nuovo evento identico in data selezionata (oggi)
        const dayISO = prompt("Data per la copia (YYYY-MM-DD)?", toISO(new Date()));
        if(!dayISO) return;

        try{
          await API.createEvent({
            title: (e.title || "") + " (copia)",
            type: e.type,
            walletId: e.walletId,
            totalAmount: Number(e.amount||0),
            category: e.category,
            occurredOn: dayISO,
            notes: e.notes || "",
            schedule: { mode:"now", payOn: dayISO }
          });
          closeModal();
          await loadMonthData();
        }catch(err){
          alert(err?.message || "Errore copia");
        }
      }

      /* -------------------------
        Render
      ------------------------- */
      function renderAll(){
        renderCalendar();
        renderSidebar();
      }

      /* -------------------------
        Bind UI
      ------------------------- */
      function bind(){
        $("#btnPrev").addEventListener("click", () => {
          state.anchorMonth = startOfMonth(addMonths(state.anchorMonth, -1));
          loadMonthData();
        });
        $("#btnNext").addEventListener("click", () => {
          state.anchorMonth = startOfMonth(addMonths(state.anchorMonth, +1));
          loadMonthData();
        });
        $("#btnToday").addEventListener("click", () => {
          state.anchorMonth = startOfMonth(new Date());
          loadMonthData();
        });

        $("#btnReload").addEventListener("click", loadMonthData);

        $("#q").addEventListener("input", (ev) => {
          state.q = ev.target.value || "";
          // ricarico mese (semplice)
          loadMonthData();
        });

        $("#btnNew").addEventListener("click", () => openModalNew(toISO(new Date())));
        $("#btnCloseModal").addEventListener("click", closeModal);
        $("#btnCancel").addEventListener("click", closeModal);

        $("#fScheduleMode").addEventListener("change", syncScheduleUI);
        $("#fAmount").addEventListener("input", syncScheduleUI);
        $("#fInstCount").addEventListener("input", syncScheduleUI);

        $("#btnSave").addEventListener("click", onSave);
        $("#btnDelete").addEventListener("click", onDelete);
        $("#btnCopy").addEventListener("click", onCopy);
      }

      /* -------------------------
        Boot
      ------------------------- */
      bind();
      loadMonthData();
    })();
  </script>
</body>
</html>
