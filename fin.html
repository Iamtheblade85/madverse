<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finance UI</title>
  <link rel="stylesheet" href="fin-theme.css" />

  <style>
    :root { --gap: 12px; --border: 1px solid #d0d0d0; --muted: #666; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
    header { padding: 10px 14px; border-bottom: var(--border); display:flex; gap: var(--gap); align-items:center; flex-wrap:wrap; }
    header .title { font-weight: 900; }
    main { padding: 14px; }
    .tabs { display:flex; gap: 8px; flex-wrap: wrap; }
    .tabbtn { padding: 8px 10px; border: var(--border); background: #fff; cursor:pointer; border-radius: 10px; }
    .tabbtn[aria-selected="true"] { font-weight: 900; outline: 2px solid #000; }
    .panel { display:none; }
    .panel.active { display:block; }

    .row { display:flex; gap: var(--gap); flex-wrap:wrap; align-items:flex-end; }
    .col { display:flex; flex-direction:column; gap: 6px; }
    label { font-size: 12px; color: var(--muted); }
    input, select, textarea { padding: 8px; border: var(--border); border-radius: 10px; min-width: 220px; }
    textarea { min-height: 80px; min-width: 320px; }
    button { padding: 8px 10px; border: var(--border); background: #fff; cursor:pointer; border-radius: 10px; }
    button.primary { outline: 2px solid #000; font-weight: 900; }
    button.danger { border-color: #b00020; color: #b00020; }

    .muted { color: var(--muted); font-size: 12px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; padding: 2px 6px; border: var(--border); border-radius: 8px; background:#fafafa; }

    .hr { height: 1px; background: #e6e6e6; margin: 12px 0; }

    .card { border: var(--border); border-radius: 14px; padding: 12px; background:#fff; }
    .grid { display:grid; gap: 10px; }
    .grid.two { grid-template-columns: repeat(2, minmax(260px, 1fr)); }
    .grid.three { grid-template-columns: repeat(3, minmax(260px, 1fr)); }

    .calendar { border: var(--border); border-radius: 14px; overflow:hidden; }
    .cal-head { display:flex; justify-content:space-between; align-items:center; padding: 10px; border-bottom: var(--border); gap: 10px; flex-wrap:wrap; }
    .cal-grid { display:grid; grid-template-columns: repeat(7, 1fr); }
    .dow { padding: 8px; font-size: 12px; color: var(--muted); border-bottom: var(--border); background:#fafafa; }
    .day { min-height: 110px; border-right: var(--border); border-bottom: var(--border); padding: 6px; display:flex; flex-direction:column; gap: 6px; }
    .day:nth-child(7n) { border-right: none; }
    .daynum { font-size: 12px; color: var(--muted); display:flex; justify-content:space-between; align-items:center; gap: 6px; }
    .pill { display:inline-flex; gap: 6px; align-items:center; padding: 4px 8px; border: var(--border); border-radius: 999px; font-size: 12px; cursor:pointer; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .pill small { color: var(--muted); }

    details { border: var(--border); border-radius: 14px; padding: 10px; background:#fff; }
    details > summary { cursor:pointer; font-weight: 900; }

    table { border-collapse: collapse; width: 100%; }
    th, td { text-align:left; border-bottom: var(--border); padding: 8px; font-size: 14px; }
    th { font-size: 12px; color: var(--muted); background: #fafafa; }

    .toast { position: fixed; right: 12px; bottom: 12px; padding: 10px 12px; border: var(--border); background: #fff; border-radius: 14px; max-width: 420px; display:none; }
    .toast.show { display:block; }

    /* Calendar header KPI cards */
    .kpi-strip { display:flex; gap: 10px; overflow:auto; padding-bottom: 4px; }
    .kpi { min-width: 320px; border: var(--border); border-radius: 14px; padding: 10px; background:#fff; }
    .kpi .name { font-weight: 900; display:flex; justify-content:space-between; gap: 10px; }
    .kpi .sub { color: var(--muted); font-size: 12px; margin-top: 2px; }
    .kpi .vals { display:grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 8px; }
    .kpi .val { border: var(--border); border-radius: 12px; padding: 8px; }
    .kpi .val .lab { color: var(--muted); font-size: 12px; }
    .kpi .val .num { font-weight: 900; margin-top: 2px; }
  </style>
</head>

<body>
<header>
  <div class="title">Finance UI</div>
  <div class="muted">Calendario • Settings • Carte</div>
  <div style="flex:1"></div>

  <div class="col">
    <label>API Base</label>
    <input id="apiBase" placeholder="/finance" value="/finance" />
    <div class="muted">Esempio: <span class="kbd">/api/finance</span></div>
  </div>

  <button id="btnReloadAll" class="primary">Ricarica dati</button>
</header>

<main>
  <nav class="tabs" role="tablist" aria-label="Finance tabs">
    <button class="tabbtn" role="tab" aria-selected="true" data-tab="tabCalendar">Calendario eventi</button>
    <button class="tabbtn" role="tab" aria-selected="false" data-tab="tabSettings">Settings</button>
    <button class="tabbtn" role="tab" aria-selected="false" data-tab="tabCards">Carte & Subtotali</button>
  </nav>

  <div class="hr"></div>

  <!-- =================== TAB: CALENDAR =================== -->
  <section id="tabCalendar" class="panel active" role="tabpanel">
    <div class="row">
      <div class="col">
        <label>Mese</label>
        <input id="calMonth" type="month" />
        <div class="muted">Seleziona il mese. Clicca un giorno per aggiornare i saldi “al giorno”.</div>
      </div>

      <div class="col">
        <label>Filtro wallet/carta (opzionale)</label>
        <select id="calWalletFilter">
          <option value="">Tutti</option>
        </select>
        <div class="muted">Filtro usa <span class="kbd">walletId</span> (backend filtra su più campi).</div>
      </div>

      <div class="col">
        <label>Ricerca</label>
        <input id="calSearch" placeholder="titolo / categoria / note" />
      </div>

      <div class="col">
        <label>Saldi “al giorno”</label>
        <input id="calAsOf" type="date" />
        <div class="muted">Cambierà automaticamente cliccando sul calendario.</div>
      </div>

      <div class="col">
        <label>&nbsp;</label>
        <button id="btnCalRefresh" class="primary">Aggiorna</button>
      </div>

      <div class="col">
        <label>&nbsp;</label>
        <button id="btnNewEvent">+ Nuovo evento</button>
      </div>
    </div>

    <div class="hr"></div>

    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:flex-start;">
        <div>
          <div style="font-weight:900;">Testate per ogni conto/carta</div>
          <div class="muted">
            Saldo al giorno • Spese mese • Diff mese scorso • Entrate mese • Diff mese scorso • Spese rimanenti mese.
            <br/>Per le carte, i “rimborsi” sono auto-creati/aggiornati come eventi in base allo statement del backend (se la carta ha <span class="kbd">defaultSourceWalletId</span>).
          </div>
        </div>
        <div class="muted">
          Regola automatica rimborsi carta: al salvataggio/modifica/cancellazione di eventi carta → ricalcolo → crea/aggiorna evento <span class="kbd">card_repayment</span>.
        </div>
      </div>

      <div class="hr"></div>
      <div id="kpiStrip" class="kpi-strip"></div>
    </div>

    <div class="hr"></div>

    <div class="calendar">
      <div class="cal-head">
        <div class="row" style="align-items:center">
          <button id="btnPrevMonth" title="Mese precedente">◀</button>
          <div>
            <div id="calTitle" style="font-weight:900"></div>
            <div class="muted">Clic su giorno: aggiorna saldi e crea evento. Clic su evento: modifica.</div>
          </div>
          <button id="btnNextMonth" title="Mese successivo">▶</button>
        </div>

        <div class="row" style="align-items:center">
          <div class="muted">Tip: per “stesso evento in più mesi” usa “Duplica su mesi” nell’editor.</div>
        </div>
      </div>

      <div class="cal-grid" id="calDow"></div>
      <div class="cal-grid" id="calGrid"></div>
    </div>

    <div class="hr"></div>

    <div class="card">
      <div style="font-weight:900; margin-bottom:8px;">Eventi nel mese (tabella)</div>
      <div class="muted" style="margin-bottom:8px;">Per verifiche e modifiche rapide.</div>
      <div style="overflow:auto">
        <table id="eventsTable">
          <thead>
            <tr>
              <th>ID</th><th>Data</th><th>Tipo</th><th>Titolo</th><th>Categoria</th><th>Importo</th><th>Wallet</th><th>Azioni</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Event Editor -->
    <dialog id="dlgEvent" style="width:min(920px, 96vw); border: var(--border); border-radius: 14px; padding: 12px;">
      <form method="dialog" id="eventForm">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <div>
            <div id="dlgTitle" style="font-weight:900; font-size: 18px;">Evento</div>
            <div class="muted">Campi minimi: tipo, data, titolo, categoria, importo. Il resto è guidato.</div>
          </div>
          <div class="row">
            <button id="btnDlgClose">Chiudi</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="grid two">
          <div class="col">
            <label>Tipo evento</label>
            <select id="evType">
              <option value="expense">Spesa (wallet normale)</option>
              <option value="income">Entrata (wallet normale)</option>
              <option value="card_purchase">Acquisto con carta</option>
              <option value="card_repayment">Rimborso carta (da wallet a carta)</option>
              <option value="card_credit">Gutschrift / Storno (su carta)</option>
              <option value="card_charge">Addebito carta (interessi/fee)</option>
            </select>
          </div>

          <div class="col">
            <label>Data (calendarDate)</label>
            <input id="evCalendarDate" type="date" />
            <div class="muted">Per <span class="kbd">card_purchase</span> viene anche usata come <span class="kbd">purchaseDate</span>.</div>
          </div>

          <div class="col">
            <label>Titolo</label>
            <input id="evTitle" placeholder="es. Supermercato" />
          </div>

          <div class="col">
            <label>Categoria</label>
            <input id="evCategory" placeholder="es. Alimentari" />
          </div>

          <div class="col">
            <label>Importo (positivo)</label>
            <input id="evAmount" type="number" step="0.01" placeholder="0.00" />
          </div>

          <div class="col">
            <label>Note (opzionale)</label>
            <textarea id="evNotes" placeholder="Dettagli (opzionale)"></textarea>
          </div>
        </div>

        <div class="hr"></div>

        <div class="grid three">
          <div class="col">
            <label>Wallet (income/expense)</label>
            <select id="evWalletId"><option value="">—</option></select>
          </div>

          <div class="col">
            <label>Carta (card_purchase / card_credit / card_charge)</label>
            <select id="evCardWalletId"><option value="">—</option></select>
          </div>

          <div class="col">
            <label>Da wallet → a carta (card_repayment)</label>
            <div class="row">
              <select id="evFromWalletId" style="min-width:260px"><option value="">Da wallet…</option></select>
              <select id="evToCardWalletId" style="min-width:260px"><option value="">A carta…</option></select>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <details id="scheduleBox">
          <summary>Pagamento rateale / finanziamento (solo per card_purchase)</summary>

          <div class="grid two" style="margin-top:10px;">
            <div class="col">
              <label>kind</label>
              <select id="schedKind">
                <option value="instant">instant</option>
                <option value="financing">financing</option>
              </select>
            </div>

            <div class="col">
              <label>count</label>
              <input id="schedCount" type="number" min="1" step="1" placeholder="es. 12" />
            </div>

            <div class="col">
              <label>firstStatementMonth (YYYY-MM)</label>
              <input id="schedFirstStatementMonth" placeholder="es. 2026-02" />
            </div>

            <div class="col">
              <label>monthlyInstallments.installmentAmount (opzionale)</label>
              <input id="schedInstallmentAmount" type="number" step="0.01" placeholder="se vuoto = amount/count" />
            </div>
          </div>

          <div class="hr"></div>

          <details>
            <summary>customInstallments (opzionale)</summary>
            <div class="muted" style="margin:8px 0;">Una riga per rata: <span class="kbd">YYYY-MM-DD;importo</span></div>
            <textarea id="schedCustomInstallments" placeholder="2026-03-05; 50.00&#10;2026-04-05; 50.00"></textarea>
          </details>
        </details>

        <div class="hr"></div>

        <details>
          <summary>Duplica su mesi</summary>
          <div class="muted" style="margin:8px 0;">Crea eventi separati (robusto per DB in produzione).</div>
          <div class="row">
            <div class="col">
              <label>Da mese</label>
              <input id="dupFromMonth" type="month" />
            </div>
            <div class="col">
              <label>A mese</label>
              <input id="dupToMonth" type="month" />
            </div>
            <div class="col">
              <label>Giorno del mese</label>
              <input id="dupDay" type="number" min="1" max="31" step="1" placeholder="es. 1" />
            </div>
            <div class="col">
              <label>&nbsp;</label>
              <button type="button" id="btnDuplicate">Duplica ora</button>
            </div>
          </div>
        </details>

        <div class="hr"></div>

        <input type="hidden" id="evId" value="" />

        <div class="row" style="justify-content:space-between;">
          <div class="row">
            <button type="button" id="btnDelete" class="danger" style="display:none;">Cancella</button>
          </div>
          <div class="row">
            <button type="button" id="btnSave" class="primary">Salva</button>
          </div>
        </div>

        <div id="dlgHint" class="muted" style="margin-top:10px;"></div>
      </form>
    </dialog>
  </section>

  <!-- =================== TAB: SETTINGS =================== -->
  <section id="tabSettings" class="panel" role="tabpanel">
    <div class="grid two">
      <div class="card">
        <div style="font-weight:900; margin-bottom:6px;">Settings carta</div>
        <div class="muted" style="margin-bottom:10px;">Applica ai wallet con <span class="kbd">type=card</span>.</div>

        <div class="col">
          <label>Carta</label>
          <select id="setCardSelect"><option value="">— Seleziona carta —</option></select>
        </div>

        <div class="hr"></div>

        <div class="grid two">
          <div class="col"><label>cycleStartDay</label><input id="setCycleStart" type="number" min="1" max="31" step="1" /></div>
          <div class="col"><label>cycleEndDay</label><input id="setCycleEnd" type="number" min="1" max="31" step="1" /></div>
          <div class="col"><label>debitDay</label><input id="setDebitDay" type="number" min="1" max="31" step="1" /></div>
          <div class="col"><label>debitMonthOffset</label><input id="setDebitOffset" type="number" step="1" /></div>
          <div class="col"><label>teilzahlungAmount</label><input id="setTeilzahlung" type="number" step="0.01" /></div>
          <div class="col"><label>kreditlimit</label><input id="setLimit" type="number" step="0.01" /></div>
          <div class="col"><label>sollzinsAnnual</label><input id="setSoll" type="number" step="0.01" /></div>
          <div class="col"><label>effektivzinsAnnual</label><input id="setEffektiv" type="number" step="0.01" /></div>
          <div class="col"><label>effectiveFrom</label><input id="setEffectiveFrom" type="date" /></div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <button id="btnLoadCardSettings">Carica</button>
          <button id="btnSaveCardSettings" class="primary">Salva</button>
        </div>

        <div id="settingsInfo" class="muted" style="margin-top:10px;"></div>
      </div>

      <div class="card">
        <div style="font-weight:900; margin-bottom:6px;">Health</div>
        <button id="btnHealth">Test connessione</button>
        <div id="healthOut" class="muted" style="margin-top:8px;"></div>

        <div class="hr"></div>

        <div style="font-weight:900; margin-bottom:6px;">Note</div>
        <ul class="muted" style="margin:0; padding-left: 18px;">
          <li>Nessuna modifica a nomi parametri/payload/response del backend.</li>
          <li>Per auto-rimborsi carta: serve <span class="kbd">defaultSourceWalletId</span> impostato sul wallet carta.</li>
          <li>I rimborsi “auto” sono riconosciuti da <span class="kbd">subType = auto_scheduled</span> (set via PUT dopo creazione).</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- =================== TAB: CARDS =================== -->
  <section id="tabCards" class="panel" role="tabpanel">
    <div class="row">
      <div class="col">
        <label>As Of</label>
        <input id="cardsAsOf" type="date" />
      </div>

      <div class="col">
        <label>Mese</label>
        <input id="cardsMonth" type="month" />
      </div>

      <div class="col">
        <label>&nbsp;</label>
        <button id="btnCardsRefresh" class="primary">Aggiorna</button>
      </div>
    </div>

    <div class="hr"></div>

    <div id="cardsOverview" class="grid two"></div>

    <div class="hr"></div>

    <div class="card">
      <div style="font-weight:900; margin-bottom:6px;">Dettagli per wallet/carta (albero richiudibile)</div>
      <div class="muted" style="margin-bottom:10px;">Mostra: saldo, spese/entrate mese, confronti, categorie, e per carte: statement + repayment previsto.</div>
      <div id="walletTree" class="grid" style="grid-template-columns: 1fr;"></div>
    </div>
  </section>

  <div id="toast" class="toast"></div>
</main>

<script>
  // =========================
  // Helpers / State
  // =========================
  const $ = (id) => document.getElementById(id);

  const state = {
    apiBase: "/finance",
    wallets: [],
    walletById: new Map(),
    events: [],
    month: null,      // Date (first day of selected month)
    calAsOf: null,    // Date (selected day)
    dashboard: null,  // /dashboard response for current month + asOf
  };

  function apiBase() {
    state.apiBase = ($("apiBase").value || "").trim() || "/finance";
    return state.apiBase.replace(/\/+$/,"");
  }

  async function apiFetch(path, opts={}) {
    const url = apiBase() + path;
    const res = await fetch(url, { headers: { "Content-Type":"application/json" }, ...opts });
    if (!res.ok) {
      let txt = ""; try { txt = await res.text(); } catch {}
      throw new Error(`HTTP ${res.status} ${res.statusText} - ${txt}`);
    }
    const ct = res.headers.get("content-type") || "";
    if (ct.includes("application/json")) return await res.json();
    return await res.text();
  }

  function toast(msg, ms=4500) {
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(t._timer);
    t._timer = setTimeout(()=>t.classList.remove("show"), ms);
  }

  function isoDate(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }
  function isoYM(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    return `${y}-${m}`;
  }
  function parseYM(s) {
    if (!s || s.length < 7) return null;
    const y = parseInt(s.slice(0,4),10);
    const m = parseInt(s.slice(5,7),10);
    if (!y || !m) return null;
    return new Date(y, m-1, 1);
  }
  function monthBounds(d) {
    const start = new Date(d.getFullYear(), d.getMonth(), 1);
    const end = new Date(d.getFullYear(), d.getMonth()+1, 0);
    return { start, end };
  }
  function clampDayToMonth(y, m1to12, day) {
    const last = new Date(y, m1to12, 0).getDate();
    return Math.min(Math.max(1, day), last);
  }
  function fmtMoney(n) {
    if (n === null || n === undefined || Number.isNaN(Number(n))) return "";
    return Number(n).toLocaleString("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
  function typeLabel(t) {
    return ({
      income: "Entrata",
      expense: "Spesa",
      card_purchase: "Acquisto carta",
      card_repayment: "Rimborso carta",
      card_credit: "Gutschrift",
      card_charge: "Addebito carta"
    }[t] || t);
  }
  function eventEffectiveDate(ev) {
    return ev.effectiveDate || ev.purchaseDate || ev.calendarDate || ev.paymentDate || "";
  }

  // =========================
  // Tabs
  // =========================
  function setTab(tabId) {
    document.querySelectorAll(".tabbtn").forEach(b=>{
      const sel = b.dataset.tab === tabId;
      b.setAttribute("aria-selected", sel ? "true":"false");
    });
    document.querySelectorAll(".panel").forEach(p=> p.classList.toggle("active", p.id === tabId));
  }
  document.querySelectorAll(".tabbtn").forEach(b=> b.addEventListener("click", ()=> setTab(b.dataset.tab)));

  // =========================
  // Load Wallets
  // =========================
  async function loadWallets() {
    const wallets = await apiFetch("/wallets", { method:"GET" });
    state.wallets = Array.isArray(wallets) ? wallets : [];
    state.walletById = new Map(state.wallets.map(w => [String(w.id), w]));

    // Calendar filter
    const wf = $("calWalletFilter");
    wf.innerHTML = `<option value="">Tutti</option>`;
    for (const w of state.wallets) {
      const opt = document.createElement("option");
      opt.value = String(w.id);
      opt.textContent = `${w.name} (${w.type})`;
      wf.appendChild(opt);
    }

    // Editor selects
    const walletSelects = [$("evWalletId"), $("evFromWalletId")];
    for (const s of walletSelects) {
      s.innerHTML = `<option value="">—</option>`;
      for (const w of state.wallets.filter(x => x.type !== "card")) {
        const opt = document.createElement("option");
        opt.value = String(w.id);
        opt.textContent = w.name;
        s.appendChild(opt);
      }
    }
    const cardSelects = [$("evCardWalletId"), $("evToCardWalletId"), $("setCardSelect")];
    for (const s of cardSelects) {
      s.innerHTML = (s === $("setCardSelect")) ? `<option value="">— Seleziona carta —</option>` : `<option value="">—</option>`;
      for (const w of state.wallets.filter(x => x.type === "card")) {
        const opt = document.createElement("option");
        opt.value = String(w.id);
        opt.textContent = w.name;
        s.appendChild(opt);
      }
    }
  }

  // =========================
  // Dashboard (shared for KPI + Cards tab)
  // =========================
  async function loadDashboardForCalendar() {
    const asOf = $("calAsOf").value || isoDate(new Date());
    const month = $("calMonth").value || isoYM(new Date());
    const params = new URLSearchParams({ asOf, month });
    state.dashboard = await apiFetch("/dashboard?" + params.toString(), { method:"GET" });
    renderKpiStrip();
  }

  async function loadDashboardForCardsTab() {
    const asOf = $("cardsAsOf").value || isoDate(new Date());
    const month = $("cardsMonth").value || isoYM(new Date());
    const params = new URLSearchParams({ asOf, month });
    state.dashboard = await apiFetch("/dashboard?" + params.toString(), { method:"GET" });
    renderCardsOverview();
    renderWalletTree();
  }

  // =========================
  // KPI Strip (Calendar tab)
  // =========================
  function renderKpiStrip() {
    const wrap = $("kpiStrip");
    wrap.innerHTML = "";

    const wallets = (state.dashboard && Array.isArray(state.dashboard.wallets)) ? state.dashboard.wallets : [];

    // Order: cards first, then others; stable by name
    wallets.sort((a,b)=>{
      if (a.type === b.type) return (a.name||"").localeCompare(b.name||"");
      if (a.type === "card") return -1;
      if (b.type === "card") return 1;
      return (a.type||"").localeCompare(b.type||"");
    });

    for (const w of wallets) {
      const k = document.createElement("div");
      k.className = "kpi";

      const b = fmtMoney(w.balance);
      const s = fmtMoney(w.spentSoFar);
      const i = fmtMoney(w.incomeSoFar);
      const sr = fmtMoney(w.spentRemaining);

      const ce = w.compareLastMonthExpenses || { amount:0, percent:0 };
      const ci = w.compareLastMonthIncome || { amount:0, percent:0 };

      const ceTxt = `${fmtMoney(ce.amount)} (${Number(ce.percent||0).toFixed(1)}%)`;
      const ciTxt = `${fmtMoney(ci.amount)} (${Number(ci.percent||0).toFixed(1)}%)`;

      // For cards, show also outstanding/available
      let cardExtra = "";
      if (w.type === "card" && w.card) {
        cardExtra = `<div class="sub">Carta • outstanding ${fmtMoney(w.card.outstanding)} • disponibile ${fmtMoney(w.card.availableCredit)}</div>`;
      } else {
        cardExtra = `<div class="sub">${w.type}</div>`;
      }

      k.innerHTML = `
        <div class="name">
          <span>${(w.name||"").replace(/</g,"&lt;")}</span>
          <span class="muted">${w.type}</span>
        </div>
        ${cardExtra}
        <div class="vals">
          <div class="val"><div class="lab">Saldo al giorno</div><div class="num">${b}</div></div>
          <div class="val"><div class="lab">Spese mese</div><div class="num">${s}</div><div class="muted">Diff: ${ceTxt}</div></div>
          <div class="val"><div class="lab">Entrate mese</div><div class="num">${i}</div><div class="muted">Diff: ${ciTxt}</div></div>
          <div class="val"><div class="lab">Spese rimanenti mese</div><div class="num">${sr}</div></div>
        </div>
      `;

      // Click KPI -> filter calendar by this wallet
      k.addEventListener("click", ()=>{
        $("calWalletFilter").value = String(w.id);
        loadEventsForMonth();
      });

      wrap.appendChild(k);
    }
  }

  // =========================
  // Calendar Events
  // =========================
  async function loadEventsForMonth() {
    const m = state.month || new Date(new Date().getFullYear(), new Date().getMonth(), 1);
    const { start, end } = monthBounds(m);

    const from = isoDate(start);
    const to = isoDate(end);

    const walletId = ($("calWalletFilter").value || "").trim();
    const q = ($("calSearch").value || "").trim();

    const params = new URLSearchParams({ from, to });
    if (walletId) params.set("walletId", walletId);
    if (q) params.set("q", q);

    const events = await apiFetch("/events?" + params.toString(), { method:"GET" });
    state.events = Array.isArray(events) ? events : [];
    renderCalendar();
    renderEventsTable();
  }

  function groupEventsByDate(events) {
    const map = new Map();
    for (const ev of events) {
      const d = eventEffectiveDate(ev);
      if (!d) continue;
      const key = d.slice(0,10);
      if (!map.has(key)) map.set(key, []);
      map.get(key).push(ev);
    }
    for (const [k, arr] of map.entries()) arr.sort((a,b)=> (a.id||0)-(b.id||0));
    return map;
  }

  function renderCalendar() {
    const m = state.month;
    if (!m) return;

    $("calTitle").textContent = m.toLocaleDateString("it-IT", { month:"long", year:"numeric" });

    const dow = ["Lun","Mar","Mer","Gio","Ven","Sab","Dom"];
    const calDow = $("calDow");
    calDow.innerHTML = "";
    for (const d of dow) {
      const el = document.createElement("div");
      el.className = "dow";
      el.textContent = d;
      calDow.appendChild(el);
    }

    const { start } = monthBounds(m);
    const firstDow = start.getDay(); // 0 Sun
    const mondayBased = (firstDow + 6) % 7;
    const gridStart = new Date(start);
    gridStart.setDate(start.getDate() - mondayBased);

    const byDate = groupEventsByDate(state.events);
    const calGrid = $("calGrid");
    calGrid.innerHTML = "";

    for (let i=0; i<42; i++) {
      const d = new Date(gridStart);
      d.setDate(gridStart.getDate()+i);
      const ds = isoDate(d);
      const inMonth = d.getMonth() === m.getMonth();

      const cell = document.createElement("div");
      cell.className = "day";
      cell.style.opacity = inMonth ? "1" : "0.45";

      const head = document.createElement("div");
      head.className = "daynum";

      const left = document.createElement("span");
      left.textContent = String(d.getDate());

      const addBtn = document.createElement("button");
      addBtn.textContent = "+";
      addBtn.title = "Nuovo evento in questo giorno";
      addBtn.addEventListener("click", (e)=>{
        e.stopPropagation();
        openEventDialogForNew(ds);
      });

      head.appendChild(left);
      head.appendChild(addBtn);
      cell.appendChild(head);

      const list = document.createElement("div");
      list.className = "row";
      list.style.flexWrap = "wrap";
      list.style.gap = "6px";

      const evs = byDate.get(ds) || [];
      for (const ev of evs.slice(0, 6)) {
        const pill = document.createElement("div");
        pill.className = "pill";
        pill.title = "Clicca per modificare";
        pill.addEventListener("click", (e)=>{ e.stopPropagation(); openEventDialogForEdit(ev.id); });

        const t = document.createElement("span");
        t.textContent = ev.title || "(senza titolo)";

        const a = document.createElement("small");
        a.textContent = `${typeLabel(ev.type)} • ${fmtMoney(ev.amount)}`;

        pill.appendChild(t);
        pill.appendChild(a);
        list.appendChild(pill);
      }

      if (evs.length > 6) {
        const more = document.createElement("div");
        more.className = "muted";
        more.textContent = `+${evs.length - 6} altri…`;
        list.appendChild(more);
      }

      cell.appendChild(list);

      // Click day: set asOf + refresh KPI + allow create
      cell.addEventListener("click", async ()=>{
        $("calAsOf").value = ds;
        state.calAsOf = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        await loadDashboardForCalendar();
      });

      calGrid.appendChild(cell);
    }
  }

  function renderEventsTable() {
    const tb = document.querySelector("#eventsTable tbody");
    tb.innerHTML = "";

    const rows = [...state.events].sort((a,b)=>{
      const da = eventEffectiveDate(a) || "";
      const db = eventEffectiveDate(b) || "";
      if (da < db) return -1;
      if (da > db) return 1;
      return (a.id||0)-(b.id||0);
    });

    for (const ev of rows) {
      const tr = document.createElement("tr");
      const wid = ev.walletId || ev.cardWalletId || ev.fromWalletId || ev.toCardWalletId || "";
      const wName = wid ? (state.walletById.get(String(wid))?.name || String(wid)) : "";

      tr.innerHTML = `
        <td>${ev.id ?? ""}</td>
        <td>${eventEffectiveDate(ev) || ""}</td>
        <td>${typeLabel(ev.type)}</td>
        <td>${(ev.title||"").replace(/</g,"&lt;")}</td>
        <td>${(ev.category||"").replace(/</g,"&lt;")}</td>
        <td>${fmtMoney(ev.amount)}</td>
        <td>${(wName||"").replace(/</g,"&lt;")}</td>
        <td></td>
      `;

      const actions = document.createElement("div");
      actions.className = "row";

      const btnEdit = document.createElement("button");
      btnEdit.textContent = "Modifica";
      btnEdit.addEventListener("click", ()=> openEventDialogForEdit(ev.id));

      const btnDel = document.createElement("button");
      btnDel.textContent = "Cancella";
      btnDel.className = "danger";
      btnDel.addEventListener("click", ()=> deleteEventById(ev.id));

      actions.appendChild(btnEdit);
      actions.appendChild(btnDel);

      tr.children[7].appendChild(actions);
      tb.appendChild(tr);
    }
  }

  // =========================
  // Auto-scheduled card repayments (calendar month)
  // =========================
  function isCardTypeEvent(t) {
    return t === "card_purchase" || t === "card_credit" || t === "card_charge";
  }

  // Find existing repayment events on a given date for a given card within current month cache (state.events),
  // or via API if not present due to filters.
  async function findRepaymentsOnDate(cardId, payDateISO) {
    // 1) try in current month cached list (includes repayments if not filtered out)
    const cached = state.events.filter(e =>
      e.type === "card_repayment" &&
      String(e.toCardWalletId || "") === String(cardId) &&
      String(e.paymentDate || e.calendarDate || "").slice(0,10) === payDateISO.slice(0,10)
    );
    if (cached.length) return cached;

    // 2) fallback: query single day range; walletId filter ensures we fetch repayments too.
    const params = new URLSearchParams({ from: payDateISO, to: payDateISO, walletId: String(cardId) });
    const evs = await apiFetch("/events?" + params.toString(), { method:"GET" });
    return Array.isArray(evs) ? evs.filter(e => e.type === "card_repayment") : [];
  }

  // Ensure: for each card, create/update an auto repayment event (card_repayment) on scheduledRepayment.paymentDate
  // amount = scheduledRepayment.suggestedAmount (or baseline)
  async function ensureScheduledRepaymentsForCurrentMonth() {
    // Uses current calendar asOf + month
    const asOf = $("calAsOf").value || isoDate(new Date());
    const month = $("calMonth").value || isoYM(new Date());
    const dash = await apiFetch("/dashboard?" + new URLSearchParams({ asOf, month }).toString(), { method:"GET" });

    // We only create/update if card has defaultSourceWalletId (from /wallets data).
    const wallets = Array.isArray(dash.wallets) ? dash.wallets : [];

    for (const w of wallets) {
      if (w.type !== "card") continue;
      const cardId = w.id;
      const wDef = state.walletById.get(String(cardId));
      const defaultSourceWalletId = wDef ? wDef.defaultSourceWalletId : null;
      if (!defaultSourceWalletId) continue;

      const sched = w.card && w.card.scheduledRepayment ? w.card.scheduledRepayment : null;
      if (!sched || !sched.paymentDate) continue;

      const payDate = String(sched.paymentDate).slice(0,10);
      const amount = Number(sched.suggestedAmount ?? sched.baselineAmount ?? 0);
      if (!Number.isFinite(amount) || amount <= 0) continue;

      const existing = await findRepaymentsOnDate(cardId, payDate);

      // Choose an "auto" one if present, else any one.
      const autoOne = existing.find(x => (x.subType || "") === "auto_scheduled") || null;
      const chosen = autoOne || existing[0] || null;

      const title = `Addebito carta (auto)`;

      if (!chosen) {
        // Create repayment
        const payload = {
          type: "card_repayment",
          title,
          amount,
          category: "Card Repayment",
          calendarDate: payDate,
          notes: "Auto-created from scheduledRepayment",
          fromWalletId: Number(defaultSourceWalletId),
          toCardWalletId: Number(cardId),
          paymentDate: payDate
        };

        try {
          const created = await apiFetch("/events", { method:"POST", body: JSON.stringify(payload) });
          // mark as auto via PUT (backend create_event doesn't set subType for card_repayment)
          if (created && created.id) {
            await apiFetch(`/events/${encodeURIComponent(created.id)}`, {
              method:"PUT",
              body: JSON.stringify({ subType: "auto_scheduled", meta: { auto: true, source: "scheduledRepayment", month } })
            });
          }
        } catch (e) {
          // Do not hard fail UI
          console.warn("auto repayment create failed:", e);
        }
      } else {
        // Update only if it's auto (to avoid overwriting a manual one)
        if ((chosen.subType || "") === "auto_scheduled") {
          const patch = {
            title,
            amount,
            category: chosen.category || "Card Repayment",
            calendarDate: payDate,
            paymentDate: payDate,
            fromWalletId: Number(defaultSourceWalletId),
            toCardWalletId: Number(cardId),
            meta: { auto: true, source: "scheduledRepayment", month }
          };
          try {
            await apiFetch(`/events/${encodeURIComponent(chosen.id)}`, { method:"PUT", body: JSON.stringify(patch) });
          } catch (e) {
            console.warn("auto repayment update failed:", e);
          }
        }
      }
    }

    // refresh month events + KPI after adjustments
    await loadEventsForMonth();
    state.dashboard = dash;
    renderKpiStrip();
  }

  // =========================
  // Event Dialog CRUD
  // =========================
  function resetEventDialog() {
    $("evId").value = "";
    $("evType").value = "expense";
    $("evCalendarDate").value = isoDate(new Date());
    $("evTitle").value = "";
    $("evCategory").value = "";
    $("evAmount").value = "";
    $("evNotes").value = "";

    $("evWalletId").value = "";
    $("evCardWalletId").value = "";
    $("evFromWalletId").value = "";
    $("evToCardWalletId").value = "";

    $("schedKind").value = "instant";
    $("schedCount").value = "";
    $("schedFirstStatementMonth").value = "";
    $("schedInstallmentAmount").value = "";
    $("schedCustomInstallments").value = "";

    $("dupFromMonth").value = "";
    $("dupToMonth").value = "";
    $("dupDay").value = "";

    $("btnDelete").style.display = "none";
    $("dlgTitle").textContent = "Nuovo evento";
    $("dlgHint").textContent = "";
  }

  function openEventDialogForNew(isoDateStr) {
    resetEventDialog();
    $("evCalendarDate").value = (isoDateStr || isoDate(new Date())).slice(0,10);
    $("dlgHint").textContent = "Se è un acquisto con carta: seleziona 'Acquisto con carta' e scegli la carta.";
    $("dlgEvent").showModal();
  }

  function fillScheduleFromEvent(ev) {
    const s = ev.schedule || null;
    if (!s || typeof s !== "object") { $("schedKind").value = "instant"; return; }
    $("schedKind").value = (s.kind || "instant");

    if ((s.kind || "instant") === "financing") {
      $("schedCount").value = s.count ?? "";
      $("schedFirstStatementMonth").value = s.firstStatementMonth ?? "";
      const mi = s.monthlyInstallments || {};
      if (mi && typeof mi === "object" && mi.installmentAmount != null) $("schedInstallmentAmount").value = mi.installmentAmount;
      const ci = s.customInstallments;
      if (Array.isArray(ci) && ci.length) $("schedCustomInstallments").value = ci.map(x => `${x.date}; ${x.amount}`).join("\n");
    }
  }

  async function openEventDialogForEdit(id) {
    let ev = state.events.find(x => String(x.id) === String(id));
    if (!ev) await loadEventsForMonth();
    ev = state.events.find(x => String(x.id) === String(id));
    if (!ev) { toast("Evento non trovato."); return; }

    resetEventDialog();
    $("dlgTitle").textContent = `Modifica evento #${ev.id}`;
    $("evId").value = String(ev.id);

    $("evType").value = ev.type || "expense";
    const cd = (ev.calendarDate || ev.purchaseDate || ev.paymentDate || "");
    if (cd) $("evCalendarDate").value = cd.slice(0,10);

    $("evTitle").value = ev.title || "";
    $("evCategory").value = ev.category || "";
    $("evAmount").value = ev.amount ?? "";
    $("evNotes").value = ev.notes || "";

    $("evWalletId").value = ev.walletId ? String(ev.walletId) : "";
    $("evCardWalletId").value = ev.cardWalletId ? String(ev.cardWalletId) : "";
    $("evFromWalletId").value = ev.fromWalletId ? String(ev.fromWalletId) : "";
    $("evToCardWalletId").value = ev.toCardWalletId ? String(ev.toCardWalletId) : "";

    fillScheduleFromEvent(ev);

    $("btnDelete").style.display = "inline-flex";
    $("dlgHint").textContent = "Dopo Salva, i rimborsi carta auto verranno ricalcolati se necessario.";
    $("dlgEvent").showModal();
  }

  function buildScheduleForSave() {
    const t = $("evType").value;
    if (t !== "card_purchase") return null;

    const kind = ($("schedKind").value || "instant").trim();
    if (kind === "instant") return { kind:"instant" };

    const count = parseInt($("schedCount").value || "0", 10);
    const fsm = ($("schedFirstStatementMonth").value || "").trim();

    const sched = { kind:"financing" };
    if (Number.isFinite(count) && count > 0) sched.count = count;
    if (fsm) sched.firstStatementMonth = fsm;

    const instAmountStr = ($("schedInstallmentAmount").value || "").trim();
    if (instAmountStr) {
      const ia = Number(instAmountStr);
      if (!Number.isNaN(ia) && ia > 0) sched.monthlyInstallments = { installmentAmount: ia };
    }

    const ciRaw = ($("schedCustomInstallments").value || "").trim();
    if (ciRaw) {
      const lines = ciRaw.split("\n").map(s => s.trim()).filter(Boolean);
      const ci = [];
      for (const ln of lines) {
        const parts = ln.split(";").map(x=>x.trim());
        if (parts.length < 2) continue;
        const d = parts[0];
        const a = Number(parts[1].replace(",", "."));
        if (d && !Number.isNaN(a) && a > 0) ci.push({ date: d, amount: a });
      }
      if (ci.length) sched.customInstallments = ci;
    }

    return sched;
  }

  function buildEventPayload() {
    const type = $("evType").value;
    const calendarDate = $("evCalendarDate").value;

    const payload = {
      type,
      title: ($("evTitle").value || "").trim(),
      amount: Number(($("evAmount").value || "").replace(",", ".")),
      category: ($("evCategory").value || "").trim(),
      calendarDate,
      notes: $("evNotes").value || "",
    };

    if (type === "income" || type === "expense") payload.walletId = $("evWalletId").value ? Number($("evWalletId").value) : null;
    if (type === "card_purchase" || type === "card_credit" || type === "card_charge") payload.cardWalletId = $("evCardWalletId").value ? Number($("evCardWalletId").value) : null;

    if (type === "card_repayment") {
      payload.fromWalletId = $("evFromWalletId").value ? Number($("evFromWalletId").value) : null;
      payload.toCardWalletId = $("evToCardWalletId").value ? Number($("evToCardWalletId").value) : null;
      payload.paymentDate = calendarDate; // semplice default
    }

    if (type === "card_purchase") {
      payload.purchaseDate = calendarDate;
      payload.schedule = buildScheduleForSave();
    }

    if (type === "card_charge") payload.subType = "fee_card";
    if (type === "card_credit") payload.subType = "gutschrift";

    return payload;
  }

  async function saveEvent() {
    const id = ($("evId").value || "").trim();
    const payload = buildEventPayload();

    if (!payload.title) return toast("Titolo obbligatorio.");
    if (!payload.category) return toast("Categoria obbligatoria.");
    if (!payload.calendarDate) return toast("Data obbligatoria.");
    if (!Number.isFinite(payload.amount) || payload.amount <= 0) return toast("Importo deve essere > 0.");

    if ((payload.type === "income" || payload.type === "expense") && !payload.walletId) return toast("Seleziona wallet per entrata/spesa.");
    if ((payload.type === "card_purchase" || payload.type === "card_credit" || payload.type === "card_charge") && !payload.cardWalletId) return toast("Seleziona carta.");
    if (payload.type === "card_repayment" && (!payload.fromWalletId || !payload.toCardWalletId)) return toast("Seleziona wallet origine e carta.");

    try {
      if (!id) {
        await apiFetch("/events", { method:"POST", body: JSON.stringify(payload) });
        toast("Evento creato.");
      } else {
        await apiFetch(`/events/${encodeURIComponent(id)}`, { method:"PUT", body: JSON.stringify(payload) });
        toast("Evento aggiornato.");
      }
      $("dlgEvent").close();

      // reload month events
      await loadEventsForMonth();

      // If card-related event changed, ensure scheduled repayments stay consistent
      if (isCardTypeEvent(payload.type) || payload.type === "card_repayment") {
        await ensureScheduledRepaymentsForCurrentMonth();
      } else {
        // still refresh KPI for non-card
        await loadDashboardForCalendar();
      }
    } catch (e) {
      toast("Errore salvataggio: " + (e.message || e));
    }
  }

  async function deleteEventById(id) {
    if (!id) return;
    const ok = confirm(`Cancellare l'evento #${id}? Azione immediata.`);
    if (!ok) return;

    // Determine type before delete (to trigger repayment recalculation if needed)
    const ev = state.events.find(x => String(x.id) === String(id));
    const t = ev ? ev.type : null;

    try {
      await apiFetch(`/events/${encodeURIComponent(id)}`, { method:"DELETE" });
      toast("Evento cancellato.");
      await loadEventsForMonth();

      if (t && (isCardTypeEvent(t) || t === "card_repayment")) {
        await ensureScheduledRepaymentsForCurrentMonth();
      } else {
        await loadDashboardForCalendar();
      }
    } catch (e) {
      toast("Errore cancellazione: " + (e.message || e));
    }
  }

  async function duplicateEventAcrossMonths() {
    const basePayload = buildEventPayload();

    const fromYM = $("dupFromMonth").value;
    const toYM = $("dupToMonth").value;
    const day = parseInt($("dupDay").value || "0", 10);

    if (!fromYM || !toYM) return toast("Imposta Da mese e A mese.");
    if (!Number.isFinite(day) || day <= 0) return toast("Imposta Giorno (1..31).");

    const from = parseYM(fromYM);
    const to = parseYM(toYM);
    if (!from || !to) return toast("Mesi non validi.");
    if (from > to) return toast("Da mese deve essere <= A mese.");

    const copies = [];
    const cur = new Date(from.getFullYear(), from.getMonth(), 1);
    const end = new Date(to.getFullYear(), to.getMonth(), 1);

    while (cur <= end) {
      const y = cur.getFullYear();
      const m1 = cur.getMonth() + 1;
      const dd = clampDayToMonth(y, m1, day);
      const d = new Date(y, m1-1, dd);

      const p = JSON.parse(JSON.stringify(basePayload));
      p.calendarDate = isoDate(d);
      if (p.type === "card_purchase") p.purchaseDate = p.calendarDate;
      if (p.type === "card_repayment") p.paymentDate = p.calendarDate;

      copies.push(p);
      cur.setMonth(cur.getMonth() + 1);
    }

    if (!confirm(`Creare ${copies.length} copie?`)) return;

    try {
      for (const p of copies) await apiFetch("/events", { method:"POST", body: JSON.stringify(p) });
      toast(`Copie create: ${copies.length}`);
      $("dlgEvent").close();
      await loadEventsForMonth();

      if (isCardTypeEvent(basePayload.type) || basePayload.type === "card_repayment") {
        await ensureScheduledRepaymentsForCurrentMonth();
      } else {
        await loadDashboardForCalendar();
      }
    } catch (e) {
      toast("Errore duplicazione: " + (e.message || e));
    }
  }

  // =========================
  // Settings Tab
  // =========================
  async function healthCheck() {
    try {
      const out = await apiFetch("/health", { method:"GET" });
      $("healthOut").textContent = JSON.stringify(out);
      toast("Health OK");
    } catch (e) {
      $("healthOut").textContent = String(e.message || e);
      toast("Health ERROR: " + (e.message || e));
    }
  }

  async function loadCardSettings() {
    const cid = ($("setCardSelect").value || "").trim();
    if (!cid) return toast("Seleziona una carta.");

    try {
      const s = await apiFetch(`/cards/${encodeURIComponent(cid)}/settings`, { method:"GET" });
      $("setCycleStart").value = s.cycleStartDay ?? "";
      $("setCycleEnd").value = s.cycleEndDay ?? "";
      $("setDebitDay").value = s.debitDay ?? "";
      $("setDebitOffset").value = s.debitMonthOffset ?? "";
      $("setTeilzahlung").value = s.teilzahlungAmount ?? "";
      $("setLimit").value = s.kreditlimit ?? "";
      $("setSoll").value = s.sollzinsAnnual ?? "";
      $("setEffektiv").value = s.effektivzinsAnnual ?? "";
      $("setEffectiveFrom").value = s.effectiveFrom ? String(s.effectiveFrom).slice(0,10) : "";
      $("settingsInfo").textContent = "Settings caricati.";
      toast("Settings caricati.");
    } catch (e) {
      $("settingsInfo").textContent = "Errore: " + (e.message || e);
      toast("Errore load settings: " + (e.message || e));
    }
  }

  async function saveCardSettings() {
    const cid = ($("setCardSelect").value || "").trim();
    if (!cid) return toast("Seleziona una carta.");

    const payload = {
      cycleStartDay: $("setCycleStart").value ? Number($("setCycleStart").value) : null,
      cycleEndDay: $("setCycleEnd").value ? Number($("setCycleEnd").value) : null,
      debitDay: $("setDebitDay").value ? Number($("setDebitDay").value) : null,
      debitMonthOffset: $("setDebitOffset").value ? Number($("setDebitOffset").value) : null,
      teilzahlungAmount: $("setTeilzahlung").value ? Number($("setTeilzahlung").value) : null,
      kreditlimit: $("setLimit").value ? Number($("setLimit").value) : null,
      sollzinsAnnual: $("setSoll").value ? Number($("setSoll").value) : null,
      effektivzinsAnnual: $("setEffektiv").value ? Number($("setEffektiv").value) : null,
      effectiveFrom: $("setEffectiveFrom").value || null
    };
    Object.keys(payload).forEach(k => (payload[k] === null || Number.isNaN(payload[k])) && delete payload[k]);

    try {
      await apiFetch(`/cards/${encodeURIComponent(cid)}/settings`, { method:"PUT", body: JSON.stringify(payload) });
      toast("Settings salvati.");
      $("settingsInfo").textContent = "Settings salvati.";

      // refresh KPI + ensure repayments after settings change (may move repayment date/amount)
      await loadDashboardForCalendar();
      await ensureScheduledRepaymentsForCurrentMonth();
    } catch (e) {
      toast("Errore save settings: " + (e.message || e));
      $("settingsInfo").textContent = "Errore: " + (e.message || e);
    }
  }

  // =========================
  // Cards Tab render (reuse dashboard)
  // =========================
  function renderCardsOverview() {
    const wrap = $("cardsOverview");
    wrap.innerHTML = "";

    const w = state.dashboard?.wallets || [];
    const cards = w.filter(x => x.type === "card");
    const normals = w.filter(x => x.type !== "card");

    const box1 = document.createElement("div");
    box1.className = "card";
    box1.innerHTML = `
      <div style="font-weight:900; margin-bottom:8px;">Sintesi carte</div>
      <div class="muted">Carte: ${cards.length}</div>
      <div class="muted">Dettagli nel pannello sotto.</div>
    `;
    wrap.appendChild(box1);

    const box2 = document.createElement("div");
    box2.className = "card";
    const totalBalance = normals.reduce((s,x)=> s + (Number(x.balance)||0), 0);
    box2.innerHTML = `
      <div style="font-weight:900; margin-bottom:8px;">Sintesi conti (non-carte)</div>
      <div>Saldo totale: <b>${fmtMoney(totalBalance)}</b></div>
      <div class="muted">Somma bilanci wallet non-card.</div>
    `;
    wrap.appendChild(box2);
  }

  function renderWalletTree() {
    const wrap = $("walletTree");
    wrap.innerHTML = "";

    const wallets = Array.isArray(state.dashboard?.wallets) ? state.dashboard.wallets : [];
    wallets.sort((a,b)=>{
      if (a.type === b.type) return (a.name||"").localeCompare(b.name||"");
      if (a.type === "card") return -1;
      if (b.type === "card") return 1;
      return (a.type||"").localeCompare(b.type||"");
    });

    for (const w of wallets) {
      const det = document.createElement("details");
      det.open = false;

      const sum = document.createElement("summary");
      sum.textContent = `${w.name} (${w.type}) — saldo: ${fmtMoney(w.balance)}`;
      det.appendChild(sum);

      const body = document.createElement("div");
      body.className = "grid two";
      body.style.marginTop = "10px";

      const left = document.createElement("div");
      left.className = "card";

      const ce = w.compareLastMonthExpenses || { amount:0, percent:0 };
      const ci = w.compareLastMonthIncome || { amount:0, percent:0 };

      left.innerHTML = `
        <div style="font-weight:900; margin-bottom:8px;">Panoramica</div>
        <div>Saldo: <b>${fmtMoney(w.balance)}</b></div>
        <div>Spese mese: <b>${fmtMoney(w.spentSoFar)}</b> <span class="muted">Diff: ${fmtMoney(ce.amount)} (${Number(ce.percent||0).toFixed(1)}%)</span></div>
        <div>Entrate mese: <b>${fmtMoney(w.incomeSoFar)}</b> <span class="muted">Diff: ${fmtMoney(ci.amount)} (${Number(ci.percent||0).toFixed(1)}%)</span></div>
        <div>Spese rimanenti mese: <b>${fmtMoney(w.spentRemaining)}</b></div>
        ${w.nextEvent ? `<div class="muted">Prossimo: ${w.nextEvent.date} • ${w.nextEvent.title} • ${fmtMoney(w.nextEvent.amount)}</div>` : `<div class="muted">Prossimo: —</div>`}
      `;
      body.appendChild(left);

      const right = document.createElement("div");
      right.className = "card";
      right.innerHTML = `<div style="font-weight:900; margin-bottom:8px;">Categorie (top 10)</div>`;
      const cats = Array.isArray(w.categories) ? w.categories : [];
      if (!cats.length) {
        right.innerHTML += `<div class="muted">Nessuna spesa nel periodo.</div>`;
      } else {
        const t = document.createElement("table");
        t.innerHTML = `<thead><tr><th>Categoria</th><th>Importo</th></tr></thead>`;
        const tb = document.createElement("tbody");
        for (const c of cats) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${(c.name||"").replace(/</g,"&lt;")}</td><td>${fmtMoney(c.amount)}</td>`;
          tb.appendChild(tr);
        }
        t.appendChild(tb);
        right.appendChild(t);
      }
      body.appendChild(right);

      det.appendChild(body);

      if (w.type === "card" && w.card) {
        const d2 = document.createElement("details");
        d2.open = false;
        const s2 = document.createElement("summary");
        s2.textContent = `Dettagli carta — limite ${fmtMoney(w.card.limit)} • disponibile ${fmtMoney(w.card.availableCredit)} • outstanding ${fmtMoney(w.card.outstanding)}`;
        d2.appendChild(s2);

        const inner = document.createElement("div");
        inner.className = "card";
        inner.style.marginTop = "10px";

        const stmt = w.card.statement || {};
        const sched = w.card.scheduledRepayment || {};

        inner.innerHTML = `
          <div style="font-weight:900; margin-bottom:8px;">Statement & repayment</div>
          <div>Window: <span class="kbd">${stmt.window?.start || "?"}</span> → <span class="kbd">${stmt.window?.end || "?"}</span></div>
          <div>Baseline: <b>${fmtMoney(stmt.baselineAmount)}</b></div>
          <div class="muted">Instant count: ${stmt.instantPurchasesCount ?? 0} • Charges ${fmtMoney(stmt.charges)} • Credits ${fmtMoney(stmt.credits)}</div>
          <div class="hr"></div>
          <div style="font-weight:900; margin-bottom:6px;">Addebito previsto</div>
          <div>Data: <span class="kbd">${sched.paymentDate || "?"}</span></div>
          <div>Importo suggerito: <b>${fmtMoney(sched.suggestedAmount)}</b> (mode: ${sched.mode || "?"})</div>
          <div class="muted">Evento presente su data: ${sched.exists ? "Sì" : "No"}</div>
        `;

        d2.appendChild(inner);
        det.appendChild(document.createElement("div")).className="hr";
        det.appendChild(d2);
      }

      wrap.appendChild(det);
    }
  }

  // =========================
  // Wires / Boot
  // =========================
  function initDefaults() {
    const now = new Date();
    const ym = isoYM(now);
    $("calMonth").value = ym;
    state.month = parseYM(ym);

    $("calAsOf").value = isoDate(now);
    state.calAsOf = new Date(now.getFullYear(), now.getMonth(), now.getDate());

    $("cardsAsOf").value = isoDate(now);
    $("cardsMonth").value = ym;
  }

  function wireCalendarControls() {
    $("btnCalRefresh").addEventListener("click", async ()=>{
      try {
        await loadEventsForMonth();
        await loadDashboardForCalendar();
      } catch (e) {
        toast("Errore refresh: " + (e.message || e));
      }
    });

    $("btnNewEvent").addEventListener("click", ()=> openEventDialogForNew($("calAsOf").value || isoDate(new Date())));

    $("calMonth").addEventListener("change", async ()=>{
      state.month = parseYM($("calMonth").value);
      try {
        await loadEventsForMonth();
        await loadDashboardForCalendar();
        await ensureScheduledRepaymentsForCurrentMonth();
      } catch (e) {
        toast("Errore cambio mese: " + (e.message || e));
      }
    });

    $("calAsOf").addEventListener("change", async ()=>{
      try { await loadDashboardForCalendar(); } catch (e) { toast("Errore asOf: " + (e.message || e)); }
    });

    $("calWalletFilter").addEventListener("change", loadEventsForMonth);

    $("calSearch").addEventListener("input", ()=>{
      clearTimeout(state._qTimer);
      state._qTimer = setTimeout(loadEventsForMonth, 250);
    });

    $("btnPrevMonth").addEventListener("click", async ()=>{
      const m = state.month || new Date();
      const d = new Date(m.getFullYear(), m.getMonth()-1, 1);
      state.month = d;
      $("calMonth").value = isoYM(d);
      await loadEventsForMonth();
      await loadDashboardForCalendar();
      await ensureScheduledRepaymentsForCurrentMonth();
    });

    $("btnNextMonth").addEventListener("click", async ()=>{
      const m = state.month || new Date();
      const d = new Date(m.getFullYear(), m.getMonth()+1, 1);
      state.month = d;
      $("calMonth").value = isoYM(d);
      await loadEventsForMonth();
      await loadDashboardForCalendar();
      await ensureScheduledRepaymentsForCurrentMonth();
    });

    $("btnSave").addEventListener("click", saveEvent);
    $("btnDelete").addEventListener("click", async ()=>{
      const id = ($("evId").value || "").trim();
      if (!id) return;
      await deleteEventById(id);
      $("dlgEvent").close();
    });
    $("btnDuplicate").addEventListener("click", duplicateEventAcrossMonths);
    $("btnDlgClose").addEventListener("click", ()=> $("dlgEvent").close());
  }

  function wireSettingsControls() {
    $("btnHealth").addEventListener("click", healthCheck);
    $("btnLoadCardSettings").addEventListener("click", loadCardSettings);
    $("btnSaveCardSettings").addEventListener("click", saveCardSettings);
  }

  function wireCardsControls() {
    $("btnCardsRefresh").addEventListener("click", async ()=>{
      try { await loadDashboardForCardsTab(); toast("Dashboard aggiornato."); }
      catch (e) { toast("Errore dashboard: " + (e.message || e)); }
    });
  }

  $("btnReloadAll").addEventListener("click", async ()=>{
    try {
      await loadWallets();
      await loadEventsForMonth();
      await loadDashboardForCalendar();
      await ensureScheduledRepaymentsForCurrentMonth();
      await loadDashboardForCardsTab();
      toast("Dati ricaricati.");
    } catch (e) {
      toast("Errore ricarica: " + (e.message || e));
    }
  });

  async function boot() {
    initDefaults();
    wireCalendarControls();
    wireSettingsControls();
    wireCardsControls();

    try {
      await loadWallets();
      await loadEventsForMonth();
      await loadDashboardForCalendar();
      await ensureScheduledRepaymentsForCurrentMonth();
      await loadDashboardForCardsTab();
      toast("Pronto.");
    } catch (e) {
      toast("Errore avvio: " + (e.message || e));
    }
  }

  boot();
</script>
</body>
</html>
