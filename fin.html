<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <meta name="fin-api-base" content="https://iamemanuele.pythonanywhere.com/api" />

  <title>Finance Calendar v3</title>
  <link rel="stylesheet" href="./fin-theme.css" />

  <style>
    :root{
      --rail-w: 86px;
      --explorer-w: 330px;
      --insights-w: 380px;
      --cmd-h: 66px;
      --soft: rgba(128,128,128,0.08);
      --soft2: rgba(128,128,128,0.06);
      --soft3: rgba(128,128,128,0.04);
      --glow: rgba(80,160,255,0.35);
    }
    body{ margin:0; }
    .workspace{
      min-height:100vh;
      display:grid;
      grid-template-columns: var(--rail-w) var(--explorer-w) 1fr var(--insights-w);
      grid-template-rows: var(--cmd-h) 1fr;
      grid-template-areas:
        "rail cmd cmd cmd"
        "rail explorer main insights";
      gap:10px;
      padding:10px;
      box-sizing:border-box;
    }
    .rail{
      grid-area: rail;
      border:1px solid var(--border);
      border-radius:18px;
      background: var(--soft3);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .rail__brand{
      padding:14px 12px;
      font-weight:1000;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
      border-bottom:1px solid rgba(128,128,128,0.18);
    }
    .rail__brand span{
      font-size:12px;
      opacity:.9;
      display:block;
      line-height:1.05;
    }
    .rail__nav{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:10px;
      flex:1;
    }
    .rail-btn{
      border:1px solid rgba(128,128,128,0.20);
      background: rgba(128,128,128,0.06);
      border-radius:16px;
      padding:10px 8px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      font-weight:900;
      color:var(--text);
    }
    .rail-btn[aria-pressed="true"]{
      border-color: rgba(80,160,255,0.55);
      background: rgba(80,160,255,0.12);
      box-shadow: 0 0 0 1px rgba(80,160,255,0.18) inset;
    }
    .rail-btn__icon{
      font-size:18px;
      line-height:1;
    }
    .rail-btn__label{
      font-size:11px;
      line-height:1.1;
      text-align:center;
      opacity:.95;
    }
    .rail__footer{
      padding:10px;
      border-top:1px solid rgba(128,128,128,0.18);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .rail-mini{
      display:flex;
      gap:8px;
      justify-content:space-between;
      align-items:center;
    }
    .rail-mini .btn{
      width:100%;
      border-radius:14px;
    }

    .commandbar{
      grid-area: cmd;
      border:1px solid var(--border);
      border-radius:18px;
      background: rgba(128,128,128,0.05);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      overflow:hidden;
    }
    .cmd-left, .cmd-right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .cmd-block{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid rgba(128,128,128,0.18);
      background: rgba(128,128,128,0.06);
      border-radius:16px;
    }
    .cmd-title{
      font-weight:1000;
      letter-spacing:.2px;
      margin-right:6px;
      white-space:nowrap;
    }
    .cmd-sub{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .cmd-range{
      font-weight:1000;
      white-space:nowrap;
    }
    .cmd-search{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid rgba(128,128,128,0.18);
      background: rgba(128,128,128,0.06);
      border-radius:16px;
      min-width: 260px;
      flex: 1;
    }
    .cmd-search input{
      width:100%;
      background: transparent;
      border:0;
      outline:0;
      color:var(--text);
      font-weight:800;
    }
    .cmd-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(128,128,128,0.24);
      background: rgba(128,128,128,0.06);
      font-weight:900;
      white-space:nowrap;
      font-size:12px;
    }
    .cmd-pill strong{ font-weight:1000; }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(128,128,128,0.12);
      color: var(--text);
      font-size: 12px;
      font-weight: 800;
      white-space: nowrap;
    }
    .badge--muted{ color: var(--muted); border-color: rgba(128,128,128,0.25); }
    .badge--ok{ border-color: rgba(120, 255, 160, 0.45); background: rgba(120, 255, 160, 0.10); }
    .badge--warn{ border-color: rgba(255, 190, 100, 0.55); background: rgba(255, 190, 100, 0.12); }
    .badge--bad{ border-color: rgba(255, 90, 90, 0.55); background: rgba(255, 90, 90, 0.12); }

    .explorer{
      grid-area: explorer;
      border:1px solid var(--border);
      border-radius:18px;
      background: rgba(128,128,128,0.04);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .explorer[data-open="false"]{ display:none; }

    .explorer__head{
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(128,128,128,0.18);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .explorer__head-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .explorer__title{
      font-weight:1000;
      letter-spacing:.2px;
      display:flex;
      flex-direction:column;
      line-height:1.05;
    }
    .explorer__title small{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      margin-top:4px;
    }
    .explorer__tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .chip{
      border:1px solid rgba(128,128,128,0.18);
      background: rgba(128,128,128,0.06);
      border-radius:999px;
      padding:6px 10px;
      font-weight:900;
      cursor:pointer;
      color:var(--text);
      font-size:12px;
    }
    .chip[aria-pressed="true"]{
      border-color: rgba(80,160,255,0.55);
      background: rgba(80,160,255,0.12);
    }

    .explorer__body{
      padding:12px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .panel{
      border:1px solid rgba(128,128,128,0.18);
      background: rgba(128,128,128,0.06);
      border-radius:16px;
      padding:12px;
    }
    .panel-title{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .panel-title b{
      font-weight:1000;
      letter-spacing:.2px;
    }
    .panel-title small{
      color:var(--muted);
      font-size:12px;
      font-weight:900;
    }

    .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .grid-3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field label{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .field input, .field select, .field textarea{
      width:100%;
      box-sizing:border-box;
      border:1px solid rgba(128,128,128,0.20);
      background: rgba(128,128,128,0.06);
      color:var(--text);
      border-radius:14px;
      padding:10px 10px;
      font-weight:800;
      outline:0;
    }
    .field textarea{ min-height:90px; resize:vertical; }
    .toggle-row{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:6px;
    }
    .tog{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border:1px solid rgba(128,128,128,0.18);
      border-radius:14px;
      background: rgba(128,128,128,0.05);
      font-weight:900;
    }
    .tog small{ color:var(--muted); font-weight:900; font-size:12px; }
    .tog input{ transform: scale(1.1); }

    .help{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      line-height:1.25;
      margin-top:6px;
    }

    .main{
      grid-area: main;
      border:1px solid var(--border);
      border-radius:18px;
      background: rgba(128,128,128,0.03);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .main__head{
      padding:12px 14px 10px;
      border-bottom:1px solid rgba(128,128,128,0.18);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .main__head-left{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 280px;
    }
    .main__title{
      font-weight:1000;
      letter-spacing:.2px;
      font-size:18px;
    }
    .main__subtitle{
      color:var(--muted);
      font-size:12px;
      font-weight:900;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .main__actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .segmented{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px;
      border-radius:14px;
      border:1px solid rgba(128,128,128,0.18);
      background: rgba(128,128,128,0.06);
    }
    .segmented .btn--seg{
      border-radius:12px;
      padding:8px 10px;
      font-weight:1000;
    }

    .view-host{
      padding:12px;
      overflow:auto;
      flex:1;
      min-height: 380px;
    }

    .insights{
      grid-area: insights;
      border:1px solid var(--border);
      border-radius:18px;
      background: rgba(128,128,128,0.04);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .insights[data-open="false"]{ display:none; }

    .insights__head{
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(128,128,128,0.18);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .insights__title{
      font-weight:1000;
      letter-spacing:.2px;
      display:flex;
      flex-direction:column;
      line-height:1.05;
    }
    .insights__title small{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      margin-top:4px;
    }
    .insights__tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .insights__body{
      padding:12px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .kpi{
      border:1px solid rgba(128,128,128,0.18);
      border-radius:16px;
      padding:10px;
      background: rgba(128,128,128,0.07);
    }
    .kpi__label{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.2px;
    }
    .kpi__value{
      font-size:18px;
      font-weight:1000;
      margin-top:6px;
    }
    .kpi__sub{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
      font-weight:800;
      line-height:1.2;
    }

    .mini-cal{
      border:1px solid rgba(128,128,128,0.18);
      background: rgba(128,128,128,0.05);
      border-radius:16px;
      overflow:hidden;
    }
    .mini-cal__head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:10px;
      border-bottom:1px solid rgba(128,128,128,0.16);
    }
    .mini-cal__head b{
      font-weight:1000;
      letter-spacing:.2px;
      font-size:12px;
      text-transform:capitalize;
    }
    .mini-cal__grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:4px;
      padding:10px;
    }
    .mini-cal__dow{
      font-size:11px;
      color:var(--muted);
      font-weight:900;
      text-align:center;
      padding:4px 0;
    }
    .mini-cal__day{
      border:1px solid rgba(128,128,128,0.14);
      background: rgba(128,128,128,0.04);
      border-radius:12px;
      padding:7px 0;
      font-weight:1000;
      font-size:12px;
      text-align:center;
      cursor:pointer;
      color:var(--text);
      position:relative;
      user-select:none;
    }
    .mini-cal__day.is-out{ opacity:.45; }
    .mini-cal__day.is-today{
      border-color: rgba(80,160,255,0.55);
      box-shadow: 0 0 0 1px rgba(80,160,255,0.18) inset;
      background: rgba(80,160,255,0.10);
    }
    .mini-cal__day.is-anchor{
      outline:2px solid rgba(255,255,255,0.12);
      outline-offset:1px;
    }
    .mini-cal__dot{
      position:absolute;
      bottom:4px;
      left:50%;
      transform: translateX(-50%);
      width:6px;
      height:6px;
      border-radius:999px;
      background: rgba(80,160,255,0.85);
      box-shadow: 0 0 0 2px rgba(0,0,0,0.25);
      opacity:.9;
    }

    .movements{
      overflow:auto;
      border:1px solid rgba(128,128,128,0.18);
      border-radius: 16px;
      background: rgba(128,128,128,0.05);
    }
    .movements table{
      width:100%;
      border-collapse: collapse;
      min-width: 980px;
    }
    .movements th, .movements td{
      padding:10px;
      border-bottom:1px solid rgba(128,128,128,0.15);
      text-align:left;
      vertical-align: top;
      font-weight:800;
    }
    .movements th{
      position: sticky;
      top: 0;
      background: rgba(30,30,30,0.85);
      backdrop-filter: blur(8px);
      z-index: 2;
      font-weight:1000;
    }
    .row-sub{
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
      font-weight:800;
      line-height:1.2;
    }
    .amt-pos{ font-weight:1000; }
    .amt-neg{ font-weight:1000; }

    .empty-state{
      border:1px dashed rgba(128,128,128,0.28);
      background: rgba(128,128,128,0.04);
      border-radius:16px;
      padding:14px;
      color:var(--muted);
      font-weight:900;
    }

    .drawer{ z-index:50; }
    .drawer-scrim{ z-index:49; }

    @media (max-width: 1220px){
      .workspace{
        grid-template-columns: var(--rail-w) var(--explorer-w) 1fr;
        grid-template-areas:
          "rail cmd cmd"
          "rail explorer main";
      }
      .insights{ display:none; }
    }
    @media (max-width: 980px){
      .workspace{
        grid-template-columns: 1fr;
        grid-template-rows: auto;
        grid-template-areas:
          "cmd"
          "main";
        padding: 8px;
      }
      .rail, .explorer, .insights{ display:none; }
      .commandbar{ position:sticky; top:8px; z-index:20; }
    }
  </style>
</head>

<body>
  <div id="app" class="workspace">
    <aside class="rail">
      <div class="rail__brand">
        <div style="font-size:18px">üíº</div>
        <div>
          <div style="font-weight:1000">Finance</div>
          <span>Calendar v3</span>
        </div>
      </div>

      <nav id="modeSwitch" class="rail__nav" aria-label="Sezioni">
        <button class="rail-btn" type="button" data-mode="calendar" aria-pressed="true">
          <div class="rail-btn__icon">üìÖ</div>
          <div class="rail-btn__label">Calendario</div>
        </button>
        <button class="rail-btn" type="button" data-mode="movements" aria-pressed="false">
          <div class="rail-btn__icon">üìÑ</div>
          <div class="rail-btn__label">Movimenti</div>
        </button>
        <button class="rail-btn" type="button" data-mode="reports" aria-pressed="false">
          <div class="rail-btn__icon">üìä</div>
          <div class="rail-btn__label">Report</div>
        </button>
        <button class="rail-btn" type="button" data-mode="setup" aria-pressed="false">
          <div class="rail-btn__icon">‚öôÔ∏è</div>
          <div class="rail-btn__label">Setup</div>
        </button>
      </nav>

      <div class="rail__footer">
        <div class="rail-mini">
          <button id="btnSidebarToggle" class="btn btn--ghost" type="button">Explorer</button>
        </div>
        <div class="rail-mini">
          <button id="btnInsightsToggle" class="btn btn--ghost" type="button">Insights</button>
        </div>
      </div>
    </aside>

    <header id="topbar" class="commandbar">
      <div class="cmd-left">
        <div class="cmd-block" style="gap:10px">
          <div class="cmd-title">Data</div>
          <button id="btnPrev" class="btn btn--icon btn--ghost" type="button" aria-label="Precedente">‚Äπ</button>
          <button id="btnToday" class="btn btn--ghost" type="button">Oggi</button>
          <button id="btnNext" class="btn btn--icon btn--ghost" type="button" aria-label="Successivo">‚Ä∫</button>
          <span id="rangeLabel" class="cmd-range">‚Äî</span>
        </div>

        <div class="cmd-block">
          <span class="cmd-pill"><strong>Basis</strong> <span id="basisBadge">Cash</span></span>
          <span id="basisSwitch" class="segmented" aria-label="Basis">
            <button class="btn btn--seg" type="button" data-basis="cash" aria-pressed="true">Cash</button>
            <button class="btn btn--seg" type="button" data-basis="accrual" aria-pressed="false">Accrual</button>
          </span>
        </div>

        <div class="cmd-search" aria-label="Ricerca rapida">
          <span style="font-weight:1000">üîé</span>
          <input id="searchInput" type="search" autocomplete="off" placeholder="Cerca titolo, categoria, note‚Ä¶ (filtra tutto)" />
        </div>
      </div>

      <div class="cmd-right">
        <div id="calendarViewSwitch" class="cmd-block segmented" aria-label="Vista calendario">
          <button class="btn btn--seg" type="button" data-view="day" aria-pressed="false">Giorno</button>
          <button class="btn btn--seg" type="button" data-view="workweek" aria-pressed="false">Work Week</button>
          <button class="btn btn--seg" type="button" data-view="week" aria-pressed="false">Settimana</button>
          <button class="btn btn--seg" type="button" data-view="month" aria-pressed="true">Mese</button>
          <button class="btn btn--seg" type="button" data-view="agenda" aria-pressed="false">Agenda</button>
          <button class="btn btn--seg" type="button" data-view="year" aria-pressed="false">Anno</button>
        </div>

        <div class="cmd-block">
          <span class="cmd-pill"><strong>Densit√†</strong></span>
          <span id="densitySwitch" class="segmented" aria-label="Densit√†">
            <button class="btn btn--seg" type="button" data-density="comfort" aria-pressed="true">Comfort</button>
            <button class="btn btn--seg" type="button" data-density="compact" aria-pressed="false">Compatta</button>
          </span>
        </div>

        <button id="btnNewEvent" class="btn btn--primary" type="button">Ôºã Nuovo evento</button>
      </div>
    </header>

    <aside id="sidebar" class="explorer" data-open="true">
      <div class="explorer__head">
        <div class="explorer__head-top">
          <div class="explorer__title">
            Explorer
            <small>Filtri, Range, Connessione, Backup</small>
          </div>
          <span id="apiStatus" class="badge badge--muted">offline</span>
        </div>

        <div class="explorer__tabs" role="tablist" aria-label="Explorer tabs">
          <button id="tabExplorerCalendar" class="chip" type="button" data-tab="calendar" aria-pressed="true">Calendario</button>
          <button id="tabExplorerFilters" class="chip" type="button" data-tab="filters" aria-pressed="false">Filtri</button>
          <button id="tabExplorerRange" class="chip" type="button" data-tab="range" aria-pressed="false">Range</button>
          <button id="tabExplorerData" class="chip" type="button" data-tab="data" aria-pressed="false">Dati</button>
        </div>
      </div>

      <div class="explorer__body">
        <section id="explorerCalendarTab" class="panel">
          <div class="panel-title">
            <b>Navigazione rapida</b>
            <small>Clicca un giorno per andare l√¨</small>
          </div>
          <div id="miniCal" class="mini-cal"></div>
          <div class="help">
            Tip: clic su una data ‚Üí porta l‚Äôanchor su quel giorno. Se sei in <b>Mese</b>, rimani nel mese; se sei in <b>Giorno</b>, apri la giornata.
          </div>
        </section>

        <section id="explorerFiltersTab" class="panel" style="display:none;">
          <div class="panel-title">
            <b>Filtri</b>
            <small id="activeFiltersMeta">‚Äî</small>
          </div>

          <div class="field">
            <label for="categorySelect">Categoria</label>
            <select id="categorySelect">
              <option value="all">Tutte</option>
            </select>
          </div>

          <div class="grid-2">
            <div class="field">
              <label for="accountSelect">Account</label>
              <select id="accountSelect">
                <option value="all">Tutti</option>
              </select>
            </div>
            <div class="field">
              <label for="paymentMethodSelect">Metodo</label>
              <select id="paymentMethodSelect">
                <option value="all">Tutti</option>
              </select>
            </div>
          </div>

          <div class="toggle-row">
            <div class="tog">
              <div>
                Entrate
                <small>Include income</small>
              </div>
              <input id="toggleIncome" type="checkbox" checked />
            </div>
            <div class="tog">
              <div>
                Uscite
                <small>Include expense</small>
              </div>
              <input id="toggleExpense" type="checkbox" checked />
            </div>
            <div class="tog">
              <div>
                Trasferimenti
                <small>Include transfer</small>
              </div>
              <input id="toggleTransfers" type="checkbox" checked />
            </div>
            <div class="tog">
              <div>
                Altro
                <small>Include other</small>
              </div>
              <input id="toggleOther" type="checkbox" checked />
            </div>
          </div>

          <div class="grid-2" style="margin-top:10px;">
            <button id="btnApplyFilters" class="btn btn--ghost" type="button">Applica</button>
            <button id="btnClearFilters" class="btn btn--ghost" type="button">Reset</button>
          </div>

          <div class="help">
            In <b>Cash</b> filtri e statistiche usano <b>Cash Date</b>. In <b>Accrual</b> usano la <b>Data evento</b>.
          </div>
        </section>

        <section id="explorerRangeTab" class="panel" style="display:none;">
          <div class="panel-title">
            <b>Range date</b>
            <small>Controllo globale</small>
          </div>

          <div id="rangePresets" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
            <button class="chip" type="button" data-preset="all" aria-pressed="true">Da inizio</button>
            <button class="chip" type="button" data-preset="from" aria-pressed="false">Da data</button>
            <button class="chip" type="button" data-preset="between" aria-pressed="false">Tra date</button>
          </div>

          <div class="grid-2">
            <div class="field">
              <label for="fromDate">Da</label>
              <input id="fromDate" type="date" />
            </div>
            <div class="field">
              <label for="toDate">A</label>
              <input id="toDate" type="date" />
            </div>
          </div>

          <div class="help">
            Questo range limita ci√≤ che vedi ovunque: calendario, movimenti, report e insights.
          </div>
        </section>

        <section id="explorerDataTab" class="panel" style="display:none;">
          <div class="panel-title">
            <b>Connessione & Backup</b>
            <small>API, Import/Export</small>
          </div>

          <div class="field">
            <label for="apiBaseInput">API Base <span class="badge badge--muted">/api</span></label>
            <input id="apiBaseInput" type="text" placeholder="Es: /api oppure https://example.com/api" />
          </div>

          <div class="grid-2">
            <button id="btnPing" class="btn btn--ghost" type="button">Ping API</button>
            <button id="btnExport" class="btn btn--ghost" type="button">Esporta JSON</button>
          </div>

          <div class="field" style="margin-top:10px;">
            <label for="importFile">Importa JSON</label>
            <input id="importFile" type="file" accept="application/json" />
            <div class="help">
              Import crea eventi e, se presenti, anche meta/settings.
            </div>
          </div>
        </section>
      </div>
    </aside>

    <main id="main" class="main">
      <header class="main__head">
        <div class="main__head-left">
          <div id="mainTitle" class="main__title">‚Äî</div>
          <div id="mainSubtitle" class="main__subtitle">‚Äî</div>
        </div>

        <div class="main__actions">
          <span class="badge badge--muted" id="viewMetaBadge">‚Äî</span>
          <span class="badge badge--muted" id="filtersMetaBadge">‚Äî</span>
        </div>
      </header>

      <section id="mainHost" class="view-host">
        <section id="calendarView" class="calendar" data-view="month" data-density="comfort"></section>

        <section id="movementsView" style="display:none;">
          <div class="panel">
            <div class="panel-title">
              <b>Movimenti</b>
              <small>Vista tipo banca ¬∑ basis <span id="movBasisLabel" class="badge badge--muted">‚Äî</span></small>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-bottom:10px;">
              <button id="btnMovRefresh" class="btn btn--ghost" type="button">Ricarica</button>
            </div>
            <div id="movementsTable" class="movements"></div>
          </div>
        </section>

        <section id="reportsView" style="display:none;">
          <div class="panel">
            <div class="panel-title">
              <b>Report</b>
              <small>Mensile ¬∑ categorie ¬∑ carta</small>
            </div>

            <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;">
              <div class="field" style="max-width:220px;">
                <label for="repMonth">Mese</label>
                <input id="repMonth" type="month" />
              </div>
              <button id="btnRepRun" class="btn btn--ghost" type="button">Aggiorna report</button>
            </div>

            <div style="height:12px"></div>

            <div class="grid-3">
              <div class="kpi">
                <div class="kpi__label">Entrate mese</div>
                <div id="repIncome" class="kpi__value">‚Äî</div>
                <div id="repIncomeSub" class="kpi__sub">‚Äî</div>
              </div>
              <div class="kpi">
                <div class="kpi__label">Uscite mese</div>
                <div id="repExpense" class="kpi__value">‚Äî</div>
                <div id="repExpenseSub" class="kpi__sub">‚Äî</div>
              </div>
              <div class="kpi">
                <div class="kpi__label">Netto mese</div>
                <div id="repNet" class="kpi__value">‚Äî</div>
                <div id="repNetSub" class="kpi__sub">‚Äî</div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="grid-2">
              <div class="panel">
                <div class="panel-title">
                  <b>Top Categorie</b>
                  <small id="repCatMeta">‚Äî</small>
                </div>
                <div id="repCats"></div>
                <div class="help">Clic su una categoria ‚Üí apre Movimenti filtrati</div>
              </div>

              <div class="panel">
                <div class="panel-title">
                  <b>Carta di credito</b>
                  <small id="repCCMeta">‚Äî</small>
                </div>

                <div class="kpi" style="margin-bottom:10px;">
                  <div class="kpi__label">Outstanding stimato</div>
                  <div id="repCCOutstanding" class="kpi__value">‚Äî</div>
                  <div id="repCCOutstandingSub" class="kpi__sub">‚Äî</div>
                </div>

                <div class="grid-2">
                  <div class="kpi">
                    <div class="kpi__label">Speso mese</div>
                    <div id="repCCSpent" class="kpi__value">‚Äî</div>
                    <div class="kpi__sub">acquisti su carta</div>
                  </div>
                  <div class="kpi">
                    <div class="kpi__label">Pagato mese</div>
                    <div id="repCCPaid" class="kpi__value">‚Äî</div>
                    <div class="kpi__sub">settlement</div>
                  </div>
                </div>

                <div class="help">Tip: fattura carta = <b>transfer</b> Bank ‚Üí Credit Card</div>
              </div>
            </div>

            <div id="repError" class="help" style="color:crimson; margin-top:10px; display:none;"></div>
          </div>
        </section>

        <section id="setupView" style="display:none;">
          <div class="panel">
            <div class="panel-title">
              <b>Setup</b>
              <small>Accounts ¬∑ Payment Methods ¬∑ Wizard</small>
            </div>

            <div class="help">
              Qui controlli la configurazione. Se l‚ÄôAPI espone /meta li vedrai subito.  
              Se non c‚Äô√® scrittura meta, useremo <b>metaOverride</b> in settings (wizard incluso).
            </div>

            <div style="height:12px"></div>

            <div class="grid-2">
              <div class="panel">
                <div class="panel-title">
                  <b>Accounts</b>
                  <small id="setupAccMeta">‚Äî</small>
                </div>
                <div id="setupAccounts"></div>
              </div>

              <div class="panel">
                <div class="panel-title">
                  <b>Payment Methods</b>
                  <small id="setupPMMeta">‚Äî</small>
                </div>
                <div id="setupPMs"></div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="panel">
              <div class="panel-title">
                <b>Categorie</b>
                <small id="setupCatMeta">‚Äî</small>
              </div>
              <div id="setupCats"></div>
              <div class="help">Deduciamo categorie da eventi + /meta</div>
            </div>

            <div style="height:12px"></div>

            <div class="panel">
              <div class="panel-title">
                <b>Wizard Sparkasse</b>
                <small>Configura Bank + Sparkasse Kreditkarte</small>
              </div>

              <div class="grid-2">
                <button id="btnWizardSparkasse" class="btn btn--ghost" type="button">Esegui Wizard</button>
                <button id="btnMetaReload" class="btn btn--ghost" type="button">Ricarica Meta</button>
              </div>

              <div class="help">
                Crea account <b>Bank</b> + <b>Sparkasse Kreditkarte</b>, metodo <b>Credit Card</b> con cashDate ‚Äúnext month day‚Äù.
              </div>
            </div>

            <div id="setupError" class="help" style="color:crimson; margin-top:10px; display:none;"></div>
          </div>
        </section>
      </section>
    </main>

    <aside id="insights" class="insights" data-open="true">
      <div class="insights__head">
        <div class="insights__title">
          Insights
          <small>Saldo ¬∑ Snapshot ¬∑ Carta ¬∑ Forecast</small>
        </div>

        <div class="insights__tabs" role="tablist" aria-label="Insights tabs">
          <button id="tabInsightsStats" class="chip" type="button" data-tab="stats" aria-pressed="true">Stats</button>
          <button id="tabInsightsCard" class="chip" type="button" data-tab="card" aria-pressed="false">Carta</button>
          <button id="tabInsightsForecast" class="chip" type="button" data-tab="forecast" aria-pressed="false">Forecast</button>
        </div>
      </div>

      <div class="insights__body">
        <section id="insightsStatsTab">
          <div class="panel">
            <div class="panel-title">
              <b>Saldo & Range</b>
              <small id="statsMeta">‚Äî</small>
            </div>

            <div class="grid-2">
              <div class="kpi">
                <div class="kpi__label">Saldo attuale (basis)</div>
                <div id="statCurrentBalance" class="kpi__value">‚Äî</div>
                <div id="statCurrentBalanceMeta" class="kpi__sub">‚Äî</div>
              </div>

              <div class="kpi">
                <div class="kpi__label">Saldo alla data</div>
                <div id="statBalanceAtDate" class="kpi__value">‚Äî</div>
                <div class="kpi__sub">
                  <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px">
                    <span style="color:var(--muted);font-weight:900">Data</span>
                    <input id="balanceAtDate" type="date" style="max-width:170px;" />
                  </div>
                </div>
              </div>

              <div class="kpi">
                <div class="kpi__label">Netto (visibile)</div>
                <div id="statNet" class="kpi__value">‚Äî</div>
                <div class="kpi__sub">
                  <span id="statIncomeCount">‚Äî</span> ¬∑ <span id="statExpenseCount">‚Äî</span> ¬∑ <span id="statTransferCount">‚Äî</span>
                </div>
              </div>

              <div class="kpi">
                <div class="kpi__label">Œî Cash vs Accrual</div>
                <div id="statDelta" class="kpi__value">‚Äî</div>
                <div class="kpi__sub">Differenza saldo alla data</div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="grid-2">
              <div class="kpi">
                <div class="kpi__label">Entrate (range)</div>
                <div id="statIncome" class="kpi__value">‚Äî</div>
                <div class="kpi__sub">Somma entrate in vista</div>
              </div>

              <div class="kpi">
                <div class="kpi__label">Uscite (range)</div>
                <div id="statExpense" class="kpi__value">‚Äî</div>
                <div class="kpi__sub">Somma uscite in vista</div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="panel" style="padding:10px;">
              <div class="panel-title" style="margin-bottom:8px;">
                <b>Snapshot</b>
                <small>ultimi 14 giorni (range)</small>
              </div>
              <div id="snapshotList" role="list" style="display:flex;flex-direction:column;gap:8px;"></div>
            </div>
          </div>
        </section>

        <section id="insightsCardTab" style="display:none;">
          <div class="panel">
            <div class="panel-title">
              <b>Carta di credito</b>
              <small>Sparkasse / Outstanding</small>
            </div>

            <div class="grid-2">
              <div class="kpi">
                <div class="kpi__label">Outstanding stimato</div>
                <div id="ccOutstanding" class="kpi__value">‚Äî</div>
                <div id="ccOutstandingMeta" class="kpi__sub">‚Äî</div>
              </div>

              <div class="kpi">
                <div class="kpi__label">Speso mese (Accrual)</div>
                <div id="ccSpentMonth" class="kpi__value">‚Äî</div>
                <div class="kpi__sub">Solo acquisti su carta</div>
              </div>

              <div class="kpi">
                <div class="kpi__label">Pagato mese (Cash)</div>
                <div id="ccPaidMonth" class="kpi__value">‚Äî</div>
                <div class="kpi__sub">Settlement / Transfer</div>
              </div>

              <div class="kpi">
                <div class="kpi__label">Suggerimento</div>
                <div class="kpi__value">Transfer</div>
                <div class="kpi__sub">Bank ‚Üí Credit Card</div>
              </div>           
            </div>
<div class="panel" style="padding:10px; margin-top:10px;">
  <div class="panel-title">
    <b>Amazon Kreditkarte ¬∑ Rimborso</b>
    <small>FULL / CUSTOM</small>
  </div>

  <div class="grid-2">
    <div class="field">
      <label for="amzLimit">Plafond (EUR)</label>
      <input id="amzLimit" type="number" step="1" />
    </div>

    <div class="field">
      <label for="amzCustomPay">Custom mensile (EUR)</label>
      <input id="amzCustomPay" type="number" step="1" />
    </div>
  </div>

  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
    <button id="btnAmzModeFull" class="btn btn--ghost" type="button">FULL</button>
    <button id="btnAmzModeCustom" class="btn btn--ghost" type="button">CUSTOM</button>
    <button id="btnAmzPayNext" class="btn btn--primary" type="button">Registra pagamento prossimo</button>
  </div>

  <div id="amzPayHint" class="help" style="margin-top:8px;">‚Äî</div>
</div>

            <div id="ccHelp" class="help" style="margin-top:10px;">‚Äî</div>
          </div>
        </section>

        <section id="insightsForecastTab" style="display:none;">
          <div class="panel">
            <div class="panel-title">
              <b>Forecast</b>
              <small id="forecastMeta">‚Äî</small>
            </div>

            <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-bottom:10px;">
              <div class="field" style="max-width:180px;">
                <label for="forecastTo">Target</label>
                <input id="forecastTo" type="date" />
              </div>

              <div class="field" style="max-width:160px;">
                <label for="forecastMode">Mode</label>
                <select id="forecastMode">
                  <option value="daily">Giornaliero</option>
                  <option value="monthly">Mensile</option>
                </select>
              </div>

              <button id="btnForecast" class="btn btn--ghost" type="button">Calcola</button>
            </div>

            <div class="grid-2" style="margin-bottom:12px;">
              <div class="kpi">
                <div class="kpi__label">Saldo previsto</div>
                <div id="forecastBalanceAtTo" class="kpi__value">‚Äî</div>
                <div id="forecastBalanceMeta" class="kpi__sub">‚Äî</div>
              </div>

              <div class="kpi">
                <div class="kpi__label">Netto totale</div>
                <div id="forecastTotalNet" class="kpi__value">‚Äî</div>
                <div class="kpi__sub">Entrate ‚àí Uscite</div>
              </div>

              <div class="kpi">
                <div class="kpi__label">Entrate totali</div>
                <div id="forecastTotalIncome" class="kpi__value">‚Äî</div>
                <div class="kpi__sub">Somma entrate</div>
              </div>

              <div class="kpi">
                <div class="kpi__label">Uscite totali</div>
                <div id="forecastTotalExpense" class="kpi__value">‚Äî</div>
                <div class="kpi__sub">Somma uscite</div>
              </div>
            </div>

            <canvas id="forecastChart" width="720" height="220" style="width:100%; height:220px; border:1px solid rgba(128,128,128,0.18); border-radius:14px; background: rgba(128,128,128,0.03);"></canvas>

            <div style="height:12px"></div>

            <div id="forecastTableWrap" style="overflow:auto; max-height:260px; border:1px solid rgba(128,128,128,0.18); border-radius:14px; background: rgba(128,128,128,0.03);"></div>
            <div id="forecastError" class="help" style="color:crimson; margin-top:10px; display:none;"></div>
          </div>
        </section>
      </div>
    </aside>

    <aside id="eventDrawer" class="drawer" aria-hidden="true">
      <div class="drawer__header">
        <h2 id="drawerTitle" style="margin:0;font-size:var(--fs-5);letter-spacing:.2px;">Evento</h2>
        <div class="drawer__actions">
          <button id="btnEditEvent" class="btn btn--ghost" type="button">Modifica</button>
          <button id="btnDeleteEvent" class="btn btn--ghost" type="button">Elimina</button>
          <button id="btnCloseDrawer" class="btn btn--icon btn--ghost" type="button" aria-label="Chiudi">‚úï</button>
        </div>
      </div>
      <div id="eventDetail" class="drawer__body"></div>
    </aside>
    <div class="drawer-scrim" id="drawerScrim"></div>

    <dialog id="eventModal">
      <div class="modal__header">
        <h2 id="eventModalTitle" style="margin:0;font-size:var(--fs-5);letter-spacing:.2px;">Evento</h2>
        <button id="btnCloseModal" class="btn btn--icon btn--ghost" type="button" aria-label="Chiudi">‚úï</button>
      </div>

      <form id="eventForm" method="dialog" autocomplete="off">
        <div class="form-field">
          <label class="label" for="evtTitle">Titolo *</label>
          <input id="evtTitle" type="text" required />
          <small class="help" id="evtTitleHint" style="display:none;color:rgba(255,190,100,0.95);font-weight:900;">
            Rilevata ‚ÄúSparkasse Kreditkartenabrechnung‚Äù: consigliato <b>TRANSFER</b> (Bank ‚Üí Carta).
          </small>
        </div>

        <div class="form-field">
          <label class="label" for="evtType">Tipo</label>
          <select id="evtType">
            <option value="income">Entrata</option>
            <option value="expense">Uscita</option>
            <option value="transfer">Trasferimento</option>
            <option value="other">Altro</option>
          </select>
        </div>

        <div class="form-field">
          <label class="label" for="evtAmount">Importo</label>
          <input id="evtAmount" type="number" step="0.01" />
        </div>

        <div class="form-field">
          <label class="label" for="evtCategory">Categoria</label>
          <input id="evtCategory" type="text" list="categoryList" />
          <datalist id="categoryList"></datalist>
        </div>

        <div class="form-field">
          <label class="label" for="evtDate">Accrual Date *</label>
          <input id="evtDate" type="date" required />
        </div>

        <div class="form-field">
          <label class="label" for="evtTime">Ora</label>
          <input id="evtTime" type="time" />
        </div>

        <div class="form-field" id="pmField">
          <label class="label" for="evtPaymentMethod">Metodo pagamento</label>
          <select id="evtPaymentMethod"></select>
          <small class="help">Influenza account default e cash date.</small>
        </div>
<div id="installmentsBox" class="form-field" style="grid-column:1 / -1; display:none;">
  <label class="label" style="display:flex;justify-content:space-between;gap:12px;">
    <span>Amazon Kreditkarte ¬∑ Rate</span>
    <span id="ccLimitBadge" class="badge badge--muted">‚Äî</span>
  </label>

  <label class="label" style="display:flex;align-items:center;gap:10px;margin:0;">
    <input id="evtIsInstallment" type="checkbox" />
    <span>Pagamento rateale</span>
  </label>

  <div id="installmentFields" style="display:none; margin-top:10px;">
    <div class="grid-3">
      <div class="field">
        <label for="evtInstCount">Numero rate</label>
        <input id="evtInstCount" type="number" min="2" step="1" value="3" />
      </div>

      <div class="field">
        <label for="evtInstMode">Tipo rate</label>
        <select id="evtInstMode">
          <option value="fixed">Importo fisso</option>
          <option value="custom">Importi variabili</option>
        </select>
      </div>

      <div class="field">
        <label for="evtInstStart">Prima rata (Accrual)</label>
        <input id="evtInstStart" type="date" />
      </div>
    </div>

    <div id="instFixedRow" class="grid-2" style="margin-top:10px;">
      <div class="field">
        <label for="evtInstFixedAmt">Importo rata</label>
        <input id="evtInstFixedAmt" type="number" step="0.01" />
      </div>
      <div class="field">
        <label>Totale calcolato</label>
        <input id="evtInstTotal" type="text" disabled />
      </div>
    </div>

    <div id="instCustomList" style="display:none; margin-top:10px;"></div>

    <div class="help" style="margin-top:8px;">
      In modalit√† rateale verranno creati <b>N eventi mensili</b> (uno per rata).
    </div>
  </div>
</div>

        <div class="form-field">
          <label class="label" for="evtAccount">Account</label>
          <select id="evtAccount"></select>
          <small class="help">Da dove escono/entrano i soldi (Cash).</small>
        </div>

        <div id="transferFields" class="form-field" style="grid-column:1 / -1; display:none;">
          <div class="grid-2">
            <div>
              <label class="label" for="evtFromAccount">From account</label>
              <select id="evtFromAccount"></select>
            </div>
            <div>
              <label class="label" for="evtToAccount">To account</label>
              <select id="evtToAccount"></select>
            </div>
          </div>
          <small class="help">Per settlement carta: <b>Bank ‚Üí Credit Card</b>.</small>
        </div>

        <div class="form-field">
          <label class="label" for="evtCashDate">Cash Date</label>
          <input id="evtCashDate" type="date" disabled />
          <label class="label" style="display:flex;align-items:center;gap:10px;margin:10px 0 0;">
            <input id="evtCashOverride" type="checkbox" />
            <span>Override manuale cash date</span>
          </label>
          <small class="help">In Cash basis il saldo cambia su questa data.</small>
        </div>

        <div class="form-field">
          <label class="label" for="evtRecurrence">Ricorrenza</label>
          <select id="evtRecurrence">
            <option value="none">Nessuna</option>
            <option value="monthly">Mensile</option>
            <option value="yearly">Annuale</option>
            <option value="custom_days">Ogni N giorni</option>
          </select>
        </div>

        <div id="recDaysField" class="form-field" style="display:none;">
          <label class="label" for="evtRecurrenceDays">Ogni quanti giorni</label>
          <input id="evtRecurrenceDays" type="number" min="1" step="1" />
        </div>

        <div id="recSpanField" class="form-field" style="display:none;">
          <label class="label">Genera occorrenze (opzionale)</label>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <input id="evtRecurrenceUntil" type="date" />
            <button id="btnMaterialize" class="btn btn--ghost btn--tiny" type="button">Materializza fino a data</button>
          </div>
          <small class="help">Consigliato: lascia master + forecast. Materializza solo se vuoi eventi ‚Äúreali‚Äù.</small>
        </div>

        <div class="form-field" style="grid-column:1 / -1;">
          <label class="label" style="display:flex;align-items:center;gap:10px;margin:0;">
            <input id="evtPinned" type="checkbox" />
            <span>In evidenza</span>
          </label>
        </div>

        <div class="form-field" style="grid-column:1 / -1;">
          <label class="label" for="evtNotes">Note</label>
          <textarea id="evtNotes"></textarea>
        </div>
      </form>

      <div class="modal__footer">
        <button id="btnCancelEvent" class="btn btn--ghost" type="button">Annulla</button>
        <button class="btn btn--primary" type="submit" form="eventForm">Salva</button>
      </div>
    </dialog>
  </div>

  <script>
    (() => {
      "use strict";
const buildInstCustomInputs = (count) => {
  const host = $("#instCustomList");
  host.innerHTML = "";
  for (let i = 0; i < count; i++) {
    const row = el("div", { className:"field", style:"margin-bottom:8px;" }, [
      el("label", {}, `Rata ${i+1}`),
      el("input", { id:`instAmt_${i}`, type:"number", step:"0.01", value:"" })
    ]);
    host.appendChild(row);
  }
};
const getNextDueISOForCard = (cardAccId) => {
  // prossima cashDate tra le charges della carta
  const dueDates = new Set();

  for (const e of state.events) {
    if (e.type !== "expense") continue;
    const pm = getPMById(e.paymentMethodId);
    if (!pm || pm.kind !== "credit_card") continue;
    if ((pm.cardAccountId || "") !== cardAccId) continue;

    const cd = e.cashDate || "";
    if (cd) dueDates.add(cd);
  }

  const list = Array.from(dueDates).sort();
  const today = toISODate(new Date());
  return list.find(d => d >= today) || list[list.length - 1] || "";
};

const computeDueAmountForISO = (cardAccId, dueISO) => {
  let charges = 0;
  for (const e of state.events) {
    if (e.type !== "expense") continue;
    const pm = getPMById(e.paymentMethodId);
    if (!pm || pm.kind !== "credit_card") continue;
    if ((pm.cardAccountId || "") !== cardAccId) continue;
    if ((e.cashDate || "") !== dueISO) continue;
    charges += Number(e.amount || 0);
  }

  let alreadyPaid = 0;
  for (const e of state.events) {
    if (e.type !== "transfer") continue;
    if (String(e.toAccountId || "") !== String(cardAccId)) continue;
    const d = e.cashDate || e.date || "";
    if (d !== dueISO) continue;
    alreadyPaid += Number(e.amount || 0);
  }

  return Math.max(0, charges - alreadyPaid);
};

const createCardPaymentTransfer = async (cardAccId) => {
  const cfg = getCCCfg(cardAccId);
  const dueISO = getNextDueISOForCard(cardAccId);
  if (!dueISO) { alert("Nessuna scadenza trovata."); return; }

  const dueAmount = computeDueAmountForISO(cardAccId, dueISO);
  if (dueAmount <= 0) { alert("Nulla da pagare per questa scadenza."); return; }

  let pay = dueAmount;
  if (cfg.repaymentMode === "custom") {
    const custom = Number(cfg.customMonthly || 0);
    if (custom <= 0) { alert("Imposta un custom mensile > 0."); return; }
    pay = Math.min(custom, dueAmount);
  }

  // Bank account guess
  const bankId = guessAccountId({ type: "bank", nameRegex: /(bank|konto|giro|current)/i });

  await API.createEvent({
    title: `Pagamento ${getAccountById(cardAccId)?.name || "Carta"} ¬∑ ${dueISO}`,
    type: "transfer",
    amount: pay,
    category: "Credit Card Payment",
    date: dueISO,
    time: "",
    notes: "",
    pinned: false,
    cashDate: dueISO,
    paymentMethodId: "",
    accountId: "",
    fromAccountId: bankId,
    toAccountId: cardAccId,
    recurrence: "none",
    recurrenceDays: null
  });
};

const readInstCustomAmounts = (count) => {
  const out = [];
  for (let i = 0; i < count; i++) {
    const v = Number($(`#instAmt_${i}`)?.value || 0);
    out.push(v);
  }
  return out;
};

const computeInstallmentSchedule = ({ startISO, count, mode, fixedAmt, customAmts }) => {
  const start = fromISODate(startISO);
  const sched = [];
  for (let i = 0; i < count; i++) {
    const d = addMonths(start, i);
    const iso = toISODate(d);
    const amt = (mode === "fixed") ? Number(fixedAmt || 0) : Number(customAmts?.[i] || 0);
    sched.push({ date: iso, amount: amt });
  }
  return sched;
};

const updateInstallmentUI = () => {
  const pmId = $("#evtPaymentMethod").value || "";
  const isAmazon = isAmazonPM(pmId);
  const isTransfer = $("#evtType").value === "transfer";

  const box = $("#installmentsBox");
  box.style.display = (!isTransfer && isAmazon) ? "" : "none";

  // start date default = accrual date
  $("#evtInstStart").value = $("#evtInstStart").value || $("#evtDate").value || toISODate(new Date());

  const on = $("#evtIsInstallment").checked;
  $("#installmentFields").style.display = on ? "" : "none";

  const count = Math.max(2, Number($("#evtInstCount").value || 2));
  const mode = $("#evtInstMode").value;

  $("#instFixedRow").style.display = (mode === "fixed") ? "" : "none";
  $("#instCustomList").style.display = (mode === "custom") ? "" : "none";

  if (mode === "custom") buildInstCustomInputs(count);

  // totale calcolato
  let total = 0;
  if (on) {
    if (mode === "fixed") {
      const a = Number($("#evtInstFixedAmt").value || 0);
      total = a * count;
    } else {
      const arr = readInstCustomAmounts(count);
      total = arr.reduce((s,v)=>s+Number(v||0), 0);
    }
  }

  $("#evtInstTotal").value = total ? formatMoney(total, state.settings.currency) : "‚Äî";

  // se rate ON, aggiorna anche il campo importo totale evento
  if (on && total > 0) $("#evtAmount").value = String(total);

  // plafond badge
  const cardAccId = getCardAccountIdFromPM(pmId);
  if (cardAccId) {
    const k = computeCardAvailable(cardAccId);
    const after = k.outstanding + (on ? total : Number($("#evtAmount").value || 0));
    const availAfter = Math.max(0, k.limit - after);

    const badge = $("#ccLimitBadge");
    badge.textContent = `Plafond: ${formatMoney(k.limit)} ¬∑ OK: ${formatMoney(k.available)} ¬∑ dopo: ${formatMoney(availAfter)}`;
    badge.className = (after > k.limit) ? "badge badge--bad" : "badge badge--ok";
  }
};

      const $ = (s, r = document) => r.querySelector(s);
      const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
// --- PATCH v3.1: modal touched flags + helpers ---
let modalAccountTouched = false;
let modalFromToTouched = false;
let modalTypeTouched = false;

const optionExists = (sel, value) =>
  Array.from(sel?.options || []).some(o => String(o.value) === String(value));

const setSelectSafe = (sel, value, fallback = "") => {
  if (!sel) return;
  if (value != null && optionExists(sel, value)) sel.value = String(value);
  else if (fallback != null && optionExists(sel, fallback)) sel.value = String(fallback);
  else if (sel.options.length) sel.value = sel.options[0].value;
  else sel.value = "";
};

// prova a ‚Äúindovinare‚Äù un account usando type e/o regex sul nome
const guessAccountId = ({ type = null, nameRegex = null } = {}) => {
  const accs = Array.isArray(state.meta.accounts) ? state.meta.accounts : [];
  let pool = accs.slice();

  if (type) {
    const t = String(type).toLowerCase();
    const byType = pool.filter(a => String(a.type || "").toLowerCase() === t);
    if (byType.length) pool = byType;
  }

  if (nameRegex) {
    const rx = (nameRegex instanceof RegExp) ? nameRegex : new RegExp(String(nameRegex), "i");
    const byName = pool.filter(a => rx.test(String(a.name || "")) || rx.test(String(a.id || "")));
    if (byName.length) pool = byName;
  }

  return pool[0]?.id || accs[0]?.id || "";
};

const syncModalTypeUI = () => {
  const type = $("#evtType").value;

  const pmField = $("#pmField"); // wrapper del payment method
  const accSelect = $("#evtAccount");
  const accField = accSelect?.closest?.(".form-field");
  const transferWrap = $("#transferFields");

  const isTransfer = (type === "transfer");

  // show/hide transfer fields
  transferWrap.style.display = isTransfer ? "" : "none";

  // payment method: hide for transfer
  if (pmField) pmField.style.display = isTransfer ? "none" : "";

  // account: disable for transfer (e in UI sembra ‚Äúnon applicabile‚Äù)
  if (accSelect) accSelect.disabled = isTransfer;
  if (accField) accField.style.opacity = isTransfer ? "0.55" : "";

  // cash date always computed unless override
  recomputeCashDateInModal();
};

const applyPMDefaultsToModal = ({ forceAccount = false } = {}) => {
  const type = $("#evtType").value;
  if (type === "transfer") return;

  const pmId = $("#evtPaymentMethod").value || "";
  const pm = getPMById(pmId);
  if (!pm) return;

  // se user ha gi√† scelto manualmente l‚Äôaccount, non sovrascrivere
  if (!forceAccount && modalAccountTouched) return;

  if (pm.defaultAccountId) {
    setSelectSafe($("#evtAccount"), pm.defaultAccountId);
  }
};

// auto-preset transfer per settlement Sparkasse
const applySparkasseTransferPresetInModal = () => {
  // evita override se l‚Äôutente ha gi√† toccato type/from-to
  if (modalTypeTouched || modalFromToTouched) return;

  // prova a trovare un bank e una credit_card
  const bankId = guessAccountId({ type: "bank", nameRegex: /(bank|konto|giro|current)/i });
  const ccId = guessAccountId({ type: "credit_card", nameRegex: /(sparkasse|kredit|credit|card|carta|cc)/i });

  // se non li trova, non fare danni
  if (!bankId || !ccId || bankId === ccId) return;

  $("#evtType").value = "transfer";
  syncModalTypeUI();

  setSelectSafe($("#evtFromAccount"), bankId);
  setSelectSafe($("#evtToAccount"), ccId);

  // per transfer non serve PM/Account
  $("#evtPaymentMethod").value = "";
  $("#evtAccount").value = "";
};

      const pad2 = (n) => String(n).padStart(2, "0");
      const toISODate = (d) => {
        const dt = (d instanceof Date) ? d : new Date(d);
        return `${dt.getFullYear()}-${pad2(dt.getMonth() + 1)}-${pad2(dt.getDate())}`;
      };
      const fromISODate = (iso) => {
        const [y, m, d] = String(iso || "").split("-").map(Number);
        if (!y || !m || !d) return new Date(NaN);
        return new Date(y, m - 1, d);
      };
      const startOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const endOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 59, 999);
      const addDays = (d, n) => {
        const x = new Date(d);
        x.setDate(x.getDate() + n);
        return x;
      };
      const addMonths = (d, n) => {
        const x = new Date(d);
        const day = x.getDate();
        x.setMonth(x.getMonth() + n);
        while (x.getDate() !== day && x.getDate() > 1) x.setDate(x.getDate() - 1);
        return x;
      };
      const addYears = (d, n) => {
        const x = new Date(d);
        x.setFullYear(x.getFullYear() + n);
        return x;
      };
      const monthKey = (iso) => String(iso || "").slice(0, 7);
      const formatMoney = (val, currency = "EUR") =>
        new Intl.NumberFormat("it-IT", { style: "currency", currency }).format(Number(val || 0));

      const formatDateHuman = (d) =>
        new Intl.DateTimeFormat("it-IT", { weekday: "short", year: "numeric", month: "long", day: "2-digit" }).format(d);
      const formatMonthHuman = (d) =>
        new Intl.DateTimeFormat("it-IT", { year: "numeric", month: "long" }).format(d);

      const startOfWeek = (d) => {
        const x = startOfDay(d);
        const day = (x.getDay() + 6) % 7;
        return addDays(x, -day);
      };
      const endOfWeek = (d) => endOfDay(addDays(startOfWeek(d), 6));
      const startOfMonth = (d) => new Date(d.getFullYear(), d.getMonth(), 1);
      const endOfMonth = (d) => endOfDay(new Date(d.getFullYear(), d.getMonth() + 1, 0));
      const startOfYear = (d) => new Date(d.getFullYear(), 0, 1);
      const endOfYear = (d) => endOfDay(new Date(d.getFullYear(), 11, 31));
      const clampDateToRange = (d, min, max) =>
        new Date(Math.min(Math.max(d.getTime(), min.getTime()), max.getTime()));
      const uid = () => crypto.randomUUID?.() || `id_${Math.random().toString(16).slice(2)}_${Date.now()}`;
      const sanitizeApiBase = (s) => String(s || "").trim().replace(/\/+$/, "");
      const META_API_BASE = sanitizeApiBase(document.querySelector('meta[name="fin-api-base"]')?.content);

      const formatRangeLabel = (start, end, view) => {
        if (view === "day") return formatDateHuman(start);
        if (view === "workweek") return `${formatDateHuman(start)} ‚Äì ${formatDateHuman(end)}`;
        if (view === "week") return `${formatDateHuman(start)} ‚Äì ${formatDateHuman(end)}`;
        if (view === "month") return formatMonthHuman(start);
        if (view === "agenda") return `${formatDateHuman(start)} ‚Äì ${formatDateHuman(end)}`;
        if (view === "year") return String(start.getFullYear());
        return `${formatDateHuman(start)} ‚Äì ${formatDateHuman(end)}`;
      };

      const defaultSettings = {
        apiBase: META_API_BASE || "/api",
        mode: "calendar",
        view: "month",
        density: "comfort",
        basis: "cash",
        rangeMode: "all",
        fromDate: "",
        toDate: "",
        search: "",
        category: "all",
        account: "all",
        paymentMethod: "all",
        creditCardConfig: {
          amazon_cc:    { limit: 3000, repaymentMode: "full", customMonthly: 200 },
          sparkasse_cc: { limit: 2000, repaymentMode: "full", customMonthly: 0 }
        },
                
        includeIncome: true,
        includeExpense: true,
        includeOther: true,
        includeTransfers: true,
        sidebarOpen: true,
        insightsOpen: true,
        currency: "EUR",
        initialBalance: 0,
        balanceAtDate: "",
        forecastTo: "",
        forecastMode: "daily",
        forecastStart: "2025-12-26",
        explorerTab: "calendar",
        insightsTab: "stats"
      };
const getCCCfg = (cardAccId) => {
  const cfg = state.settings.creditCardConfig?.[cardAccId];
  return cfg || { limit: 0, repaymentMode: "full", customMonthly: 0 };
};

const setCCCfg = (cardAccId, patch) => {
  state.settings.creditCardConfig = state.settings.creditCardConfig || {};
  state.settings.creditCardConfig[cardAccId] = { ...getCCCfg(cardAccId), ...patch };
  saveSettings();
};
const computeCardOutstanding = (cardAccId) => {
  // charges = tutte le expense fatte con PM collegati a questa carta
  let charges = 0;
  for (const e of state.events) {
    if (e.type !== "expense") continue;
    const pm = getPMById(e.paymentMethodId);
    if (!pm) continue;
    if (pm.kind !== "credit_card") continue;
    if ((pm.cardAccountId || "") !== cardAccId) continue;
    charges += Number(e.amount || 0);
  }

  // payments = trasferimenti Bank -> Carta
  let payments = 0;
  for (const e of state.events) {
    if (e.type !== "transfer") continue;
    if (String(e.toAccountId || "") !== String(cardAccId)) continue;
    payments += Number(e.amount || 0);
  }

  return Math.max(0, charges - payments);
};

const computeCardAvailable = (cardAccId) => {
  const cfg = getCCCfg(cardAccId);
  const limit = Number(cfg.limit || 0);
  const out = computeCardOutstanding(cardAccId);
  return { limit, outstanding: out, available: Math.max(0, limit - out) };
};

      const state = {
        settings: structuredClone(defaultSettings),
        meta: { accounts: [], paymentMethods: [], categories: [] },
        events: [],
        anchorDate: startOfDay(new Date()),
        selectedEventId: null,
        draftEventId: null,
        forecast: null,
        apiOnline: false
      };

      const API = {
        base() {
          const b = String(state.settings.apiBase || "/api").trim().replace(/\/+$/, "");
          return b || "/api";
        },
        async request(path, { method = "GET", body } = {}) {
          const url = `${this.base()}${path}`;
          const res = await fetch(url, {
            method,
            headers: body === undefined
              ? { "Accept": "application/json" }
              : { "Accept": "application/json", "Content-Type": "application/json" },
            credentials: "omit",
            body: body === undefined ? undefined : JSON.stringify(body)
          });
          const ct = res.headers.get("content-type") || "";
          const data = ct.includes("application/json")
            ? await res.json().catch(() => null)
            : await res.text().catch(() => null);
          if (!res.ok) {
            const msg = (data && data.error) ? data.error : `HTTP ${res.status}`;
            throw new Error(msg);
          }
          return data;
        },
        ping() { return this.request(`/meta`); },
        getMeta() { return this.request(`/meta`); },
        listEvents(params = {}) {
          const qs = new URLSearchParams(params).toString();
          return this.request(`/events${qs ? `?${qs}` : ""}`);
        },
        createEvent(payload) { return this.request(`/events`, { method: "POST", body: payload }); },
        updateEvent(id, payload) { return this.request(`/events/${encodeURIComponent(id)}`, { method: "PUT", body: payload }); },
        deleteEvent(id) { return this.request(`/events/${encodeURIComponent(id)}`, { method: "DELETE" }); },
        deleteSeries(seriesId) { return this.request(`/series/${encodeURIComponent(seriesId)}`, { method: "DELETE" }); },
        deleteSeriesFrom(seriesId, fromISO) { return this.request(`/series/${encodeURIComponent(seriesId)}/from/${encodeURIComponent(fromISO)}`, { method: "DELETE" }); },
        getSettings() { return this.request(`/settings`); },
        saveSettings(payload) { return this.request(`/settings`, { method: "PUT", body: payload }); },
        forecast(params = {}) {
          const qs = new URLSearchParams(params).toString();
          return this.request(`/forecast${qs ? `?${qs}` : ""}`);
        },
        reportMonthly(params = {}) {
          const qs = new URLSearchParams(params).toString();
          return this.request(`/reports/monthly${qs ? `?${qs}` : ""}`);
        },
        reportCreditCard(params = {}) {
          const qs = new URLSearchParams(params).toString();
          return this.request(`/reports/credit-card${qs ? `?${qs}` : ""}`);
        },
        materializeSeries(seriesId, toISO) {
          return this.request(`/series/${encodeURIComponent(seriesId)}/materialize`, {
            method: "POST",
            body: { to: toISO }
          });
        }
      };

      let settingsTimer = null;
      const saveSettings = () => {
        clearTimeout(settingsTimer);
        settingsTimer = setTimeout(async () => {
          try { await API.saveSettings(state.settings); } catch (_) {}
        }, 250);
      };

      const safeArr = (x) => Array.isArray(x) ? x : [];
      const normAccount = (a) => ({
        id: String(a?.id ?? ""),
        name: String(a?.name ?? a?.title ?? a?.label ?? "Account"),
        type: String(a?.type ?? "bank"),
        currency: String(a?.currency ?? state.settings.currency ?? "EUR"),
        isDefault: !!a?.isDefault
      });
      const normPM = (p) => ({
        id: String(p?.id ?? ""),
        name: String(p?.name ?? p?.title ?? p?.label ?? "Metodo"),
        kind: String(p?.kind ?? p?.type ?? "unknown"),
        defaultAccountId: String(p?.defaultAccountId ?? p?.accountId ?? ""),
        settlementRule: p?.settlementRule ? String(p.settlementRule) : "",
        settlementParam: (p?.settlementParam && typeof p.settlementParam === "object") ? p.settlementParam : {},
      
        // ‚úÖ NEW
        cardAccountId: String(p?.cardAccountId ?? p?.settlementParam?.cardAccountId ?? "")
      });
const getCardAccountIdFromPM = (pmId) => {
  const pm = getPMById(pmId);
  return pm?.cardAccountId || "";
};

const isAmazonPM = (pmId) => {
  const pm = getPMById(pmId);
  if (!pm) return false;
  return /amazon/i.test(pm.name) || pm.id === "amazon_card";
};


      const getAccountById = (id) => state.meta.accounts.find(a => a.id === id) || null;
      const getPMById = (id) => state.meta.paymentMethods.find(p => p.id === id) || null;

      const getCreditCardAccounts = () => state.meta.accounts.filter(a => a.type === "credit_card");
      const getCreditCardPMs = () => state.meta.paymentMethods.filter(pm => pm.kind === "credit_card" || /credit/i.test(pm.name) || /kredit/i.test(pm.name));

      const normalizeEvent = (e) => {
        const o = { ...(e || {}) };
        o.id = String(o.id ?? "");
        o.title = String(o.title ?? "");
        o.category = String(o.category ?? "Senza categoria");
        o.type = String(o.type ?? "other");
        o.amount = (o.amount === "" || o.amount == null) ? null : Number(o.amount);
        o.date = String(o.date ?? "");
        o.time = String(o.time ?? "");
        o.notes = String(o.notes ?? "");
        o.pinned = !!o.pinned;
        o.recurrence = String(o.recurrence ?? "none");
        o.recurrenceDays = (o.recurrenceDays == null || o.recurrenceDays === "") ? null : Number(o.recurrenceDays);
        o.seriesId = o.seriesId ?? null;
        o.seriesMaster = !!o.seriesMaster;
        o.cashDate = String(o.cashDate ?? o.cash_date ?? "") || "";
        o.paymentMethodId = String(o.paymentMethodId ?? o.payment_method_id ?? "") || "";
        o.accountId = String(o.accountId ?? o.account_id ?? "") || "";
        o.fromAccountId = String(o.fromAccountId ?? o.from_account_id ?? "") || "";
        o.toAccountId = String(o.toAccountId ?? o.to_account_id ?? "") || "";
        o._virtual = !!o._virtual;
        o._estimated = !!o._estimated;
        return o;
      };

      const eventDateForBasis = (evt, basis) => {
        const b = basis || state.settings.basis;
        if (b === "cash") return evt.cashDate || evt.date || "";
        return evt.date || "";
      };

      const eventSignedAmount = (evt) => {
        const v = Number(evt.amount || 0);
        if (!v) return 0;
        if (evt.type === "income") return +v;
        if (evt.type === "expense") return -v;
        return 0;
      };

      const computeCashDate = ({ accrualISO, pm, type }) => {
        const base = fromISODate(accrualISO);
        if (type === "income") return toISODate(base);
        if (!isFinite(base.getTime())) return "";
        if (type === "transfer") return toISODate(base);
        if (!pm || !pm.settlementRule) return toISODate(base);

        const rule = pm.settlementRule;
        const param = pm.settlementParam || {};

        if (rule === "same_day") return toISODate(base);

        if (rule === "lag_days") {
          const lag = Math.max(0, Number(param.days || 0));
          return toISODate(addDays(base, lag));
        }

        if (rule === "month_end") {
          const end = new Date(base.getFullYear(), base.getMonth() + 1, 0);
          return toISODate(end);
        }

        if (rule === "next_month_day") {
          const payDay = Math.min(28, Math.max(1, Number(param.day || 1)));
          const next = addMonths(new Date(base.getFullYear(), base.getMonth(), 1), 1);
          const cand = new Date(next.getFullYear(), next.getMonth(), payDay);
          return toISODate(cand);
        }

        return toISODate(base);
      };

      const getTrackingBounds = (events) => {
        const dates = events
          .map(e => eventDateForBasis(e, state.settings.basis))
          .filter(Boolean)
          .sort();
        if (!dates.length) {
          const t = startOfDay(new Date());
          return [t, t];
        }
        return [fromISODate(dates[0]), fromISODate(dates[dates.length - 1])];
      };

      const getEffectiveRangeForView = () => {
        const v = state.settings.view;
        const a = state.anchorDate;
        if (v === "day") return [startOfDay(a), endOfDay(a)];
        if (v === "workweek") {
          const s = startOfWeek(a);
          const e = endOfDay(addDays(s, 4));
          return [s, e];
        }
        if (v === "week") return [startOfWeek(a), endOfWeek(a)];
        if (v === "month") return [startOfMonth(a), endOfMonth(a)];
        if (v === "agenda") return [startOfWeek(a), endOfWeek(a)];
        if (v === "year") return [startOfYear(a), endOfYear(a)];
        return [startOfMonth(a), endOfMonth(a)];
      };

      const getUserRangeConstraints = () => {
        const { rangeMode, fromDate, toDate } = state.settings;
        const [minTrack, maxTrack] = getTrackingBounds(state.events);
        if (rangeMode === "all") return [minTrack, maxTrack];
        if (rangeMode === "from") {
          const from = fromDate ? fromISODate(fromDate) : minTrack;
          return [startOfDay(from), maxTrack];
        }
        if (rangeMode === "between") {
          const from = fromDate ? fromISODate(fromDate) : minTrack;
          const to = toDate ? fromISODate(toDate) : maxTrack;
          const a = startOfDay(from);
          const b = endOfDay(to);
          return a <= b ? [a, b] : [b, a];
        }
        return [minTrack, maxTrack];
      };

      const passesTypeFilter = (e) => {
        if (e.type === "income" && !state.settings.includeIncome) return false;
        if (e.type === "expense" && !state.settings.includeExpense) return false;
        if (e.type === "other" && !state.settings.includeOther) return false;
        if (e.type === "transfer" && !state.settings.includeTransfers) return false;
        return true;
      };

      const passesCategoryFilter = (e) => {
        const cat = (state.settings.category || "all").toLowerCase();
        if (cat === "all") return true;
        return (e.category || "").toLowerCase() === cat;
      };

      const passesAccountFilter = (e) => {
        const acc = state.settings.account || "all";
        if (acc === "all") return true;
        if (e.type === "transfer") return e.fromAccountId === acc || e.toAccountId === acc;
        return e.accountId === acc;
      };

      const passesPaymentMethodFilter = (e) => {
        const pm = state.settings.paymentMethod || "all";
        if (pm === "all") return true;
        return String(e.paymentMethodId || "") === pm;
      };

      const passesSearchFilter = (e) => {
        const q = (state.settings.search || "").trim().toLowerCase();
        if (!q) return true;
        const hay = `${e.title} ${e.category} ${e.notes}`.toLowerCase();
        return hay.includes(q);
      };

      const passesUserRange = (e) => {
        const [uStart, uEnd] = getUserRangeConstraints();
        const dISO = eventDateForBasis(e, state.settings.basis);
        const d = fromISODate(dISO);
        return d >= uStart && d <= uEnd;
      };

      const getFilteredEvents = () => state.events
        .filter(e => eventDateForBasis(e, state.settings.basis))
        .filter(passesTypeFilter)
        .filter(passesCategoryFilter)
        .filter(passesAccountFilter)
        .filter(passesPaymentMethodFilter)
        .filter(passesSearchFilter)
        .filter(passesUserRange)
        .sort((a, b) => {
          const da = eventDateForBasis(a, state.settings.basis) + (a.time || "");
          const db = eventDateForBasis(b, state.settings.basis) + (b.time || "");
          return da < db ? -1 : 1;
        });

      const computeBalanceUpTo = (events, initialBalance, cutoffISO, basis) => {
        const cutoff = fromISODate(cutoffISO);
        let bal = Number(initialBalance || 0);
        for (const e of events) {
          const dISO = eventDateForBasis(e, basis);
          const d = fromISODate(dISO);
          if (d <= endOfDay(cutoff)) bal += eventSignedAmount(e);
        }
        return bal;
      };

      const computeSnapshots = (eventsInRange, initialBalance, rangeStart, rangeEnd, basis) => {
        const days = [];
        const map = new Map();
        for (const e of eventsInRange) {
          const iso = eventDateForBasis(e, basis);
          map.set(iso, (map.get(iso) || 0) + eventSignedAmount(e));
        }
        let bal = Number(initialBalance || 0);
        let cur = startOfDay(rangeStart);
        const last = startOfDay(rangeEnd);
        while (cur <= last) {
          const iso = toISODate(cur);
          bal += (map.get(iso) || 0);
          days.push({ date: iso, balance: bal });
          cur = addDays(cur, 1);
        }
        return days;
      };

      const computeVisibleStats = (filtered) => {
        const [viewStart, viewEnd] = getEffectiveRangeForView();
        const [userStart, userEnd] = getUserRangeConstraints();
        const rangeStart = new Date(Math.max(viewStart.getTime(), userStart.getTime()));
        const rangeEnd = new Date(Math.min(viewEnd.getTime(), userEnd.getTime()));
        const inVisible = filtered.filter(e => {
          const d = fromISODate(eventDateForBasis(e, state.settings.basis));
          return d >= startOfDay(rangeStart) && d <= endOfDay(rangeEnd);
        });

        const incomeEvents = inVisible.filter(e => e.type === "income");
        const expenseEvents = inVisible.filter(e => e.type === "expense");
        const transferEvents = inVisible.filter(e => e.type === "transfer");

        const incomeSum = incomeEvents.reduce((s, e) => s + Number(e.amount || 0), 0);
        const expenseSum = expenseEvents.reduce((s, e) => s + Number(e.amount || 0), 0);
        const net = incomeSum - expenseSum;

        const snapshots = computeSnapshots(inVisible, state.settings.initialBalance, startOfDay(rangeStart), startOfDay(rangeEnd), state.settings.basis);
        return {
          rangeStart, rangeEnd,
          incomeSum, expenseSum, net,
          incomeCount: incomeEvents.length,
          expenseCount: expenseEvents.length,
          transferCount: transferEvents.length,
          snapshots
        };
      };

      const computeCreditCardKPIs = ({ monthISO = null } = {}) => {
        const cur = state.settings.currency;
        const ccAccs = getCreditCardAccounts();
        const ccPMs = getCreditCardPMs();
        const ccAccIds = new Set(ccAccs.map(a => a.id));
        const ccPMIds = new Set(ccPMs.map(p => p.id));

        const todayISO = toISODate(new Date());
        const month = monthISO || monthKey(todayISO);
        const isInMonth = (iso) => monthKey(iso) === month;

        let spentMonth = 0;
        let paidMonth = 0;

        for (const e of state.events) {
          if (e.type === "expense" && ccPMIds.has(String(e.paymentMethodId || "")) && isInMonth(e.date)) {
            spentMonth += Number(e.amount || 0);
          }
        }

        for (const e of state.events) {
          const title = (e.title || "").toLowerCase();
          const isLikelySettlement = title.includes("kreditkartenabrechnung") || title.includes("sparkasse kreditkartenabrechnung");
          if (e.type === "transfer") {
            if (ccAccIds.has(String(e.toAccountId || "")) || isLikelySettlement) {
              const dISO = e.cashDate || e.date;
              if (isInMonth(dISO)) paidMonth += Number(e.amount || 0);
            }
          }
        }

        let totalCharges = 0;
        let totalSettlements = 0;
        for (const e of state.events) {
          if (e.type === "expense" && ccPMIds.has(String(e.paymentMethodId || ""))) {
            totalCharges += Number(e.amount || 0);
          }
          if (e.type === "transfer") {
            const title = (e.title || "").toLowerCase();
            const isLikelySettlement = title.includes("kreditkartenabrechnung") || title.includes("sparkasse kreditkartenabrechnung");
            if (ccAccIds.has(String(e.toAccountId || "")) || isLikelySettlement) {
              totalSettlements += Number(e.amount || 0);
            }
          }
        }
        const outstanding = Math.max(0, totalCharges - totalSettlements);

        return { month, spentMonth, paidMonth, outstanding, currency: cur };
      };

      const drawForecastChart = (canvas, series, currency) => {
        const ctx = canvas.getContext("2d");
        if (!ctx) return;
        const W = canvas.width;
        const H = canvas.height;
        ctx.clearRect(0, 0, W, H);

        if (!series || !series.length) {
          ctx.fillStyle = "#888";
          ctx.font = "14px system-ui";
          ctx.fillText("Nessun dato forecast.", 12, 24);
          return;
        }

        const pad = 28;
        const ys = series.map(p => Number(p.balance || 0));
        const minY = Math.min(...ys);
        const maxY = Math.max(...ys);
        const spanY = (maxY - minY) || 1;

        const xTo = (i) => pad + (i / Math.max(1, series.length - 1)) * (W - pad * 2);
        const yTo = (v) => (H - pad) - ((v - minY) / spanY) * (H - pad * 2);

        ctx.strokeStyle = "rgba(128,128,128,0.35)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(pad, pad);
        ctx.lineTo(pad, H - pad);
        ctx.lineTo(W - pad, H - pad);
        ctx.stroke();

        ctx.strokeStyle = "rgba(80,160,255,0.9)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        series.forEach((p, i) => {
          const x = xTo(i);
          const y = yTo(Number(p.balance || 0));
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();

        ctx.fillStyle = "rgba(200,200,200,0.9)";
        ctx.font = "12px system-ui";
        const fmt = (v) => formatMoney(v, currency);
        ctx.fillText(`min ${fmt(minY)}`, pad + 6, pad + 6);
        ctx.fillText(`max ${fmt(maxY)}`, pad + 6, pad + 20);
        const last = series[series.length - 1];
        ctx.fillText(`${last.date}: ${fmt(last.balance)}`, pad + 6, H - 10);
      };

      const el = (tag, attrs = {}, children = []) => {
        const node = document.createElement(tag);
        for (const [k, v] of Object.entries(attrs)) {
          if (k === "className") node.className = v;
          else if (k === "textContent") node.textContent = v;
          else node.setAttribute(k, v);
        }
        if (!Array.isArray(children)) children = [children];
        for (const ch of children) {
          if (ch == null) continue;
          node.appendChild(ch.nodeType ? ch : document.createTextNode(String(ch)));
        }
        return node;
      };

      const emptyState = (text) =>
        el("div", { className: "empty-state" }, [
          el("div", { textContent: text || "" })
        ]);

      const renderForecastTable = (wrapEl, perMonth, currency) => {
        wrapEl.innerHTML = "";
        if (!perMonth || !perMonth.length) {
          wrapEl.appendChild(emptyState("Nessun riepilogo mensile."));
          return;
        }

        const table = el("table", { style: "width:100%; border-collapse:collapse;" });
        const thead = el("thead");
        thead.appendChild(el("tr", {}, [
          el("th", { style:"text-align:left; padding:10px; border-bottom:1px solid rgba(128,128,128,0.18);" }, "Mese"),
          el("th", { style:"text-align:left; padding:10px; border-bottom:1px solid rgba(128,128,128,0.18);" }, "Entrate"),
          el("th", { style:"text-align:left; padding:10px; border-bottom:1px solid rgba(128,128,128,0.18);" }, "Uscite"),
          el("th", { style:"text-align:left; padding:10px; border-bottom:1px solid rgba(128,128,128,0.18);" }, "Netto"),
        ]));

        const tbody = el("tbody");
        for (const m of perMonth) {
          tbody.appendChild(el("tr", {}, [
            el("td", { style:"padding:10px; border-bottom:1px solid rgba(128,128,128,0.12); font-weight:1000;" }, m.month),
            el("td", { style:"padding:10px; border-bottom:1px solid rgba(128,128,128,0.12);" }, formatMoney(m.income, currency)),
            el("td", { style:"padding:10px; border-bottom:1px solid rgba(128,128,128,0.12);" }, formatMoney(m.expense, currency)),
            el("td", { style:"padding:10px; border-bottom:1px solid rgba(128,128,128,0.12);" }, formatMoney(m.net, currency)),
          ]));
        }

        table.append(thead, tbody);
        wrapEl.appendChild(table);
      };

      const loadForecastFromBackend = async () => {
        const todayISO = toISODate(new Date());
        const toISO = state.settings.forecastTo || state.settings.toDate || todayISO;
        const mode = state.settings.forecastMode || "daily";
        const start = state.settings.forecastStart || "2025-12-26";
        const basis = state.settings.basis || "cash";

        const params = {
          to: toISO,
          mode,
          start,
          basis,
          initialBalance: String(state.settings.initialBalance || 0)
        };
        return API.forecast(params);
      };

      const renderForecast = () => {
        const errEl = $("#forecastError");
        errEl.style.display = "none";
        errEl.textContent = "";

        const f = state.forecast;
        if (!f) {
          $("#forecastMeta").textContent = "‚Äî";
          $("#forecastBalanceAtTo").textContent = "‚Äî";
          $("#forecastBalanceMeta").textContent = "‚Äî";
          $("#forecastTotalIncome").textContent = "‚Äî";
          $("#forecastTotalExpense").textContent = "‚Äî";
          $("#forecastTotalNet").textContent = "‚Äî";
          renderForecastTable($("#forecastTableWrap"), [], state.settings.currency);
          drawForecastChart($("#forecastChart"), [], state.settings.currency);
          return;
        }

        const cur = state.settings.currency;

        $("#forecastMeta").textContent =
          `basis=${state.settings.basis} ¬∑ storico ${f.meta?.historyWindow?.from || "?"} ‚Üí ${f.meta?.historyWindow?.to || "?"} ¬∑ real=${f.components?.realCount ?? "?"} ¬∑ rec=${f.components?.futureRecurringCount ?? "?"} ¬∑ stima=${f.components?.estimatedCount ?? "?"}`;

        $("#forecastBalanceAtTo").textContent = formatMoney(f.totals?.balanceAtTo, cur);
        $("#forecastBalanceMeta").textContent = `Target ${f.meta?.to || ""} ¬∑ init ${formatMoney(f.meta?.initialBalance, cur)}`;

        $("#forecastTotalIncome").textContent = formatMoney(f.totals?.income, cur);
        $("#forecastTotalExpense").textContent = formatMoney(f.totals?.expense, cur);
        $("#forecastTotalNet").textContent = formatMoney(f.totals?.net, cur);

        drawForecastChart($("#forecastChart"), f.series || [], cur);
        renderForecastTable($("#forecastTableWrap"), f.perMonth || [], cur);
      };

      const refreshForecast = async () => {
        try {
          state.forecast = null;
          renderForecast();
          const data = await loadForecastFromBackend();
          state.forecast = data;
          renderForecast();
        } catch (e) {
          const errEl = $("#forecastError");
          errEl.style.display = "";
          errEl.textContent = (e && e.message) ? e.message : "Errore forecast";
        }
      };

      const escapeHtml = (s) =>
        String(s || "").replace(/[&<>"']/g, (c) => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", "\"":"&quot;", "'":"&#39;" }[c]));

      const categorySlug = (cat) => (cat || "uncategorized")
        .trim().toLowerCase()
        .replace(/\s+/g, "-")
        .replace(/[^a-z0-9\-_]/g, "");

      const eventBadges = (evt) => {
        const pm = getPMById(evt.paymentMethodId);
        const acc = getAccountById(evt.accountId);
        const accrualISO = evt.date || "";
        const cashISO = evt.cashDate || "";
        const out = [];

        if (pm?.name) out.push(`<span class="badge badge--muted">üí≥ ${escapeHtml(pm.name)}</span>`);
        if (evt.type === "transfer") {
          const fa = getAccountById(evt.fromAccountId);
          const ta = getAccountById(evt.toAccountId);
          if (fa?.name && ta?.name) out.push(`<span class="badge badge--muted">‚áÑ ${escapeHtml(fa.name)} ‚Üí ${escapeHtml(ta.name)}</span>`);
        } else if (acc?.name) {
          out.push(`<span class="badge badge--muted">üè¶ ${escapeHtml(acc.name)}</span>`);
        }

        if (state.settings.basis === "cash" && accrualISO && cashISO && accrualISO !== cashISO) {
          out.push(`<span class="badge badge--warn">Cash ${escapeHtml(cashISO)}</span>`);
        }

        if (evt._virtual) out.push(`<span class="badge badge--muted">virtual</span>`);
        if (evt._estimated) out.push(`<span class="badge badge--muted">estimated</span>`);

        return out.join(" ");
      };

      const eventBlock = (evt) => {
        const amt = evt.amount != null && evt.amount !== "" ? formatMoney(Number(evt.amount), state.settings.currency) : "";
        const cat = evt.category || "Senza categoria";
        const basisISO = eventDateForBasis(evt, state.settings.basis);

        const root = el("button", {
          type: "button",
          className: [
            "event-block",
            `event-block--type-${evt.type}`,
            `event-block--cat-${categorySlug(cat)}`,
            evt.pinned ? "is-pinned" : "",
            state.settings.density === "compact" ? "is-compact" : "is-comfort"
          ].filter(Boolean).join(" "),
          id: `evt_${evt.id}`,
          "data-event-id": evt.id,
          "data-date": basisISO
        });

        const top = el("div", { className: "event-block__top" }, [
          el("span", { className: "event-block__title", textContent: evt.title || "(senza titolo)" }),
          evt.pinned ? el("span", { className: "event-block__pin", textContent: "‚òÖ", "aria-hidden": "true" }) : null
        ].filter(Boolean));

        const meta = el("div", { className: "event-block__meta" }, [
          el("span", { className: "event-block__cat", textContent: cat }),
          evt.time ? el("span", { className: "event-block__time", textContent: evt.time }) : null
        ].filter(Boolean));

        root.append(top, meta);
        if (amt) root.append(el("div", { className: "event-block__amount", textContent: amt }));

        const badgesHTML = eventBadges(evt);
        if (badgesHTML) {
          const badgeWrap = el("div", { className: "event-block__meta" });
          badgeWrap.innerHTML = badgesHTML;
          root.append(badgeWrap);
        }

        root.addEventListener("click", () => openEventDrawer(evt.id));
        return root;
      };

      const renderDayView = (events) => {
        const [start] = getEffectiveRangeForView();
        const dayISO = toISODate(start);
        const container = el("div", { className: "view view--day", id: "viewDayHost" });

        const list = el("div", { className: "event-list event-list--day", role: "list" });
        const dayEvents = events.filter(e => eventDateForBasis(e, state.settings.basis) === dayISO);

        if (!dayEvents.length) list.appendChild(emptyState("Nessun evento in questo giorno."));
        else for (const e of dayEvents) list.appendChild(el("div", {}, [eventBlock(e)]));

        container.appendChild(list);
        return container;
      };

      const renderWeekColumns = (events, { workweek = false } = {}) => {
        const [start] = getEffectiveRangeForView();
        const container = el("div", { className: "view view--week", id: workweek ? "viewWorkWeekHost" : "viewWeekHost" });
        const grid = el("div", { className: "calendar-grid calendar-grid--week", id: workweek ? "workWeekGrid" : "weekGrid" });

        const todayISO = toISODate(new Date());
        const cols = workweek ? 5 : 7;

        for (let i = 0; i < cols; i++) {
          const d = addDays(start, i);
          const iso = toISODate(d);

          const isToday = iso === todayISO;
          const isWeekend = (d.getDay() === 0 || d.getDay() === 6);

          const col = el("section", {
            className: [
              "day-col",
              "day-col--week",
              isToday ? "is-today" : "",
              (!workweek && isWeekend) ? "is-weekend" : ""
            ].filter(Boolean).join(" "),
            "data-date": iso
          });

          const colHeader = el("header", { className: "day-col__header" }, [
            el("div", { className: "day-col__dow", textContent: new Intl.DateTimeFormat("it-IT", { weekday: "short" }).format(d) }),
            el("div", { className: "day-col__date", textContent: `${pad2(d.getDate())}/${pad2(d.getMonth() + 1)}` })
          ]);

          const colBody = el("div", { className: "day-col__body", role: "list" });

          const dayEvents = events.filter(e => eventDateForBasis(e, state.settings.basis) === iso);
          if (!dayEvents.length) colBody.appendChild(emptyState("‚Äî"));
          else for (const e of dayEvents) colBody.appendChild(eventBlock(e));

          col.append(colHeader, colBody);
          grid.appendChild(col);
        }

        container.appendChild(grid);
        return container;
      };

      const renderMonthView = (events) => {
        const [start] = getEffectiveRangeForView();
        const container = el("div", { className: "view view--month", id: "viewMonthHost" });
        const grid = el("div", { className: "calendar-grid calendar-grid--month", id: "monthGrid" });

        const dowRow = el("div", { className: "dow-row", id: "monthDowRow" });
        for (const name of ["Lun", "Mar", "Mer", "Gio", "Ven", "Sab", "Dom"]) {
          dowRow.appendChild(el("div", { className: "dow-cell", textContent: name }));
        }
        grid.appendChild(dowRow);

        const gridStart = startOfWeek(startOfMonth(start));
        const gridEnd = endOfWeek(endOfMonth(start));

        let cur = gridStart;
        const todayISO = toISODate(new Date());

        while (cur <= gridEnd) {
          const weekRow = el("div", { className: "week-row", role: "row" });

          for (let i = 0; i < 7; i++) {
            const d = addDays(cur, i);
            const iso = toISODate(d);
            const inMonth = d.getMonth() === start.getMonth();
            const isToday = iso === todayISO;
            const isWeekend = (d.getDay() === 0 || d.getDay() === 6);

            const cell = el("section", {
              className: [
                "day-cell",
                "day-cell--month",
                inMonth ? "is-in-month" : "is-out-month",
                isToday ? "is-today" : "",
                isWeekend ? "is-weekend" : ""
              ].filter(Boolean).join(" "),
              id: `monthDay_${iso}`,
              "data-date": iso,
              role: "gridcell"
            });

            const cellHeader = el("header", { className: "day-cell__header" }, [
              el("div", { className: "day-cell__num", textContent: String(d.getDate()) }),
              el("button", {
                className: "btn btn--icon btn--cell-add",
                type: "button",
                "data-action": "quick-add",
                "data-date": iso,
                "aria-label": `Aggiungi evento il ${formatDateHuman(d)}`,
                textContent: "+"
              })
            ]);

            const cellBody = el("div", { className: "day-cell__body", role: "list" });
            const dayEvents = events.filter(e => eventDateForBasis(e, state.settings.basis) === iso);

            if (!dayEvents.length) cellBody.appendChild(el("div"));
            else for (const e of dayEvents) cellBody.appendChild(eventBlock(e));

            cell.append(cellHeader, cellBody);
            weekRow.appendChild(cell);
          }

          grid.appendChild(weekRow);
          cur = addDays(cur, 7);
        }

        container.appendChild(grid);
        return container;
      };

      const renderYearView = (events) => {
        const [start] = getEffectiveRangeForView();
        const container = el("div", { className: "view view--year", id: "viewYearHost" });
        const wrap = el("div", { className: "year-grid", id: "yearGrid" });

        for (let m = 0; m < 12; m++) {
          const monthDate = new Date(start.getFullYear(), m, 1);
          const monthBox = el("section", {
            className: "month-mini",
            "data-month": String(m),
            "data-year": String(start.getFullYear()),
            role: "button",
            tabindex: "0"
          });

          const inThisMonth = events.filter(e => {
            const d = fromISODate(eventDateForBasis(e, state.settings.basis));
            return d.getFullYear() === start.getFullYear() && d.getMonth() === m;
          });

          monthBox.append(
            el("div", { className: "month-mini__header" }, [
              el("div", { className: "month-mini__title", textContent: new Intl.DateTimeFormat("it-IT", { month: "long" }).format(monthDate) }),
              el("div", { className: "month-mini__count", textContent: `${inThisMonth.length} evt` })
            ])
          );

          wrap.appendChild(monthBox);
        }

        container.appendChild(wrap);
        return container;
      };

      const renderAgendaView = (events) => {
        const [vs, ve] = getEffectiveRangeForView();
        const container = el("div", { className: "view view--agenda", id: "viewAgendaHost" });
        const box = el("div", { className: "panel", style: "padding:12px;" });

        const days = [];
        let cur = startOfDay(vs);
        const last = startOfDay(ve);
        while (cur <= last) {
          days.push(toISODate(cur));
          cur = addDays(cur, 1);
        }

        if (!events.length) {
          box.appendChild(emptyState("Nessun evento nel range Agenda."));
          container.appendChild(box);
          return container;
        }

        for (const dISO of days) {
          const dayEvents = events.filter(e => eventDateForBasis(e, state.settings.basis) === dISO);
          const head = el("div", { style: "display:flex;align-items:baseline;justify-content:space-between;gap:10px;margin:10px 0 8px;" }, [
            el("div", { style:"font-weight:1000;letter-spacing:.2px;" }, dISO),
            el("span", { className:"badge badge--muted" }, `${dayEvents.length} evt`)
          ]);

          box.appendChild(head);

          if (!dayEvents.length) {
            box.appendChild(el("div", { className:"empty-state", style:"padding:10px;margin-bottom:8px;" }, "‚Äî"));
          } else {
            const list = el("div", { style:"display:flex;flex-direction:column;gap:8px;margin-bottom:10px;" });
            for (const e of dayEvents) list.appendChild(eventBlock(e));
            box.appendChild(list);
          }
        }

        container.appendChild(box);
        return container;
      };

      const renderCalendar = () => {
        const filtered = getFilteredEvents();
        const view = state.settings.view;

        const host = $("#calendarView");
        host.innerHTML = "";
        host.dataset.view = view;
        host.dataset.density = state.settings.density;

        const [vs, ve] = getEffectiveRangeForView();
        $("#rangeLabel").textContent = formatRangeLabel(vs, ve, view);

        $("#mainTitle").textContent = "Calendario";
        $("#mainSubtitle").innerHTML = [
          `<span class="badge badge--muted">basis: <b>${escapeHtml(state.settings.basis)}</b></span>`,
          `<span class="badge badge--muted">vista: <b>${escapeHtml(view)}</b></span>`,
          `<span class="badge badge--muted">filtrati: <b>${filtered.length}</b></span>`
        ].join(" ");

        if (view === "day") host.appendChild(renderDayView(filtered));
        else if (view === "workweek") host.appendChild(renderWeekColumns(filtered, { workweek: true }));
        else if (view === "week") host.appendChild(renderWeekColumns(filtered, { workweek: false }));
        else if (view === "month") host.appendChild(renderMonthView(filtered));
        else if (view === "agenda") host.appendChild(renderAgendaView(filtered));
        else host.appendChild(renderYearView(filtered));

        $("#viewMetaBadge").textContent = `Vista: ${view}`;
      };

      const renderMovements = () => {
        const filtered = getFilteredEvents();
        $("#movBasisLabel").textContent = state.settings.basis;

        $("#mainTitle").textContent = "Movimenti";
        $("#mainSubtitle").innerHTML = [
          `<span class="badge badge--muted">basis: <b>${escapeHtml(state.settings.basis)}</b></span>`,
          `<span class="badge badge--muted">righe: <b>${filtered.length}</b></span>`
        ].join(" ");

        const wrap = $("#movementsTable");
        wrap.innerHTML = "";

        if (!filtered.length) {
          wrap.appendChild(emptyState("Nessun movimento nel filtro corrente."));
          return;
        }

        const table = el("table");
        const thead = el("thead");
        thead.appendChild(el("tr", {}, [
          el("th", {}, "Data (Accrual)"),
          el("th", {}, "Cash Date"),
          el("th", {}, "Titolo"),
          el("th", {}, "Categoria"),
          el("th", {}, "Metodo/Account"),
          el("th", {}, "Importo"),
        ]));

        const tbody = el("tbody");

        for (const e of filtered) {
          const pm = getPMById(e.paymentMethodId);
          const acc = getAccountById(e.accountId);

          const metaParts = [];
          if (e.type === "transfer") {
            const fa = getAccountById(e.fromAccountId);
            const ta = getAccountById(e.toAccountId);
            metaParts.push(`‚áÑ ${fa?.name || "?"} ‚Üí ${ta?.name || "?"}`);
          } else {
            metaParts.push(pm?.name ? `üí≥ ${pm.name}` : "‚Äî");
            metaParts.push(acc?.name ? `üè¶ ${acc.name}` : "‚Äî");
          }

          const signed = eventSignedAmount(e);
          const amt = (e.amount == null) ? "‚Äî" : formatMoney(e.amount, state.settings.currency);
          const amtClass = signed >= 0 ? "amt-pos" : "amt-neg";

          const tr = el("tr", { style: "cursor:pointer;" });
          tr.addEventListener("click", () => openEventDrawer(e.id));

          tr.appendChild(el("td", {}, [
            el("div", { textContent: e.date || "‚Äî", style:"font-weight:1000;" }),
            el("div", { className: "row-sub", textContent: e.type })
          ]));
          tr.appendChild(el("td", {}, [
            el("div", { textContent: e.cashDate || e.date || "‚Äî", style:"font-weight:1000;" }),
            (state.settings.basis === "cash" && e.cashDate && e.date && e.cashDate !== e.date)
              ? el("div", { className: "row-sub", textContent: "cash‚â†accrual" })
              : el("div", { className: "row-sub", textContent: "" })
          ]));
          tr.appendChild(el("td", {}, [
            el("div", { textContent: e.title || "(senza titolo)", style:"font-weight:1000;" }),
            el("div", { className: "row-sub", textContent: e.notes ? e.notes.slice(0, 90) : "" })
          ]));
          tr.appendChild(el("td", {}, e.category || "Senza categoria"));
          tr.appendChild(el("td", {}, metaParts.join(" ¬∑ ")));
          tr.appendChild(el("td", { className: amtClass }, amt));

          tbody.appendChild(tr);
        }

        table.append(thead, tbody);
        wrap.appendChild(table);
      };

      const computeMonthlyReportClient = (yyyymm) => {
        const basis = state.settings.basis;
        const cur = state.settings.currency;

        const eventsMonth = state.events.filter(e => {
          const dISO = (basis === "cash") ? (e.cashDate || e.date) : e.date;
          return monthKey(dISO) === yyyymm;
        });

        let income = 0, expense = 0;
        const byCat = new Map();

        for (const e of eventsMonth) {
          if (e.type === "income") income += Number(e.amount || 0);
          else if (e.type === "expense") {
            expense += Number(e.amount || 0);
            const c = (e.category || "Senza categoria").trim();
            byCat.set(c, (byCat.get(c) || 0) + Number(e.amount || 0));
          }
        }

        const net = income - expense;

        const topCats = Array.from(byCat.entries())
          .sort((a,b)=>b[1]-a[1])
          .slice(0, 10);

        const cc = computeCreditCardKPIs({ monthISO: yyyymm + "-01" });

        return { yyyymm, income, expense, net, topCats, cc, currency: cur, basis };
      };

      const renderReportCats = (topCats, totalExpense) => {
        const host = $("#repCats");
        host.innerHTML = "";
        if (!topCats.length) {
          host.appendChild(emptyState("Nessuna uscita per categoria."));
          return;
        }

        const max = Math.max(...topCats.map(([,v])=>v), 1);

        for (const [cat, val] of topCats) {
          const pct = Math.round((val / max) * 100);
          const row = el("div", { className: "panel", style: "padding:10px; cursor:pointer;" });
          row.addEventListener("click", () => {
            state.settings.mode = "movements";
            state.settings.category = cat.toLowerCase();
            saveSettings();
            render();
          });

          row.appendChild(el("div", { style:"display:flex;gap:10px;justify-content:space-between;align-items:center;" }, [
            el("div", { style:"font-weight:1000;" }, cat),
            el("div", { style:"font-weight:1000;" }, formatMoney(val, state.settings.currency))
          ]));

          row.appendChild(el("div", { style:"height:8px" }));
          row.appendChild(el("div", { style:`height:10px;border-radius:999px;border:1px solid rgba(128,128,128,0.18); background: rgba(128,128,128,0.08); overflow:hidden;` }, [
            el("div", { style:`height:100%; width:${pct}%; background: rgba(80,160,255,0.55);` })
          ]));

          const share = totalExpense > 0 ? Math.round((val / totalExpense) * 100) : 0;
          row.appendChild(el("div", { className: "help", style:"margin-top:6px;" }, `${share}% delle uscite del mese`));

          host.appendChild(row);
        }
      };

      const runReports = async () => {
        const errEl = $("#repError");
        errEl.style.display = "none";
        errEl.textContent = "";

        const monthVal = $("#repMonth").value;
        if (!monthVal) return;

        try {
          let data = null;
          try { data = await API.reportMonthly({ month: monthVal, basis: state.settings.basis }); }
          catch (_) { data = null; }

          if (!data || typeof data !== "object") data = computeMonthlyReportClient(monthVal);

          const income = Number(data.income || 0);
          const expense = Number(data.expense || 0);
          const net = Number(data.net || (income - expense));

          $("#repIncome").textContent = formatMoney(income, state.settings.currency);
          $("#repExpense").textContent = formatMoney(expense, state.settings.currency);
          $("#repNet").textContent = formatMoney(net, state.settings.currency);

          $("#repIncomeSub").textContent = `basis=${state.settings.basis}`;
          $("#repExpenseSub").textContent = `basis=${state.settings.basis}`;
          $("#repNetSub").textContent = "income ‚àí expense";

          $("#repCatMeta").textContent = `${(data.topCats || []).length} categorie`;
          renderReportCats(data.topCats || [], expense);

          const cc = data.cc || computeCreditCardKPIs({ monthISO: monthVal + "-01" });
          $("#repCCMeta").textContent = `mese ${monthVal}`;
          $("#repCCOutstanding").textContent = formatMoney(cc.outstanding, state.settings.currency);
          $("#repCCOutstandingSub").textContent = `charges‚àísettlement`;
          $("#repCCSpent").textContent = formatMoney(cc.spentMonth, state.settings.currency);
          $("#repCCPaid").textContent = formatMoney(cc.paidMonth, state.settings.currency);

        } catch (e) {
          errEl.style.display = "";
          errEl.textContent = e?.message || "Errore report";
        }
      };

const renderSetup = () => {
  $("#setupError").style.display = "none";
  $("#setupError").textContent = "";

  const accHost = $("#setupAccounts");
  const pmHost = $("#setupPMs");
  const catHost = $("#setupCats");

  accHost.innerHTML = "";
  pmHost.innerHTML = "";
  catHost.innerHTML = "";

  const accs = state.meta.accounts || [];
  const pms = state.meta.paymentMethods || [];

  $("#setupAccMeta").textContent = `${accs.length} accounts`;
  $("#setupPMMeta").textContent = `${pms.length} metodi`;

  // Accounts
  if (!accs.length) {
    accHost.appendChild(emptyState("Nessun account configurato."));
  } else {
    for (const a of accs) {
      accHost.appendChild(
        el("div", { className: "panel", style: "padding:10px;" }, [
          el("div", { style: "display:flex;justify-content:space-between;align-items:center;gap:10px;" }, [
            el("div", { style: "font-weight:1000;" }, a.name),
            el("span", { className: "badge badge--muted" }, a.type || "‚Äî")
          ]),
          el("div", { className: "help" }, `id=${a.id} ¬∑ currency=${a.currency || state.settings.currency || "EUR"}`)
        ])
      );
    }
  }

  // Payment Methods
  if (!pms.length) {
    pmHost.appendChild(emptyState("Nessun metodo configurato."));
  } else {
    for (const p of pms) {
      const defaultAccName = p.defaultAccountId
        ? (getAccountById(p.defaultAccountId)?.name || p.defaultAccountId)
        : "";

      const info = [
        `id=${p.id || "‚Äî"}`,
        p.defaultAccountId ? ` ¬∑ defaultAcc=${defaultAccName}` : "",
        p.settlementRule ? ` ¬∑ rule=${p.settlementRule}` : ""
      ].join("");

      pmHost.appendChild(
        el("div", { className: "panel", style: "padding:10px;" }, [
          el("div", { style: "display:flex;justify-content:space-between;align-items:center;gap:10px;" }, [
            el("div", { style: "display:flex;align-items:center;gap:10px;" }, [
              el("div", { style: "font-weight:1000;" }, p.name || "Metodo"),
              el("span", { className: "badge badge--muted" }, p.kind || "‚Äî")
            ]),
            el("div", { className: "help" }, info)
          ])
        ])
      );
    }
  }

  // Categories
  const cats = collectCategories();
  $("#setupCatMeta").textContent = `${cats.length} categorie`;

  if (!cats.length) {
    catHost.appendChild(emptyState("Nessuna categoria rilevata."));
  } else {
    const wrap = el("div", { style: "display:flex;gap:8px;flex-wrap:wrap;" });
    for (const c of cats) {
      wrap.appendChild(
        el("span", { className: "badge badge--muted", style: "cursor:pointer;" }, c)
      );
    }
    catHost.appendChild(wrap);
  }
};


      const collectCategories = () => {
        const set = new Set();
        for (const c of safeArr(state.meta.categories)) set.add(String(c).trim()).delete("");
        for (const e of state.events) set.add(String(e.category || "").trim()).delete("");
        const out = Array.from(set).filter(Boolean);
        out.sort((a,b)=>a.localeCompare(b, "it", { sensitivity:"base" }));
        return out;
      };

      const fillSelect = (sel, items, { addAll = false, allLabel = "Tutti" } = {}) => {
        sel.innerHTML = "";
        if (addAll) sel.appendChild(el("option", { value:"all" }, allLabel));
        for (const it of items) {
          sel.appendChild(el("option", { value: it.value }, it.label));
        }
      };

      // --- PATCH v3.1: refreshMetaUI non resetta pi√π i select del modal ---
      const refreshMetaUI = () => {
        const cats = collectCategories();
      
        // salva valori attuali (IMPORTANTISSIMO per non resettare il modal)
        const prevModalPM = $("#evtPaymentMethod")?.value ?? "";
        const prevModalAcc = $("#evtAccount")?.value ?? "";
        const prevModalFrom = $("#evtFromAccount")?.value ?? "";
        const prevModalTo = $("#evtToAccount")?.value ?? "";
      
        // Explorer filters selects
        fillSelect(
          $("#categorySelect"),
          cats.map(c => ({ value: c.toLowerCase(), label: c })),
          { addAll: true, allLabel: "Tutte" }
        );
      
        fillSelect(
          $("#accountSelect"),
          safeArr(state.meta.accounts).map(a => ({ value: a.id, label: a.name })),
          { addAll: true, allLabel: "Tutti" }
        );
      
        fillSelect(
          $("#paymentMethodSelect"),
          safeArr(state.meta.paymentMethods).map(p => ({ value: p.id, label: p.name })),
          { addAll: true, allLabel: "Tutti" }
        );
      
        // Modal selects (aggiungo anche possibilit√† valore vuoto per transfer)
        fillSelect(
          $("#evtPaymentMethod"),
          [
            { value: "", label: "‚Äî" },
            ...safeArr(state.meta.paymentMethods).map(p => ({ value: p.id, label: p.name }))
          ],
          { addAll: false }
        );
      
        fillSelect(
          $("#evtAccount"),
          [
            { value: "", label: "‚Äî" },
            ...safeArr(state.meta.accounts).map(a => ({ value: a.id, label: a.name }))
          ],
          { addAll: false }
        );
      
        fillSelect(
          $("#evtFromAccount"),
          safeArr(state.meta.accounts).map(a => ({ value: a.id, label: a.name })),
          { addAll: false }
        );
      
        fillSelect(
          $("#evtToAccount"),
          safeArr(state.meta.accounts).map(a => ({ value: a.id, label: a.name })),
          { addAll: false }
        );
      
        // Datalist categories
        const dl = $("#categoryList");
        dl.innerHTML = "";
        for (const c of cats) dl.appendChild(el("option", { value: c }));
      
        // restore selezioni explorer
        if (state.settings.category && state.settings.category !== "all") {
          $("#categorySelect").value = state.settings.category;
        } else {
          $("#categorySelect").value = "all";
        }
        $("#accountSelect").value = state.settings.account || "all";
        $("#paymentMethodSelect").value = state.settings.paymentMethod || "all";
      
        // restore selezioni modal (NON resetta pi√π)
        setSelectSafe($("#evtPaymentMethod"), prevModalPM, "");
        setSelectSafe($("#evtAccount"), prevModalAcc, "");
        setSelectSafe($("#evtFromAccount"), prevModalFrom);
        setSelectSafe($("#evtToAccount"), prevModalTo);
      };


      const renderMiniCalendar = () => {
        const host = $("#miniCal");
        host.innerHTML = "";

        const anchor = state.anchorDate;
        const monthStart = startOfMonth(anchor);
        const gridStart = startOfWeek(monthStart);

        const head = el("div", { className:"mini-cal__head" }, [
          el("button", { className:"btn btn--icon btn--ghost", type:"button", id:"miniPrev", "aria-label":"Mese precedente" }, "‚Äπ"),
          el("b", { textContent: formatMonthHuman(monthStart) }),
          el("button", { className:"btn btn--icon btn--ghost", type:"button", id:"miniNext", "aria-label":"Mese successivo" }, "‚Ä∫")
        ]);

        const grid = el("div", { className:"mini-cal__grid" });

        // dow
        for (const n of ["L", "M", "M", "G", "V", "S", "D"]) {
          grid.appendChild(el("div", { className:"mini-cal__dow", textContent:n }));
        }

        const todayISO = toISODate(new Date());
        const anchorISO = toISODate(anchor);

        // map days with events (filtered by current global filters/range)
        const filtered = getFilteredEvents();
        const byDay = new Map();
        for (const e of filtered) {
          const iso = eventDateForBasis(e, state.settings.basis);
          byDay.set(iso, (byDay.get(iso) || 0) + 1);
        }

        for (let i = 0; i < 42; i++) {
          const d = addDays(gridStart, i);
          const iso = toISODate(d);
          const inMonth = d.getMonth() === monthStart.getMonth();

          const dayBtn = el("button", {
            type:"button",
            className: [
              "mini-cal__day",
              inMonth ? "" : "is-out",
              iso === todayISO ? "is-today" : "",
              iso === anchorISO ? "is-anchor" : ""
            ].filter(Boolean).join(" "),
            "data-date": iso
          }, String(d.getDate()));

          if (byDay.get(iso)) dayBtn.appendChild(el("span", { className:"mini-cal__dot", "aria-hidden":"true" }));

          dayBtn.addEventListener("click", () => {
            state.anchorDate = fromISODate(iso);
            // se sei in day, resta in day e vai l√¨; in month resta in month
            if (state.settings.view === "day") {
              // no-op
            }
            saveSettings();
            render();
          });

          grid.appendChild(dayBtn);
        }

        host.append(head, grid);

        $("#miniPrev").addEventListener("click", () => {
          state.anchorDate = addMonths(state.anchorDate, -1);
          renderMiniCalendar();
        });
        $("#miniNext").addEventListener("click", () => {
          state.anchorDate = addMonths(state.anchorDate, +1);
          renderMiniCalendar();
        });
      };

      const setMode = (mode) => {
        state.settings.mode = mode;
        saveSettings();
        render();
      };

      const setView = (view) => {
        state.settings.view = view;
        saveSettings();
        render();
      };

      const setBasis = (basis) => {
        state.settings.basis = basis;
        $("#basisBadge").textContent = basis === "cash" ? "Cash" : "Accrual";
        saveSettings();
        render();
      };

      const setDensity = (density) => {
        state.settings.density = density;
        saveSettings();
        render();
      };

      const setExplorerTab = (tab) => {
        state.settings.explorerTab = tab;
        saveSettings();
        // tabs visibility
        $("#explorerCalendarTab").style.display = (tab === "calendar") ? "" : "none";
        $("#explorerFiltersTab").style.display = (tab === "filters") ? "" : "none";
        $("#explorerRangeTab").style.display = (tab === "range") ? "" : "none";
        $("#explorerDataTab").style.display = (tab === "data") ? "" : "none";
        // pressed chips
        $$("#sidebar .chip").forEach(c => c.setAttribute("aria-pressed", String(c.dataset.tab === tab)));
      };

      const setInsightsTab = (tab) => {
        state.settings.insightsTab = tab;
        saveSettings();
        $("#insightsStatsTab").style.display = tab === "stats" ? "" : "none";
        $("#insightsCardTab").style.display = tab === "card" ? "" : "none";
        $("#insightsForecastTab").style.display = tab === "forecast" ? "" : "none";
        $$("#insights .chip").forEach(c => c.setAttribute("aria-pressed", String(c.dataset.tab === tab)));
      };

      const showModeView = () => {
        const mode = state.settings.mode;
        $("#calendarView").style.display = (mode === "calendar") ? "" : "none";
        $("#movementsView").style.display = (mode === "movements") ? "" : "none";
        $("#reportsView").style.display = (mode === "reports") ? "" : "none";
        $("#setupView").style.display = (mode === "setup") ? "" : "none";

        // calendar view switch visible solo in calendario
        $("#calendarViewSwitch").style.display = (mode === "calendar") ? "" : "none";

        $$("#modeSwitch .rail-btn").forEach(b => {
          b.setAttribute("aria-pressed", String(b.dataset.mode === mode));
        });
      };

      const setSidebarOpen = (open) => {
        state.settings.sidebarOpen = !!open;
        $("#sidebar").dataset.open = open ? "true" : "false";
        saveSettings();
      };

      const setInsightsOpen = (open) => {
        state.settings.insightsOpen = !!open;
        $("#insights").dataset.open = open ? "true" : "false";
        saveSettings();
      };

      const updateApiStatusBadge = () => {
        const badge = $("#apiStatus");
        if (state.apiOnline) {
          badge.className = "badge badge--ok";
          badge.textContent = "online";
        } else {
          badge.className = "badge badge--muted";
          badge.textContent = "offline";
        }
      };

      const updateFilterBadges = () => {
        const parts = [];
        if ((state.settings.category || "all") !== "all") parts.push(`cat:${state.settings.category}`);
        if ((state.settings.account || "all") !== "all") parts.push(`acc:${state.settings.account}`);
        if ((state.settings.paymentMethod || "all") !== "all") parts.push(`pm:${state.settings.paymentMethod}`);
        if (!(state.settings.includeIncome && state.settings.includeExpense && state.settings.includeTransfers && state.settings.includeOther)) parts.push("type:custom");
        if ((state.settings.search || "").trim()) parts.push("search");
        $("#filtersMetaBadge").textContent = parts.length ? `Filtri: ${parts.join(" ¬∑ ")}` : "Filtri: nessuno";

        $("#activeFiltersMeta").textContent = parts.length ? parts.join(" ¬∑ ") : "nessun filtro attivo";
      };

      const refreshInsights = () => {
        const filtered = getFilteredEvents();
        const stats = computeVisibleStats(filtered);

        const cur = state.settings.currency;
        const todayISO = toISODate(new Date());

        $("#statsMeta").textContent = `${toISODate(stats.rangeStart)} ‚Üí ${toISODate(stats.rangeEnd)} ¬∑ basis=${state.settings.basis}`;

        const curBal = computeBalanceUpTo(filtered, state.settings.initialBalance, todayISO, state.settings.basis);
        $("#statCurrentBalance").textContent = formatMoney(curBal, cur);
        $("#statCurrentBalanceMeta").textContent = `oggi ${todayISO} ¬∑ init ${formatMoney(state.settings.initialBalance, cur)}`;

        const balAtISO = state.settings.balanceAtDate || todayISO;
        $("#balanceAtDate").value = balAtISO;
        const balAt = computeBalanceUpTo(filtered, state.settings.initialBalance, balAtISO, state.settings.basis);
        $("#statBalanceAtDate").textContent = formatMoney(balAt, cur);

        $("#statIncome").textContent = formatMoney(stats.incomeSum, cur);
        $("#statExpense").textContent = formatMoney(stats.expenseSum, cur);
        $("#statNet").textContent = formatMoney(stats.net, cur);

        $("#statIncomeCount").textContent = `income ${stats.incomeCount}`;
        $("#statExpenseCount").textContent = `expense ${stats.expenseCount}`;
        $("#statTransferCount").textContent = `transfer ${stats.transferCount}`;

        // delta cash vs accrual (balance at date)
        const balCash = computeBalanceUpTo(filtered, state.settings.initialBalance, balAtISO, "cash");
        const balAccrual = computeBalanceUpTo(filtered, state.settings.initialBalance, balAtISO, "accrual");
        $("#statDelta").textContent = formatMoney(balCash - balAccrual, cur);

        // snapshot list last 14 days within visible range
        const snapHost = $("#snapshotList");
        snapHost.innerHTML = "";
        const snaps = stats.snapshots.slice(-14);
        if (!snaps.length) snapHost.appendChild(emptyState("Nessun dato snapshot."));
        else {
          for (const s of snaps) {
            snapHost.appendChild(el("div", { className:"panel", style:"padding:10px; display:flex; justify-content:space-between; gap:10px; align-items:center;" }, [
              el("div", { style:"font-weight:1000;" }, s.date),
              el("div", { style:"font-weight:1000;" }, formatMoney(s.balance, cur))
            ]));
          }
        }

        // credit card KPIs
        const cc = computeCreditCardKPIs({ monthISO: monthKey(todayISO) + "-01" });
        $("#ccOutstanding").textContent = formatMoney(cc.outstanding, cur);
        $("#ccOutstandingMeta").textContent = `charges‚àísettlement ¬∑ basis mix`;
        $("#ccSpentMonth").textContent = formatMoney(cc.spentMonth, cur);
        $("#ccPaidMonth").textContent = formatMoney(cc.paidMonth, cur);
        $("#ccHelp").textContent = `Se il settlement appare come ‚ÄúSparkasse Kreditkartenabrechnung‚Äù, usa TRANSFER Bank ‚Üí Credit Card (Cash).`;
        // ‚úÖ Amazon card KPIs
        const k = computeCardAvailable("amazon_cc");
        $("#amzLimit").value = String(getCCCfg("amazon_cc").limit || 0);
        $("#amzCustomPay").value = String(getCCCfg("amazon_cc").customMonthly || 0);
        
        const dueISO = getNextDueISOForCard("amazon_cc");
        const dueAmt = dueISO ? computeDueAmountForISO("amazon_cc", dueISO) : 0;
        
        $("#amzPayHint").textContent =
          `Outstanding: ${formatMoney(k.outstanding)} ¬∑ Disponibile: ${formatMoney(k.available)} ¬∑ Prossima scadenza: ${dueISO || "‚Äî"} (${formatMoney(dueAmt)})`;

        renderForecast();
      };

      const applyRangeControls = () => {
        $("#fromDate").value = state.settings.fromDate || "";
        $("#toDate").value = state.settings.toDate || "";

        const mode = state.settings.rangeMode || "all";
        $$("#rangePresets .chip").forEach(ch => ch.setAttribute("aria-pressed", String(ch.dataset.preset === mode)));

        // enable/disable
        const enableFrom = (mode === "from" || mode === "between");
        const enableTo = (mode === "between");
        $("#fromDate").disabled = !enableFrom;
        $("#toDate").disabled = !enableTo;
      };

      // --- PATCH v3.1: openEventModal stabile (no reset select) + touched reset ---
      const openEventModal = ({ dateISO = null, eventId = null } = {}) => {
        const dlg = $("#eventModal");
      
        // reset touched flags ad ogni apertura modal
        modalAccountTouched = false;
        modalFromToTouched = false;
        modalTypeTouched = false;
      
        // load event if edit
        let evt = null;
        if (eventId) evt = state.events.find(e => e.id === eventId) || null;
      
        // set draft ID SUBITO (serve per hint sparkasse)
        state.draftEventId = evt?.id || null;
      
        // IMPORTANT: riempi i select PRIMA di settare valori
        refreshMetaUI();
      
        const titleEl = $("#eventModalTitle");
        titleEl.textContent = evt ? "Modifica evento" : "Nuovo evento";
      
        const baseDate = dateISO || evt?.date || toISODate(state.anchorDate);
      
        $("#evtTitle").value = evt?.title || "";
        $("#evtType").value = evt?.type || "expense";
        $("#evtAmount").value = (evt?.amount == null) ? "" : String(evt.amount);
        $("#evtCategory").value = evt?.category || "";
        $("#evtDate").value = evt?.date || baseDate;
        $("#evtTime").value = evt?.time || "";
        $("#evtNotes").value = evt?.notes || "";
        $("#evtPinned").checked = !!evt?.pinned;
      
        // payment method + account (per transfer li svuotiamo)
        const defaultPM = safeArr(state.meta.paymentMethods)[0]?.id || "";
        const defaultAcc = safeArr(state.meta.accounts)[0]?.id || "";
      
        setSelectSafe($("#evtPaymentMethod"), evt?.paymentMethodId || defaultPM, "");
        setSelectSafe($("#evtAccount"), evt?.accountId || defaultAcc, "");
      
        setSelectSafe($("#evtFromAccount"), evt?.fromAccountId || defaultAcc);
        setSelectSafe($("#evtToAccount"), evt?.toAccountId || defaultAcc);
      
        $("#evtRecurrence").value = evt?.recurrence || "none";
        $("#evtRecurrenceDays").value = evt?.recurrenceDays == null ? "" : String(evt.recurrenceDays);
        $("#evtRecurrenceUntil").value = "";
      
        // sync UI (transfer fields, hide pm, disable account ecc)
        syncModalTypeUI();
      
        // se √® nuovo evento e PM ha default account, applicalo
        applyPMDefaultsToModal({ forceAccount: false });
      
        // cash date logic
        const pm = getPMById($("#evtPaymentMethod").value);
        const type = $("#evtType").value;
        const accrualISO = $("#evtDate").value;
      
        const autoCash = computeCashDate({ accrualISO, pm, type });
        const cashISO = evt?.cashDate || autoCash;
      
        $("#evtCashDate").value = cashISO || "";
        $("#evtCashOverride").checked = !!evt?.cashDate && evt.cashDate !== autoCash;
        $("#evtCashDate").disabled = !$("#evtCashOverride").checked;
      
        // recurrence fields + sparkasse hint
        updateRecurrenceFields();
        updateSparkasseHint();
      updateInstallmentUI(); // ‚úÖ NEW

        // open dialog
        if (typeof dlg.showModal === "function") dlg.showModal();
        else dlg.setAttribute("open", "");
      };


      const closeEventModal = () => {
        const dlg = $("#eventModal");
        if (typeof dlg.close === "function") dlg.close();
        else dlg.removeAttribute("open");
        state.draftEventId = null;
      };

      const openEventDrawer = (eventId) => {
        const evt = state.events.find(e => e.id === eventId) || null;
        if (!evt) return;

        state.selectedEventId = evt.id;

        const drawer = $("#eventDrawer");
        drawer.setAttribute("aria-hidden", "false");
        $("#drawerScrim").style.display = "";
        $("#drawerTitle").textContent = evt.title || "Evento";

        const pm = getPMById(evt.paymentMethodId);
        const acc = getAccountById(evt.accountId);
        const fa = getAccountById(evt.fromAccountId);
        const ta = getAccountById(evt.toAccountId);

        const signed = eventSignedAmount(evt);
        const amt = evt.amount == null ? "‚Äî" : formatMoney(evt.amount, state.settings.currency);

        const parts = [];

        parts.push(el("div", { className:"panel", style:"padding:12px;" }, [
          el("div", { style:"display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap;" }, [
            el("div", {}, [
              el("div", { style:"font-weight:1000;font-size:16px;" }, evt.title || "(senza titolo)"),
              el("div", { className:"help" }, `${evt.type} ¬∑ ${evt.category || "Senza categoria"}`),
              el("div", { style:"height:6px" }),
              el("div", { className:"help" }, `Accrual: ${evt.date || "‚Äî"} ${evt.time || ""}`.trim()),
              el("div", { className:"help" }, `Cash: ${evt.cashDate || evt.date || "‚Äî"}`)
            ]),
            el("div", { style:"text-align:right;" }, [
              el("div", { style:`font-weight:1000;font-size:18px;` }, amt),
              el("div", { className:"help" }, signed >= 0 ? "saldo ‚Üë" : "saldo ‚Üì")
            ])
          ]),
        ]));

        parts.push(el("div", { className:"panel", style:"padding:12px;" }, [
          el("div", { style:"font-weight:1000;letter-spacing:.2px;margin-bottom:8px;" }, "Dettagli"),
          el("div", { className:"help" }, evt.notes ? evt.notes : "‚Äî"),
          el("div", { style:"height:10px" }),
          el("div", { className:"help" }, [
            pm?.name ? `Metodo: ${pm.name}` : "Metodo: ‚Äî",
            evt.type === "transfer"
              ? ` ¬∑ Transfer: ${fa?.name || "?"} ‚Üí ${ta?.name || "?"}`
              : ` ¬∑ Account: ${acc?.name || "‚Äî"}`
          ].join(""))
        ]));

        if (evt.seriesId) {
          parts.push(el("div", { className:"panel", style:"padding:12px;" }, [
            el("div", { style:"font-weight:1000;letter-spacing:.2px;margin-bottom:8px;" }, "Serie"),
            el("div", { className:"help" }, `seriesId=${evt.seriesId} ¬∑ master=${evt.seriesMaster ? "yes" : "no"}`),
            el("div", { style:"height:10px" }),
            el("div", { style:"display:flex;gap:10px;flex-wrap:wrap;" }, [
              el("button", { className:"btn btn--ghost", type:"button", id:"btnDelSeriesAll" }, "Elimina serie"),
              el("button", { className:"btn btn--ghost", type:"button", id:"btnDelSeriesFrom" }, "Elimina da qui in poi")
            ])
          ]));
        }

        const detail = $("#eventDetail");
        detail.innerHTML = "";
        parts.forEach(p => detail.appendChild(p));

        // actions
        $("#btnEditEvent").onclick = () => openEventModal({ eventId: evt.id });
        $("#btnDeleteEvent").onclick = () => deleteEventFlow(evt);

        // series actions (if present)
        const bAll = $("#btnDelSeriesAll");
        const bFrom = $("#btnDelSeriesFrom");
        if (bAll) {
          bAll.onclick = async () => {
            if (!evt.seriesId) return;
            if (!confirm("Eliminare tutta la serie?")) return;
            try {
              await API.deleteSeries(evt.seriesId);
              await reloadAll();
              closeDrawer();
            } catch (e) {
              alert(e?.message || "Errore elimina serie");
            }
          };
        }
        if (bFrom) {
          bFrom.onclick = async () => {
            if (!evt.seriesId) return;
            const fromISO = eventDateForBasis(evt, state.settings.basis) || evt.date;
            if (!confirm(`Eliminare la serie da ${fromISO} in poi?`)) return;
            try {
              await API.deleteSeriesFrom(evt.seriesId, fromISO);
              await reloadAll();
              closeDrawer();
            } catch (e) {
              alert(e?.message || "Errore elimina serie da data");
            }
          };
        }
      };

      const closeDrawer = () => {
        $("#eventDrawer").setAttribute("aria-hidden", "true");
        $("#drawerScrim").style.display = "none";
        state.selectedEventId = null;
      };

      const deleteEventFlow = async (evt) => {
        if (!evt) return;
        const ok = confirm("Eliminare questo evento?");
        if (!ok) return;

        try {
          await API.deleteEvent(evt.id);
          await reloadAll();
          closeDrawer();
        } catch (e) {
          alert(e?.message || "Errore eliminazione");
        }
      };

      const updateRecurrenceFields = () => {
        const r = $("#evtRecurrence").value;
        $("#recDaysField").style.display = (r === "custom_days") ? "" : "none";
        $("#recSpanField").style.display = (r !== "none") ? "" : "none";
      };

      // --- PATCH v3.1: hint + preset automatico Sparkasse (solo evento nuovo) ---
      const updateSparkasseHint = () => {
        const t = ($("#evtTitle").value || "").toLowerCase();
        const hint = $("#evtTitleHint");
      
        const isSpark =
          t.includes("sparkasse kreditkartenabrechnung") ||
          t.includes("kreditkartenabrechnung");
      
        hint.style.display = isSpark ? "" : "none";
      
        // auto preset SOLO se:
        // - evento nuovo (non editing)
        // - non hai gi√† toccato type/from-to
        if (!isSpark) return;
        if (state.draftEventId) return;
      
        applySparkasseTransferPresetInModal();
      };
      

      const recomputeCashDateInModal = () => {
        const override = $("#evtCashOverride").checked;
        $("#evtCashDate").disabled = !override;

        if (override) return;

        const accrualISO = $("#evtDate").value;
        const type = $("#evtType").value;
        const pm = getPMById($("#evtPaymentMethod").value);
        const autoCash = computeCashDate({ accrualISO, pm, type });
        $("#evtCashDate").value = autoCash || "";
      };

// --- PATCH v3.1: payload clean per transfer (no PM/account) ---
const readEventFromModal = () => {
  const title = $("#evtTitle").value.trim();
  const type = $("#evtType").value;

  const amountRaw = $("#evtAmount").value;
  const amount = amountRaw === "" ? null : Number(amountRaw);

  const category = $("#evtCategory").value.trim() || "Senza categoria";
  const date = $("#evtDate").value;
  const time = $("#evtTime").value || "";
  const notes = $("#evtNotes").value || "";
  const pinned = !!$("#evtPinned").checked;

  const isTransfer = (type === "transfer");

  const paymentMethodId = isTransfer ? "" : ($("#evtPaymentMethod").value || "");
  const accountId = isTransfer ? "" : ($("#evtAccount").value || "");

  const fromAccountId = $("#evtFromAccount").value || "";
  const toAccountId = $("#evtToAccount").value || "";

  const pm = getPMById(paymentMethodId);
  const autoCash = computeCashDate({ accrualISO: date, pm, type });

  const cashOverride = $("#evtCashOverride").checked;
  const cashDate = cashOverride ? ($("#evtCashDate").value || autoCash) : autoCash;

  const recurrence = $("#evtRecurrence").value || "none";
  const recurrenceDays = recurrence === "custom_days"
    ? (Number($("#evtRecurrenceDays").value || 0) || null)
    : null;

  return {
    title,
    type,
    amount,
    category,
    date,
    time,
    notes,
    pinned,
    cashDate,
    paymentMethodId,
    accountId,
    fromAccountId: isTransfer ? fromAccountId : "",
    toAccountId: isTransfer ? toAccountId : "",
    recurrence,
    recurrenceDays
  };
};


const upsertEvent = async () => {
  const payload = readEventFromModal();

  if (!payload.title) { alert("Titolo obbligatorio."); return; }
  if (!payload.date) { alert("Data obbligatoria."); return; }

  // ‚úÖ RATE AMAZON
  const pmId = payload.paymentMethodId || "";
  const isInst = $("#evtIsInstallment").checked && isAmazonPM(pmId) && payload.type === "expense";

  if (isInst) {
    if (state.draftEventId) {
      alert("Per semplicit√†: modifica rata singola oppure elimina e ricrea il piano rateale.");
      return;
    }

    const count = Math.max(2, Number($("#evtInstCount").value || 2));
    const mode = $("#evtInstMode").value;
    const startISO = $("#evtInstStart").value || payload.date;

    let sched = [];
    if (mode === "fixed") {
      const fixedAmt = Number($("#evtInstFixedAmt").value || 0);
      if (fixedAmt <= 0) { alert("Importo rata non valido."); return; }
      sched = computeInstallmentSchedule({ startISO, count, mode, fixedAmt });
    } else {
      const arr = readInstCustomAmounts(count);
      const sum = arr.reduce((s,v)=>s+Number(v||0), 0);
      if (sum <= 0) { alert("Inserisci importi rate validi."); return; }
      sched = computeInstallmentSchedule({ startISO, count, mode, customAmts: arr });
    }

    const total = sched.reduce((s,x)=>s+Number(x.amount||0), 0);

    // ‚úÖ CHECK PLAFOND
    const cardAccId = getCardAccountIdFromPM(pmId);
    if (cardAccId) {
      const k = computeCardAvailable(cardAccId);
      const after = k.outstanding + total;
      if (after > k.limit) {
        const ok = confirm(
          `ATTENZIONE: superi il plafond!\n` +
          `Limit: ${formatMoney(k.limit)}\n` +
          `Outstanding: ${formatMoney(k.outstanding)}\n` +
          `Nuovo totale: ${formatMoney(total)}\n` +
          `Dopo: ${formatMoney(after)}\n\nVuoi salvare lo stesso?`
        );
        if (!ok) return;
      }
    }

    const groupId = uid();
    const pm = getPMById(pmId);

    try {
      for (let i = 0; i < sched.length; i++) {
        const it = sched[i];
        const cashDate = computeCashDate({ accrualISO: it.date, pm, type: "expense" });

        await API.createEvent({
          ...payload,
          title: `${payload.title} ¬∑ Rata ${i+1}/${sched.length}`,
          amount: Number(it.amount || 0),
          date: it.date,
          cashDate,
          notes: `${payload.notes || ""}\n[AMZ_INST:${groupId}]`.trim()
        });
      }

      closeEventModal();
      await reloadAll();
      return;
    } catch (e) {
      alert(e?.message || "Errore salvataggio rate");
      return;
    }
  }

  // ‚úÖ NORMALE (single)
  try {
    if (state.draftEventId) await API.updateEvent(state.draftEventId, payload);
    else await API.createEvent(payload);

    closeEventModal();
    await reloadAll();
  } catch (e) {
    alert(e?.message || "Errore salvataggio");
  }
};

      const materializeSeriesFlow = async () => {
        if (!state.draftEventId) {
          alert("Prima salva l'evento (master).");
          return;
        }
        const evt = state.events.find(e => e.id === state.draftEventId) || null;
        if (!evt?.seriesId) {
          alert("Questo evento non √® una serie.");
          return;
        }
        const toISO = $("#evtRecurrenceUntil").value;
        if (!toISO) {
          alert("Scegli una data target.");
          return;
        }
        try {
          await API.materializeSeries(evt.seriesId, toISO);
          await reloadAll();
          alert("Occorrenze materializzate.");
        } catch (e) {
          alert(e?.message || "Errore materializzazione");
        }
      };

      const exportJson = () => {
        const payload = {
          exportedAt: new Date().toISOString(),
          settings: state.settings,
          meta: state.meta,
          events: state.events
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `finance-calendar-v3-export-${toISODate(new Date())}.json`;
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 2500);
      };

      const importJson = async (file) => {
        if (!file) return;
        const text = await file.text();
        const data = JSON.parse(text);

        if (!data || typeof data !== "object") {
          alert("JSON non valido.");
          return;
        }

        // settings
        if (data.settings && typeof data.settings === "object") {
          state.settings = { ...state.settings, ...data.settings };
          saveSettings();
        }

        // meta (solo in memoria)
        if (data.meta && typeof data.meta === "object") {
          // normalize
          state.meta.accounts = safeArr(data.meta.accounts).map(normAccount);
          state.meta.paymentMethods = safeArr(data.meta.paymentMethods).map(normPM);
          state.meta.categories = safeArr(data.meta.categories).map(String);
        }

        // events: create on backend
        const evts = safeArr(data.events).map(normalizeEvent);
        if (!evts.length) {
          alert("Import ok (nessun evento).");
          await reloadAll();
          return;
        }

        if (!confirm(`Importare ${evts.length} eventi? Verranno creati via API.`)) return;

        let ok = 0, fail = 0;
        for (const e of evts) {
          try {
            const payload = {
              title: e.title,
              type: e.type,
              amount: e.amount,
              category: e.category,
              date: e.date,
              time: e.time,
              notes: e.notes,
              pinned: e.pinned,
              cashDate: e.cashDate || e.date,
              paymentMethodId: e.paymentMethodId,
              accountId: e.accountId,
              fromAccountId: e.fromAccountId,
              toAccountId: e.toAccountId,
              recurrence: e.recurrence,
              recurrenceDays: e.recurrenceDays
            };
            await API.createEvent(payload);
            ok++;
          } catch (_) {
            fail++;
          }
        }

        alert(`Import completato. OK=${ok} ¬∑ FAIL=${fail}`);
        await reloadAll();
      };

const applyWizardSparkasse = async () => {
  const bankId = "bank";

  const sparkasseAccId = "sparkasse_cc";
  const sparkassePmId  = "sparkasse_card";

  const amazonAccId = "amazon_cc";
  const amazonPmId  = "amazon_card";

  const metaOverride = {
    accounts: [
      { id: bankId,        name: "Bank",                 type: "bank",        currency: state.settings.currency, isDefault: true },

      { id: sparkasseAccId,name: "Sparkasse Kreditkarte", type: "credit_card", currency: state.settings.currency, isDefault: false },

      { id: amazonAccId,   name: "Amazon Kreditkarte",    type: "credit_card", currency: state.settings.currency, isDefault: false },
    ],
    paymentMethods: [
      // Sparkasse
      {
        id: sparkassePmId,
        name: "Sparkasse CC",
        kind: "credit_card",
        defaultAccountId: bankId,
        settlementRule: "next_month_day",
        settlementParam: { day: 1, cardAccountId: sparkasseAccId }
      },

      // Amazon
      {
        id: amazonPmId,
        name: "Amazon CC",
        kind: "credit_card",
        defaultAccountId: bankId,
        settlementRule: "next_month_day",
        settlementParam: { day: 1, cardAccountId: amazonAccId }
      }
    ]
  };

  state.settings.metaOverride = metaOverride;
  saveSettings();

  state.meta.accounts = metaOverride.accounts.map(normAccount);
  state.meta.paymentMethods = metaOverride.paymentMethods.map(normPM);

  refreshMetaUI();
  renderSetup();

  alert("Wizard applicato (Sparkasse + Amazon Kreditkarte).");
};


      const applyMetaOverrideIfAny = () => {
        const mo = state.settings.metaOverride;
        if (!mo || typeof mo !== "object") return;
        const accs = safeArr(mo.accounts).map(normAccount);
        const pms = safeArr(mo.paymentMethods).map(normPM);
        if (accs.length) state.meta.accounts = accs;
        if (pms.length) state.meta.paymentMethods = pms;
      };

      const loadSettings = async () => {
        try {
          const data = await API.getSettings();
          if (data && typeof data === "object") {
            state.settings = { ...state.settings, ...data };
          }
        } catch (_) {
          // ignore
        }

        // normalize booleans/defaults
        state.settings.sidebarOpen = (state.settings.sidebarOpen !== false);
        state.settings.insightsOpen = (state.settings.insightsOpen !== false);
        state.settings.includeIncome = (state.settings.includeIncome !== false);
        state.settings.includeExpense = (state.settings.includeExpense !== false);
        state.settings.includeTransfers = (state.settings.includeTransfers !== false);
        state.settings.includeOther = (state.settings.includeOther !== false);

        // anchor date from today
        state.anchorDate = startOfDay(new Date());

        // apply UI values
        $("#apiBaseInput").value = state.settings.apiBase || API.base();
        $("#searchInput").value = state.settings.search || "";
        $("#forecastTo").value = state.settings.forecastTo || "";
        $("#forecastMode").value = state.settings.forecastMode || "daily";
        $("#repMonth").value = $("#repMonth").value || monthKey(toISODate(new Date()));

        applyRangeControls();
        setSidebarOpen(state.settings.sidebarOpen);
        setInsightsOpen(state.settings.insightsOpen);
        setExplorerTab(state.settings.explorerTab || "calendar");
        setInsightsTab(state.settings.insightsTab || "stats");
      };

      const loadMeta = async () => {
        try {
          const data = await API.getMeta();
          state.apiOnline = true;
          updateApiStatusBadge();

          const accs = safeArr(data?.accounts).map(normAccount);
          const pms = safeArr(data?.paymentMethods).map(normPM);
          const cats = safeArr(data?.categories).map(String);

          state.meta.accounts = accs;
          state.meta.paymentMethods = pms;
          state.meta.categories = cats;

          applyMetaOverrideIfAny();
        } catch (_) {
          state.apiOnline = false;
          updateApiStatusBadge();
          applyMetaOverrideIfAny();
        }
      };

      const loadEvents = async () => {
        try {
          const data = await API.listEvents();
          const arr = safeArr(data?.events ?? data);
          state.events = arr.map(normalizeEvent);
          state.apiOnline = true;
          updateApiStatusBadge();
        } catch (_) {
          state.events = [];
          state.apiOnline = false;
          updateApiStatusBadge();
        }
      };

      const reloadAll = async () => {
        await loadMeta();
        await loadEvents();
        refreshMetaUI();
        render();
      };

      const render = () => {
        // mode view
        showModeView();

        // basis switch pressed
        $$("#basisSwitch .btn--seg").forEach(b => {
          b.setAttribute("aria-pressed", String(b.dataset.basis === state.settings.basis));
        });
        $("#basisBadge").textContent = state.settings.basis === "cash" ? "Cash" : "Accrual";

        // view switch pressed
        $$("#calendarViewSwitch .btn--seg").forEach(b => {
          b.setAttribute("aria-pressed", String(b.dataset.view === state.settings.view));
        });

        // density pressed
        $$("#densitySwitch .btn--seg").forEach(b => {
          b.setAttribute("aria-pressed", String(b.dataset.density === state.settings.density));
        });

        updateFilterBadges();
        renderMiniCalendar();

        // title area depends on mode
        if (state.settings.mode === "calendar") renderCalendar();
        if (state.settings.mode === "movements") renderMovements();
        if (state.settings.mode === "reports") {
          $("#mainTitle").textContent = "Report";
          $("#mainSubtitle").textContent = "Mensile ¬∑ categorie ¬∑ carta";
          runReports();
        }
        if (state.settings.mode === "setup") {
          $("#mainTitle").textContent = "Setup";
          $("#mainSubtitle").textContent = "Accounts ¬∑ Payment Methods ¬∑ Wizard";
          renderSetup();
        }

        // insights always refresh (if visible)
        refreshInsights();

        // forecast input reflect
        $("#forecastTo").value = state.settings.forecastTo || "";
        $("#forecastMode").value = state.settings.forecastMode || "daily";

        // range controls reflect
        applyRangeControls();
      };

      const bindUI = () => {
        // rail mode switch
        $$("#modeSwitch .rail-btn").forEach(btn => {
          btn.addEventListener("click", () => setMode(btn.dataset.mode));
        });

        // sidebar toggle
        $("#btnSidebarToggle").addEventListener("click", () => {
          const open = $("#sidebar").dataset.open !== "true";
          setSidebarOpen(open);
        });

        // insights toggle
        $("#btnInsightsToggle").addEventListener("click", () => {
          const open = $("#insights").dataset.open !== "true";
          setInsightsOpen(open);
        });

        // date nav
        $("#btnPrev").addEventListener("click", () => {
          const v = state.settings.view;
          if (v === "day") state.anchorDate = addDays(state.anchorDate, -1);
          else if (v === "workweek" || v === "week" || v === "agenda") state.anchorDate = addDays(state.anchorDate, -7);
          else if (v === "month") state.anchorDate = addMonths(state.anchorDate, -1);
          else if (v === "year") state.anchorDate = addYears(state.anchorDate, -1);
          render();
        });

        $("#btnNext").addEventListener("click", () => {
          const v = state.settings.view;
          if (v === "day") state.anchorDate = addDays(state.anchorDate, +1);
          else if (v === "workweek" || v === "week" || v === "agenda") state.anchorDate = addDays(state.anchorDate, +7);
          else if (v === "month") state.anchorDate = addMonths(state.anchorDate, +1);
          else if (v === "year") state.anchorDate = addYears(state.anchorDate, +1);
          render();
        });

        $("#btnToday").addEventListener("click", () => {
          state.anchorDate = startOfDay(new Date());
          render();
        });

        // basis switch
        $$("#basisSwitch .btn--seg").forEach(b => {
          b.addEventListener("click", () => setBasis(b.dataset.basis));
        });

        // view switch
        $$("#calendarViewSwitch .btn--seg").forEach(b => {
          b.addEventListener("click", () => setView(b.dataset.view));
        });

        // density switch
        $$("#densitySwitch .btn--seg").forEach(b => {
          b.addEventListener("click", () => setDensity(b.dataset.density));
        });

        // search
        $("#searchInput").addEventListener("input", (ev) => {
          state.settings.search = ev.target.value || "";
          saveSettings();
          render();
        });

        // explorer tabs
        $$("#sidebar .chip").forEach(ch => {
          ch.addEventListener("click", () => setExplorerTab(ch.dataset.tab));
        });

        // insights tabs
        $$("#insights .chip").forEach(ch => {
          ch.addEventListener("click", () => setInsightsTab(ch.dataset.tab));
        });

        // filters
        $("#btnApplyFilters").addEventListener("click", () => {
          state.settings.category = $("#categorySelect").value || "all";
          state.settings.account = $("#accountSelect").value || "all";
          state.settings.paymentMethod = $("#paymentMethodSelect").value || "all";

          state.settings.includeIncome = $("#toggleIncome").checked;
          state.settings.includeExpense = $("#toggleExpense").checked;
          state.settings.includeTransfers = $("#toggleTransfers").checked;
          state.settings.includeOther = $("#toggleOther").checked;

          saveSettings();
          render();
        });

        $("#btnClearFilters").addEventListener("click", () => {
          state.settings.category = "all";
          state.settings.account = "all";
          state.settings.paymentMethod = "all";
          state.settings.includeIncome = true;
          state.settings.includeExpense = true;
          state.settings.includeTransfers = true;
          state.settings.includeOther = true;
          $("#categorySelect").value = "all";
          $("#accountSelect").value = "all";
          $("#paymentMethodSelect").value = "all";
          $("#toggleIncome").checked = true;
          $("#toggleExpense").checked = true;
          $("#toggleTransfers").checked = true;
          $("#toggleOther").checked = true;
          saveSettings();
          render();
        });

        // range presets
        $$("#rangePresets .chip").forEach(ch => {
          ch.addEventListener("click", () => {
            const preset = ch.dataset.preset;
            state.settings.rangeMode = preset;
            if (preset === "all") {
              state.settings.fromDate = "";
              state.settings.toDate = "";
            } else if (preset === "from") {
              state.settings.fromDate = state.settings.fromDate || toISODate(new Date());
              state.settings.toDate = "";
            } else if (preset === "between") {
              const t = toISODate(new Date());
              state.settings.fromDate = state.settings.fromDate || t;
              state.settings.toDate = state.settings.toDate || t;
            }
            saveSettings();
            applyRangeControls();
            render();
          });
        });

        $("#fromDate").addEventListener("change", (ev) => {
          state.settings.fromDate = ev.target.value || "";
          saveSettings();
          render();
        });
        $("#toDate").addEventListener("change", (ev) => {
          state.settings.toDate = ev.target.value || "";
          saveSettings();
          render();
        });

        // data tab
        $("#apiBaseInput").addEventListener("change", (ev) => {
          state.settings.apiBase = sanitizeApiBase(ev.target.value || "/api") || "/api";
          saveSettings();
        });

        $("#btnPing").addEventListener("click", async () => {
          try {
            await API.ping();
            state.apiOnline = true;
            updateApiStatusBadge();
            alert("API OK (/meta)");
          } catch (e) {
            state.apiOnline = false;
            updateApiStatusBadge();
            alert(e?.message || "API offline");
          }
        });

        $("#btnExport").addEventListener("click", exportJson);
        $("#importFile").addEventListener("change", async (ev) => {
          const file = ev.target.files?.[0];
          if (!file) return;
          await importJson(file);
          ev.target.value = "";
        });

        // new event
        $("#btnNewEvent").addEventListener("click", () => openEventModal({ dateISO: toISODate(state.anchorDate) }));

        // movements refresh
        $("#btnMovRefresh").addEventListener("click", reloadAll);

        // reports refresh
        $("#btnRepRun").addEventListener("click", runReports);
        $("#repMonth").addEventListener("change", runReports);

        // setup wizard buttons
        $("#btnWizardSparkasse").addEventListener("click", applyWizardSparkasse);
        $("#btnMetaReload").addEventListener("click", reloadAll);

        // insights inputs
        $("#balanceAtDate").addEventListener("change", (ev) => {
          state.settings.balanceAtDate = ev.target.value || "";
          saveSettings();
          refreshInsights();
        });

        // forecast controls
        $("#forecastTo").addEventListener("change", (ev) => {
          state.settings.forecastTo = ev.target.value || "";
          saveSettings();
        });
        $("#forecastMode").addEventListener("change", (ev) => {
          state.settings.forecastMode = ev.target.value || "daily";
          saveSettings();
        });
        $("#btnForecast").addEventListener("click", refreshForecast);

        // drawer close/scrim
        $("#btnCloseDrawer").addEventListener("click", closeDrawer);
        $("#drawerScrim").addEventListener("click", closeDrawer);

        // modal close/cancel
        $("#btnCloseModal").addEventListener("click", closeEventModal);
        $("#btnCancelEvent").addEventListener("click", closeEventModal);

        // modal dynamic logic
        // --- PATCH v3.1: modal dynamic logic (touched + sync + defaults) ---
        $("#evtTitle").addEventListener("input", () => {
          updateSparkasseHint();
        });
        
        $("#evtType").addEventListener("change", () => {
          modalTypeTouched = true;
          syncModalTypeUI();
          // se torno su expense e PM ha defaultAcc e non ho toccato account, applicalo
          applyPMDefaultsToModal({ forceAccount: false });
        });
        
        $("#evtPaymentMethod").addEventListener("change", () => {
          // se cambio PM e account non √® stato ‚Äútoccato‚Äù, pu√≤ aggiornare default
          applyPMDefaultsToModal({ forceAccount: false });
          recomputeCashDateInModal();
        });
        
        $("#evtAccount").addEventListener("change", () => {
          modalAccountTouched = true;
        });
        
        $("#evtFromAccount").addEventListener("change", () => {
          modalFromToTouched = true;
        });
        $("#evtToAccount").addEventListener("change", () => {
          modalFromToTouched = true;
        });
        
        $("#evtDate").addEventListener("change", () => {
          recomputeCashDateInModal();
        });
        
        $("#evtCashOverride").addEventListener("change", () => {
          $("#evtCashDate").disabled = !$("#evtCashOverride").checked;
          recomputeCashDateInModal();
        });
        
        $("#evtRecurrence").addEventListener("change", () => {
          updateRecurrenceFields();
        });
        
        $("#btnMaterialize").addEventListener("click", materializeSeriesFlow);


        // handle submit
        $("#eventForm").addEventListener("submit", async (ev) => {
          ev.preventDefault();
          await upsertEvent();
        });

        // quick-add in month cells (event delegation)
        $("#calendarView").addEventListener("click", (ev) => {
          const btn = ev.target?.closest?.("button[data-action='quick-add']");
          if (!btn) return;
          const iso = btn.getAttribute("data-date");
          openEventModal({ dateISO: iso });
        });
        $("#evtPaymentMethod").addEventListener("change", () => {
          applyPMDefaultsToModal({ forceAccount: false });
          recomputeCashDateInModal();
          updateInstallmentUI(); // ‚úÖ NEW
        });
        
        $("#evtIsInstallment").addEventListener("change", updateInstallmentUI);
        $("#evtInstCount").addEventListener("input", updateInstallmentUI);
        $("#evtInstMode").addEventListener("change", updateInstallmentUI);
        $("#evtInstFixedAmt").addEventListener("input", updateInstallmentUI);
        $("#evtInstStart").addEventListener("change", updateInstallmentUI);
        
        // quando modifichi gli importi custom
        $("#eventModal").addEventListener("input", (ev) => {
          if (String(ev.target?.id || "").startsWith("instAmt_")) updateInstallmentUI();
        });
const AMAZON_ACC = "amazon_cc";

$("#amzLimit").addEventListener("input", (ev) => {
  setCCCfg(AMAZON_ACC, { limit: Number(ev.target.value || 0) });
  refreshInsights();
});

$("#amzCustomPay").addEventListener("input", (ev) => {
  setCCCfg(AMAZON_ACC, { customMonthly: Number(ev.target.value || 0) });
  refreshInsights();
});

$("#btnAmzModeFull").addEventListener("click", () => {
  setCCCfg(AMAZON_ACC, { repaymentMode: "full" });
  refreshInsights();
});

$("#btnAmzModeCustom").addEventListener("click", () => {
  setCCCfg(AMAZON_ACC, { repaymentMode: "custom" });
  refreshInsights();
});

$("#btnAmzPayNext").addEventListener("click", async () => {
  try {
    await createCardPaymentTransfer(AMAZON_ACC);
    await reloadAll();
  } catch (e) {
    alert(e?.message || "Errore pagamento carta");
  }
});

        // year view month click (delegation)
        $("#calendarView").addEventListener("click", (ev) => {
          const box = ev.target?.closest?.(".month-mini");
          if (!box) return;
          const year = Number(box.getAttribute("data-year"));
          const month = Number(box.getAttribute("data-month"));
          if (!Number.isFinite(year) || !Number.isFinite(month)) return;
          state.anchorDate = new Date(year, month, 1);
          state.settings.view = "month";
          saveSettings();
          render();
        });
      };

      const boot = async () => {
        bindUI();
        await loadSettings();
        await reloadAll();

        // restore toggles and inputs
        $("#toggleIncome").checked = state.settings.includeIncome !== false;
        $("#toggleExpense").checked = state.settings.includeExpense !== false;
        $("#toggleTransfers").checked = state.settings.includeTransfers !== false;
        $("#toggleOther").checked = state.settings.includeOther !== false;

        // apply explorer & insights initial tabs
        setExplorerTab(state.settings.explorerTab || "calendar");
        setInsightsTab(state.settings.insightsTab || "stats");

        // initial render
        render();

        // auto forecast init once (optional)
        // refreshForecast();
      };

      boot();
    })();
  </script>
</body>
</html>
