<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>üíº Controllo Finanze</title>
  <link rel="stylesheet" href="finv2.css">
</head>

<body class="app" data-active-tab="calendario">
  <!-- Area notifiche (toast) -->
  <div class="toast-area" id="toastArea" aria-live="polite" aria-atomic="true">
    <!-- Toast generati via JS (finv2.js) -->
  </div>

  <!-- Top bar -->
  <header class="topbar">
    <div class="brand" aria-label="Titolo applicazione">üíº Controllo Finanze</div>

    <div class="refdate" aria-label="Data di riferimento">
      <span class="small">Riferimento:</span>
      <span class="big" id="refDateLabel">‚Äî</span>
    </div>

    <div class="row" style="gap:10px;">
      <button class="btn" id="btnOggi" type="button">Oggi</button>
      <button class="btn btn--primary" id="btnNuovo" type="button">+ Nuovo</button>
      <button class="btn" id="btnRicarica" type="button">Ricarica</button>
    </div>

    <div class="search" role="search" aria-label="Ricerca globale">
      <span class="muted" aria-hidden="true">üîé</span>
      <input id="globalSearch" type="search" placeholder="Cerca (titolo, categoria, note)‚Ä¶" />
    </div>

    <div class="row" style="gap:10px;">
      <span class="badge" id="apiStatusBadge" title="Stato API">
        <span class="dot" id="apiStatusDot"></span>
        <span id="apiStatusText">API: sconosciuto</span>
      </span>
    </div>
  </header>

  <!-- Layout 3 aree: nav sinistra + contenuto + sidebar -->
  <div class="main">
    <!-- Colonna sinistra (tabs) -->
    <nav class="nav panel" aria-label="Navigazione">
      <button class="btn tabbtn" type="button" data-tab="calendario" aria-selected="true">üìÖ Calendario</button>
      <button class="btn tabbtn" type="button" data-tab="nuovo" aria-selected="false">‚ûï Nuovo evento</button>
      <button class="btn tabbtn" type="button" data-tab="rimborsi" aria-selected="false">üí≥ Rimborsi carte</button>
      <button class="btn tabbtn" type="button" data-tab="wallets" aria-selected="false">üëõ Wallet &amp; Metodi</button>
      <button class="btn tabbtn" type="button" data-tab="impostazioni" aria-selected="false">‚öôÔ∏è Impostazioni</button>

      <hr class="hr" />

      <div class="footnote">
        <strong>Nota UX:</strong> ‚ÄúAcquisto su carta‚Äù ‚â† ‚ÄúQuota dovuta‚Äù ‚â† ‚ÄúRimborso carta‚Äù.<br/>
        Tutti gli importi sono sempre in <strong>EUR</strong>. Le date sono salvate come <strong>YYYY-MM-DD</strong> e mostrate con label tipo ‚Äú23 Gen 2026‚Äù.
      </div>
    </nav>

    <!-- Area centrale (contenuto tab) -->
    <main class="content panel" aria-label="Contenuto">
      <!-- TAB 1: CALENDARIO -->
      <section class="tab-panel" id="tab-calendario" aria-label="Calendario">
        <div class="cal-header">
          <div class="cal-title">
            <button class="btn btn--ghost" id="btnPrevMonth" type="button" aria-label="Mese precedente">‚Äπ mese precedente</button>
            <span id="monthLabel" style="font-size:16px;">‚Äî</span>
            <button class="btn btn--ghost" id="btnNextMonth" type="button" aria-label="Mese successivo">mese successivo ‚Ä∫</button>
          </div>

          <div class="cal-filters" aria-label="Filtri calendario">
            <div class="field" style="min-width:220px;">
              <label class="label" for="filterWallet">Filtro Wallet</label>
              <select class="select" id="filterWallet">
                <option value="">Tutti</option>
                <!-- Popolato via JS: GET /wallets -->
              </select>
            </div>

            <div class="field" style="min-width:240px;">
              <label class="label" for="filterType">Filtro Tipo evento</label>
              <select class="select" id="filterType">
                <option value="">Tutti</option>
                <option value="income">Entrate</option>
                <option value="expense">Uscite</option>
                <option value="card_purchase">Acquisti carta</option>
                <option value="card_due">Quote carta</option>
                <option value="card_repayment">Rimborsi carta</option>
              </select>
            </div>
          </div>
        </div>

        <div class="content-inner">
          <!-- Intestazioni giorni settimana -->
          <div class="cal-grid" style="padding-bottom:0;">
            <div class="dow">Lun</div><div class="dow">Mar</div><div class="dow">Mer</div><div class="dow">Gio</div><div class="dow">Ven</div><div class="dow">Sab</div><div class="dow">Dom</div>
          </div>

          <!-- Griglia calendario (celle giorno) -->
          <div class="cal-grid" id="calendarGrid" aria-label="Griglia calendario">
            <!-- Celle generate via JS (finv2.js) -->
            <!-- Placeholder statico: verr√† sostituito con rendering reale -->
            <div class="day" aria-selected="false" data-date="2026-01-01">
              <div class="day-top">
                <div class="day-num">1</div>
                <div class="day-count">0 eventi</div>
              </div>
              <div class="hint">‚Äî</div>
            </div>

            <div class="day" aria-selected="false" data-date="2026-01-02">
              <div class="day-top">
                <div class="day-num">2</div>
                <div class="day-count">1 evento</div>
              </div>
              <div class="event-line event-line--uscita" title="Uscita ¬∑ Banca ¬∑ 13,99 ‚Ç¨">
                <span class="dot dot--bad" aria-hidden="true"></span>
                <span class="title">Netflix</span>
                <span class="amt">13,99‚Ç¨</span>
                <span class="muted">¬∑ Banca</span>
              </div>
            </div>

            <div class="day" aria-selected="true" data-date="2026-01-23">
              <div class="day-top">
                <div class="day-num">23</div>
                <div class="day-count">3 eventi</div>
              </div>
              <div class="event-line event-line--entrata" title="Entrata ¬∑ Banca ¬∑ 1.800,00 ‚Ç¨">
                <span class="dot dot--ok" aria-hidden="true"></span>
                <span class="title">Stipendio</span>
                <span class="amt">1.800,00‚Ç¨</span>
                <span class="muted">¬∑ Banca</span>
              </div>
              <div class="event-line event-line--acquisto" title="Acquisto su carta ¬∑ Carta Amazon ¬∑ 120,00 ‚Ç¨">
                <span class="dot dot--card" aria-hidden="true"></span>
                <span class="title">Spesa</span>
                <span class="amt">120,00‚Ç¨</span>
                <span class="muted">¬∑ Carta</span>
              </div>
              <div class="event-line event-line--quota" title="Quota dovuta ¬∑ Carta Amazon ¬∑ 40,00 ‚Ç¨">
                <span class="dot dot--due" aria-hidden="true"></span>
                <span class="title">Quota dovuta</span>
                <span class="amt">40,00‚Ç¨</span>
                <span class="muted">¬∑ Carta</span>
              </div>
            </div>

            <!-- (altre celle verranno generate dal JS) -->
          </div>

          <hr class="hr" />

          <div class="row wrap" style="justify-content:space-between;">
            <div class="row wrap" style="gap:10px;">
              <span class="badge"><span class="dot dot--ok"></span> Entrata</span>
              <span class="badge"><span class="dot dot--bad"></span> Uscita</span>
              <span class="badge"><span class="dot dot--card"></span> Acquisto carta</span>
              <span class="badge"><span class="dot dot--due"></span> Quota carta</span>
              <span class="badge"><span class="dot dot--repay"></span> Rimborso carta</span>
            </div>
            <div class="muted" style="font-size:13px;">
              Clicca un giorno per aggiornare ‚ÄúStato al giorno selezionato‚Äù.
              Le <strong>Quote carta</strong> che risultano gi√† coperte da un
              <strong>rimborso</strong> non sono pi√π considerate debito residuo
              e, nella vista definitiva, non verranno pi√π mostrate nel calendario.
            </div>
          </div>
        </div>
      </section>

      <!-- TAB 2: NUOVO EVENTO -->
      <section class="tab-panel" id="tab-nuovo" aria-label="Nuovo evento">
        <div class="content-inner">
          <div class="page-title">
            <div>
              <h2>Nuovo evento</h2>
              <div class="page-sub">
                Inserimento guidato e coerente: <strong>Entrata</strong>, <strong>Uscita</strong>, <strong>Acquisto su carta</strong>, <strong>Rimborso carta (pagamento reale)</strong>.
                Tutto sar√† sempre modificabile e cancellabile, incluse le serie.
              </div>
            </div>
            <div class="row wrap">
              <button class="btn" id="btnResetNewEvent" type="button">Reset campi</button>
              <button class="btn btn--primary" id="btnSaveEvent" type="button">Salva</button>
            </div>
          </div>

          <!-- Scelta tipo evento -->
          <div class="form-section">
            <p class="section-title">1) Tipo evento</p>
            <div class="type-cards" id="eventTypeCards" role="radiogroup" aria-label="Scelta tipo evento">
              <div class="type-card" role="radio" tabindex="0" aria-checked="true" data-event-type="income">
                <div class="t">Entrata</div>
                <div class="d">Movimento reale: aumenta il saldo del wallet scelto.</div>
              </div>
              <div class="type-card" role="radio" tabindex="0" aria-checked="false" data-event-type="expense">
                <div class="t">Uscita</div>
                <div class="d">Movimento reale: diminuisce il saldo del wallet scelto.</div>
              </div>
              <div class="type-card" role="radio" tabindex="0" aria-checked="false" data-event-type="card_purchase">
                <div class="t">Acquisto su carta</div>
                <div class="d">Consuma plafond subito; genera quote/debiti, non muove soldi.</div>
              </div>
              <div class="type-card" role="radio" tabindex="0" aria-checked="false" data-event-type="card_repayment">
                <div class="t">Rimborso carta (pagamento reale)</div>
                <div class="d">Movimento reale: wallet sorgente ‚Üí carta; recupera plafond; sempre editabile.</div>
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <!-- Campi comuni -->
          <div class="form-section">
            <p class="section-title">2) Campi comuni</p>
            <div class="form-grid">
              <div class="field">
                <label class="label" for="fTitle">Titolo <span class="muted">(obbligatorio)</span></label>
                <input class="input" id="fTitle" type="text" placeholder="Esempio: Netflix / Spesa / Stipendio" />
              </div>

              <div class="field">
                <label class="label" for="fAmount">Importo (EUR) <span class="muted">(obbligatorio, &gt; 0)</span></label>
                <input class="input" id="fAmount" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0,00" />
              </div>

              <div class="field">
                <label class="label" for="fCategory">Categoria <span class="muted">(obbligatoria)</span></label>
                <select class="select" id="fCategory">
                  <option value="">Seleziona categoria‚Ä¶</option>
                  <!-- Popolato via JS (categorie globali) -->
                </select>
                <div class="hint">Suggerimenti rapidi e lista categorie gestita in ‚ÄúImpostazioni‚Äù.</div>
              </div>

              <div class="field">
                <label class="label" for="fCalendarDate">Data nel calendario <span class="muted">(YYYY-MM-DD)</span></label>
                <input class="input" id="fCalendarDate" type="date" />
                <div class="hint">√à la data che vedrai nel calendario per questo evento.</div>
              </div>

              <div class="field" style="grid-column: 1 / -1;">
                <label class="label" for="fNotes">Note <span class="muted">(opzionale)</span></label>
                <textarea class="textarea" id="fNotes" placeholder="Dettagli utili‚Ä¶"></textarea>
              </div>
            </div>
          </div>
          <div class="hr"></div>
          <!-- Sezioni specifiche (mostrate/nascoste via JS) -->
          <div class="form-grid">
            <!-- Entrata/Uscita -->
            <div class="form-section" id="sectionRealMovement">
              <p class="section-title">3) Entrata / Uscita (movimento reale)</p>
              <div class="field">
                <label class="label" for="fWallet">Wallet (conto) <span class="muted">(obbligatorio)</span></label>
                <select class="select" id="fWallet">
                  <option value="">Seleziona wallet‚Ä¶</option>
                  <!-- Popolato via JS: GET /wallets -->
                </select>
                <div class="hint">La data nel calendario coincide con la data di impatto sul saldo.</div>
                <!-- NEW: hint dinamico (gestito da finv2.js) -->
                <div class="hint" id="walletTypeHint" style="display:none; margin-top:6px;"></div>
                <div class="hint">La data nel calendario coincide con la data di impatto sul saldo.</div>
              </div>
            </div>
            <!-- Acquisto su carta -->
            <div class="form-section" id="sectionCardPurchase">
              <p class="section-title">3) Acquisto su carta</p>
              <div class="field">
                <label class="label" for="fCardWallet">Carta (wallet di tipo carta) <span class="muted">(obbligatorio)</span></label>
                <select class="select" id="fCardWallet">
                  <option value="">Seleziona carta‚Ä¶</option>
                  <!-- Popolato via JS: wallet type=carta -->
                </select>
              </div>

              <div class="field">
                <label class="label" for="fPurchaseDate">Data acquisto reale <span class="muted">(quando hai comprato davvero?)</span></label>
                <input class="input" id="fPurchaseDate" type="date" />
              </div>

              <div class="field">
                <label class="label" for="fMethod">Metodo per costruire le quote <span class="muted">(obbligatorio)</span></label>
                <select class="select" id="fMethod">
                  <option value="">Seleziona metodo‚Ä¶</option>
                  <option value="one_shot">Unica soluzione</option>
                  <option value="monthly_installments">Rate mensili</option>
                  <option value="custom_installments">Rate personalizzate</option>
                  <option value="revolving">Revolving</option>
                </select>
                <div class="hint">Questi metodi NON sono il rimborso reale. Servono solo a costruire le quote del debito.</div>
              </div>

              <!-- Metodo: unica soluzione -->
              <div class="form-section panel--flat" id="methodOneShot">
                <p class="section-title">Unica soluzione</p>
                <div class="field">
                  <label class="label" for="fDueDateOneShot">Data quota dovuta</label>
                  <input class="input" id="fDueDateOneShot" type="date" />
                  <div class="hint">Il backend creer√† 1 acquisto (purchase) + 1 quota dovuta (due line).</div>
                </div>
              </div>

              <!-- Metodo: rate mensili -->
              <div class="form-section panel--flat" id="methodMonthly">
                <p class="section-title">Rate mensili</p>
                <div class="form-grid">
                  <div class="field">
                    <label class="label" for="fInstN">Numero rate (N)</label>
                    <input class="input" id="fInstN" type="number" min="2" step="1" placeholder="3" />
                  </div>
                  <div class="field">
                    <label class="label" for="fFirstDueMonthly">Prima quota dovuta</label>
                    <input class="input" id="fFirstDueMonthly" type="date" />
                  </div>
                  <div class="field" style="grid-column: 1 / -1;">
                    <label class="label" for="fInstAmount">Importo rata (auto + modificabile)</label>
                    <input class="input" id="fInstAmount" type="number" min="0" step="0.01" placeholder="0,00" />
                    <div class="hint">Il backend creer√† N quote dovute (modificabili singolarmente in modifica evento).</div>
                  </div>
                </div>
              </div>

              <!-- Metodo: rate personalizzate -->
              <div class="form-section panel--flat" id="methodCustom">
                <p class="section-title">Rate personalizzate</p>
                <div class="hint" style="margin-bottom:10px;">
                  Inserisci righe con <strong>Data</strong> e <strong>Importo</strong>. Il totale dovrebbe corrispondere all‚Äôimporto dell‚Äôacquisto.
                </div>
                <div class="row wrap" style="justify-content:space-between; margin-bottom:10px;">
                  <button class="btn" type="button" id="btnAddCustomRow">+ Aggiungi quota</button>
                  <span class="muted" style="font-size:13px;">Totale quote: <strong id="customTotal">0,00‚Ç¨</strong></span>
                </div>
                <table aria-label="Tabella rate personalizzate">
                  <thead>
                    <tr>
                      <th style="width: 200px;">Data quota</th>
                      <th style="width: 200px;">Importo</th>
                      <th>Azioni</th>
                    </tr>
                  </thead>
                  <tbody id="customRows">
                    <tr>
                      <td><input class="input" type="date" /></td>
                      <td><input class="input" type="number" step="0.01" min="0" placeholder="0,00" /></td>
                      <td class="table-actions">
                        <button class="btn btn--danger" type="button">Rimuovi</button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Metodo: revolving -->
              <div class="form-section panel--flat" id="methodRevolving">
                <p class="section-title">Revolving</p>
                <div class="form-grid">
                  <div class="field">
                    <label class="label" for="fMinMonthly">Minimo mensile</label>
                    <input class="input" id="fMinMonthly" type="number" step="0.01" min="0" placeholder="0,00" />
                  </div>
                  <div class="field">
                    <label class="label" for="fInterestPct">Interessi % mensile</label>
                    <input class="input" id="fInterestPct" type="number" step="0.01" min="0" placeholder="0,00" />
                  </div>
                  <div class="field" style="grid-column: 1 / -1;">
                    <label class="label" for="fRevolvingMode">Modalit√† calcolo</label>
                    <select class="select" id="fRevolvingMode">
                      <option value="simple">Semplice (v1)</option>
                      <option value="interest_on_remaining">Interessi sul residuo</option>
                    </select>
                    <div class="hint">In v1 la logica pu√≤ essere semplice ma deve essere chiara e prevedibile.</div>
                  </div>
                </div>
              </div>

              <hr class="hr" />

              <!-- Opzione cloni mese prossimo -->
              <div class="form-section panel--flat">
                <p class="section-title">Opzione: Clona nel prossimo mese (stesso giorno)</p>

                <div class="row wrap" style="align-items:flex-start;">
                  <label class="row" style="gap:10px; cursor:pointer;">
                    <input id="fCloneNextMonth" type="checkbox" />
                    <span><strong>Crea copie nel mese prossimo</strong></span>
                  </label>
                </div>

                <div class="form-grid" style="margin-top:10px;">
                  <div class="field">
                    <label class="label" for="fCloneN">Numero copie (N)</label>
                    <input class="input" id="fCloneN" type="number" min="1" step="1" placeholder="1" />
                  </div>
                  <div class="field">
                    <label class="label" for="fCloneSpacing">Spaziatura</label>
                    <select class="select" id="fCloneSpacing">
                      <option value="same_day">Stesso giorno</option>
                      <option value="consecutive_days">Giorni consecutivi</option>
                    </select>
                  </div>
                </div>

                <div class="hint" style="margin-top:10px;">
                  Il frontend generer√† N richieste POST (cloni indipendenti). Se un giorno non esiste (es. 31 ‚Üí Febbraio),
                  si sposta automaticamente all‚Äôultimo giorno valido del mese e si mostra una label chiara (es. ‚ÄúFebbraio non ha 31 ‚Üí salvato al 28/29‚Äù).
                </div>

                <div class="badge" id="cloneInfoBadge" style="margin-top:10px;">
                  <span class="dot"></span> Nessun clone configurato
                </div>
              </div>
            </div>

            <!-- Rimborso carta -->
            <div class="form-section" id="sectionCardRepayment">
              <p class="section-title">3) Rimborso carta (movimento reale)</p>
              <div class="form-grid">
                <div class="field">
                  <label class="label" for="fFromWallet">Da wallet (sorgente)</label>
                  <select class="select" id="fFromWallet">
                    <option value="">Seleziona sorgente‚Ä¶</option>
                    <!-- Popolato via JS: wallet non-carta (o comunque sorgenti ammesse) -->
                  </select>
                </div>
                <div class="field">
                  <label class="label" for="fToCard">A carta (wallet carta)</label>
                  <select class="select" id="fToCard">
                    <option value="">Seleziona carta‚Ä¶</option>
                    <!-- Popolato via JS: wallet type=carta -->
                  </select>
                </div>
                <div class="field">
                  <label class="label" for="fPaymentDate">Data pagamento reale</label>
                  <input class="input" id="fPaymentDate" type="date" />
                </div>
                <div class="field">
                  <label class="label" for="fRepayAmount">Importo (EUR)</label>
                  <input class="input" id="fRepayAmount" type="number" step="0.01" min="0" placeholder="0,00" />
                </div>
              </div>

              <div class="hint" style="margin-top:10px;">
                Effetto: diminuisce wallet sorgente, aumenta plafond disponibile della carta. √à sempre editabile.
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <!-- Serie / contratti ricorrenti -->
          <div class="form-section">
            <p class="section-title">4) Serie / Contratto ricorrente</p>

            <label class="row" style="gap:10px; cursor:pointer; align-items:flex-start;">
              <input id="fIsSeries" type="checkbox" />
              <span>
                <strong>Questo √® un contratto ricorrente</strong><br/>
                <span class="hint">Frequenza mensile, con durata ‚ÄúPer sempre‚Äù o ‚ÄúPer N mesi‚Äù.</span>
              </span>
            </label>

            <div class="form-grid" style="margin-top:10px;">
              <div class="field">
                <label class="label" for="fSeriesFrequency">Frequenza</label>
                <select class="select" id="fSeriesFrequency" disabled>
                  <option value="monthly">Mensile</option>
                </select>
              </div>
              <div class="field">
                <label class="label" for="fSeriesDurationMode">Durata</label>
                <select class="select" id="fSeriesDurationMode">
                  <option value="forever">Per sempre</option>
                  <option value="n_months">Per N mesi</option>
                </select>
              </div>
              <div class="field">
                <label class="label" for="fSeriesMonths">N mesi</label>
                <input class="input" id="fSeriesMonths" type="number" min="1" step="1" placeholder="12" />
              </div>
              <div class="field">
                <label class="label" for="fSeriesFirstDate">Data prima occorrenza</label>
                <input class="input" id="fSeriesFirstDate" type="date" />
              </div>
            </div>

            <div class="hint" style="margin-top:10px;">
              Gli eventi generati avranno <code>seriesId</code> e <code>seriesIndex</code>. In modifica evento sar√† possibile: modificare solo uno,
              modificare questa + future, cancellare uno (salto), cancellare future, cancellare tutta la serie.
            </div>
          </div>
        </div>
      </section>

      <!-- TAB 3: RIMBORSI CARTE -->
      <section class="tab-panel" id="tab-rimborsi" aria-label="Rimborsi carte">
        <div class="content-inner">
          <div class="page-title">
            <div>
              <h2>Rimborsi carte</h2>
              <div class="page-sub">
                Cruscotto per ogni carta: debito attuale, quote dovute nel mese, rimborsi gi√† inseriti nel mese, differenza.
                Azioni rapide: nuovo rimborso, modifica, cancella, suggerisci importo.
              </div>
            </div>
            <div class="row wrap">
              <button class="btn" id="btnNewRepayment" type="button">+ Nuovo rimborso</button>
              <button class="btn" id="btnSuggestRepayment" type="button">Suggerisci importo</button>
              <button class="btn btn--primary" id="btnRefreshCards" type="button">Ricarica dati</button>
            </div>
          </div>

          <div id="cardsDashboard" class="col">
            <!-- Card carta generate via JS: GET /dashboard?asOf=... -->
            <div class="form-section">
              <p class="section-title">Carta (esempio)</p>
              <div class="kpi">
                <div><div class="k">Debito totale attuale</div><div class="v">‚Äî</div></div>
                <div><div class="k">Quote dovute entro fine mese</div><div class="v">‚Äî</div></div>
                <div><div class="k">Rimborsi effettuati nel mese</div><div class="v">‚Äî</div></div>
                <div><div class="k">Differenza</div><div class="v">‚Äî</div></div>
              </div>

              <div class="hr"></div>

              <table aria-label="Elenco rimborsi del mese">
                <thead>
                  <tr>
                    <th>Data pagamento reale</th>
                    <th>Da wallet</th>
                    <th>Importo</th>
                    <th>Azioni</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>‚Äî</td>
                    <td>‚Äî</td>
                    <td>‚Äî</td>
                    <td class="table-actions">
                      <button class="btn" type="button" disabled>Modifica</button>
                      <button class="btn btn--danger" type="button" disabled>Cancella</button>
                    </td>
                  </tr>
                </tbody>
              </table>

              <div class="hint" style="margin-top:10px;">
                ‚ÄúSuggerisci importo‚Äù √® solo un suggerimento (nessuna azione automatica).
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- TAB 4: WALLET & METODI -->
      <section class="tab-panel" id="tab-wallets" aria-label="Wallet e metodi">
        <div class="content-inner">
          <div class="page-title">
            <div>
              <h2>Wallet &amp; Metodi</h2>
              <div class="page-sub">
                Configura la struttura: wallet (conto) e metodi associati per gli acquisti (soprattutto carte).
                I metodi definiscono <strong>come si costruiscono le quote del debito</strong> (non sono rimborsi).
              </div>
            </div>
            <div class="row wrap">
              <button class="btn" id="btnAddWallet" type="button">+ Aggiungi wallet</button>
              <button class="btn btn--primary" id="btnReloadWallets" type="button">Ricarica</button>
            </div>
          </div>

          <div class="form-section">
            <p class="section-title">Lista wallet</p>
            <table aria-label="Tabella wallet">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Tipo</th>
                  <th>Saldo iniziale</th>
                  <th>(Carta) Limite</th>
                  <th>(Carta) Wallet sorgente default</th>
                  <th>Azioni</th>
                </tr>
              </thead>
              <tbody id="walletTableBody">
                <tr>
                  <td>‚Äî</td>
                  <td>‚Äî</td>
                  <td>‚Äî</td>
                  <td>‚Äî</td>
                  <td>‚Äî</td>
                  <td class="table-actions">
                    <button class="btn" type="button" disabled>Modifica</button>
                    <button class="btn btn--danger" type="button" disabled>Elimina</button>
                  </td>
                </tr>
              </tbody>
            </table>
            <div class="hint" style="margin-top:10px;">
              API: <code>GET/POST/PUT/DELETE /wallets</code>
            </div>
          </div>

          <div class="hr"></div>

          <div class="form-section">
            <div class="row wrap" style="justify-content:space-between;">
              <p class="section-title" style="margin:0;">Metodi disponibili per questo wallet</p>
              <div class="row wrap">
                <div class="field" style="min-width:260px;">
                  <label class="label" for="methodsWalletSelect">Seleziona wallet</label>
                  <select class="select" id="methodsWalletSelect">
                    <option value="">Seleziona‚Ä¶</option>
                    <!-- Popolato via JS -->
                  </select>
                </div>
                <button class="btn" id="btnAddMethod" type="button">Aggiungi metodo</button>
              </div>
            </div>

            <div class="hr"></div>

            <table aria-label="Tabella metodi per wallet">
              <thead>
                <tr>
                  <th>Metodo</th>
                  <th>Regola</th>
                  <th>Azioni</th>
                </tr>
              </thead>
              <tbody id="methodsTableBody">
                <tr>
                  <td>‚Äî</td>
                  <td class="muted">Seleziona un wallet per vedere i metodi</td>
                  <td class="table-actions">
                    <button class="btn" type="button" disabled>Modifica</button>
                    <button class="btn btn--danger" type="button" disabled>Elimina</button>
                  </td>
                </tr>
              </tbody>
            </table>

            <div class="hint" style="margin-top:10px;">
              API: <code>GET /wallets/:id/methods</code>, <code>POST /wallets/:id/methods</code>, <code>PUT /methods/:id</code>, <code>DELETE /methods/:id</code>
            </div>
          </div>
        </div>
      </section>

      <!-- TAB 5: IMPOSTAZIONI -->
      <section class="tab-panel" id="tab-impostazioni" aria-label="Impostazioni">
        <div class="content-inner">
          <div class="page-title">
            <div>
              <h2>Impostazioni</h2>
              <div class="page-sub">
                Impostazioni di sistema: categorie globali, valori predefiniti, export/import (facoltativo), reset UI (solo UI, NON DB).
              </div>
            </div>
            <div class="row wrap">
              <button class="btn" id="btnExport" type="button">Export (facoltativo)</button>
              <button class="btn" id="btnImport" type="button">Import (facoltativo)</button>
              <button class="btn btn--danger" id="btnResetUI" type="button">Reset UI</button>
            </div>
          </div>

          <div class="form-grid">
            <div class="form-section">
              <p class="section-title">Categorie globali</p>
              <div class="hint" style="margin-bottom:10px;">
                Gestisci la lista categorie (usata nei suggerimenti e nel campo ‚ÄúCategoria‚Äù del Nuovo evento).
              </div>
              <div class="row wrap" style="justify-content:space-between;">
                <button class="btn" id="btnAddCategory" type="button">+ Aggiungi categoria</button>
                <button class="btn btn--primary" id="btnReloadCategories" type="button">Ricarica</button>
              </div>

              <div class="hr"></div>

              <table aria-label="Tabella categorie">
                <thead>
                  <tr>
                    <th>Categoria</th>
                    <th>Azioni</th>
                  </tr>
                </thead>
                <tbody id="categoriesTableBody">
                  <tr>
                    <td>‚Äî</td>
                    <td class="table-actions">
                      <button class="btn" type="button" disabled>Modifica</button>
                      <button class="btn btn--danger" type="button" disabled>Elimina</button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="form-section">
              <p class="section-title">Valori predefiniti</p>
              <div class="field">
                <label class="label" for="defaultWallet">Wallet predefinito per nuove uscite/entrate</label>
                <select class="select" id="defaultWallet">
                  <option value="">Nessuno</option>
                  <!-- Popolato via JS -->
                </select>
              </div>

              <div class="field">
                <label class="label" for="defaultCard">Carta predefinita per acquisti</label>
                <select class="select" id="defaultCard">
                  <option value="">Nessuna</option>
                  <!-- Popolato via JS -->
                </select>
              </div>

              <div class="hr"></div>

              <div class="hint">
                Reset UI: cancella solo preferenze/interfaccia (es. filtri, tab attiva, token), senza toccare il database.
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Sidebar destra: snapshot live (solo nella tab Calendario) -->
    <aside class="sidebar panel" aria-label="Stato al giorno selezionato">
      <h3 id="snapshotTitle">üìå Stato al: ‚Äî</h3>
      <div class="muted" style="font-size:13px; margin-bottom:12px;">
        Valori calcolati <strong>fino al giorno selezionato</strong>.
        <br>
        Per le <strong>carte</strong>:
        <br>‚Äì il <strong>debito dovuto entro fine mese</strong> √® gi√† <strong>al netto</strong> dei rimborsi registrati;
        <br>‚Äì le <strong>quote carta gi√† coperte</strong> non devono pi√π essere mostrate nel calendario, per non sporcare la vista.
      </div>
      <div id="snapshotWalletCards">
        <!-- Card wallet generate via JS: GET /dashboard?asOf=YYYY-MM-DD&month=YYYY-MM -->
        <div class="wallet-card">
          <div class="wallet-head">
            <div>
              <div class="wallet-name">Banca (esempio)</div>
              <div class="wallet-type">Tipo: banca</div>
            </div>
            <span class="badge"><span class="dot"></span> EUR</span>
          </div>

          <div class="kpi">
            <div><div class="k">Saldo al giorno selezionato</div><div class="v">‚Äî</div></div>
            <div><div class="k">Spese mese (fatte fino a data)</div><div class="v">‚Äî</div></div>
            <div><div class="k">Spese mese (ancora da fare nel mese)</div><div class="v">‚Äî</div></div>
            <div><div class="k">Entrate mese (fatte fino a data)</div><div class="v">‚Äî</div></div>
            <div><div class="k">Entrate mese (ancora previste)</div><div class="v">‚Äî</div></div>
            <div><div class="k">Spese: confronto mese scorso</div><div class="v">‚Äî</div></div>
            <div><div class="k">Entrate: confronto mese scorso</div><div class="v">‚Äî</div></div>
          </div>

          <div class="wallet-next">
            <strong>Prossimo evento:</strong> <span id="nextEventExample">‚Äî</span>
          </div>

          <div class="wallet-cats">
            <div class="muted" style="font-size:12px; margin-bottom:6px;"><strong>Categorie principali del mese</strong> (top 3 + max 10)</div>
            <div class="cat-row"><span>Spesa</span><strong>‚Äî</strong></div>
            <div class="cat-row"><span>Bollette</span><strong>‚Äî</strong></div>
            <div class="cat-row"><span>Trasporti</span><strong>‚Äî</strong></div>
          </div>
        </div>

        <div class="wallet-card">
          <div class="wallet-head">
            <div>
              <div class="wallet-name">Carta (esempio)</div>
              <div class="wallet-type">Tipo: carta</div>
            </div>
            <span class="badge"><span class="dot dot--card"></span> Carta</span>
          </div>

          <div class="kpi">
            <div><div class="k">Limite carta</div><div class="v">‚Äî</div></div>
            <div><div class="k">Plafond disponibile</div><div class="v">‚Äî</div></div>
            <div><div class="k">Debito totale attuale</div><div class="v">‚Äî</div></div>
            <div><div class="k">Debito dovuto entro fine mese</div><div class="v">‚Äî</div></div>
            <div><div class="k">Rimborsi effettuati nel mese</div><div class="v">‚Äî</div></div>
            <div><div class="k">Saldo al giorno selezionato</div><div class="v">‚Äî</div></div>
          </div>

          <div class="wallet-next">
            <strong>Prossimo evento:</strong> <span>‚Äî</span>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Bottom tabs (mobile) -->
  <nav class="bottom-nav" aria-label="Navigazione mobile">
    <button class="btn tabbtn" type="button" data-tab="calendario" aria-selected="true">üìÖ<br/>Calendario</button>
    <button class="btn tabbtn" type="button" data-tab="nuovo" aria-selected="false">‚ûï<br/>Nuovo</button>
    <button class="btn tabbtn" type="button" data-tab="rimborsi" aria-selected="false">üí≥<br/>Rimborsi</button>
    <button class="btn tabbtn" type="button" data-tab="wallets" aria-selected="false">üëõ<br/>Wallet</button>
    <button class="btn tabbtn" type="button" data-tab="impostazioni" aria-selected="false">‚öôÔ∏è<br/>Impost.</button>
  </nav>

  <!-- Template: riga evento (per rendering calendario/lista) -->
  <template id="tplEventLine">
    <div class="event-line">
      <span class="dot" aria-hidden="true"></span>
      <span class="title"></span>
      <span class="amt"></span>
      <span class="muted"></span>
    </div>
  </template>

  <!-- Template: card wallet snapshot -->
  <template id="tplWalletCard">
    <div class="wallet-card">
      <div class="wallet-head">
        <div>
          <div class="wallet-name"></div>
          <div class="wallet-type"></div>
          <!-- Riassunto breve per questo wallet/carta -->
          <div class="hint" data-kpi="walletShortSummary" style="margin-top:4px;">
            <!-- Es.: "Tutto pagato per questo mese" / "Ancora 240,00 ‚Ç¨ da rimborsare" -->
          </div>
        </div>
        <span class="badge"><span class="dot"></span> EUR</span>
      </div>
  
      <!-- KPI base (valide per tutti i wallet) -->
      <div class="kpi">
        <div>
          <div class="k">Saldo al giorno selezionato</div>
          <div class="v" data-kpi="balance">‚Äî</div>
        </div>
        <div>
          <div class="k">Spese mese (fatte fino a data)</div>
          <div class="v" data-kpi="spentSoFar">‚Äî</div>
        </div>
        <div>
          <div class="k">Spese mese (ancora da fare nel mese)</div>
          <div class="v" data-kpi="spentRemaining">‚Äî</div>
        </div>
        <div>
          <div class="k">Entrate mese (fatte fino a data)</div>
          <div class="v" data-kpi="incomeSoFar">‚Äî</div>
        </div>
        <div>
          <div class="k">Entrate mese (ancora previste)</div>
          <div class="v" data-kpi="incomeRemaining">‚Äî</div>
        </div>
        <div>
          <div class="k">Spese: confronto mese scorso</div>
          <div class="v" data-kpi="compareLastMonthExpenses">‚Äî</div>
        </div>
        <div>
          <div class="k">Entrate: confronto mese scorso</div>
          <div class="v" data-kpi="compareLastMonthIncome">‚Äî</div>
        </div>
      </div>
  
      <!-- Prossimo evento collegato a questo wallet -->
      <div class="wallet-next">
        <strong>Prossimo evento:</strong>
        <span data-kpi="nextEvent">‚Äî</span>
      </div>
  
      <!-- Categorie principali -->
      <div class="wallet-cats">
        <div class="muted" style="font-size:12px; margin-bottom:6px;">
          <strong>Categorie principali del mese</strong>
        </div>
        <div data-slot="categories"></div>
      </div>
  
      <!-- Se carta: area extra (mostrata via JS, solo per wallet di tipo "carta") -->
      <div data-slot="cardExtras" style="display:none;">
        <div class="grid cardExtras" style="margin-top:10px; gap:10px;">
      
          <!-- KPI legacy (NON rimuovere: il frontend vecchio continua a funzionare) -->
          <div class="kpi">
            <div class="kpi-label">Limite</div>
            <div class="kpi-value" data-kpi="cardLimit">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Credito disponibile</div>
            <div class="kpi-value" data-kpi="availableCredit">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Outstanding</div>
            <div class="kpi-value" data-kpi="outstanding">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Baseline statement (mese)</div>
            <div class="kpi-value" data-kpi="dueByEom">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Rimborsi mese</div>
            <div class="kpi-value" data-kpi="repaymentsThisMonth">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Conto predefinito</div>
            <div class="kpi-value" data-kpi="defaultSourceWallet">‚Äî</div>
          </div>
      
          <!-- NEW: statement (backend-aligned) -->
          <div class="cardBox" style="grid-column: 1 / -1; padding:12px; border:1px solid rgba(255,255,255,.08); border-radius:10px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
              <div style="font-weight:600;">Statement (cutoff 16 ‚Üí 15)</div>
              <div style="opacity:.8; font-size:12px;">
                Finestra: <span data-kpi="statementWindowStart">‚Äî</span> ‚Üí <span data-kpi="statementWindowEnd">‚Äî</span>
              </div>
            </div>
          
            <div style="margin-top:10px; display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px;">
              <div class="kpi">
                <div class="kpi-label">Baseline statement</div>
                <div class="kpi-value" data-kpi="statementBaselineAmount">‚Äî</div>
              </div>
              <div class="kpi">
                <div class="kpi-label">Instant purchases (count)</div>
                <div class="kpi-value" data-kpi="statementInstantCount">‚Äî</div>
              </div>
              <div class="kpi">
                <div class="kpi-label">Charges (somma)</div>
                <div class="kpi-value" data-kpi="statementCharges">‚Äî</div>
              </div>
              <div class="kpi">
                <div class="kpi-label">Credits (somma)</div>
                <div class="kpi-value" data-kpi="statementCredits">‚Äî</div>
              </div>
            </div>
          
            <div style="margin-top:10px;">
              <div style="font-size:12px; opacity:.8; margin-bottom:6px;">
                Rate (installments) nel mese selezionato
              </div>
              <div data-slot="statementInstallments" style="display:flex; flex-direction:column; gap:6px;">
                <div class="hint">‚Äî</div>
              </div>
            </div>
          </div>

      
          <!-- NEW: scheduled repayment (virtuale) + override -->
          <div class="cardBox" style="grid-column: 1 / -1; padding:12px; border:1px solid rgba(255,255,255,.08); border-radius:10px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
              <div style="font-weight:600;">Rimborso programmato (virtuale)</div>
              <div style="opacity:.8; font-size:12px;">
                Data addebito: <span data-kpi="schedPaymentDate">‚Äî</span>
              </div>
            </div>
      
            <div style="margin-top:10px; display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px;">
              <div class="kpi">
                <div class="kpi-label">Baseline (statement)</div>
                <div class="kpi-value" data-kpi="schedBaseline">‚Äî</div>
              </div>
              <div class="kpi">
                <div class="kpi-label">Suggerito</div>
                <div class="kpi-value" data-kpi="schedSuggested">‚Äî</div>
              </div>
              <div class="kpi">
                <div class="kpi-label">Evento rimborso</div>
                <div class="kpi-value" data-kpi="schedExists">‚Äî</div>
              </div>
            </div>
      
            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
              <div style="min-width:220px;">
                <label style="display:block; font-size:12px; opacity:.8;">Importo rimborso (puoi cambiarlo)</label>
                <input class="input" type="number" step="0.01" data-input="schedUserAmount" placeholder="es. 200.00" />
              </div>
      
              <div style="min-width:220px;">
                <label style="display:block; font-size:12px; opacity:.8;">Se differenza vs baseline</label>
                <select class="input" data-input="schedDeltaMode">
                  <option value="fee">Fee (costo)</option>
                  <option value="prepayment">Prepayment (estinzione)</option>
                </select>
              </div>
      
              <button class="btn" data-action="cardCreateScheduledRepayment">Crea rimborso</button>
              <button class="btn" data-action="cardOverrideScheduledRepayment">Applica override</button>
      
              <div style="font-size:12px; opacity:.75; margin-left:auto;">
                Usa ‚ÄúCrea rimborso‚Äù se non esiste; ‚ÄúOverride‚Äù se esiste gi√†.
              </div>
            </div>
          </div>
      
          <!-- NEW: settings card -->
          <div class="cardBox" style="grid-column: 1 / -1; padding:12px; border:1px solid rgba(255,255,255,.08); border-radius:10px;">
            <div style="font-weight:600;">Impostazioni carta</div>
      
            <div style="margin-top:10px; display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px;">
              <div>
                <label style="display:block; font-size:12px; opacity:.8;">Teilzahlung (‚Ç¨)</label>
                <input class="input" type="number" step="0.01" data-input="csTeilzahlung" />
              </div>
              <div>
                <label style="display:block; font-size:12px; opacity:.8;">Sollzins annuo</label>
                <input class="input" type="number" step="0.000001" data-input="csSollzins" />
              </div>
              <div>
                <label style="display:block; font-size:12px; opacity:.8;">Effektivzins annuo</label>
                <input class="input" type="number" step="0.000001" data-input="csEffektivzins" />
              </div>
              <div>
                <label style="display:block; font-size:12px; opacity:.8;">Kreditlimit override</label>
                <input class="input" type="number" step="0.01" data-input="csKreditlimit" />
              </div>
            </div>
      
            <div style="margin-top:10px; display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px;">
              <div>
                <label style="display:block; font-size:12px; opacity:.8;">Cycle start day</label>
                <input class="input" type="number" min="1" max="31" data-input="csCycleStartDay" />
              </div>
              <div>
                <label style="display:block; font-size:12px; opacity:.8;">Cycle end day</label>
                <input class="input" type="number" min="1" max="31" data-input="csCycleEndDay" />
              </div>
              <div>
                <label style="display:block; font-size:12px; opacity:.8;">Debit day</label>
                <input class="input" type="number" min="1" max="31" data-input="csDebitDay" />
              </div>
              <div>
                <label style="display:block; font-size:12px; opacity:.8;">Effective from</label>
                <input class="input" type="date" data-input="csEffectiveFrom" />
              </div>
            </div>
      
            <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
              <button class="btn" data-action="cardSaveSettings">Salva impostazioni</button>
              <div style="font-size:12px; opacity:.75;">
                Valori attuali: Teilzahlung <span data-kpi="csTeilzahlungLabel">‚Äî</span> ‚Ä¢ Effective <span data-kpi="csEffectiveFromLabel">‚Äî</span>
              </div>
            </div>
          </div>
      
          <!-- NEW: estinzione anticipata -->
          <div class="cardBox" style="grid-column: 1 / -1; padding:12px; border:1px solid rgba(255,255,255,.08); border-radius:10px;">
            <div style="font-weight:600;">Estinzione anticipata finanziamento</div>
            <div style="opacity:.8; font-size:12px; margin-top:4px;">
              Seleziona una <b>card_purchase</b> (finanziamento) dal calendario/lista eventi e poi clicca ‚ÄúApri estinzione‚Äù.
            </div>
      
            <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <div style="font-size:12px; opacity:.8;">
                Finanziamento selezionato: <span data-kpi="payoffSelectedPurchase">‚Äî</span>
              </div>
              <button class="btn" data-action="openPayoffModal">Apri estinzione</button>
            </div>
          </div>
      
        </div>
      </div>
    </div>
  </template>

  <!-- Overlay: dettaglio / modifica evento -->
  <div class="event-overlay" id="eventOverlay" role="dialog" aria-modal="true" aria-labelledby="eventDialogTitle">
    <div class="event-card">
      <div class="event-header">
        <div>
          <div class="badge" id="eventTypeBadge">
            <span class="dot"></span>
            <span id="eventTypeLabel">Tipo evento</span>
          </div>
          <h2 id="eventDialogTitle" style="margin:8px 0 4px 0; font-size:18px;">Dettaglio evento</h2>
          <div class="event-meta" id="eventMeta">
            <!-- Popolato via JS: wallet collegato, impatto su saldo/debito/plafond, date -->
          </div>
        </div>
        <div class="row wrap">
          <button class="btn" type="button" id="btnEditSingle">Modifica solo questo</button>
          <button class="btn" type="button" id="btnEditThisAndFuture">Modifica questa + future</button>
          <button class="btn btn--danger" type="button" id="btnDeleteSingle">Elimina solo questo</button>
          <button class="btn btn--danger" type="button" id="btnDeleteThisAndFuture">Elimina questa + future</button>
          <button class="btn btn--danger" type="button" id="btnDeleteSeries">Elimina tutta la serie</button>
          <button class="btn btn--ghost" type="button" id="btnCloseEventOverlay">Chiudi</button>
        </div>
      </div>

      <!-- Info serie (mostrata solo se l'evento appartiene a una serie) -->
      <div class="form-section panel--flat" id="eventSeriesInfo">
        <p class="section-title">Evento in serie</p>
        <div class="hint">
          Questo evento fa parte di un contratto ricorrente (<code>seriesId</code> e <code>seriesIndex</code>).
          In base ai pulsanti sopra puoi modificare solo questo evento, oppure anche quelli futuri, o cancellarli.
        </div>
      </div>

      <!-- Sezione quote generate (solo per acquisto su carta) -->
      <div class="form-section panel--flat" id="eventQuotesSection">
        <p class="section-title">Quote generate</p>
        <div class="hint" style="margin-bottom:8px;">
          Elenco delle quote dovute create da questo acquisto su carta. Puoi modificare o saltare singole quote.
        </div>
        <div class="event-quote-list" id="eventQuotesList">
          <!-- Righe create via JS -->
          <!-- Esempio:
          <div class="event-quote-row">
            <span>2026-02-10 ¬∑ 40,00‚Ç¨</span>
            <span class="muted">Stato: attiva</span>
            <span class="table-actions">
              <button class="btn" type="button">Modifica</button>
              <button class="btn btn--danger" type="button">Salta quota</button>
            </span>
          </div>
          -->
        </div>
      </div>

      <!-- Sezione rimborso carta (semplice, solo quando l'evento √® un rimborso) -->
      <div class="form-section panel--flat" id="eventRepaymentSection">
        <p class="section-title">Rimborso carta (modifica)</p>
        <div class="form-grid">
          <div class="field">
            <label class="label" for="editRepayFromWallet">Da wallet (sorgente)</label>
            <select class="select" id="editRepayFromWallet">
              <!-- Popolato via JS -->
            </select>
          </div>
          <div class="field">
            <label class="label" for="editRepayToCard">A carta (wallet carta)</label>
            <select class="select" id="editRepayToCard">
              <!-- Popolato via JS -->
            </select>
          </div>
          <div class="field">
            <label class="label" for="editRepayDate">Data pagamento reale</label>
            <input class="input" id="editRepayDate" type="date" />
          </div>
          <div class="field">
            <label class="label" for="editRepayAmount">Importo (EUR)</label>
            <input class="input" id="editRepayAmount" type="number" min="0" step="0.01" />
          </div>
        </div>
        <div class="hint" style="margin-top:8px;">
          Effetto: diminuisce il wallet sorgente e aumenta il plafond disponibile della carta. Rimane sempre modificabile.
        </div>
      </div>
    </div>
  </div>
<!-- MODALE EVENTI DEL GIORNO -->
<div id="dayEventsModal"
     style="
       position:fixed;
       inset:0;
       background:rgba(15,23,42,0.75);
       display:none;
       align-items:center;
       justify-content:center;
       z-index:50;
     ">
  <div
    style="
      background:#020617;
      color:#e5e7eb;
      width:min(600px, 92vw);
      max-height:82vh;
      border-radius:18px;
      box-shadow:0 24px 60px rgba(0,0,0,0.7);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      border:1px solid rgba(148,163,184,0.4);
    ">
    <!-- HEADER -->
    <div
      style="
        padding:10px 16px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        border-bottom:1px solid rgba(51,65,85,0.8);
        background:radial-gradient(circle at top left,rgba(59,130,246,0.12),transparent);
      ">
      <div>
        <div id="dayModalDate"
             style="font-weight:600;font-size:15px;letter-spacing:0.02em;">
          <!-- 10 Gen 2025 -->
        </div>
        <div id="dayModalSummary"
             style="font-size:12px;color:#9ca3af;margin-top:2px;">
          <!-- Totali del giorno -->
        </div>
      </div>
      <button id="dayModalClose"
              type="button"
              class="btn"
              style="
                min-width:auto;
                padding:4px 10px;
                font-size:13px;
                border-radius:999px;
              ">
        ‚úï
      </button>
    </div>

    <!-- CONTENUTO -->
    <div id="dayModalContent"
         style="
           padding:10px 14px 12px;
           overflow-y:auto;
           display:flex;
           flex-direction:column;
           gap:6px;
         ">
      <!-- Riga vuota di default -->
      <div class="hint" style="margin-top:4px;">
        Nessun evento registrato per questo giorno.
      </div>
    </div>
  </div>
</div>
<!-- Payoff Modal -->
<div class="modal hide" id="payoffModal">
  <div class="modal-content" style="max-width:720px;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <h3 style="margin:0;">Estinzione anticipata</h3>
      <button class="btn" id="payoffCloseBtn">Chiudi</button>
    </div>

    <div style="margin-top:10px; font-size:12px; opacity:.85;">
      Purchase ID: <span id="payoffPurchaseIdLabel">‚Äî</span> ‚Ä¢ Carta: <span id="payoffCardWalletIdLabel">‚Äî</span>
    </div>

    <div style="margin-top:12px; display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px;">
      <div>
        <label style="display:block; font-size:12px; opacity:.8;">Da wallet (fromWalletId)</label>
        <select class="input" id="payoffFromWalletId"></select>
      </div>
      <div>
        <label style="display:block; font-size:12px; opacity:.8;">Payment date</label>
        <input class="input" type="date" id="payoffPaymentDate" />
      </div>
      <div>
        <label style="display:block; font-size:12px; opacity:.8;">Calendar date (statement date)</label>
        <input class="input" type="date" id="payoffCalendarDate" />
      </div>
      <div></div>

      <div>
        <label style="display:block; font-size:12px; opacity:.8;">Payoff principal (netto)</label>
        <input class="input" type="number" step="0.01" id="payoffPrincipal" placeholder="es. 1200.00" />
      </div>
      <div>
        <label style="display:block; font-size:12px; opacity:.8;">Payoff interest (zinsen)</label>
        <input class="input" type="number" step="0.01" id="payoffInterest" placeholder="es. 35.20" />
      </div>

      <div style="grid-column:1 / -1;">
        <label style="display:block; font-size:12px; opacity:.8;">Note</label>
        <textarea class="input" id="payoffNotes" rows="3" placeholder="Opzionale"></textarea>
      </div>
    </div>

    <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
      <button class="btn" id="payoffSubmitBtn">Esegui estinzione</button>
      <div id="payoffResult" style="font-size:12px; opacity:.85;"></div>
    </div>
  </div>
</div>

  <!-- Script principale -->
  <script src="finv2.js" defer></script>

  <!-- Mini bootstrap UI (solo per far vedere struttura e tab; logica reale in finv2.js) -->
  <script>
    (function(){
      // Default: mostra una data di riferimento leggibile (placeholder).
      const ref = document.getElementById('refDateLabel');
      const snap = document.getElementById('snapshotTitle');
      const todayISO = new Date().toISOString().slice(0,10);
      ref.textContent = todayISO;
      snap.textContent = "üìå Stato al: " + todayISO;

      // Tab switching (solo UI). La logica dati sar√† in finv2.js.
      function setActiveTab(tab){
        document.body.dataset.activeTab = tab;
        document.querySelectorAll('[data-tab]').forEach(b=>{
          b.setAttribute('aria-selected', b.dataset.tab === tab ? 'true' : 'false');
        });
      }
      document.addEventListener('click', (e)=>{
        const btn = e.target.closest('[data-tab]');
        if(btn) setActiveTab(btn.dataset.tab);
      });

      // CTA ‚Äú+ Nuovo‚Äù porta alla tab ‚ÄúNuovo evento‚Äù
      const btnNuovo = document.getElementById('btnNuovo');
      if(btnNuovo) btnNuovo.addEventListener('click', ()=> setActiveTab('nuovo'));

      // NOTA: la logica reale (API, snapshot, calendario, ecc.) verr√† implementata in finv2.js.
      // Qui c'√® solo il wiring base delle tab e dei pulsanti.

    })();
  </script>  
</body>
</html>
