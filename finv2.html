<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finance UI</title>

  <!-- CSS separato (lo faremo dopo) -->
  <link rel="stylesheet" href="fin-theme.css" />

  <!-- Minimo indispensabile (layout) -->
  <style>
    :root { --gap: 12px; --border: 1px solid #d0d0d0; --muted: #666; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
    header { padding: 10px 14px; border-bottom: var(--border); display:flex; gap: var(--gap); align-items:center; flex-wrap:wrap; }
    header .title { font-weight: 700; }
    main { padding: 14px; }
    .tabs { display:flex; gap: 8px; flex-wrap: wrap; }
    .tabbtn { padding: 8px 10px; border: var(--border); background: #fff; cursor:pointer; border-radius: 8px; }
    .tabbtn[aria-selected="true"] { font-weight: 700; outline: 2px solid #000; }
    .panel { display:none; }
    .panel.active { display:block; }
    .row { display:flex; gap: var(--gap); flex-wrap:wrap; align-items:flex-end; }
    .col { display:flex; flex-direction:column; gap: 6px; }
    label { font-size: 12px; color: var(--muted); }
    input, select, textarea { padding: 8px; border: var(--border); border-radius: 8px; min-width: 220px; }
    textarea { min-height: 80px; min-width: 320px; }
    button { padding: 8px 10px; border: var(--border); background: #fff; cursor:pointer; border-radius: 8px; }
    button.primary { outline: 2px solid #000; font-weight: 700; }
    button.danger { border-color: #b00020; color: #b00020; }
    .muted { color: var(--muted); font-size: 12px; }
    .card { border: var(--border); border-radius: 12px; padding: 12px; }
    .grid { display:grid; gap: 8px; }
    .grid.two { grid-template-columns: repeat(2, minmax(260px, 1fr)); }
    .grid.three { grid-template-columns: repeat(3, minmax(260px, 1fr)); }
    .calendar { border: var(--border); border-radius: 12px; overflow:hidden; }
    .cal-head { display:flex; justify-content:space-between; align-items:center; padding: 10px; border-bottom: var(--border); }
    .cal-grid { display:grid; grid-template-columns: repeat(7, 1fr); }
    .dow { padding: 8px; font-size: 12px; color: var(--muted); border-bottom: var(--border); background:#fafafa; }
    .day { min-height: 110px; border-right: var(--border); border-bottom: var(--border); padding: 6px; display:flex; flex-direction:column; gap: 6px; }
    .day:nth-child(7n) { border-right: none; }
    .daynum { font-size: 12px; color: var(--muted); display:flex; justify-content:space-between; align-items:center; gap: 6px; }
    .pill { display:inline-flex; gap: 6px; align-items:center; padding: 4px 6px; border: var(--border); border-radius: 999px; font-size: 12px; cursor:pointer; }
    .pill small { color: var(--muted); }
    .list { display:flex; flex-direction:column; gap: 8px; }
    details { border: var(--border); border-radius: 12px; padding: 10px; }
    details > summary { cursor:pointer; font-weight: 700; }
    table { border-collapse: collapse; width: 100%; }
    th, td { text-align:left; border-bottom: var(--border); padding: 8px; font-size: 14px; }
    th { font-size: 12px; color: var(--muted); background: #fafafa; }
    .toast { position: fixed; right: 12px; bottom: 12px; padding: 10px 12px; border: var(--border); background: #fff; border-radius: 12px; max-width: 360px; display:none; }
    .toast.show { display:block; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; padding: 2px 6px; border: var(--border); border-radius: 8px; background:#fafafa; }
    .hr { height: 1px; background: #e6e6e6; margin: 12px 0; }
  </style>
</head>

<body>
  <header>
    <div class="title">Finance UI</div>
    <div class="muted">Calendario eventi • Settings • Carte (totali, subtotali, confronto mese)</div>
    <div style="flex:1"></div>
    <div class="col">
      <label>API Base (se serve)</label>
      <input id="apiBase" placeholder="/finance" value="/finance" />
      <div class="muted">Se il blueprint è montato altrove, cambia qui (es. <span class="kbd">/api/finance</span>).</div>
    </div>
    <button id="btnReloadAll" class="primary">Ricarica dati</button>
  </header>

  <main>
    <nav class="tabs" role="tablist" aria-label="Finance tabs">
      <button class="tabbtn" role="tab" aria-selected="true" data-tab="tabCalendar">Calendario eventi</button>
      <button class="tabbtn" role="tab" aria-selected="false" data-tab="tabSettings">Settings</button>
      <button class="tabbtn" role="tab" aria-selected="false" data-tab="tabCards">Carte & Subtotali</button>
    </nav>

    <div class="hr"></div>

    <!-- =================== TAB: CALENDAR =================== -->
    <section id="tabCalendar" class="panel active" role="tabpanel">
      <div class="row">
        <div class="col">
          <label>Mese</label>
          <input id="calMonth" type="month" />
          <div class="muted">Mostra eventi nel mese selezionato.</div>
        </div>

        <div class="col">
          <label>Filtro wallet/carta (opzionale)</label>
          <select id="calWalletFilter">
            <option value="">Tutti</option>
          </select>
          <div class="muted">Filtro usa <span class="kbd">walletId</span> (backend filtra su più campi).</div>
        </div>

        <div class="col">
          <label>Ricerca (titolo/categoria/note)</label>
          <input id="calSearch" placeholder="es. supermercato, affitto..." />
        </div>

        <div class="col">
          <label>&nbsp;</label>
          <button id="btnCalRefresh" class="primary">Aggiorna</button>
        </div>

        <div class="col">
          <label>&nbsp;</label>
          <button id="btnNewEvent">+ Nuovo evento</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="calendar">
        <div class="cal-head">
          <div class="row" style="align-items:center">
            <button id="btnPrevMonth" title="Mese precedente">◀</button>
            <div>
              <div id="calTitle" style="font-weight:800"></div>
              <div class="muted">Clicca su un giorno per creare. Clicca su un evento per modificare.</div>
            </div>
            <button id="btnNextMonth" title="Mese successivo">▶</button>
          </div>
          <div class="row" style="align-items:center">
            <span class="muted">Suggerimento: per duplicare lo stesso evento su più mesi usa “Duplica su mesi…” nell’editor.</span>
          </div>
        </div>

        <div class="cal-grid" id="calDow"></div>
        <div class="cal-grid" id="calGrid"></div>
      </div>

      <div class="hr"></div>

      <div class="card">
        <div style="font-weight:800; margin-bottom:8px;">Elenco eventi nel mese (vista tabellare)</div>
        <div class="muted" style="margin-bottom:8px;">Questa lista è comoda per verifiche rapide e modifiche.</div>
        <div style="overflow:auto">
          <table id="eventsTable">
            <thead>
              <tr>
                <th>ID</th><th>Data</th><th>Tipo</th><th>Titolo</th><th>Categoria</th><th>Importo</th><th>Wallet</th><th>Azioni</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Editor (modal) -->
      <dialog id="dlgEvent" style="width:min(900px, 96vw); border: var(--border); border-radius: 12px; padding: 12px;">
        <form method="dialog" id="eventForm">
          <div class="row" style="justify-content:space-between; align-items:center;">
            <div>
              <div id="dlgTitle" style="font-weight:900; font-size: 18px;">Evento</div>
              <div class="muted">Compila i campi in modo semplice. Se non sai: lascia i default.</div>
            </div>
            <div class="row">
              <button id="btnDlgClose">Chiudi</button>
            </div>
          </div>

          <div class="hr"></div>

          <div class="grid two">
            <div class="col">
              <label>Tipo evento</label>
              <select id="evType">
                <option value="expense">Spesa (wallet normale)</option>
                <option value="income">Entrata (wallet normale)</option>
                <option value="card_purchase">Acquisto con carta</option>
                <option value="card_repayment">Rimborso carta (da wallet a carta)</option>
                <option value="card_credit">Gutschrift / Storno (su carta)</option>
                <option value="card_charge">Addebito carta (interessi/fee)</option>
              </select>
              <div class="muted">Scegli in base a “cosa è successo” nella realtà.</div>
            </div>

            <div class="col">
              <label>Data (calendario)</label>
              <input id="evCalendarDate" type="date" />
              <div class="muted">Per <span class="kbd">card_purchase</span> è ok: verrà anche come <span class="kbd">purchaseDate</span>.</div>
            </div>

            <div class="col">
              <label>Titolo</label>
              <input id="evTitle" placeholder="es. Supermercato" />
            </div>

            <div class="col">
              <label>Categoria</label>
              <input id="evCategory" placeholder="es. Alimentari" />
            </div>

            <div class="col">
              <label>Importo (positivo)</label>
              <input id="evAmount" type="number" step="0.01" placeholder="0.00" />
            </div>

            <div class="col">
              <label>Note (opzionale)</label>
              <textarea id="evNotes" placeholder="Dettagli (opzionale)"></textarea>
            </div>
          </div>

          <div class="hr"></div>

          <div class="grid three">
            <div class="col">
              <label>Wallet (income/expense)</label>
              <select id="evWalletId"><option value="">—</option></select>
              <div class="muted">Usato per income/expense.</div>
            </div>

            <div class="col">
              <label>Carta (card_purchase / card_credit / card_charge)</label>
              <select id="evCardWalletId"><option value="">—</option></select>
              <div class="muted">Seleziona la carta su cui avviene l’operazione.</div>
            </div>

            <div class="col">
              <label>Da wallet → a carta (card_repayment)</label>
              <div class="row">
                <select id="evFromWalletId" style="min-width:260px"><option value="">Da wallet…</option></select>
                <select id="evToCardWalletId" style="min-width:260px"><option value="">A carta…</option></select>
              </div>
              <div class="muted">Per rimborso carta: scegli conto e carta.</div>
            </div>
          </div>

          <div class="hr"></div>

          <details id="scheduleBox">
            <summary>Pagamento rateale / finanziamento (solo per card_purchase)</summary>
            <div class="muted" style="margin:8px 0;">
              Se non hai rate, lascia “Instant”.
            </div>

            <div class="grid two">
              <div class="col">
                <label>Tipo</label>
                <select id="schedKind">
                  <option value="instant">Instant (tutto nello statement)</option>
                  <option value="financing">Financing (rate)</option>
                </select>
              </div>

              <div class="col">
                <label>Numero rate (count)</label>
                <input id="schedCount" type="number" min="1" step="1" placeholder="es. 12" />
                <div class="muted">Solo se Financing.</div>
              </div>

              <div class="col">
                <label>Primo statement month (YYYY-MM)</label>
                <input id="schedFirstStatementMonth" placeholder="es. 2026-02" />
                <div class="muted">Indica da quale mese parte la prima rata.</div>
              </div>

              <div class="col">
                <label>Importo rata fisso (opzionale)</label>
                <input id="schedInstallmentAmount" type="number" step="0.01" placeholder="se vuoto = amount/count" />
              </div>
            </div>

            <div class="hr"></div>

            <details>
              <summary>Rate personalizzate (opzionale)</summary>
              <div class="muted" style="margin:8px 0;">
                Inserisci una riga per rata: <span class="kbd">YYYY-MM-DD;importo</span>
              </div>
              <textarea id="schedCustomInstallments" placeholder="2026-03-05; 50.00&#10;2026-04-05; 50.00"></textarea>
            </details>
          </details>

          <div class="hr"></div>

          <details>
            <summary>Duplica su mesi (crea copie dello stesso evento)</summary>
            <div class="muted" style="margin:8px 0;">
              Crea eventi separati (drop-in, senza toccare series). Utile per “stesso evento in più mesi”.
            </div>
            <div class="row">
              <div class="col">
                <label>Da mese</label>
                <input id="dupFromMonth" type="month" />
              </div>
              <div class="col">
                <label>A mese</label>
                <input id="dupToMonth" type="month" />
              </div>
              <div class="col">
                <label>Giorno del mese</label>
                <input id="dupDay" type="number" min="1" max="31" step="1" placeholder="es. 1" />
                <div class="muted">Se il mese ha meno giorni, viene clampato all’ultimo giorno.</div>
              </div>
              <div class="col">
                <label>&nbsp;</label>
                <button type="button" id="btnDuplicate">Duplica ora</button>
              </div>
            </div>
          </details>

          <div class="hr"></div>

          <input type="hidden" id="evId" value="" />

          <div class="row" style="justify-content:space-between;">
            <div class="row">
              <button type="button" id="btnDelete" class="danger" style="display:none;">Cancella</button>
            </div>
            <div class="row">
              <button type="button" id="btnSave" class="primary">Salva</button>
            </div>
          </div>

          <div id="dlgHint" class="muted" style="margin-top:10px;"></div>
        </form>
      </dialog>
    </section>

    <!-- =================== TAB: SETTINGS =================== -->
    <section id="tabSettings" class="panel" role="tabpanel">
      <div class="grid two">
        <div class="card">
          <div style="font-weight:800; margin-bottom:6px;">Wallet & Carte (seleziona)</div>
          <div class="muted" style="margin-bottom:10px;">I settings si applicano alle carte (wallet type=card).</div>

          <div class="col">
            <label>Carta</label>
            <select id="setCardSelect"><option value="">— Seleziona carta —</option></select>
          </div>

          <div class="hr"></div>

          <div class="grid two">
            <div class="col">
              <label>Cycle Start Day</label>
              <input id="setCycleStart" type="number" min="1" max="31" step="1" />
              <div class="muted">Esempio: 16</div>
            </div>
            <div class="col">
              <label>Cycle End Day</label>
              <input id="setCycleEnd" type="number" min="1" max="31" step="1" />
              <div class="muted">Esempio: 15</div>
            </div>
            <div class="col">
              <label>Debit Day</label>
              <input id="setDebitDay" type="number" min="1" max="31" step="1" />
              <div class="muted">Esempio: 18</div>
            </div>
            <div class="col">
              <label>Debit Month Offset</label>
              <input id="setDebitOffset" type="number" step="1" />
              <div class="muted">0 = stesso mese, 1 = mese successivo</div>
            </div>
            <div class="col">
              <label>Teilzahlung Amount (opzionale)</label>
              <input id="setTeilzahlung" type="number" step="0.01" />
            </div>
            <div class="col">
              <label>Kreditlimit (opzionale)</label>
              <input id="setLimit" type="number" step="0.01" />
            </div>
            <div class="col">
              <label>Sollzins Annual (opzionale)</label>
              <input id="setSoll" type="number" step="0.01" />
            </div>
            <div class="col">
              <label>Effektivzins Annual (opzionale)</label>
              <input id="setEffektiv" type="number" step="0.01" />
            </div>
            <div class="col">
              <label>Effective From</label>
              <input id="setEffectiveFrom" type="date" />
              <div class="muted">Da quando vale Teilzahlung (e simili).</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <button id="btnLoadCardSettings">Carica settings</button>
            <button id="btnSaveCardSettings" class="primary">Salva settings</button>
          </div>

          <div id="settingsInfo" class="muted" style="margin-top:10px;"></div>
        </div>

        <div class="card">
          <div style="font-weight:800; margin-bottom:6px;">Note operative</div>
          <ul class="muted" style="margin:0; padding-left: 18px;">
            <li>Questa UI usa solo API già esistenti: <span class="kbd">/wallets</span>, <span class="kbd">/events</span>, <span class="kbd">/dashboard</span>, <span class="kbd">/cards/&lt;id&gt;/settings</span>.</li>
            <li>Nessuna migrazione DB: lavora “drop-in” sui dati in produzione.</li>
            <li>Le cancellazioni chiedono sempre conferma.</li>
            <li>Se qualcosa non torna: controlla <span class="kbd">API Base</span> in alto.</li>
          </ul>

          <div class="hr"></div>

          <div class="col">
            <label>Health</label>
            <button id="btnHealth">Test connessione</button>
            <div id="healthOut" class="muted"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- =================== TAB: CARDS =================== -->
    <section id="tabCards" class="panel" role="tabpanel">
      <div class="row">
        <div class="col">
          <label>As Of (data)</label>
          <input id="cardsAsOf" type="date" />
          <div class="muted">Bilanci / outstanding / disponibili “fino a”.</div>
        </div>

        <div class="col">
          <label>Mese selezionato (per confronti e categorie)</label>
          <input id="cardsMonth" type="month" />
        </div>

        <div class="col">
          <label>&nbsp;</label>
          <button id="btnCardsRefresh" class="primary">Aggiorna</button>
        </div>
      </div>

      <div class="hr"></div>

      <div id="cardsOverview" class="grid two"></div>

      <div class="hr"></div>

      <div class="card">
        <div style="font-weight:800; margin-bottom:6px;">Dettagli per wallet/carta (albero richiudibile)</div>
        <div class="muted" style="margin-bottom:10px;">
          Ogni sezione è richiudibile. Mostra: saldo, spese, entrate, confronto mese, categorie (top 10), e per carte: statement window + repayment previsto.
        </div>
        <div id="walletTree" class="list"></div>
      </div>
    </section>

    <div id="toast" class="toast"></div>
  </main>

  <script>
    // =========================
    // CONFIG / STATE
    // =========================
    const $ = (id) => document.getElementById(id);

    const state = {
      apiBase: "https://iamemanuele.pythonanywhere.com/finance",
      wallets: [],
      walletById: new Map(),
      events: [],
      month: null,     // Date object (1st of month)
      dashboard: null,
    };

    function isoDate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${dd}`;
    }
    function isoYM(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      return `${y}-${m}`;
    }
    function parseYM(s) {
      if (!s || s.length < 7) return null;
      const y = parseInt(s.slice(0,4),10);
      const m = parseInt(s.slice(5,7),10);
      if (!y || !m) return null;
      return new Date(y, m-1, 1);
    }
    function clampDayToMonth(y, m1to12, day) {
      const last = new Date(y, m1to12, 0).getDate(); // month is 1..12 => passing m gives last day of prev? Here m1to12 is 1..12 so date(y,m,0)=last of m
      return Math.min(Math.max(1, day), last);
    }
    function toast(msg, ms=4000) {
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      window.clearTimeout(t._timer);
      t._timer = window.setTimeout(()=>t.classList.remove("show"), ms);
    }

    // =========================
    // API
    // =========================
    function apiBase() {
      state.apiBase = ($("apiBase").value || "").trim() || "/finance";
      return state.apiBase.replace(/\/+$/,"");
    }

    async function apiFetch(path, opts={}) {
      const url = apiBase() + path;
      const res = await fetch(url, {
        headers: { "Content-Type":"application/json" },
        ...opts
      });
      if (!res.ok) {
        let txt = "";
        try { txt = await res.text(); } catch {}
        throw new Error(`HTTP ${res.status} ${res.statusText} - ${txt}`);
      }
      const ct = res.headers.get("content-type") || "";
      if (ct.includes("application/json")) return await res.json();
      return await res.text();
    }

    // =========================
    // TABS
    // =========================
    function setTab(tabId) {
      document.querySelectorAll(".tabbtn").forEach(b=>{
        const sel = b.dataset.tab === tabId;
        b.setAttribute("aria-selected", sel ? "true":"false");
      });
      document.querySelectorAll(".panel").forEach(p=>{
        p.classList.toggle("active", p.id === tabId);
      });
    }
    document.querySelectorAll(".tabbtn").forEach(b=>{
      b.addEventListener("click", ()=> setTab(b.dataset.tab));
    });

    // =========================
    // LOAD WALLETS
    // =========================
    async function loadWallets() {
      const wallets = await apiFetch("/wallets", { method:"GET" });
      state.wallets = Array.isArray(wallets) ? wallets : [];
      state.walletById = new Map(state.wallets.map(w => [String(w.id), w]));

      // Calendar filter
      const wf = $("calWalletFilter");
      wf.innerHTML = `<option value="">Tutti</option>`;
      for (const w of state.wallets) {
        const opt = document.createElement("option");
        opt.value = String(w.id);
        opt.textContent = `${w.name} (${w.type})`;
        wf.appendChild(opt);
      }

      // Event editor selects
      const walletSelects = [$("evWalletId"), $("evFromWalletId")];
      for (const s of walletSelects) {
        s.innerHTML = `<option value="">—</option>`;
        for (const w of state.wallets.filter(x => x.type !== "card")) {
          const opt = document.createElement("option");
          opt.value = String(w.id);
          opt.textContent = w.name;
          s.appendChild(opt);
        }
      }
      const cardSelects = [$("evCardWalletId"), $("evToCardWalletId"), $("setCardSelect")];
      for (const s of cardSelects) {
        if (s === $("setCardSelect")) s.innerHTML = `<option value="">— Seleziona carta —</option>`;
        else s.innerHTML = `<option value="">—</option>`;
        for (const w of state.wallets.filter(x => x.type === "card")) {
          const opt = document.createElement("option");
          opt.value = String(w.id);
          opt.textContent = w.name;
          s.appendChild(opt);
        }
      }
    }

    // =========================
    // CALENDAR: LOAD EVENTS
    // =========================
    function monthBounds(d) {
      const start = new Date(d.getFullYear(), d.getMonth(), 1);
      const end = new Date(d.getFullYear(), d.getMonth()+1, 0);
      return { start, end };
    }

    async function loadEventsForMonth() {
      const m = state.month || new Date(new Date().getFullYear(), new Date().getMonth(), 1);
      const { start, end } = monthBounds(m);

      const from = isoDate(start);
      const to = isoDate(end);

      const walletId = ($("calWalletFilter").value || "").trim();
      const q = ($("calSearch").value || "").trim();

      const params = new URLSearchParams({ from, to });
      if (walletId) params.set("walletId", walletId);
      if (q) params.set("q", q);

      const events = await apiFetch("/events?" + params.toString(), { method:"GET" });
      state.events = Array.isArray(events) ? events : [];

      renderCalendar();
      renderEventsTable();
    }

    function eventEffectiveDate(ev) {
      // backend: card_purchase uses purchaseDate (fallback calendarDate) for filtering; others use calendarDate
      return ev.effectiveDate || ev.purchaseDate || ev.calendarDate || ev.paymentDate || "";
    }

    function groupEventsByDate(events) {
      const map = new Map();
      for (const ev of events) {
        const d = eventEffectiveDate(ev);
        if (!d) continue;
        const key = d.slice(0,10);
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(ev);
      }
      for (const [k, arr] of map.entries()) {
        arr.sort((a,b)=> (a.id||0)-(b.id||0));
      }
      return map;
    }

    function fmtMoney(n) {
      if (n === null || n === undefined || Number.isNaN(Number(n))) return "";
      const x = Number(n);
      return x.toLocaleString("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function typeLabel(t) {
      const m = {
        income: "Entrata",
        expense: "Spesa",
        card_purchase: "Acquisto carta",
        card_repayment: "Rimborso carta",
        card_credit: "Gutschrift",
        card_charge: "Addebito carta",
      };
      return m[t] || t;
    }

    function renderCalendar() {
      const m = state.month;
      if (!m) return;
      $("calTitle").textContent = `${m.toLocaleDateString("it-IT", { month:"long", year:"numeric" })}`;

      const dow = ["Lun","Mar","Mer","Gio","Ven","Sab","Dom"];
      const calDow = $("calDow");
      calDow.innerHTML = "";
      for (const d of dow) {
        const el = document.createElement("div");
        el.className = "dow";
        el.textContent = d;
        calDow.appendChild(el);
      }

      const { start, end } = monthBounds(m);
      const firstDow = (new Date(start)).getDay(); // 0 Sun
      const mondayBased = (firstDow + 6) % 7; // 0=Mon
      const gridStart = new Date(start);
      gridStart.setDate(start.getDate() - mondayBased);

      const byDate = groupEventsByDate(state.events);

      const calGrid = $("calGrid");
      calGrid.innerHTML = "";

      // 6 weeks grid
      for (let i=0; i<42; i++) {
        const d = new Date(gridStart);
        d.setDate(gridStart.getDate()+i);
        const ds = isoDate(d);
        const inMonth = d.getMonth() === m.getMonth();

        const cell = document.createElement("div");
        cell.className = "day";
        cell.style.opacity = inMonth ? "1" : "0.45";

        const head = document.createElement("div");
        head.className = "daynum";

        const left = document.createElement("span");
        left.textContent = String(d.getDate());

        const addBtn = document.createElement("button");
        addBtn.textContent = "+";
        addBtn.title = "Nuovo evento in questo giorno";
        addBtn.addEventListener("click", (e)=>{
          e.stopPropagation();
          openEventDialogForNew(ds);
        });

        head.appendChild(left);
        head.appendChild(addBtn);

        cell.appendChild(head);

        const list = document.createElement("div");
        list.className = "list";

        const evs = byDate.get(ds) || [];
        for (const ev of evs.slice(0, 6)) {
          const pill = document.createElement("div");
          pill.className = "pill";
          pill.title = "Clicca per modificare";
          pill.addEventListener("click", ()=> openEventDialogForEdit(ev.id));

          const t = document.createElement("span");
          t.textContent = ev.title || "(senza titolo)";

          const a = document.createElement("small");
          a.textContent = `${typeLabel(ev.type)} • ${fmtMoney(ev.amount)}`;

          pill.appendChild(t);
          pill.appendChild(a);
          list.appendChild(pill);
        }

        if (evs.length > 6) {
          const more = document.createElement("div");
          more.className = "muted";
          more.textContent = `+${evs.length - 6} altri…`;
          list.appendChild(more);
        }

        cell.appendChild(list);

        // click day to create
        cell.addEventListener("click", ()=> openEventDialogForNew(ds));

        calGrid.appendChild(cell);
      }
    }

    function renderEventsTable() {
      const tb = document.querySelector("#eventsTable tbody");
      tb.innerHTML = "";
      const rows = [...state.events].sort((a,b)=>{
        const da = eventEffectiveDate(a) || "";
        const db = eventEffectiveDate(b) || "";
        if (da < db) return -1;
        if (da > db) return 1;
        return (a.id||0)-(b.id||0);
      });

      for (const ev of rows) {
        const tr = document.createElement("tr");

        const wid = ev.walletId || ev.cardWalletId || ev.fromWalletId || ev.toCardWalletId || "";
        const wName = wid ? (state.walletById.get(String(wid))?.name || String(wid)) : "";

        tr.innerHTML = `
          <td>${ev.id ?? ""}</td>
          <td>${eventEffectiveDate(ev) || ""}</td>
          <td>${typeLabel(ev.type)}</td>
          <td>${(ev.title||"").replace(/</g,"&lt;")}</td>
          <td>${(ev.category||"").replace(/</g,"&lt;")}</td>
          <td>${fmtMoney(ev.amount)}</td>
          <td>${wName}</td>
          <td></td>
        `;

        const actions = document.createElement("div");
        actions.className = "row";

        const btnEdit = document.createElement("button");
        btnEdit.textContent = "Modifica";
        btnEdit.addEventListener("click", ()=> openEventDialogForEdit(ev.id));

        const btnDel = document.createElement("button");
        btnDel.textContent = "Cancella";
        btnDel.className = "danger";
        btnDel.addEventListener("click", ()=> deleteEventById(ev.id));

        actions.appendChild(btnEdit);
        actions.appendChild(btnDel);

        tr.children[7].appendChild(actions);
        tb.appendChild(tr);
      }
    }

    // =========================
    // EVENT DIALOG CRUD
    // =========================
    function resetEventDialog() {
      $("evId").value = "";
      $("evType").value = "expense";
      $("evCalendarDate").value = isoDate(new Date());
      $("evTitle").value = "";
      $("evCategory").value = "";
      $("evAmount").value = "";
      $("evNotes").value = "";

      $("evWalletId").value = "";
      $("evCardWalletId").value = "";
      $("evFromWalletId").value = "";
      $("evToCardWalletId").value = "";

      $("schedKind").value = "instant";
      $("schedCount").value = "";
      $("schedFirstStatementMonth").value = "";
      $("schedInstallmentAmount").value = "";
      $("schedCustomInstallments").value = "";

      $("dupFromMonth").value = "";
      $("dupToMonth").value = "";
      $("dupDay").value = "";

      $("btnDelete").style.display = "none";
      $("dlgHint").textContent = "";
      $("dlgTitle").textContent = "Nuovo evento";
    }

    function openEventDialogForNew(isoDateStr) {
      resetEventDialog();
      $("evCalendarDate").value = (isoDateStr || isoDate(new Date())).slice(0,10);
      $("dlgHint").textContent = "Crea un evento. Se è un acquisto con carta, usa “Acquisto con carta”.";
      $("dlgEvent").showModal();
    }

    function fillScheduleFromEvent(ev) {
      const s = ev.schedule || null;
      if (!s || typeof s !== "object") {
        $("schedKind").value = "instant";
        return;
      }
      const kind = (s.kind || "instant");
      $("schedKind").value = kind;

      if (kind === "financing") {
        $("schedCount").value = s.count ?? "";
        $("schedFirstStatementMonth").value = s.firstStatementMonth ?? "";

        const mi = s.monthlyInstallments || {};
        if (mi && typeof mi === "object" && mi.installmentAmount != null) {
          $("schedInstallmentAmount").value = mi.installmentAmount;
        }
        const ci = s.customInstallments;
        if (Array.isArray(ci) && ci.length) {
          $("schedCustomInstallments").value = ci.map(x => `${x.date}; ${x.amount}`).join("\n");
        }
      }
    }

    async function openEventDialogForEdit(id) {
      const ev = state.events.find(x => String(x.id) === String(id));
      if (!ev) {
        // fallback: reload month events and try again
        await loadEventsForMonth();
      }
      const ev2 = state.events.find(x => String(x.id) === String(id));
      if (!ev2) {
        toast("Evento non trovato (forse già cancellato).");
        return;
      }

      resetEventDialog();
      $("dlgTitle").textContent = `Modifica evento #${ev2.id}`;
      $("evId").value = String(ev2.id);
      $("evType").value = ev2.type || "expense";

      // calendarDate
      const cd = (ev2.calendarDate || ev2.purchaseDate || ev2.paymentDate || "");
      if (cd) $("evCalendarDate").value = cd.slice(0,10);

      $("evTitle").value = ev2.title || "";
      $("evCategory").value = ev2.category || "";
      $("evAmount").value = ev2.amount ?? "";
      $("evNotes").value = ev2.notes || "";

      $("evWalletId").value = ev2.walletId ? String(ev2.walletId) : "";
      $("evCardWalletId").value = ev2.cardWalletId ? String(ev2.cardWalletId) : "";
      $("evFromWalletId").value = ev2.fromWalletId ? String(ev2.fromWalletId) : "";
      $("evToCardWalletId").value = ev2.toCardWalletId ? String(ev2.toCardWalletId) : "";

      fillScheduleFromEvent(ev2);

      $("btnDelete").style.display = "inline-flex";
      $("dlgHint").textContent = "Salva applica modifiche immediate. Duplica crea copie in altri mesi.";
      $("dlgEvent").showModal();
    }

    function buildScheduleForSave() {
      const t = $("evType").value;
      if (t !== "card_purchase") return null;

      const kind = ($("schedKind").value || "instant").trim();
      if (kind === "instant") return { kind:"instant" };

      // financing
      const count = parseInt($("schedCount").value || "0", 10);
      const fsm = ($("schedFirstStatementMonth").value || "").trim();

      const sched = { kind:"financing" };
      if (Number.isFinite(count) && count > 0) sched.count = count;
      if (fsm) sched.firstStatementMonth = fsm;

      const instAmountStr = ($("schedInstallmentAmount").value || "").trim();
      if (instAmountStr) {
        const ia = Number(instAmountStr);
        if (!Number.isNaN(ia) && ia > 0) {
          sched.monthlyInstallments = { installmentAmount: ia };
        }
      }

      const ciRaw = ($("schedCustomInstallments").value || "").trim();
      if (ciRaw) {
        const lines = ciRaw.split("\n").map(s => s.trim()).filter(Boolean);
        const ci = [];
        for (const ln of lines) {
          const parts = ln.split(";").map(x=>x.trim());
          if (parts.length < 2) continue;
          const d = parts[0];
          const a = Number(parts[1].replace(",", "."));
          if (d && !Number.isNaN(a) && a > 0) {
            ci.push({ date: d, amount: a });
          }
        }
        if (ci.length) {
          sched.customInstallments = ci;
          // count coerente lato backend: verrà forzato = len(ci)
        }
      }

      return sched;
    }

    function buildEventPayload() {
      const type = $("evType").value;
      const calendarDate = $("evCalendarDate").value;

      const payload = {
        type,
        title: ($("evTitle").value || "").trim(),
        amount: Number(($("evAmount").value || "").replace(",", ".")),
        category: ($("evCategory").value || "").trim(),
        calendarDate,
        notes: $("evNotes").value || "",
      };

      // routing wallet fields
      if (type === "income" || type === "expense") {
        payload.walletId = $("evWalletId").value ? Number($("evWalletId").value) : null;
      }
      if (type === "card_purchase" || type === "card_credit" || type === "card_charge") {
        payload.cardWalletId = $("evCardWalletId").value ? Number($("evCardWalletId").value) : null;
      }
      if (type === "card_repayment") {
        payload.fromWalletId = $("evFromWalletId").value ? Number($("evFromWalletId").value) : null;
        payload.toCardWalletId = $("evToCardWalletId").value ? Number($("evToCardWalletId").value) : null;
        payload.paymentDate = calendarDate; // semplice: stesso giorno (puoi cambiare poi in edit)
      }

      // purchaseDate for card_purchase
      if (type === "card_purchase") {
        payload.purchaseDate = calendarDate;
        payload.schedule = buildScheduleForSave();
      }

      // subtype for card_charge (richiesto dal backend)
      if (type === "card_charge") {
        // default safe
        payload.subType = "fee_card";
      }

      // subtype for card_credit
      if (type === "card_credit") {
        payload.subType = "gutschrift";
      }

      return payload;
    }

    async function saveEvent() {
      const id = ($("evId").value || "").trim();
      const payload = buildEventPayload();

      // Minimal client validation (backend farà il resto)
      if (!payload.title) return toast("Titolo obbligatorio.");
      if (!payload.category) return toast("Categoria obbligatoria.");
      if (!payload.calendarDate) return toast("Data obbligatoria.");
      if (!Number.isFinite(payload.amount) || payload.amount <= 0) return toast("Importo deve essere > 0.");

      if ((payload.type === "income" || payload.type === "expense") && !payload.walletId) {
        return toast("Per entrata/spesa scegli un wallet.");
      }
      if ((payload.type === "card_purchase" || payload.type === "card_credit" || payload.type === "card_charge") && !payload.cardWalletId) {
        return toast("Per operazione su carta scegli la carta.");
      }
      if (payload.type === "card_repayment" && (!payload.fromWalletId || !payload.toCardWalletId)) {
        return toast("Per rimborso carta scegli wallet di origine e carta.");
      }

      try {
        if (!id) {
          await apiFetch("/events", { method:"POST", body: JSON.stringify(payload) });
          toast("Evento creato.");
        } else {
          // PUT: usa campi compatibili con backend (camelCase già ok)
          await apiFetch(`/events/${encodeURIComponent(id)}`, { method:"PUT", body: JSON.stringify(payload) });
          toast("Evento aggiornato.");
        }
        $("dlgEvent").close();
        await loadEventsForMonth();
      } catch (e) {
        toast("Errore salvataggio: " + (e.message || e));
      }
    }

    async function deleteEventById(id) {
      if (!id) return;
      const ok = confirm(`Cancellare l'evento #${id}? Questa azione è immediata.`);
      if (!ok) return;
      try {
        await apiFetch(`/events/${encodeURIComponent(id)}`, { method:"DELETE" });
        toast("Evento cancellato.");
        await loadEventsForMonth();
      } catch (e) {
        toast("Errore cancellazione: " + (e.message || e));
      }
    }

    async function duplicateEventAcrossMonths() {
      const basePayload = buildEventPayload();

      const fromYM = $("dupFromMonth").value;
      const toYM = $("dupToMonth").value;
      const day = parseInt($("dupDay").value || "0", 10);

      if (!fromYM || !toYM) return toast("Imposta Da mese e A mese.");
      if (!Number.isFinite(day) || day <= 0) return toast("Imposta Giorno del mese (1..31).");

      const from = parseYM(fromYM);
      const to = parseYM(toYM);
      if (!from || !to) return toast("Mesi non validi.");
      if (from > to) return toast("Da mese deve essere <= A mese.");

      // crea copie: una per mese
      const copies = [];
      const cur = new Date(from.getFullYear(), from.getMonth(), 1);
      const end = new Date(to.getFullYear(), to.getMonth(), 1);
      while (cur <= end) {
        const y = cur.getFullYear();
        const m1 = cur.getMonth() + 1;
        const dd = clampDayToMonth(y, m1, day);
        const d = new Date(y, m1-1, dd);

        const p = JSON.parse(JSON.stringify(basePayload));
        p.calendarDate = isoDate(d);
        if (p.type === "card_purchase") p.purchaseDate = p.calendarDate;
        if (p.type === "card_repayment") {
          p.paymentDate = p.calendarDate;
        }

        // IMPORTANT: non duplicare l'ID (ovviamente), e forziamo sempre POST
        copies.push(p);

        cur.setMonth(cur.getMonth() + 1);
      }

      const ok = confirm(`Creare ${copies.length} copie?`);
      if (!ok) return;

      try {
        for (const p of copies) {
          await apiFetch("/events", { method:"POST", body: JSON.stringify(p) });
        }
        toast(`Copie create: ${copies.length}`);
        $("dlgEvent").close();
        await loadEventsForMonth();
      } catch (e) {
        toast("Errore duplicazione: " + (e.message || e));
      }
    }

    // =========================
    // SETTINGS (card_settings)
    // =========================
    async function healthCheck() {
      try {
        const out = await apiFetch("/health", { method:"GET" });
        $("healthOut").textContent = JSON.stringify(out);
        toast("Health OK");
      } catch (e) {
        $("healthOut").textContent = String(e.message || e);
        toast("Health ERROR: " + (e.message || e));
      }
    }

    async function loadCardSettings() {
      const cid = ($("setCardSelect").value || "").trim();
      if (!cid) return toast("Seleziona una carta.");
      try {
        const s = await apiFetch(`/cards/${encodeURIComponent(cid)}/settings`, { method:"GET" });

        $("setCycleStart").value = s.cycleStartDay ?? "";
        $("setCycleEnd").value = s.cycleEndDay ?? "";
        $("setDebitDay").value = s.debitDay ?? "";
        $("setDebitOffset").value = s.debitMonthOffset ?? "";
        $("setTeilzahlung").value = s.teilzahlungAmount ?? "";
        $("setLimit").value = s.kreditlimit ?? "";
        $("setSoll").value = s.sollzinsAnnual ?? "";
        $("setEffektiv").value = s.effektivzinsAnnual ?? "";
        $("setEffectiveFrom").value = s.effectiveFrom ? String(s.effectiveFrom).slice(0,10) : "";

        $("settingsInfo").textContent = "Settings caricati.";
        toast("Settings caricati.");
      } catch (e) {
        $("settingsInfo").textContent = "Errore: " + (e.message || e);
        toast("Errore load settings: " + (e.message || e));
      }
    }

    async function saveCardSettings() {
      const cid = ($("setCardSelect").value || "").trim();
      if (!cid) return toast("Seleziona una carta.");

      const payload = {
        cycleStartDay: $("setCycleStart").value ? Number($("setCycleStart").value) : null,
        cycleEndDay: $("setCycleEnd").value ? Number($("setCycleEnd").value) : null,
        debitDay: $("setDebitDay").value ? Number($("setDebitDay").value) : null,
        debitMonthOffset: $("setDebitOffset").value ? Number($("setDebitOffset").value) : null,
        teilzahlungAmount: $("setTeilzahlung").value ? Number($("setTeilzahlung").value) : null,
        kreditlimit: $("setLimit").value ? Number($("setLimit").value) : null,
        sollzinsAnnual: $("setSoll").value ? Number($("setSoll").value) : null,
        effektivzinsAnnual: $("setEffektiv").value ? Number($("setEffektiv").value) : null,
        effectiveFrom: $("setEffectiveFrom").value || null,
      };

      // rimuovi null non necessari (backend accetta, ma meglio pulito)
      Object.keys(payload).forEach(k => (payload[k] === null || Number.isNaN(payload[k])) && delete payload[k]);

      try {
        await apiFetch(`/cards/${encodeURIComponent(cid)}/settings`, { method:"PUT", body: JSON.stringify(payload) });
        toast("Settings salvati.");
        $("settingsInfo").textContent = "Settings salvati.";
      } catch (e) {
        toast("Errore save settings: " + (e.message || e));
        $("settingsInfo").textContent = "Errore: " + (e.message || e);
      }
    }

    // =========================
    // DASHBOARD (cards & wallets)
    // =========================
    async function loadDashboard() {
      const asOf = $("cardsAsOf").value || isoDate(new Date());
      const month = $("cardsMonth").value || isoYM(new Date());

      const params = new URLSearchParams({ asOf, month });
      const data = await apiFetch("/dashboard?" + params.toString(), { method:"GET" });
      state.dashboard = data;

      renderCardsOverview();
      renderWalletTree();
    }

    function renderCardsOverview() {
      const wrap = $("cardsOverview");
      wrap.innerHTML = "";

      const w = state.dashboard?.wallets || [];
      const cards = w.filter(x => x.type === "card");
      const normals = w.filter(x => x.type !== "card");

      const card1 = document.createElement("div");
      card1.className = "card";
      card1.innerHTML = `
        <div style="font-weight:900; margin-bottom:8px;">Sintesi carte</div>
        <div class="muted">Numero carte: ${cards.length}</div>
        <div class="muted">Mostra limite/available/outstanding per ogni carta sotto.</div>
      `;
      wrap.appendChild(card1);

      const card2 = document.createElement("div");
      card2.className = "card";
      const totalBalance = (normals.reduce((s,x)=> s + (Number(x.balance)||0), 0));
      card2.innerHTML = `
        <div style="font-weight:900; margin-bottom:8px;">Sintesi conti (non-carte)</div>
        <div>Saldo totale conti: <b>${fmtMoney(totalBalance)}</b></div>
        <div class="muted">Somma dei bilanci wallet non-card (come calcolato dal backend).</div>
      `;
      wrap.appendChild(card2);
    }

    function renderWalletTree() {
      const wrap = $("walletTree");
      wrap.innerHTML = "";

      const wallets = state.dashboard?.wallets || [];
      // ordine: carte prima, poi conti
      wallets.sort((a,b)=>{
        if (a.type === b.type) return (a.name||"").localeCompare(b.name||"");
        if (a.type === "card") return -1;
        if (b.type === "card") return 1;
        return (a.type||"").localeCompare(b.type||"");
      });

      for (const w of wallets) {
        const det = document.createElement("details");
        det.open = false;

        const balance = fmtMoney(w.balance);
        const spent = fmtMoney(w.spentSoFar);
        const income = fmtMoney(w.incomeSoFar);

        const compareE = w.compareLastMonthExpenses || { amount:0, percent:0 };
        const compareI = w.compareLastMonthIncome || { amount:0, percent:0 };

        const summary = document.createElement("summary");
        summary.textContent = `${w.name} (${w.type}) — saldo: ${balance}`;
        det.appendChild(summary);

        const body = document.createElement("div");
        body.className = "grid two";
        body.style.marginTop = "10px";

        const left = document.createElement("div");
        left.className = "card";
        left.innerHTML = `
          <div style="font-weight:800; margin-bottom:8px;">Panoramica</div>
          <div>Saldo: <b>${balance}</b></div>
          <div>Spese mese (finora): <b>${spent}</b></div>
          <div>Entrate mese (finora): <b>${income}</b></div>
          <div class="muted">Confronto spese vs mese scorso: ${fmtMoney(compareE.amount)} (${Number(compareE.percent||0).toFixed(1)}%)</div>
          <div class="muted">Confronto entrate vs mese scorso: ${fmtMoney(compareI.amount)} (${Number(compareI.percent||0).toFixed(1)}%)</div>
          ${w.nextEvent ? `<div class="muted">Prossimo evento: ${w.nextEvent.date} • ${w.nextEvent.title} • ${fmtMoney(w.nextEvent.amount)}</div>` : `<div class="muted">Prossimo evento: —</div>`}
        `;
        body.appendChild(left);

        const right = document.createElement("div");
        right.className = "card";
        right.innerHTML = `<div style="font-weight:800; margin-bottom:8px;">Categorie (top 10)</div>`;
        const cats = Array.isArray(w.categories) ? w.categories : [];
        if (!cats.length) {
          right.innerHTML += `<div class="muted">Nessuna spesa nel periodo.</div>`;
        } else {
          const t = document.createElement("table");
          t.innerHTML = `<thead><tr><th>Categoria</th><th>Importo</th></tr></thead>`;
          const tb = document.createElement("tbody");
          for (const c of cats) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${(c.name||"").replace(/</g,"&lt;")}</td><td>${fmtMoney(c.amount)}</td>`;
            tb.appendChild(tr);
          }
          t.appendChild(tb);
          right.appendChild(t);
        }
        body.appendChild(right);

        det.appendChild(body);

        // Card-specific details
        if (w.type === "card" && w.card) {
          const cardDet = document.createElement("details");
          cardDet.open = false;
          const sum = document.createElement("summary");
          const lim = fmtMoney(w.card.limit);
          const av = fmtMoney(w.card.availableCredit);
          const out = fmtMoney(w.card.outstanding);
          sum.textContent = `Dettagli carta — limite: ${lim} • disponibile: ${av} • outstanding: ${out}`;
          cardDet.appendChild(sum);

          const stmt = w.card.statement || {};
          const sched = w.card.scheduledRepayment || {};

          const inner = document.createElement("div");
          inner.className = "card";
          inner.style.marginTop = "10px";

          inner.innerHTML = `
            <div style="font-weight:800; margin-bottom:8px;">Statement & repayment</div>
            <div>Window statement: <span class="kbd">${stmt.window?.start || "?"}</span> → <span class="kbd">${stmt.window?.end || "?"}</span></div>
            <div>Baseline statement: <b>${fmtMoney(stmt.baselineAmount)}</b></div>
            <div class="muted">Instant purchases count: ${stmt.instantPurchasesCount ?? 0}</div>
            <div class="muted">Charges: ${fmtMoney(stmt.charges)} • Credits: ${fmtMoney(stmt.credits)}</div>
            <div class="hr"></div>
            <div style="font-weight:800; margin-bottom:6px;">Addebito previsto</div>
            <div>Data: <span class="kbd">${sched.paymentDate || "?"}</span></div>
            <div>Importo suggerito: <b>${fmtMoney(sched.suggestedAmount)}</b> (mode: ${sched.mode || "?"})</div>
            <div class="muted">Già registrato su quella data: ${sched.exists ? "Sì" : "No"}</div>
          `;

          // installments
          const inst = (stmt.installments || []);
          const instBox = document.createElement("details");
          instBox.open = false;
          const instSum = document.createElement("summary");
          instSum.textContent = `Rate nello statement (${inst.length})`;
          instBox.appendChild(instSum);

          const instInner = document.createElement("div");
          instInner.style.marginTop = "10px";

          if (!inst.length) {
            instInner.innerHTML = `<div class="muted">Nessuna rata in questo statement.</div>`;
          } else {
            const t = document.createElement("table");
            t.innerHTML = `<thead><tr><th>Purchase ID</th><th>Titolo</th><th>Importo</th><th>Tipo</th><th>Index</th><th>Data</th><th>Status</th></tr></thead>`;
            const tb = document.createElement("tbody");
            for (const x of inst) {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${x.purchaseEventId}</td>
                <td>${(x.title||"").replace(/</g,"&lt;")}</td>
                <td>${fmtMoney(x.amount)}</td>
                <td>${x.installmentKind || ""}</td>
                <td>${x.installmentIndex ?? ""}</td>
                <td>${x.installmentDate ?? ""}</td>
                <td>${x.status || ""}</td>
              `;
              tb.appendChild(tr);
            }
            t.appendChild(tb);
            instInner.appendChild(t);
          }
          instBox.appendChild(instInner);
          inner.appendChild(instBox);

          cardDet.appendChild(inner);
          det.appendChild(document.createElement("div")).className="hr";
          det.appendChild(cardDet);
        }

        wrap.appendChild(det);
      }
    }

    // =========================
    // INIT / WIRES
    // =========================
    function initDefaults() {
      // calendar month default = current month
      const now = new Date();
      const ym = isoYM(now);
      $("calMonth").value = ym;
      state.month = parseYM(ym);

      // cards tab defaults
      $("cardsAsOf").value = isoDate(now);
      $("cardsMonth").value = ym;
    }

    function wireCalendarControls() {
      $("btnCalRefresh").addEventListener("click", loadEventsForMonth);
      $("btnNewEvent").addEventListener("click", ()=> openEventDialogForNew(isoDate(new Date())));
      $("calMonth").addEventListener("change", async ()=>{
        state.month = parseYM($("calMonth").value);
        await loadEventsForMonth();
      });
      $("calWalletFilter").addEventListener("change", loadEventsForMonth);
      $("calSearch").addEventListener("input", ()=>{
        // debounce
        window.clearTimeout(state._qTimer);
        state._qTimer = window.setTimeout(loadEventsForMonth, 250);
      });

      $("btnPrevMonth").addEventListener("click", async ()=>{
        const m = state.month || new Date();
        const d = new Date(m.getFullYear(), m.getMonth()-1, 1);
        state.month = d;
        $("calMonth").value = isoYM(d);
        await loadEventsForMonth();
      });
      $("btnNextMonth").addEventListener("click", async ()=>{
        const m = state.month || new Date();
        const d = new Date(m.getFullYear(), m.getMonth()+1, 1);
        state.month = d;
        $("calMonth").value = isoYM(d);
        await loadEventsForMonth();
      });

      // dialog buttons
      $("btnSave").addEventListener("click", saveEvent);
      $("btnDelete").addEventListener("click", async ()=>{
        const id = ($("evId").value || "").trim();
        if (!id) return;
        await deleteEventById(id);
        $("dlgEvent").close();
      });
      $("btnDuplicate").addEventListener("click", duplicateEventAcrossMonths);
      $("btnDlgClose").addEventListener("click", ()=> $("dlgEvent").close());
    }

    function wireSettingsControls() {
      $("btnHealth").addEventListener("click", healthCheck);
      $("btnLoadCardSettings").addEventListener("click", loadCardSettings);
      $("btnSaveCardSettings").addEventListener("click", saveCardSettings);
    }

    function wireCardsControls() {
      $("btnCardsRefresh").addEventListener("click", async ()=>{
        try {
          await loadDashboard();
          toast("Dashboard aggiornato.");
        } catch (e) {
          toast("Errore dashboard: " + (e.message || e));
        }
      });
    }

    $("btnReloadAll").addEventListener("click", async ()=>{
      try {
        await loadWallets();
        await loadEventsForMonth();
        await loadDashboard();
        toast("Dati ricaricati.");
      } catch (e) {
        toast("Errore ricarica: " + (e.message || e));
      }
    });

    async function boot() {
      initDefaults();
      wireCalendarControls();
      wireSettingsControls();
      wireCardsControls();

      try {
        await loadWallets();
        await loadEventsForMonth();
        await loadDashboard();
        toast("Pronto.");
      } catch (e) {
        toast("Errore avvio: " + (e.message || e));
      }
    }
    boot();
  </script>
</body>
</html>
