<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <title>ChipsWallet - Wax Chain Project</title>
</head>
<body>

<!-- Sezione 1: Logo e animazione -->
<div class="logo-section">
  <div class="logo">ChipsWallet</div>
  <div class="golden-circle"></div>
</div>

<!-- Sezione 2: Menu animato sotto il logo -->
<div class="menu-section">
  <div class="title-container">
    <div class="title-circle">C</div>
    <h1 class="section-title">Wax Chain Project</h1>
  </div>
  <div class="menu">
    <button onclick="loadContent('balance')"><i>üíº</i> Wallet</button>
    <button onclick="loadContent('staking_farms')"><i>üå±</i> Staking</button>
    <button onclick="loadContent('mynfts')"><i>üé®</i> NFTs Inventory</button>
    <button onclick="loadContent('waxdao_pools')"><i>üè¶</i> Pools</button>
    <button onclick="loadContent('profile')"><i>üë§</i> Account</button>
  </div>
</div>

<!-- Sezione 3: Contenuto delle pagine -->
<div class="content-frame" id="content-frame">
  <p>Select an option from the menu.</p>
</div>

<div class="footer">
  ChipsWallet @2024 - A Wax Chain Project
</div>

<script>
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  const userId = getQueryParam("user_id");
  let user_wax_account = null;

  async function fetchWaxAccount() {
    console.log("Fetching Wax Account...");
    const response = await fetch(`https://iamemanuele.pythonanywhere.com/profile?user_id=${userId}`);
    console.log("Response status:", response.status);
    const data = await response.json();
    console.log("Account data received:", data);
    
    if (response.ok && data.wax_account) {
        user_wax_account = data.wax_account;
        document.getElementById("welcome-message").textContent = `Welcome, ${user_wax_account}`;
    } else {
        document.getElementById("welcome-message").textContent = `Welcome, User`;
    }
  }

async function loadContent(page) {
    console.log("Loading content for page:", page);
    const contentFrame = document.getElementById("content-frame");
    let url;

    switch(page) {
      case 'balance':
        url = `https://iamemanuele.pythonanywhere.com/saldo?user_id=${userId}`;
        break;
      case 'staking_farms':
        url = `https://iamemanuele.pythonanywhere.com/open_pools?user_id=${userId}`; 
        break;
      case 'mynfts':
        url = `https://iamemanuele.pythonanywhere.com/mynfts?user_id=${userId}`;
        break;
      case 'waxdao_pools':
        loadNFTFarms();
        return;
      case 'profile':
        url = `https://iamemanuele.pythonanywhere.com/profile?user_id=${userId}`;
        break;
    }
    
    console.log("API URL:", url);
    try {
        const response = await fetch(url);
        console.log("Response status:", response.status);
        
        // Se lo stato non √® "OK" (200), logga un messaggio di errore
        if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`);
        }

        const data = await response.json();
        console.log("Data received for page:", page, data);

        if (page === 'balance') {
            contentFrame.innerHTML = `
                <h2 class="pool-title">Your Token Balances</h2>
                <div class="balance-grid">
                  ${data.balances.map(balance => `
                      <div class="balance-item">
                        <h4>${balance.symbol}</h4> <!-- Usa "symbol" invece di "token_symbol" -->
                        <p style="text-align: left;"><span class="value">${balance.amount}</span></p>
                      </div>
                  `).join("")}
                </div>`;
        }
        else if (page === 'staking_farms') {
            contentFrame.innerHTML = `
                <h2 class="pool-title">Staking Farms</h2>
                <div class="staking-grid">
                  ${data.pools.map(farm => `
                      <div class="staking-item">
                        <h4>üå± ${farm.farm_name}</h4>
                        <p><span class="label">APR:</span> <span class="value">${farm.apr}%</span></p>
                      </div>
                  `).join("")}
                </div>`;
        } else if (page === 'mynfts') {
            contentFrame.innerHTML = `
              <h2 class="section-title">Your NFTs Inventory</h2>
              <div class="nft-grid">
                ${data.nfts.map(nft => `
                  <div class="nft-item">
                    <img src="${nft.image_url}" alt="NFT Image" class="nft-image">
                    <div class="nft-details">
                      <p><span class="label">ID:</span> <span class="value">${nft.nft_id}</span></p>
                      <p><span class="label">Asset:</span> <span class="value">${nft.asset_id}</span></p>
                      <p><span class="label">Status:</span> <span class="value">${nft.is_staked}</span></p>
                      <p><span class="label">On Sale:</span> <span class="value">${nft.for_sale}</span></p>
                    </div>
                  </div>
                `).join("")}
              </div>`;
        } else if (page === 'profile') {
            contentFrame.innerHTML = `
              <h2 class="pool-title">Your Profile</h2>
              <p><strong>Username:</strong> ${data.username}</p>
              <p><strong>Level:</strong> ${data.sqj_level}</p>
              <p><strong>Account:</strong> ${data.wax_account}</p>`;
        }
    } catch (error) {
        console.error("Error loading content for page:", page, error);
        contentFrame.innerHTML = `<p>Error loading ${page}: ${error.message}</p>`;
    }
}
  async function loadNFTFarms(viewType = 'all') {
    console.log("Loading NFT Farms with view type:", viewType);
    const contentFrame = document.getElementById("content-frame");
    const userId = getQueryParam("user_id");
    let url = `https://iamemanuele.pythonanywhere.com/nfts_farms?user_id=${userId}`;

    if (viewType === 'user_staking') {
        url += "&view=user_staking";
    }

    console.log("NFT Farms API URL:", url);

    const response = await fetch(url);
    console.log("Response status for NFT farms:", response.status);

    const data = await response.json();
    console.log("NFT farms data received:", data);

    if (response.ok && data.farms) {
        contentFrame.innerHTML = `
          <div class="switch-container">
            <button onclick="loadNFTFarms('all')" ${viewType === 'all' ? 'class="active"' : ''}>All Pools</button>
            <button onclick="loadNFTFarms('user_staking')" ${viewType === 'user_staking' ? 'class="active"' : ''}>My Staked Pools</button>
          </div>
          <h2 class="pool-title">Active NFTs Farms</h2>
          <div class="pool-grid">
            ${data.farms.map(farm => `
              <div class="pool-item">
                <h4>üè¶ ${farm.farm_name}</h4>
                <p><span class="label">Reward:</span> <span class="value">${farm.reward_token}</span></p>
              </div>
            `).join("")}
          </div>
        `;
    } else {
        contentFrame.innerHTML = `<p>Error loading pools: ${data.error}</p>`;
        console.error("Error loading NFT farms:", data.error);
    }
  }
  
  // Carica i dati dell'account all'avvio
  fetchWaxAccount();
</script>
</body>
</html>
