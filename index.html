<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChipsWallet - Wax Chain Project</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <!-- Logo Section -->
    <div class="logo-section">
      <div class="logo-container">
        <div class="logo">ChipsWallet</div>
      </div>
    </div>
    <div class="menu-section">
      <button onclick="loadContent('balance')">üíº Wallet</button>
      <button onclick="loadContent('staking_farms')">üå± Staking</button>
      <button onclick="loadContent('mynfts')">üé® NFTs Inventory</button>
      <button onclick="loadContent('waxdao_pools')">üè¶ Pools</button>
      <button onclick="loadContent('profile')">üë§ Account</button>
    </div>
    <div class="content-frame" id="content-frame">
      <p id="welcome-message">Select an option from the menu.</p>
      <div class="card-3d-container">
        <div class="card-3d">
          <p id="personalized-message"></p>
        </div>
      </div>
    </div>
    <div class="footer">
      ChipsWallet @2024 - A Wax Chain Project
    </div>
  </div>
  
  <script>
    // Variabili globali per user_id e token
    const userId = "<user_id_from_telegram>"; // Questi valori saranno popolati dinamicamente
    const token = "<token_from_telegram>";

    let user_wax_account = null;

    async function fetchWaxAccount() {
        console.log("Fetching Wax Account...");

        try {
            // Esegui la richiesta con gli header
            const response = await fetch('https://iamemanuele.pythonanywhere.com/profile', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'X-User-ID': userId
                }
            });

            console.log("Response status:", response.status);

            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();
            console.log("Account data received:", data);

            if (data.user_profile?.wax_account) {
                user_wax_account = data.user_profile.wax_account;

                // Imposta il messaggio di benvenuto
                const welcomeMessage = `Welcome, ${user_wax_account}`;
                document.getElementById("welcome-message").textContent = welcomeMessage;

                // Applica l'animazione alle lettere
                animateText(welcomeMessage);

                // Messaggio personalizzato per l'utente
                document.getElementById("personalized-message").textContent = `Welcome to our platform, where innovation meets opportunity! As a valued member, you are part of a revolutionary ecosystem fueled by our exclusive token CHIPS, which drives the entire economy. Get ready to engage in a world of endless possibilities and growth!`;
            } else {
                displayGenericWelcome();
            }
        } catch (error) {
            console.error("Error fetching Wax Account:", error);
            displayGenericWelcome();
        }
    }

    function displayGenericWelcome() {
        const welcomeMessage = `Welcome, User`;
        document.getElementById("welcome-message").textContent = welcomeMessage;

        // Applica l'animazione alle lettere
        animateText(welcomeMessage);

        // Messaggio generico per utenti non autenticati
        document.getElementById("personalized-message").textContent = `Welcome to our platform! Explore the power of our unique token CHIPS, designed to empower and sustain an ever-growing digital economy. Join us today to unlock endless potential and experience the future of decentralized finance!`;
    }

    // Funzione per animare il testo lettera per lettera
    function animateText(text) {
        const welcomeMessageElement = document.getElementById("welcome-message");

        // Pulisci il contenuto precedente
        welcomeMessageElement.innerHTML = '';

        // Dividi il testo in lettere e avvolgile in span
        text.split('').forEach((letter, index) => {
            const span = document.createElement('span');
            span.textContent = letter;
            span.style.setProperty('--letter-index', index); // Imposta l'indice per il ritardo dell'animazione
            welcomeMessageElement.appendChild(span);
        });
    }

    // Esegui la richiesta al caricamento della pagina
    fetchWaxAccount();
    async function loadContent(page) {
      console.log("Loading content for page:", page);
      const contentFrame = document.getElementById("content-frame");
      let url;
      switch(page) {
        case 'balance':
          url = `https://iamemanuele.pythonanywhere.com/saldo?user_id=${userId}`;
          break;
        case 'staking_farms':
          url = `https://iamemanuele.pythonanywhere.com/open_pools?user_id=${userId}`; 
          break;
        case 'mynfts':
          url = `https://iamemanuele.pythonanywhere.com/mynfts?user_id=${userId}`;
          break;
        case 'waxdao_pools':
          loadNFTFarms();
          return;
        case 'profile':
          url = `https://iamemanuele.pythonanywhere.com/profile?user_id=${userId}`;
          break;
      }
      
      console.log("API URL:", url);
      try {
          const response = await fetch(url);
          console.log("Response status:", response.status);
          
          if (!response.ok) {
              throw new Error(`Server responded with status: ${response.status}`);
          }
          const data = await response.json();
          console.log("Data received for page:", page, data);

if (page === 'balance') {
    if (!data || !data.balances || data.balances.length === 0) {
      contentFrame.innerHTML = "<p>No balances found.</p>";
      return;
    }
        contentFrame.innerHTML = `
            <h2 class="pool-title" style="text-align: center;">Your Token Balances</h2>
            <div class="balance-grid">
                ${data.balances.map(balance => `
                    <div class="card">
                        <h4>${balance.symbol}</h4>
                        <p><span class="value">${balance.amount}</span></p>
                        
                        <!-- Pulsante di prelievo -->
                        <button class="withdraw-button" data-symbol="${balance.symbol}" data-amount="${balance.amount}" style="margin-top: 10px; padding: 10px; background-color: #FF5722; color: white; border: none; border-radius: 5px;">Withdraw</button>
                        
                        <!-- Sezione di prelievo -->
                        <div class="withdraw-inputs" style="display: none; margin-top: 10px;">
                            <input type="number" class="withdraw-quantity" placeholder="Quantity" style="margin-right: 5px;"/>
                            <button class="confirm-withdraw" data-symbol="${balance.symbol}">Confirm</button>
                        </div>
                        
                        <!-- Pulsante di trasferimento -->
                        <button class="transfer-button" data-symbol="${balance.symbol}" data-amount="${balance.amount}" style="margin-top: 10px; padding: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 5px;">Transfer</button>
                        
                        <!-- Sezione di trasferimento -->
                        <div class="transfer-inputs" style="display: none; margin-top: 10px;">
                            <input type="number" class="transfer-quantity" placeholder="Quantity" style="margin-right: 5px;"/>
                            <input type="text" class="transfer-receiver" placeholder="Receiver" style="margin-right: 5px;"/>
                            <button class="confirm-transfer" data-symbol="${balance.symbol}">Confirm</button>
                        </div>
                        <!-- Pulsante Swap to -->
                        <button class="swap-button" data-symbol="${balance.symbol}" data-amount="${balance.amount}" style="margin-top: 10px; padding: 10px; background-color: #2196F3; color: white; border: none; border-radius: 5px;">Swap to</button>                            
                        <!-- Sezione di swap -->
                        <div class="swap-inputs" style="display: none; margin-top: 10px;">
                            <input type="number" class="swap-quantity" placeholder="Quantity" style="margin-right: 5px;"/>
                            <input type="text" class="swap-to-token" placeholder="To Token" style="margin-right: 5px;"/>
                            <button class="confirm-swap" data-symbol="${balance.symbol}">Confirm Swap</button>
                        </div>                        
                    </div>
                `).join("")}
            </div>
        `;
        // Funzione per creare un messaggio dinamico sotto i pulsanti
        function createMessageElement(message, isSuccess) {
            const messageDiv = document.createElement('div');
            messageDiv.style.marginTop = '10px';
            messageDiv.style.padding = '10px';
            messageDiv.style.borderRadius = '5px';
            messageDiv.style.fontSize = '14px';
        
            if (isSuccess) {
                messageDiv.style.backgroundColor = '#4CAF50';  // Successo
                messageDiv.style.color = 'white';
            } else {
                messageDiv.style.backgroundColor = '#FF5722';  // Errore
                messageDiv.style.color = 'white';
            }
        
            messageDiv.textContent = message;
            return messageDiv;
        }
        // Gestione del clic sul pulsante "Swap to"
        document.querySelectorAll('.swap-button').forEach(button => {
            button.addEventListener('click', function() {
                const symbol = this.getAttribute('data-symbol');
                const amount = this.getAttribute('data-amount');
                const card = this.closest('.card');
                const swapInputs = card.querySelector('.swap-inputs');
                swapInputs.style.display = 'block';  // Mostra la sezione di swap
            });
        });
        
        // Gestione della conferma dello swap
        document.querySelectorAll('.confirm-swap').forEach(button => {
            button.addEventListener('click', async function() {
                this.style.display = 'none'; // Nascondi il pulsante Confirm
                const symbol = this.getAttribute('data-symbol');
                const swapQuantity = this.closest('.card').querySelector('.swap-quantity').value;
                const toToken = this.closest('.card').querySelector('.swap-to-token').value;
                const waxAccount = user_wax_account;  // Imposta l'account utente
                const card = this.closest('.card');  // Riferimento alla card
        
                // Validazione degli input
                if (!swapQuantity || isNaN(swapQuantity) || swapQuantity <= 0 || !toToken) {
                    const messageDiv = createMessageElement('Please enter valid quantity and token for swap.', false);
                    card.appendChild(messageDiv);  // Aggiungi il messaggio alla card
                    return;
                }
        
                const url = 'https://iamemanuele.pythonanywhere.com/swap_tokens';
                const data = {
                    wax_account: waxAccount,
                    from_token: symbol,
                    to_token: toToken,
                    amount: swapQuantity
                };
        
                // Mostra un messaggio di "Request in Progress"
                const inProgressMessage = createMessageElement('Processing your request...', false);
                card.appendChild(inProgressMessage);
        
                try {
                    console.log("Trying the fetch of backend response")
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    console.log("response:", response)        
                    const responseText = await response.text();
                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error("Error parsing response:", parseError);
                        return;
                    }
                    console.log("result:", result)    
                    const messageDiv = createMessageElement(response.ok ? 
                        `Success: ${result.details.received_amount} ${result.details.to_token} received` : 
                        `Error: ${result.error}`, response.ok);
                    
                    card.replaceChild(messageDiv, inProgressMessage);  // Sostituisci il messaggio di progress con il risultato
        
                    // Mostra il messaggio per 2-3 secondi prima di ricaricare i bilanci
                    setTimeout(async () => {
                        await reloadBalances();  // Ricarica i bilanci dopo lo swap
                    }, 2000);  // Ritardo di 2 secondi
                } catch (error) {
                    console.error("Error during swap request:", error);
                    const errorMessageDiv = createMessageElement('An error occurred. Please try again.', false);
                    card.replaceChild(errorMessageDiv, inProgressMessage);  // Sostituisci il messaggio di progress con l'errore
        
                    // Mostra il messaggio per 2-3 secondi prima di ricaricare i bilanci
                    setTimeout(async () => {
                        await reloadBalances();  // Ricarica i bilanci dopo lo swap
                    }, 2000);  // Ritardo di 2 secondi
        } 
    });
});

        // Gestione dei click sui pulsanti "Withdraw"
        document.querySelectorAll('.withdraw-button').forEach(button => {
            button.addEventListener('click', function() {
                const symbol = this.getAttribute('data-symbol');
                const amount = this.getAttribute('data-amount');
                const card = this.closest('.card');
                const withdrawInputs = card.querySelector('.withdraw-inputs');
                withdrawInputs.style.display = 'block';
            });
        });

        // Gestione dei click sui pulsanti "Transfer"
        document.querySelectorAll('.transfer-button').forEach(button => {
            button.addEventListener('click', function() {
                const symbol = this.getAttribute('data-symbol');
                const amount = this.getAttribute('data-amount');
                const card = this.closest('.card');
                const transferInputs = card.querySelector('.transfer-inputs');
                transferInputs.style.display = 'block';
            });
        });

// Gestione della conferma del prelievo
document.querySelectorAll('.confirm-withdraw').forEach(button => {
    button.addEventListener('click', async function() {
        this.style.display = 'none'; // Nascondi il pulsante Confirm
        const symbol = this.getAttribute('data-symbol');
        const withdrawQuantity = this.closest('.card').querySelector('.withdraw-quantity').value;
        const waxAccount = user_wax_account; // Imposta l'account utente
        const card = this.closest('.card');  // Riferimento alla card

        if (!withdrawQuantity || isNaN(withdrawQuantity) || withdrawQuantity <= 0) {
            const messageDiv = createMessageElement('Please enter a valid quantity for withdrawal.', false);
            card.appendChild(messageDiv);  // Aggiungi il messaggio alla card
            return;
        }

        const url = 'https://iamemanuele.pythonanywhere.com/withdraw';
        const data = {
            wax_account: waxAccount,
            token_symbol: symbol,
            amount: withdrawQuantity
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const responseText = await response.text();
            let result;
            try {
                result = JSON.parse(responseText);
            } catch (parseError) {
                console.error("Error parsing response:", parseError);
                return;
            }

            const messageDiv = createMessageElement(response.ok ? `Success: ${result.message}` : `Error: ${result.error}`, response.ok);
            card.appendChild(messageDiv);  // Aggiungi il messaggio alla card

            // Mostra il messaggio per 3 secondi prima di ricaricare i bilanci
            setTimeout(async () => {
                await reloadBalances();  // Ricarica i bilanci dopo il prelievo
            }, 3000);  // Ritardo di 3 secondi
        } catch (error) {
            console.error("Error during withdrawal request:", error);
            const messageDiv = createMessageElement('An error occurred. Please try again.', false);
            card.appendChild(messageDiv);  // Aggiungi il messaggio alla card

            // Mostra il messaggio per 3 secondi prima di ricaricare i bilanci
            setTimeout(async () => {
                await reloadBalances();  // Ricarica i bilanci dopo il prelievo
            }, 3000);  // Ritardo di 3 secondi
        } finally {
            this.style.display = 'none'; // Nasconde il pulsante dopo l'azione
        }
    });
});

// Gestione della conferma del trasferimento
document.querySelectorAll('.confirm-transfer').forEach(button => {
    button.addEventListener('click', async function() {
        this.style.display = 'none'; // Nascondi il pulsante Confirm
        const symbol = this.getAttribute('data-symbol');
        const transferQuantity = this.closest('.card').querySelector('.transfer-quantity').value;
        const transferReceiver = this.closest('.card').querySelector('.transfer-receiver').value;
        const waxAccount = user_wax_account; // Imposta l'account utente
        const card = this.closest('.card');  // Riferimento alla card

        // Validazione degli input
        if (!transferQuantity || isNaN(transferQuantity) || transferQuantity <= 0 || !transferReceiver) {
            const messageDiv = createMessageElement('Please enter valid quantity and receiver details.', false);
            card.appendChild(messageDiv);  // Aggiungi il messaggio alla card
            return;
        }

        const url = 'https://iamemanuele.pythonanywhere.com/transfer';
        const data = {
            wax_account: waxAccount,
            token_symbol: symbol,
            amount: transferQuantity,
            receiver: transferReceiver
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const responseText = await response.text();
            let result;
            try {
                result = JSON.parse(responseText);
            } catch (parseError) {
                console.error("Error parsing response:", parseError);
                return;
            }

            const messageDiv = createMessageElement(response.ok ? `Success: ${result.message}` : `Error: ${result.error}`, response.ok);
            card.appendChild(messageDiv);  // Aggiungi il messaggio alla card

            // Mostra il messaggio per 3 secondi prima di ricaricare i bilanci
            setTimeout(async () => {
                await reloadBalances();  // Ricarica i bilanci dopo il trasferimento
            }, 3000);  // Ritardo di 3 secondi
        } catch (error) {
            console.error("Error during transfer request:", error);
            const messageDiv = createMessageElement('An error occurred. Please try again.', false);
            card.appendChild(messageDiv);  // Aggiungi il messaggio alla card

            // Mostra il messaggio per 3 secondi prima di ricaricare i bilanci
            setTimeout(async () => {
                await reloadBalances();  // Ricarica i bilanci dopo il trasferimento
            }, 3000);  // Ritardo di 3 secondi
        } finally {
            this.style.display = 'none'; // Nasconde il pulsante dopo l'azione
        }
    });
});
        // Funzione per ricaricare i bilanci
        async function reloadBalances() {
            const url = `https://iamemanuele.pythonanywhere.com/saldo?user_id=${userId}`;
            const contentFrame = document.getElementById("content-frame");
    
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch updated balances.');
    
                const data = await response.json();
                if (data && Array.isArray(data.balances)) {
                    contentFrame.innerHTML = ''; // Cancella il contenuto corrente
                    loadContent('balance'); // Ricarica i bilanci aggiornati
                } else {
                    console.error("Invalid balance data received.");
                }
            } catch (error) {
                console.error("Error updating balances:", error);
                contentFrame.innerHTML = '<p>Error updating balances. Please try again.</p>';
            }
        }
    }
      else if (page === 'staking_farms') {
          let showAllPools = true; // Stato per il pulsante switch

          function renderPools(pools) {
              contentFrame.innerHTML = `
                  <h2 class="pool-title" style="text-align: center;">Staking Farms</h2>
                  <div style="text-align: center; margin-bottom: 20px;">
                  <label class="custom-switch">
                    <input type="checkbox" id="toggle-pools" ${showAllPools ? '' : 'checked'}>
                    <span class="slider"></span>
                </label>
                <span style="margin-left: 15px; font-size: 1.2em; vertical-align: middle;">${showAllPools ? 'Show My Pools' : 'Show All Pools'}</span>
            </div>
            <div class="balance-grid">
                ${pools.map(pool => `
                    <div class="card">
                        <h4>üå± Pool: ${pool.token_symbol}</h4>
                        <div style="display: flex; gap: 10px; justify-content: flex-start; margin-bottom: 10px;">
                            <button class="add-button" data-pool-id="${pool.pool_id}" data-symbol="${pool.token_symbol}" style="padding: 5px 10px; background-color: #4CAF50; color: white; border: none; border-radius: 5px;">Add</button>
                            <button class="remove-button" data-pool-id="${pool.pool_id}" data-symbol="${pool.token_symbol}" style="padding: 5px 10px; background-color: #FF5722; color: white; border: none; border-radius: 5px;">Remove</button>
                        </div>
                        <div class="action-inputs" style="display: none; margin-top: 10px;">
                            <input type="number" class="action-quantity" placeholder="Quantity" style="margin-right: 5px;"/>
                            <button class="confirm-action" data-pool-id="${pool.pool_id}" data-symbol="${pool.token_symbol}">Confirm</button>
                        </div>                        
                        <p><strong>Total Staked:</strong> ${pool.total_staked.toLocaleString()} ${pool.token_symbol}</p>
                        <p><strong>Your Stake:</strong> ${pool.user_staked.toLocaleString()} ${pool.token_symbol}</p>
                        <h5>Rewards:</h5>
                        <div class="reward-grid">
                            ${pool.rewards_info.map(reward => `
                                <div class="reward-card">
                                    <h4>${reward.reward_token}</h4>
                                    <p><strong>APR:</strong> ${reward.apr.toFixed(2)}%</p>
                                    <p><strong>Daily Reward:</strong> ${reward.daily_reward.toLocaleString()} ${reward.reward_token}</p>
                                    <p><strong>Your Daily Reward:</strong> ${reward.user_daily_reward.toLocaleString()} ${reward.reward_token}</p>
                                    <p><strong>Days Remaining:</strong> ${reward.days_remaining}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    
        // Gestione degli eventi
        attachEventHandlers();
    }
    function createMessageElement(message, isSuccess) {
        const messageDiv = document.createElement('div');
        messageDiv.textContent = message;
        messageDiv.style.marginTop = '10px';
        messageDiv.style.padding = '10px';
        messageDiv.style.borderRadius = '5px';
        messageDiv.style.fontSize = '1.1em';
    
        if (isSuccess) {
            messageDiv.style.backgroundColor = '#4CAF50'; // Successo (verde)
            messageDiv.style.color = 'white';
        } else {
            messageDiv.style.backgroundColor = '#FF5722'; // Errore (rosso)
            messageDiv.style.color = 'white';
        }
    
        return messageDiv;
    }        
    function attachEventHandlers() {
        document.getElementById('toggle-pools').addEventListener('change', function () {
            showAllPools = !this.checked;
            loadPools(); // Ricarica le pool
        });
    
        document.querySelectorAll('.add-button').forEach(button => {
            button.addEventListener('click', function () {
                const card = this.closest('.card');
                const actionInputs = card.querySelector('.action-inputs');
                actionInputs.style.display = 'flex';
                actionInputs.querySelector('.confirm-action').dataset.action = 'add';
            });
        });
    
        document.querySelectorAll('.remove-button').forEach(button => {
            button.addEventListener('click', function () {
                const card = this.closest('.card');
                const actionInputs = card.querySelector('.action-inputs');
                actionInputs.style.display = 'flex';
                actionInputs.querySelector('.confirm-action').dataset.action = 'remove';
            });
        });
    
        document.querySelectorAll('.confirm-action').forEach(button => {
            button.addEventListener('click', async function () {
                const action = this.dataset.action; // "add" o "remove"
                const symbol = this.dataset.symbol;
                const poolId = this.dataset.poolId;
                const quantityInput = this.closest('.card').querySelector('.action-quantity');
                const quantity = parseFloat(quantityInput.value);
                const card = this.closest('.card');

                // Validazione
                if (!quantity || isNaN(quantity) || quantity <= 0) {
                    const messageDiv = createMessageElement('Please enter a valid quantity.', false);
                    // Sostituire il campo di input e bottone con il messaggio di errore
                    card.querySelector('.action-inputs').replaceWith(messageDiv);
                    return;
                }

                const url = action === 'add'
                    ? 'https://iamemanuele.pythonanywhere.com/stake_add'
                    : 'https://iamemanuele.pythonanywhere.com/stake_remove';
                const data = {
                    user_id: userId,         // ID dell'utente dal contesto
                    pool_id: poolId,         // ID del pool
                    wax_account: user_wax_account, // Account WAX
                    token_symbol: symbol,    // Simbolo del token
                    amount: quantity         // Quantit√†
                };
                console.log("Data for Add/Remove:", data)

                // Crea il messaggio di in-progress
                const inProgressMessage = createMessageElement('Processing your request...', false);
                // Sostituire la sezione di azioni (input e bottone) con il messaggio in progress
                card.querySelector('.action-inputs').replaceWith(inProgressMessage);

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();
                    const messageDiv = createMessageElement(response.ok ?
                        `Success: ${result.message}` :
                        `Error: ${result.error}`, response.ok);

                    // Sostituire il messaggio di in-progress con quello finale
                    card.replaceChild(messageDiv, inProgressMessage);

                    console.log('Final message: ', messageDiv.textContent);

                    setTimeout(() => loadPools(), 3000); // Ricarica le pool dopo 3 secondi
                } catch (error) {
                    console.error("Error during stake request:", error);
                    const errorMessageDiv = createMessageElement('An error occurred. Please try again.', false);
                    card.replaceChild(errorMessageDiv, inProgressMessage);

                    console.log('Error message: ', errorMessageDiv.textContent);
                    setTimeout(() => loadPools(), 3000);
                }
            });
        });
    }

    function loadPools() {
        const url = `https://iamemanuele.pythonanywhere.com/open_pools?user_id=${userId}`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                const filteredPools = showAllPools
                    ? data.pools
                    : data.pools.filter(pool => pool.user_staked > 0);
                renderPools(filteredPools);
            })
            .catch(error => console.error("Error loading pools:", error));
    }

    loadPools(); // Carica le pool inizialmente
} else if (page === 'mynfts') {
            if (!data || !Array.isArray(data.nfts)) {
                console.error("NFT data is missing or invalid.");
                contentFrame.innerHTML = `<p>Error: Unable to load NFT data.</p>`;
                return;
            }
        
            if (!data.nfts.length) {
                contentFrame.innerHTML = `<p>No NFTs found in your inventory.</p>`;
                return;
            }
        
            try {
                contentFrame.innerHTML = `
                    <div style="padding: 3px;">
                        <!-- Titolo della sezione -->
                        <h2 class="section-title" style="font-size: 2rem; font-weight: bold; text-align: center; color: #333; text-shadow: 1px 1px 5px rgba(0,0,0,0.2);">
                            Your NFTs Inventory
                        </h2>
        
                        <!-- Numero di NFTs -->
                        <div style="text-align: center; margin: 1px 0; font-size: 1.5rem; color: #555;">
                            <p>You own <span style="font-weight: bold; color: #4CAF50;">${data.nfts.length}</span> NFTs.</p>
                        </div>
            
                        <div class="menu-section" style="display: flex; justify-content: space-between; align-items: center; gap: 10px; width: 100%; padding: 10px 0;">
                            <!-- Filtri aggiuntivi -->
                            <div class="filter-switch" style="flex: 1; text-align: center;">
                                <label for="nft-filter" style="display: block; margin-bottom: 1px;">Filter NFTs:</label>
                                <select id="nft-filter" style="width: 90%; padding: 5px;">
                                    <option value="all">All</option>
                                    <option value="staked">Only Staked</option>
                                    <option value="unstaked">Only Unstaked</option>
                                    <option value="sale">On Sale</option>
                                </select>
                            </div>
                        
                            <!-- Filtro per Collection -->
                            <div class="filter-switch" style="flex: 1; text-align: center;">
                                <label for="collection-filter" style="display: block; margin-bottom: 1px;">Filter by Collection:</label>
                                <select id="collection-filter" style="width: 90%; padding: 5px;">
                                    <option value="all">All Collections</option>
                                    ${[...new Set(data.nfts.map(nft => nft.template_info.collection_name))].map(collection => `
                                        <option value="${collection}">${collection}</option>
                                    `).join('')}
                                </select>
                            </div>
                        
                            <!-- Ordinamento -->
                            <div class="filter-switch" style="flex: 1; text-align: center;">
                                <label for="sort-order" style="display: block; margin-bottom: 1px;">Sort NFTs:</label>
                                <select id="sort-order" style="width: 90%; padding: 5px;">
                                    <option value="newest-desc">Newest (Desc)</option>
                                    <option value="newest-asc">Newest (Asc)</option>
                                    <option value="oldest-desc">Oldest (Desc)</option>
                                    <option value="oldest-asc">Oldest (Asc)</option>
                                    <option value="a-z-asc">A-Z (Asc)</option>
                                    <option value="a-z-desc">A-Z (Desc)</option>
                                </select>
                            </div>
                        </div>           
                        <div class="nft-grid" id="nft-grid">
                            ${data.nfts.map(nft => `
                                <div class="card">
                                    ${nft.template_info && nft.template_info.img_hash && !nft.template_info.img_hash.startsWith('Qm') ? `
                                        <img src="${nft.template_info.img_hash}" alt="NFT Image" class="nft-image">
                                    ` : `
                                        <p class="no-media">Image Not Available</p>
                                    `}
                        
                                    <div class="nft-details">
                                        <p><span class="label">ID:</span> <span class="value">${nft.nft_id}</span></p>
                                        <p><span class="label">Asset:</span> <span class="value">${nft.asset_id}</span></p>
                                        <p><span class="label">Status:</span> <span class="value">${nft.is_staked}</span></p>
                                        <p><span class="label">On Sale:</span> <span class="value">${nft.for_sale}</span></p>
                        
                                        <div class="template-info">
                                            <p><span class="label">Collection:</span> <span class="value">${nft.template_info.collection_name || 'N/A'}</span></p>
                                            <p><span class="label">Schema:</span> <span class="value">${nft.template_info.schema_name || 'N/A'}</span></p>
                                            <p><span class="label">Template Name:</span> <span class="value">${nft.template_info.template_name || 'N/A'}</span></p>
                                            <p><span class="label">Max Supply:</span> <span class="value">${nft.template_info.max_supply || 'N/A'}</span></p>
                                            <p><span class="label">Transferable:</span> <span class="value">${nft.template_info.is_transferable ? 'Yes' : 'No'}</span></p>
                                        </div>
                                    </div>
                                    <!-- Pulsante Withdraw -->
                                                  <button class="withdraw-button" data-nft-id="${nft.nft_id}" data-wax-account="${user_wax_account}" style="margin-top: 10px; padding: 10px; background-color: #FF5722; color: white; border: none; border-radius: 5px;">Withdraw</button>
                                </div>
                            `).join('')}
                        </div>
                    `;
            
                    // Gestione dei filtri e ordinamenti
                    document.getElementById('nft-filter').addEventListener('change', updateNftGrid);
                    document.getElementById('collection-filter').addEventListener('change', updateNftGrid);
                    document.getElementById('sort-order').addEventListener('change', updateNftGrid);
            
                    function updateNftGrid() {
                        let filteredNfts = data.nfts;
            
                        // Filtro per "Staked", "Unstaked", "On Sale"
                        const filter = document.getElementById('nft-filter').value;
                        filteredNfts = filterNfts(filter, filteredNfts);
            
                        // Filtro per "Collection"
                        const collectionFilter = document.getElementById('collection-filter').value;
                        if (collectionFilter !== 'all') {
                            filteredNfts = filteredNfts.filter(nft => nft.template_info.collection_name === collectionFilter);
                        }
                        // Ordinamento
                        const sortOrder = document.getElementById('sort-order').value;
                        filteredNfts = sortNfts(sortOrder, filteredNfts);
            
                        // Aggiorna la griglia
                        const nftGrid = document.getElementById('nft-grid');
                        nftGrid.innerHTML = filteredNfts.map(nft => `
                            <div class="card">
                                ${nft.template_info.img_hash && !nft.template_info.img_hash.startsWith('Qm') ? `
                                    <img src="${nft.template_info.img_hash}" alt="NFT Image" class="nft-image">
                                ` : `
                                    <p class="no-media">Image Not Available</p>
                                `}
            
                                <div class="nft-details">
                                    <p><span class="label">ID:</span> <span class="value">${nft.nft_id}</span></p>
                                    <p><span class="label">Asset:</span> <span class="value">${nft.asset_id}</span></p>
                                    <p><span class="label">Status:</span> <span class="value">${nft.is_staked}</span></p>
                                    <p><span class="label">On Sale:</span> <span class="value">${nft.for_sale}</span></p>
            
                                    <div class="template-info">
                                        <p><span class="label">Collection:</span> <span class="value">${nft.template_info.collection_name || 'N/A'}</span></p>
                                        <p><span class="label">Schema:</span> <span class="value">${nft.template_info.schema_name || 'N/A'}</span></p>
                                        <p><span class="label">Template Name:</span> <span class="value">${nft.template_info.template_name || 'N/A'}</span></p>
                                        <p><span class="label">Max Supply:</span> <span class="value">${nft.template_info.max_supply || 'N/A'}</span></p>
                                        <p><span class="label">Transferable:</span> <span class="value">${nft.template_info.is_transferable ? 'Yes' : 'No'}</span></p>
                                    </div>
                                    <!-- Pulsante Withdraw -->
                                    <button class="withdraw-button" data-nft-id="${nft.nft_id}" data-wax-account="${wax_account}" style="margin-top: 10px; padding: 10px; background-color: #FF5722; color: white; border: none; border-radius: 5px;">Withdraw</button>
                                </div>
                            </div>
                        `).join("");
                    }
            
                    // Funzione di filtraggio per gli NFT
                    function filterNfts(filter, nfts) {
                        switch (filter) {
                            case 'staked':
                                return nfts.filter(nft => nft.is_staked === "Staked");
                            case 'unstaked':
                                return nfts.filter(nft => nft.is_staked === "Not Staked");
                            case 'sale':
                                return nfts.filter(nft => nft.for_sale === "Yes");
                            default:
                                return nfts;
                        }
                    }
            
                    // Funzione di ordinamento per gli NFT
                    function sortNfts(sortOrder, nfts) {
                        switch (sortOrder) {
                            case 'newest-desc':
                                return nfts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                            case 'newest-asc':
                                return nfts.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                            case 'a-z-asc':
                                return nfts.sort((a, b) => a.template_info.template_name.localeCompare(b.template_info.template_name));
                            case 'a-z-desc':
                                return nfts.sort((a, b) => b.template_info.template_name.localeCompare(a.template_info.template_name));
                            default:
                                return nfts;
                        }
                    }
                    // Gestisci il click sul pulsante "Withdraw per NFTs"
                    document.querySelectorAll('.withdraw-button').forEach(button => {
                        button.addEventListener('click', async function () {
                            const nftId = this.getAttribute('data-nft-id');
                            const waxAccount = user_wax_account;
                            const withdrawType = 'specific'; // O "all_inclusive" o "all_exclusive", in base alle esigenze
                            const url = 'https://iamemanuele.pythonanywhere.com/withdraw_nft';
                    
                            // Log per debug
                            console.log("Button clicked, preparing withdrawal with the following data:");
                            console.log("NFT ID:", nftId);
                            console.log("Wax Account:", waxAccount);
                            console.log("Withdraw Type:", withdrawType);
                            console.log("URL:", url);
                    
                            // Identifica l'elemento della card per aggiungere feedback
                            const card = this.closest('.card'); // Trova l'elemento genitore della card
                            const feedbackElement = card.querySelector('.feedback'); // Trova o crea un elemento per il feedback
                    
                            // Se non esiste, crealo dinamicamente
                            if (!feedbackElement) {
                                const newFeedback = document.createElement('div');
                                newFeedback.className = 'feedback';
                                card.appendChild(newFeedback);
                            }
                    
                            // Aggiungi un messaggio di caricamento
                            card.querySelector('.feedback').innerText = 'Processing withdrawal...';
                    
                            // Crea l'oggetto da inviare al backend
                            const data = {
                                wax_account: waxAccount,
                                nft_id: nftId,
                                withdraw_type: withdrawType
                            };
                    
                            console.log("Request payload (data) being sent to backend:", JSON.stringify(data));
                    
                            try {
                                // Invia la richiesta POST al backend
                                const response = await fetch(url, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(data)
                                });
                                console.log("Response status code:", response.status);
                                const responseText = await response.text();
                                console.log("Response body as text:", responseText);
                                let result;
                                try {
                                    result = JSON.parse(responseText); // Cerca di convertire la risposta in JSON
                                } catch (parseError) {
                                    console.error("Error parsing the response as JSON:", parseError);
                                    card.querySelector('.feedback').innerText = "An error occurred. Please try again.";
                                    return;
                                }
                                console.log("Parsed response JSON:", result);
                                // Gestione del feedback basato sulla risposta
                                if (response.ok) {
                                    card.querySelector('.feedback').innerText = `Success: ${result.message}`;
                                    await reloadNFTs();
                                } else {
                                    card.querySelector('.feedback').innerText = `Error: ${result.error}`;
                                }
                            } catch (error) {
                                console.error("Error during withdrawal request:", error);
                                card.querySelector('.feedback').innerText = 'An error occurred. Please try again.';
                            }
                        });
                    });
                } catch (error) {
                    console.error("Error rendering the NFTs:", error);
                    contentFrame.innerHTML = `<p>Error: Unable to render NFTs. Please try again later.</p>`;
                }
            } else if (page === 'profile') {
              contentFrame.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <h2 class="pool-title" style="text-align: center;">Your Profile</h2>                
                  <!--      commento             -->
                    <button 
                      id="toggle-sqj" 
                      style="
                        background-color: #39ff14; 
                        color: black; 
                        border: none; 
                        border-radius: 5px; 
                        padding: 10px 15px; 
                        font-size: 1rem; 
                        cursor: pointer;
                        transition: transform 0.3s ease;
                      "
                      onmouseover="this.style.transform='scale(1.1)';" 
                      onmouseout="this.style.transform='scale(1)';">
                      Show SQJ Data
                    </button>
                </div>
                <div class="profile-grid">
                  <!-- User Profile -->
                  <div class="profile-card">
                    <h4>Username</h4>
                    <p>${data.user_profile.username}</p>
                  </div>
                  <div class="profile-card">
                    <h4>Wax Account</h4>
                    <p>${data.user_profile.wax_account}</p>
                  </div>
                  <div class="profile-card">
                    <h4>User ID</h4>
                    <p>${data.user_profile.user_id}</p>
                  </div>
          
                  <!-- CHIPS Stats -->
                  <div class="profile-card">
                    <h4>CHIPS Level</h4>
                    <p>${data.chips_stats.CHIPS_level}</p>
                  </div>
                  <div class="profile-card">
                    <h4>CHIPS XP</h4>
                    <p>${data.chips_stats.xp}</p>
                  </div>
                  <div class="profile-card">
                    <h4>XP for Next Level</h4>
                    <p>${data.chips_stats.xp_for_next_level}</p>
                  </div>
                  <div class="profile-card">
                    <h4>Short Message Earnings</h4>
                    <p>${data.chips_stats.short_message_earnings}</p>
                  </div>
                  <div class="profile-card">
                    <h4>Long Message Earnings</h4>
                    <p>${data.chips_stats.long_message_earnings}</p>
                  </div>
          
                  <!-- Booster Stats -->
                  <div class="profile-card">
                    <h4>Boosters Owned</h4>
                    <p>
                      Common: ${data.chips_stats.boosters_owned.common}<br>
                      Rare: ${data.chips_stats.boosters_owned.rare}<br>
                      Epic: ${data.chips_stats.boosters_owned.epic}<br>
                      Legendary: ${data.chips_stats.boosters_owned.legendary}
                    </p>
                  </div>
        
                  <!-- Rewards Stats -->
                  <div class="profile-card">
                    <h4>Total Rewards</h4>
                    <p>
                      Short: ${data.chips_stats.total_rewards.short}<br>
                      Long: ${data.chips_stats.total_rewards.long}
                    </p>
                  </div>
          
                  <!-- Membership Status -->
                  <div class="profile-card">
                    <h4>VIP Membership</h4>
                    <p>${data.membership_status.vip_membership ? "Yes" : "No"}</p>
                  </div>
                  <div class="profile-card">
                    <h4>SQJ Pass</h4>
                    <p>${data.membership_status.sqj_pass ? "Yes" : "No"}</p>
                  </div>
                </div>
          
                <!-- SQJ Stats Section -->
                <div id="sqj-data" style="display: none; margin-top: 1px;">
                  <h3 class="section-title">SQJ Specific Data</h3>
                  <div class="profile-grid">
                    <div class="profile-card">
                      <h4>SQJ Level</h4>
                      <p>${data.sqj_stats.sqj_level}</p>
                    </div>
                    <div class="profile-card">
                      <h4>SQJ XP</h4>
                      <p>${data.sqj_stats.sqj_xp}</p>
                    </div>
                    <div class="profile-card">
                      <h4>XP for Next Level</h4>
                      <p>${data.sqj_stats.xp_for_next_level}</p>
                    </div>
                    <div class="profile-card">
                      <h4>XP Remaining</h4>
                      <p>${data.sqj_stats.xp_remaining}</p>
                    </div>
                  </div>
                </div>
              `;
          
              // Aggiungi l'evento per il pulsante switch
              const toggleButton = document.getElementById("toggle-sqj");
              toggleButton.addEventListener("click", () => {
                  const sqjData = document.getElementById("sqj-data");
                  if (sqjData.style.display === "none") {
                      sqjData.style.display = "block";
                      toggleButton.textContent = "Hide SQJ Data";
                  } else {
                      sqjData.style.display = "none";
                      toggleButton.textContent = "Show SQJ Data";
                  }
              });
          }
      } catch (error) {
          console.error("Error loading content for page:", page, error);
          contentFrame.innerHTML = `<p>Error loading ${page}: ${error.message}</p>`;
      }
    } 
// Funzione per ricaricare gli NFT e aggiornare il contenuto della pagina
async function reloadNFTs() {
    const url = `https://iamemanuele.pythonanywhere.com/mynfts?user_id=${userId}`;
    const contentFrame = document.getElementById("content-frame");

    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch updated NFTs.');

        const data = await response.json();
        console.log("Updated NFTs data fetched:", data);

        // Aggiorna la visualizzazione
        if (data && Array.isArray(data.nfts)) {
            // Usa il codice esistente per aggiornare la griglia degli NFT
            contentFrame.innerHTML = ''; // Cancella il contenuto corrente
            loadContent('mynfts'); // Ricarica il contenuto aggiornato
        } else {
            console.error("Invalid NFT data received.");
        }
    } catch (error) {
        console.error("Error updating NFTs:", error);
        contentFrame.innerHTML = '<p>Error updating NFTs. Please try again.</p>';
    }
}       
async function loadNFTFarms(viewType = 'all') {
          console.log("Loading NFT Farms with view type:", viewType);
          const contentFrame = document.getElementById("content-frame");
          const userId = getQueryParam("user_id");
          let url = `https://iamemanuele.pythonanywhere.com/nfts_farms?user_id=${userId}`;
      
          if (viewType === 'user_staking') {
              url += "&view=user_staking";
          }
      
          console.log("NFT Farms API URL:", url);
      
          try {
              const response = await fetch(url);
              console.log("Response status for NFT farms:", response.status);
      
              if (!response.ok) {
                  throw new Error(`Error loading NFT farms: ${response.status}`);
              }
      
              const data = await response.json();
              console.log("NFT farms data received:", data);
      
              if (data.farms && data.farms.length > 0) {
                contentFrame.innerHTML = `
                    <h2 class="pool-title" style="text-align: center;">NFT Farms</h2>                  
                    <div class="balance-grid">
                        ${data.farms.map(farm => `
                            <div class="nft-reward-card">
                                <h4>üè¶ ${farm.farm_name}</h4>
                                <p><strong>Token Symbol:</strong> ${farm.token_symbol}</p>
                                <h5>Templates and Rewards:</h5>
                                <ul>
                                    ${farm.templates.map(template => `
                                        <li class="template-row">
                                            <span class="template-id">ID: ${template.template_id}</span>
                                            <span class="daily-reward">Reward: ${template.daily_reward} ${farm.token_symbol}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        `).join('')}
                    </div>`;
            } else {
                contentFrame.innerHTML = `<p>No NFT farms available at the moment.</p>`;
            }

          } catch (error) {
              console.error("Error loading NFT farms:", error);
              contentFrame.innerHTML = `<p>Error loading NFT farms: ${error.message}</p>`;
          }
      }      
  </script>
</body>
</html>
