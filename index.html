<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChipsWallet - Wax Chain Project</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <!-- Logo Section -->
    <div class="logo-section">
      <div class="logo-container">
        <div class="logo">ChipsWallet</div>
      </div>
    </div>
    <div class="menu-section">
      <button onclick="loadContent('balance')">üíºWallet</button>
      <button onclick="loadContent('staking_farms')">üå±Staking</button>
      <button onclick="loadContent('mynfts')">üé®NFTs Inventory</button>
      <button onclick="loadContent('waxdao_pools')">üè¶Pools</button>
      <button onclick="loadContent('profile')">üë§Account</button>
    </div>
    <div class="content-frame" id="content-frame">
      <p id="welcome-message" style="display: flex; justify-content: center; align-items: center; text-align: center; height: 100%; width: 100%; margin: 0;">
          <span class="highlight">Calling the Boss,</span><br>
          asking for your data. <br>Please wait...
      </p>
      <div class="card-3d-container">
        <div class="card-3d">
          <p id="personalized-message"></p>
        </div>
      </div>
    </div>
    <div class="footer">
      ChipsWallet @2024 - A Wax Chain Project
    </div>
  </div>
<script>  
// Funzione per ottenere i parametri dalla query string dell'URL
function getQueryParam(param) {
    console.log("Fetching getQueryParam...");
    const urlParams = new URLSearchParams(window.location.search);
    console.log("Fetching urlParams...", urlParams);
    return urlParams.get(param);
}
// Variabili globali per user_id e token
const userId = getQueryParam('user_id'); // Estrai user_id dall'URL
const token = getQueryParam('usx_token'); // Estrai usx_token dall'URL
let user_wax_account = null;
async function fetchWaxAccount() {
    try {
        // Costruisci l'URL con i parametri user_id e usx_token
        const url = `https://iamemanuele.pythonanywhere.com/profile?user_id=${encodeURIComponent(userId)}&usx_token=${encodeURIComponent(token)}`;
        console.log("URL", url);
        // Esegui la richiesta GET al backend per il profilo
        const response = await fetch(url, {
            method: 'GET', 
        });     
        console.log("Response status:", response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
        console.log("Account data received:", data);

        // Accedi al wax_account nei dati ricevuti (modifica in base alla struttura)
        user_wax_account = data.general_data?.wax_account;  
        const waxAccount = user_wax_account
        if (user_wax_account) {
            // Imposta il messaggio di benvenuto
            const welcomeMessage = `Welcome, ${user_wax_account}`;
            document.getElementById("welcome-message").textContent = welcomeMessage;

            // Applica l'animazione alle lettere
            animateText(welcomeMessage);

            // Messaggio personalizzato per l'utente
            document.getElementById("personalized-message").textContent = `Welcome to our platform, where innovation meets opportunity! As a valued member, you are part of a revolutionary ecosystem fueled by our exclusive token CHIPS, which drives the entire economy. Get ready to engage in a world of endless possibilities and growth!`;
        } else {
            // Se non trovi il wax_account, mostra un messaggio generico
            displayGenericWelcome();
        }
    } catch (error) {
        console.error("Error fetching Wax Account:", error);
        displayGenericWelcome();
    }
}

function displayGenericWelcome() {
    const welcomeMessage = `Welcome, User`;
    document.getElementById("welcome-message").textContent = welcomeMessage;

    // Applica l'animazione alle lettere
    animateText(welcomeMessage);

    // Messaggio generico per utenti non autenticati
    document.getElementById("personalized-message").textContent = `Welcome to our platform! Explore the power of our unique token CHIPS, designed to empower and sustain an ever-growing digital economy. Join us today to unlock endless potential and experience the future of decentralized finance!`;
}

// Funzione per animare il testo lettera per lettera
function animateText(text) {
    const welcomeMessageElement = document.getElementById("welcome-message");

    // Pulisci il contenuto precedente
    welcomeMessageElement.innerHTML = '';

    // Dividi il testo in lettere e avvolgile in span
    text.split('').forEach((letter, index) => {
        const span = document.createElement('span');
        span.textContent = letter;
        span.style.setProperty('--letter-index', index); // Imposta l'indice per il ritardo dell'animazione
        welcomeMessageElement.appendChild(span);
    });
}

// Esegui la richiesta al caricamento della pagina
fetchWaxAccount();

async function loadContent(page) {
    console.log("Loading content for page:", page);
    console.log(`Wax Account available: ${user_wax_account}`);
    const contentFrame = document.getElementById("content-frame");
    let url;
    switch(page) {
        case 'balance':
            url = `https://iamemanuele.pythonanywhere.com/saldo?user_id=${userId}&usx_token=${token}`;
            break;
        case 'staking_farms':
            url = `https://iamemanuele.pythonanywhere.com/open_pools?user_id=${userId}&usx_token=${token}`; 
            break;
        case 'mynfts':
            url = `https://iamemanuele.pythonanywhere.com/mynfts?user_id=${userId}&usx_token=${token}`;
            break;
        case 'waxdao_pools':
            url = `https://iamemanuele.pythonanywhere.com/nfts_farms?user_id=${userId}&usx_token=${token}`;
            break;
        case 'profile':
            url = `https://iamemanuele.pythonanywhere.com/profile?user_id=${userId}&usx_token=${token}`;
            break;
    }
    
    console.log("API URL:", url);
    try {
        const response = await fetch(url);
        console.log("Response status:", response.status);
        
        if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`);
        }
        const data = await response.json();
        console.log("Data received for page:", page, data);

        if (page === 'balance') {
            if (!data || !data.balances || data.balances.length === 0) {
              contentFrame.innerHTML = "<p>No balances found.</p>";
              return;
            }
            contentFrame.innerHTML = `
                <h2 class="pool-title" style="text-align: center;">Your Token Balances</h2>
                <div class="balance-grid">
                    ${data.balances.map(balance => `
                        <div class="card">
                            <h4>${balance.symbol}</h4>
                            <p><span class="value">${balance.amount}</span></p>
        
                            <!-- Pulsante di prelievo -->
                            <button class="withdraw-button" data-symbol="${balance.symbol}" data-amount="${balance.amount}" style="margin-top: 10px; padding: 10px; background-color: #FF5722; color: white; border: none; border-radius: 5px;">Withdraw</button>
        
                            <!-- Sezione di prelievo -->
                            <div class="withdraw-inputs" style="display: none; margin-top: 10px;">
                                <input type="number" class="withdraw-quantity" placeholder="Quantity" style="margin-right: 3px; padding: 4px; font-size: 0.8rem; width: 30%;"/>
                                <button class="confirm-withdraw" data-symbol="${balance.symbol}">Confirm</button>
                            </div>
        
                            <!-- Pulsante di trasferimento -->
                            <button class="transfer-button" data-symbol="${balance.symbol}" data-amount="${balance.amount}" style="margin-top: 10px; padding: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 5px;">Transfer</button>
        
                            <!-- Sezione di trasferimento -->
                            <div class="transfer-inputs" style="display: none; margin-top: 10px;">
                                <input type="number" class="transfer-quantity" placeholder="Quantity" style="margin-right: 3px; padding: 4px; font-size: 0.8rem; width: 30%;"/>
                                <input type="text" class="transfer-receiver" placeholder="Receiver" style="margin-right: 3px; padding: 4px; font-size: 0.8rem; width: 30%;"/>
                                <button class="confirm-transfer" data-symbol="${balance.symbol}">Confirm</button>
                            </div>
        
                            <!-- Pulsante Swap to -->
                            <button class="swap-button" data-symbol="${balance.symbol}" data-amount="${balance.amount}" style="margin-top: 10px; padding: 10px; background-color: #2196F3; color: white; border: none; border-radius: 5px;">Swap to</button>
        
                            <!-- Sezione di swap -->
                            <div class="swap-inputs" style="display: none; margin-top: 10px;">
                                <input type="number" class="swap-quantity" placeholder="Quantity" style="margin-right: 3px; padding: 4px; font-size: 0.8rem; width: 30%;"/>
                                <input type="text" class="swap-to-token" placeholder="To Token" style="margin-right: 3px; padding: 4px; font-size: 0.8rem; width: 30%;"/>
                                <button class="confirm-swap" data-symbol="${balance.symbol}">Confirm Swap</button>
                            </div>                        
                        </div>
                    `).join("")}
                </div>
            `;
        // Funzione per creare un messaggio dinamico sotto i pulsanti
        function createMessageElement(message, isSuccess) {
            const messageDiv = document.createElement('div');
            messageDiv.style.marginTop = '10px';
            messageDiv.style.padding = '10px';
            messageDiv.style.borderRadius = '5px';
            messageDiv.style.fontSize = '14px';
        
            if (isSuccess) {
                messageDiv.style.backgroundColor = '#4CAF50';  // Successo
                messageDiv.style.color = 'white';
            } else {
                messageDiv.style.backgroundColor = '#FF5722';  // Errore
                messageDiv.style.color = 'white';
            }
        
            messageDiv.textContent = message;
            return messageDiv;
        }
        // Funzione per gestire l'apertura/chiusura delle sezioni
          function toggleInputSection(button, sectionClass) {
              const card = button.closest('.card');
              const currentSection = card.querySelector(sectionClass);
              
              // Chiudi tutte le altre sezioni
              card.querySelectorAll('.withdraw-inputs, .transfer-inputs, .swap-inputs').forEach(section => {
                  if (section !== currentSection) {
                      section.style.display = 'none';
                  }
              });
      
              // Toggle visibilit√† della sezione corrente
              currentSection.style.display = currentSection.style.display === 'none' ? 'block' : 'none';
          }
      
          // Gestione dei clic sui pulsanti
          document.querySelectorAll('.withdraw-button').forEach(button => {
              button.addEventListener('click', function() {
                  toggleInputSection(this, '.withdraw-inputs');
              });
          });
      
          document.querySelectorAll('.transfer-button').forEach(button => {
              button.addEventListener('click', function() {
                  toggleInputSection(this, '.transfer-inputs');
              });
          });
      
          document.querySelectorAll('.swap-button').forEach(button => {
              button.addEventListener('click', function() {
                  toggleInputSection(this, '.swap-inputs');
              });
          });
        
        // Gestione della conferma dello swap
        document.querySelectorAll('.confirm-swap').forEach(button => {
            button.addEventListener('click', async function() {
                this.style.display = 'none'; // Nascondi il pulsante Confirm
                const symbol = this.getAttribute('data-symbol');
                const swapQuantity = this.closest('.card').querySelector('.swap-quantity').value;
                const toToken = this.closest('.card').querySelector('.swap-to-token').value;
                const waxAccount = user_wax_account;  
                const card = this.closest('.card');  // Riferimento alla card
        
                // Validazione degli input
                if (!swapQuantity || isNaN(swapQuantity) || swapQuantity <= 0 || !toToken) {
                    const messageDiv = createMessageElement('Please enter valid quantity and token for swap.', false);
                    card.appendChild(messageDiv);  // Aggiungi il messaggio alla card
                    return;
                }
        
                const url = `https://iamemanuele.pythonanywhere.com/swap_tokens?user_id=${userId}&usx_token=${token}`;
                const data = {
                    wax_account: waxAccount,
                    from_token: symbol,
                    to_token: toToken,
                    amount: swapQuantity
                };
        
                // Mostra un messaggio di "Request in Progress"
                const inProgressMessage = createMessageElement('Processing your request...', false);
                card.appendChild(inProgressMessage);
        
                try {
                    console.log("Trying the fetch of backend response")
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    console.log("response:", response)        
                    const responseText = await response.text();
                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error("Error parsing response:", parseError);
                        return;
                    }
                    console.log("result:", result)    
                    const messageDiv = createMessageElement(response.ok ? 
                        `Success: ${result.details.received_amount} ${result.details.to_token} received` : 
                        `Error: ${result.error}`, response.ok);
                    
                    card.replaceChild(messageDiv, inProgressMessage);  // Sostituisci il messaggio di progress con il risultato
        
                    // Mostra il messaggio per 2-3 secondi prima di ricaricare i bilanci
                    setTimeout(async () => {
                        await reloadBalances();  // Ricarica i bilanci dopo lo swap
                    }, 2000);  // Ritardo di 2 secondi
                } catch (error) {
                    console.error("Error during swap request:", error);
                    const errorMessageDiv = createMessageElement('An error occurred. Please try again.', false);
                    card.replaceChild(errorMessageDiv, inProgressMessage);  // Sostituisci il messaggio di progress con l'errore
        
                    // Mostra il messaggio per 2-3 secondi prima di ricaricare i bilanci
                    setTimeout(async () => {
                        await reloadBalances();  // Ricarica i bilanci dopo lo swap
                    }, 2000);  // Ritardo di 2 secondi
                  } 
              });
          });
// Gestione della conferma del prelievo
document.querySelectorAll('.confirm-withdraw').forEach(button => {
    button.addEventListener('click', async function() {
        this.style.display = 'none'; // Nascondi il pulsante Confirm
        const symbol = this.getAttribute('data-symbol');
        const withdrawQuantity = this.closest('.card').querySelector('.withdraw-quantity').value;
        const waxAccount = user_wax_account;
        const card = this.closest('.card');

        if (!withdrawQuantity || isNaN(withdrawQuantity) || withdrawQuantity <= 0) {
            const messageDiv = createMessageElement('Please enter a valid quantity for withdrawal.', false);
            card.appendChild(messageDiv);  // Aggiungi il messaggio alla card
            return;
        }

        const url = `https://iamemanuele.pythonanywhere.com/withdraw?user_id=${userId}&usx_token=${token}`;
        const data = {
            wax_account: waxAccount,
            token_symbol: symbol,
            amount: withdrawQuantity
        };
        console.log("Data for withdraw after confirmation: ",data)
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const responseText = await response.text();
            let result;
            try {
                result = JSON.parse(responseText);
            } catch (parseError) {
                console.error("Error parsing response:", parseError);
                return;
            }

            const messageDiv = createMessageElement(response.ok ? `Success: ${result.message}` : `Error: ${result.error}`, response.ok);
            card.appendChild(messageDiv);  // Aggiungi il messaggio alla card

            // Mostra il messaggio per 3 secondi prima di ricaricare i bilanci
            setTimeout(async () => {
                await reloadBalances();  // Ricarica i bilanci dopo il prelievo
            }, 3000);  // Ritardo di 3 secondi
        } catch (error) {
            console.error("Error during withdrawal request:", error);
            const messageDiv = createMessageElement('An error occurred. Please try again.', false);
            card.appendChild(messageDiv);  // Aggiungi il messaggio alla card

            // Mostra il messaggio per 3 secondi prima di ricaricare i bilanci
            setTimeout(async () => {
                await reloadBalances();  // Ricarica i bilanci dopo il prelievo
            }, 3000);  // Ritardo di 3 secondi
        } finally {
            this.style.display = 'none'; // Nasconde il pulsante dopo l'azione
        }
    });
});

// Gestione della conferma del trasferimento
document.querySelectorAll('.confirm-transfer').forEach(button => {
    button.addEventListener('click', async function() {
        this.style.display = 'none'; // Nascondi il pulsante Confirm
        const symbol = this.getAttribute('data-symbol');
        const transferQuantity = this.closest('.card').querySelector('.transfer-quantity').value;
        const transferReceiver = this.closest('.card').querySelector('.transfer-receiver').value;
        const waxAccount = user_wax_account; // Imposta l'account utente
        const card = this.closest('.card');  // Riferimento alla card

        // Validazione degli input
        if (!transferQuantity || isNaN(transferQuantity) || transferQuantity <= 0 || !transferReceiver) {
            const messageDiv = createMessageElement('Please enter valid quantity and receiver details.', false);
            card.appendChild(messageDiv);  // Aggiungi il messaggio alla card
            return;
        }

        const url = `https://iamemanuele.pythonanywhere.com/transfer?user_id=${userId}&usx_token=${token}`;
        const data = {
            wax_account: waxAccount,
            token_symbol: symbol,
            amount: transferQuantity,
            receiver: transferReceiver
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const responseText = await response.text();
            let result;
            try {
                result = JSON.parse(responseText);
            } catch (parseError) {
                console.error("Error parsing response:", parseError);
                return;
            }

            const messageDiv = createMessageElement(response.ok ? `Success: ${result.message}` : `Error: ${result.error}`, response.ok);
            card.appendChild(messageDiv);  // Aggiungi il messaggio alla card

            // Mostra il messaggio per 3 secondi prima di ricaricare i bilanci
            setTimeout(async () => {
                await reloadBalances();  // Ricarica i bilanci dopo il trasferimento
            }, 3000);  // Ritardo di 3 secondi
        } catch (error) {
            console.error("Error during transfer request:", error);
            const messageDiv = createMessageElement('An error occurred. Please try again.', false);
            card.appendChild(messageDiv);  // Aggiungi il messaggio alla card

            // Mostra il messaggio per 3 secondi prima di ricaricare i bilanci
            setTimeout(async () => {
                await reloadBalances();  // Ricarica i bilanci dopo il trasferimento
            }, 3000);  // Ritardo di 3 secondi
        } finally {
            this.style.display = 'none'; // Nasconde il pulsante dopo l'azione
        }
    });
});
        // Funzione per ricaricare i bilanci
        async function reloadBalances() {
            const url = `https://iamemanuele.pythonanywhere.com/saldo?user_id=${userId}&usx_token=${token}`;
            const contentFrame = document.getElementById("content-frame");
    
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch updated balances.');
    
                const data = await response.json();
                if (data && Array.isArray(data.balances)) {
                    contentFrame.innerHTML = ''; // Cancella il contenuto corrente
                    loadContent('balance'); // Ricarica i bilanci aggiornati
                } else {
                    console.error("Invalid balance data received.");
                }
            } catch (error) {
                console.error("Error updating balances:", error);
                contentFrame.innerHTML = '<p>Error updating balances. Please try again.</p>';
            }
        }
    }
      else if (page === 'staking_farms') {
          let showAllPools = true; // Stato per il pulsante switch

          function renderPools(pools) {
              contentFrame.innerHTML = `
                  <h2 class="pool-title" style="text-align: center;">Staking Farms</h2>
                  <div style="text-align: center; margin-bottom: 10px;">
                    <label class="custom-switch">
                    <input type="checkbox" id="toggle-pools" ${showAllPools ? '' : 'checked'}>
                    <span class="slider"></span>
                </label>
                <span style="margin-left: 15px; font-size: 1.2em; vertical-align: middle;">${showAllPools ? 'Show My Pools' : 'Show All Pools'}</span>
            </div>
            <div class="balance-grid">
                ${pools.map(pool => `
                    <div class="card">
                        <h4>üå± Pool: ${pool.token_symbol}</h4>
                        <div style="display: flex; gap: 10px; justify-content: flex-start; margin-bottom: 10px;">
                            <button class="add-button" data-pool-id="${pool.pool_id}" data-symbol="${pool.token_symbol}" style="padding: 4px 8px; background-color: #4CAF50; color: white; border: none; border-radius: 5px;">Add</button>
                            <button class="remove-button" data-pool-id="${pool.pool_id}" data-symbol="${pool.token_symbol}" style="padding: 4px 8px; background-color: #FF5722; color: white; border: none; border-radius: 5px;">Remove</button>
                        </div>
                        <div class="action-inputs" style="display: none; margin-top: 10px; font-size: 0.4rem; padding: 0.4rem;">
                            <input 
                                type="number" 
                                class="action-quantity" 
                                placeholder="Quantity" 
                                style="margin-right: 2px; padding: 4px; font-size: 0.8rem; width: 70%;"/>
                            <button 
                                class="confirm-action" 
                                data-pool-id="${pool.pool_id}" 
                                data-symbol="${pool.token_symbol}" 
                                style="padding: 2px 4px; font-size: 0.8rem; width: auto;">
                                Confirm
                            </button>
                        </div>
                        <p><strong>Total Staked:</strong> ${pool.total_staked.toLocaleString()} ${pool.token_symbol}</p>
                        <p><strong>Your Stake:</strong> ${pool.user_staked.toLocaleString()} ${pool.token_symbol}</p>
                        <h5>Rewards:</h5>
                        <div class="reward-grid">
                            ${pool.rewards_info.map(reward => `
                                <div class="reward-card">
                                    <h4>${reward.reward_token}</h4>
                                    <p><strong>APR:</strong> ${reward.apr.toFixed(2)}%</p>
                                    <p><strong>Daily Reward:</strong> ${reward.daily_reward.toLocaleString()} ${reward.reward_token}</p>
                                    <p><strong>Your Daily Reward:</strong> ${reward.user_daily_reward.toLocaleString()} ${reward.reward_token}</p>
                                    <p><strong>Days Remaining:</strong> ${reward.days_remaining}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    
        // Gestione degli eventi
        attachEventHandlers();
    }
    function createMessageElement(message, isSuccess) {
        const messageDiv = document.createElement('div');
        messageDiv.textContent = message;
        messageDiv.style.marginTop = '10px';
        messageDiv.style.padding = '10px';
        messageDiv.style.borderRadius = '5px';
        messageDiv.style.fontSize = '1.1em';
    
        if (isSuccess) {
            messageDiv.style.backgroundColor = '#4CAF50'; // Successo (verde)
            messageDiv.style.color = 'white';
        } else {
            messageDiv.style.backgroundColor = '#FF5722'; // Errore (rosso)
            messageDiv.style.color = 'white';
        }
    
        return messageDiv;
    }        
    function attachEventHandlers() {
        document.getElementById('toggle-pools').addEventListener('change', function () {
            showAllPools = !this.checked;
            loadPools(); // Ricarica le pool
        });
    
        document.querySelectorAll('.add-button, .remove-button').forEach(button => {
            button.addEventListener('click', function(event) {
                event.stopPropagation(); // Impedisce la propagazione del clic al document
        
                const parentCard = this.closest('.card'); // Trova la card associata
                const actionInputs = parentCard.querySelector('.action-inputs');
        
                // Se il form non esiste, logga un messaggio di avviso e interrompi
                if (!actionInputs) {
                    console.warn('Action inputs not found for:', this);
                    return;
                }
        
                // Chiudi tutti gli altri form aperti
                document.querySelectorAll('.action-inputs').forEach(input => {
                    if (input !== actionInputs) {
                        input.style.display = 'none';
                    }
                });
        
                // Apri o chiudi il form corrente
                if (actionInputs.style.display === 'none' || actionInputs.style.display === '') {
                    actionInputs.style.display = 'flex'; // Mostra il form
                } else {
                    actionInputs.style.display = 'none'; // Nascondi il form
                }
            });
        });
        
        // Aggiungi il listener per chiudere i form quando clicchi fuori
        document.addEventListener('click', function(event) {
            const isInsideActionInputs = event.target.closest('.action-inputs');
            const isActionButton = event.target.closest('.add-button, .remove-button');
        
            // Chiudi tutti i form se il clic √® al di fuori dei form o dei pulsanti
            if (!isInsideActionInputs && !isActionButton) {
                document.querySelectorAll('.action-inputs').forEach(input => {
                    input.style.display = 'none';
                });
            }
        });


    
        document.querySelectorAll('.confirm-action').forEach(button => {
            button.addEventListener('click', async function () {
                const action = this.dataset.action; // "add" o "remove"
                const symbol = this.dataset.symbol;
                const poolId = this.dataset.poolId;
                const quantityInput = this.closest('.card').querySelector('.action-quantity');
                const quantity = parseFloat(quantityInput.value);
                const card = this.closest('.card');

                // Validazione
                if (!quantity || isNaN(quantity) || quantity <= 0) {
                    const messageDiv = createMessageElement('Please enter a valid quantity.', false);
                    // Sostituire il campo di input e bottone con il messaggio di errore
                    card.querySelector('.action-inputs').replaceWith(messageDiv);
                    return;
                }

                const url = action === 'add'
                    ? `https://iamemanuele.pythonanywhere.com/stake_add?user_id=${userId}&usx_token=${token}`
                    : `https://iamemanuele.pythonanywhere.com/stake_remove?user_id=${userId}&usx_token=${token}`;
                const data = {
                    user_id: userId,         
                    pool_id: poolId,         
                    wax_account: user_wax_account, 
                    token_symbol: symbol,    
                    amount: quantity
                };
                console.log("Data for Add/Remove:", data)

                // Crea il messaggio di in-progress
                const inProgressMessage = createMessageElement('Processing your request...', false);
                // Sostituire la sezione di azioni (input e bottone) con il messaggio in progress
                card.querySelector('.action-inputs').replaceWith(inProgressMessage);

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();
                    const messageDiv = createMessageElement(response.ok ?
                        `Success: ${result.message}` :
                        `Error: ${result.error}`, response.ok);

                    // Sostituire il messaggio di in-progress con quello finale
                    card.replaceChild(messageDiv, inProgressMessage);

                    console.log('Final message: ', messageDiv.textContent);

                    setTimeout(() => loadPools(), 3000); // Ricarica le pool dopo 3 secondi
                } catch (error) {
                    console.error("Error during stake request:", error);
                    const errorMessageDiv = createMessageElement('An error occurred. Please try again.', false);
                    card.replaceChild(errorMessageDiv, inProgressMessage);

                    console.log('Error message: ', errorMessageDiv.textContent);
                    setTimeout(() => loadPools(), 3000);
                }
            });
        });
    }

    function loadPools() {
        const url = `https://iamemanuele.pythonanywhere.com/open_pools?user_id=${userId}&usx_token=${token}`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                const filteredPools = showAllPools
                    ? data.pools
                    : data.pools.filter(pool => pool.user_staked > 0);
                renderPools(filteredPools);
            })
            .catch(error => console.error("Error loading pools:", error));
    }

    loadPools(); // Carica le pool inizialmente
} else if (page === 'mynfts') {
            if (!data || !Array.isArray(data.nfts)) {
                console.error("NFT data is missing or invalid.");
                contentFrame.innerHTML = `<p>Error: Unable to load NFT data.</p>`;
                return;
            }
        
            if (!data.nfts.length) {
                contentFrame.innerHTML = `<p>No NFTs found in your inventory.</p>`;
                return;
            }
        
            try {
                contentFrame.innerHTML = `
                    <div style="padding: 3px;">
                        <!-- Titolo della sezione -->
                        <h2 class="section-title" style="font-size: 2rem; font-weight: bold; text-align: center; color: #333; text-shadow: 1px 1px 5px rgba(0,0,0,0.2);">
                            Your NFTs Inventory
                        </h2>
        
                        <!-- Numero di NFTs -->
                        <div style="text-align: center; margin: 1px 0; font-size: 1.5rem; color: #555;">
                            <p>You own <span style="font-weight: bold; color: #4CAF50;">${data.nfts.length}</span> NFTs.</p>
                        </div>
            
                        <div class="menu-section" style="display: flex; justify-content: space-between; align-items: center; gap: 10px; width: 100%; padding: 10px 0;">
                            <!-- Filtri aggiuntivi -->
                            <div class="filter-switch" style="flex: 1; text-align: center;">
                                <label for="nft-filter" style="display: block; margin-bottom: 1px;">Filter NFTs:</label>
                                <select id="nft-filter" style="width: 90%; padding: 5px;">
                                    <option value="all">All</option>
                                    <option value="staked">Only Staked</option>
                                    <option value="unstaked">Only Unstaked</option>
                                    <option value="sale">On Sale</option>
                                </select>
                            </div>
                        
                            <!-- Filtro per Collection -->
                            <div class="filter-switch" style="flex: 1; text-align: center;">
                                <label for="collection-filter" style="display: block; margin-bottom: 1px;">Filter by Collection:</label>
                                <select id="collection-filter" style="width: 90%; padding: 5px;">
                                    <option value="all">All Collections</option>
                                    ${[...new Set(data.nfts.map(nft => nft.template_info.collection_name))].map(collection => `
                                        <option value="${collection}">${collection}</option>
                                    `).join('')}
                                </select>
                            </div>
                        
                            <!-- Ordinamento -->
                            <div class="filter-switch" style="flex: 1; text-align: center;">
                                <label for="sort-order" style="display: block; margin-bottom: 1px;">Sort NFTs:</label>
                                <select id="sort-order" style="width: 90%; padding: 5px;">
                                    <option value="newest-desc">Newest (Desc)</option>
                                    <option value="newest-asc">Newest (Asc)</option>
                                    <option value="oldest-desc">Oldest (Desc)</option>
                                    <option value="oldest-asc">Oldest (Asc)</option>
                                    <option value="a-z-asc">A-Z (Asc)</option>
                                    <option value="a-z-desc">A-Z (Desc)</option>
                                </select>
                            </div>
                        </div>           
                        <div class="nft-grid" id="nft-grid">
                            ${data.nfts.map(nft => `
                                <div class="card">
                                    ${nft.template_info && nft.template_info.img_hash && !nft.template_info.img_hash.startsWith('Qm') ? `
                                        <img src="${nft.template_info.img_hash}" alt="NFT Image" class="nft-image">
                                    ` : `
                                        <p class="no-media">Image Not Available</p>
                                    `}
                        
                                    <div class="nft-details">
                                        <p><span class="label">ID:</span> <span class="value">${nft.nft_id}</span></p>
                                        <p><span class="label">Asset:</span> <span class="value">${nft.asset_id}</span></p>
                                        <p><span class="label">Status:</span> <span class="value">${nft.is_staked}</span></p>
                                        <p><span class="label">On Sale:</span> <span class="value">${nft.for_sale}</span></p>
                        
                                        <div class="template-info">
                                            <p><span class="label">Collection:</span> <span class="value">${nft.template_info.collection_name || 'N/A'}</span></p>
                                            <p><span class="label">Schema:</span> <span class="value">${nft.template_info.schema_name || 'N/A'}</span></p>
                                            <p><span class="label">Template Name:</span> <span class="value">${nft.template_info.template_name || 'N/A'}</span></p>
                                            <p><span class="label">Max Supply:</span> <span class="value">${nft.template_info.max_supply || 'N/A'}</span></p>
                                            <p><span class="label">Transferable:</span> <span class="value">${nft.template_info.is_transferable ? 'Yes' : 'No'}</span></p>
                                        </div>
                                    </div>
                                    <!-- Pulsante Withdraw -->
                                                  <button class="withdraw-button" data-nft-id="${nft.nft_id}" data-wax-account="${user_wax_account}" style="margin-top: 10px; padding: 10px; background-color: #FF5722; color: white; border: none; border-radius: 5px;">Withdraw</button>
                                </div>
                            `).join('')}
                        </div>
                    `;
            
                    // Gestione dei filtri e ordinamenti
                    document.getElementById('nft-filter').addEventListener('change', updateNftGrid);
                    document.getElementById('collection-filter').addEventListener('change', updateNftGrid);
                    document.getElementById('sort-order').addEventListener('change', updateNftGrid);
            
                    function updateNftGrid() {
                        let filteredNfts = data.nfts;
            
                        // Filtro per "Staked", "Unstaked", "On Sale"
                        const filter = document.getElementById('nft-filter').value;
                        filteredNfts = filterNfts(filter, filteredNfts);
            
                        // Filtro per "Collection"
                        const collectionFilter = document.getElementById('collection-filter').value;
                        if (collectionFilter !== 'all') {
                            filteredNfts = filteredNfts.filter(nft => nft.template_info.collection_name === collectionFilter);
                        }
                        // Ordinamento
                        const sortOrder = document.getElementById('sort-order').value;
                        filteredNfts = sortNfts(sortOrder, filteredNfts);
            
                        // Aggiorna la griglia
                        const nftGrid = document.getElementById('nft-grid');
                        nftGrid.innerHTML = filteredNfts.map(nft => `
                            <div class="card">
                                ${nft.template_info.img_hash && !nft.template_info.img_hash.startsWith('Qm') ? `
                                    <img src="${nft.template_info.img_hash}" alt="NFT Image" class="nft-image">
                                ` : `
                                    <p class="no-media">Image Not Available</p>
                                `}
            
                                <div class="nft-details">
                                    <p><span class="label">ID:</span> <span class="value">${nft.nft_id}</span></p>
                                    <p><span class="label">Asset:</span> <span class="value">${nft.asset_id}</span></p>
                                    <p><span class="label">Status:</span> <span class="value">${nft.is_staked}</span></p>
                                    <div id="stakable-info">
                                        <p>
                                            ${nft.is_staked === "Not Staked" && nft.is_stakable === "Stakable" ? 
                                                `<button class="btn-stake">Stake Now</button>` : 
                                                ''}
                                        </p>
                                        <p>
                                            ${nft.is_staked === "Not Staked" && nft.is_stakable === "Not Stakable" ? 
                                                `NFT not Stakable` : 
                                                ''}
                                        </p>
                                    </div>
                                    <p><span class="label">On Sale:</span> <span class="value">${nft.for_sale}</span></p>
                                </div>                                     
                                <div class="template-info">
                                        <p><span class="label">Collection:</span> <span class="value">${nft.template_info.collection_name || 'N/A'}</span></p>
                                        <p><span class="label">Schema:</span> <span class="value">${nft.template_info.schema_name || 'N/A'}</span></p>
                                        <p><span class="label">Template Name:</span> <span class="value">${nft.template_info.template_name || 'N/A'}</span></p>
                                        <p><span class="label">Max Supply:</span> <span class="value">${nft.template_info.max_supply || 'N/A'}</span></p>
                                        <p><span class="label">Transferable:</span> <span class="value">${nft.template_info.is_transferable ? 'Yes' : 'No'}</span></p>
                                </div>
                                    <!-- Pulsante Withdraw -->
                                    <button class="withdraw-button" data-nft-id="${nft.nft_id}" data-wax-account="${user_wax_account}" style="margin-top: 10px; padding: 10px; background-color: #FF5722; color: white; border: none; border-radius: 5px;">Withdraw</button>
                                </div>
                            </div>
                        `).join("");
                    }
            
                    // Funzione di filtraggio per gli NFT
                    function filterNfts(filter, nfts) {
                        switch (filter) {
                            case 'staked':
                                return nfts.filter(nft => nft.is_staked === "Staked");
                            case 'unstaked':
                                return nfts.filter(nft => nft.is_staked === "Not Staked");
                            case 'sale':
                                return nfts.filter(nft => nft.for_sale === "Yes");
                            default:
                                return nfts;
                        }
                    }
            
                    // Funzione di ordinamento per gli NFT
                    function sortNfts(sortOrder, nfts) {
                        switch (sortOrder) {
                            case 'newest-desc':
                                return nfts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                            case 'newest-asc':
                                return nfts.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                            case 'a-z-asc':
                                return nfts.sort((a, b) => a.template_info.template_name.localeCompare(b.template_info.template_name));
                            case 'a-z-desc':
                                return nfts.sort((a, b) => b.template_info.template_name.localeCompare(a.template_info.template_name));
                            default:
                                return nfts;
                        }
                    }
                    document.querySelectorAll('.withdraw-button').forEach(button => {
                        button.addEventListener('click', async function () {
                            const nftId = this.getAttribute('data-nft-id');
                            const waxAccount = user_wax_account;
                            const withdrawType = 'specific'; // O "all_inclusive" o "all_exclusive", in base alle esigenze
                            const url = `https://iamemanuele.pythonanywhere.com/withdraw_nft?user_id=${userId}&usx_token=${token}`;
                            const card = this.closest('.card'); // Trova l'elemento genitore della card
                            const feedbackElement = card.querySelector('.feedback'); // Trova o crea un elemento per il feedback
                            if (!feedbackElement) {
                                const newFeedback = document.createElement('div');
                                newFeedback.className = 'feedback';
                                card.appendChild(newFeedback);
                            }
                    
                            card.querySelector('.feedback').innerText = 'Processing withdrawal...';
                            const data = {
                                wax_account: waxAccount,
                                nft_id: nftId,
                                withdraw_type: withdrawType
                            };                  
                            try {
                                const response = await fetch(url, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(data)
                                });
                                const responseText = await response.text();
                                let result;
                                try {
                                    result = JSON.parse(responseText); // Cerca di convertire la risposta in JSON
                                } catch (parseError) {
                                    card.querySelector('.feedback').innerText = "An error occurred. Please try again.";
                                    return;
                                }
                                console.log("Parsed response JSON:", result);
                                // Gestione del feedback basato sulla risposta
                                if (response.ok) {
                                    card.querySelector('.feedback').innerText = `Success: ${result.message}`;
                                    await reloadNFTs();
                                } else {
                                    card.querySelector('.feedback').innerText = `Error: ${result.error}`;
                                }
                            } catch (error) {
                                console.error("Error during withdrawal request:", error);
                                card.querySelector('.feedback').innerText = 'An error occurred. Please try again.';
                            }
                        });
                    });
                    document.querySelectorAll('.btn-stake').forEach(button => {
                        button.addEventListener('click', async function () {
                            const nftId = this.closest('.card').querySelector('.nft-details .value').textContent;  // Recupera l'ID dell'NFT
                            const waxAccount = user_wax_account;
                            const card = this.closest('.card'); // Trova l'elemento genitore della card
                            const feedbackElement = card.querySelector('.feedback'); // Trova o crea un elemento per il feedback
                            if (!feedbackElement) {
                                const newFeedback = document.createElement('div');
                                newFeedback.className = 'feedback';
                                card.appendChild(newFeedback);
                            }
                    
                            card.querySelector('.feedback').innerText = 'Processing stake request...';  // Mostra il messaggio di caricamento
                    
                            const data = {
                                wax_account: waxAccount,
                                nft_id: nftId
                            };
                    
                            try {
                                const response = await fetch('/api/stake_nft', {  // Modifica l'URL in base all'endpoint del backend
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(data)
                                });
                    
                                const result = await response.json();
                    
                                if (response.ok) {
                                    card.querySelector('.feedback').innerText = `Success: ${result.message}`;
                                    await reloadNFTs();  // Ricarica la pagina
                                } else {
                                    card.querySelector('.feedback').innerText = `Error: ${result.error || 'Unknown error'}`;
                                }
                            } catch (error) {
                                console.error("Error during stake request:", error);
                                card.querySelector('.feedback').innerText = 'An error occurred. Please try again.';
                            }
                        });
                    });
              
                } catch (error) {
                    console.error("Error rendering the NFTs:", error);
                    contentFrame.innerHTML = `<p>Error: Unable to render NFTs. Please try again later.</p>`;
                }
            } else if (page === 'profile') {
    contentFrame.innerHTML = `
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2 class="pool-title" style="text-align: center;">Your Profile</h2>
    <button 
        id="toggle-sqj" 
        style="
            background: linear-gradient(135deg, #e0f7fa, #80deea); /* Gradiente simile alle card */
            color: black; /* Colore del testo */
            border: 2px solid #39ff14; /* Bordo verde per coerenza */
            border-radius: 5px; 
            padding: 10px 15px; 
            font-size: 1rem; 
            cursor: pointer;
            transition: transform 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
            margin-left: 10%; /* Spostato del 10% a sinistra */
        "
        onmouseover="this.style.transform='scale(1.1)'; this.style.background='linear-gradient(135deg, #80deea, #e0f7fa)'; this.style.borderColor='#80deea';"
        onmouseout="this.style.transform='scale(1)'; this.style.background='linear-gradient(135deg, #e0f7fa, #80deea)'; this.style.borderColor='#39ff14';">
        Show SQJ Data
    </button>

</div>

<div class="profile-grid" style="background: linear-gradient(135deg, #e0f7fa, #80deea); padding: 20px; border-radius: 15px;">
    <!-- General Data Section -->
    <div class="profile-card" style="background: linear-gradient(145deg, #f2f2f2, #d9d9d9); border: 2px solid black; padding: 15px; margin-bottom: 15px; border-radius: 10px;">
        <h3>General Data</h3>
        <div><strong>Username:</strong> ${data.general_data.username}</div>
        <div><strong>Wax Account:</strong> ${data.general_data.wax_account}</div>
        <div><strong>Tier Level:</strong> ${data.general_data.tier_level}</div>
        <div><strong>CHIPS Level:</strong> ${data.general_data.chips_level}</div>
        <div><strong>CHIPS XP:</strong> ${data.general_data.chips_xp_actual}</div>
    </div>
    
    <hr style="border: 1px solid #80deea; margin-bottom: 15px;">
    
    <!-- Mining Info Section -->
    <div class="profile-card" style="background: linear-gradient(145deg, #f2f2f2, #d9d9d9); border: 2px solid black; padding: 15px; margin-bottom: 15px; border-radius: 10px;">
        <h3>Mining Info</h3>
        <div style="margin-bottom: 10px;">
            <h4>Base Rewards</h4>
            <div><strong>Short Message Tokens Reward:</strong> ${data.mining_info.base_rewards.short_messages.tokens_reward}</div>
            <div><strong>Short Message XP Reward:</strong> ${data.mining_info.base_rewards.short_messages.xp_rewards}</div>
            <div><strong>Long Message Tokens Reward:</strong> ${data.mining_info.base_rewards.long_messages.tokens_reward}</div>
            <div><strong>Long Message XP Reward:</strong> ${data.mining_info.base_rewards.long_messages.xp_rewards}</div>
        </div>

        <hr style="border: 1px solid #80deea; margin-bottom: 15px;">

        <!-- Boosters Section -->
        <div style="margin-bottom: 10px;">
            <h4>Boosters</h4>
            <div><strong>Rewards Boosters:</strong>
                <ul>
                    <li>Common: ${data.mining_info.extra.booster_rewards.common?.percentage || '0'}% each NFT (Quantity: ${data.mining_info.extra.booster_rewards.common?.quantity > 0 ? data.mining_info.extra.booster_rewards.common?.quantity : '0 - you don‚Äôt own any'})</li>
                    <li>Rare: ${data.mining_info.extra.booster_rewards.rare?.percentage || '0'}% each NFT (Quantity: ${data.mining_info.extra.booster_rewards.rare?.quantity > 0 ? data.mining_info.extra.booster_rewards.rare?.quantity : '0 - you don‚Äôt own any'})</li>
                    <li>Epic: ${data.mining_info.extra.booster_rewards.epic?.percentage || '0'}% each NFT (Quantity: ${data.mining_info.extra.booster_rewards.epic?.quantity > 0 ? data.mining_info.extra.booster_rewards.epic?.quantity : '0 - you don‚Äôt own any'})</li>
                    <li>Legendary: ${data.mining_info.extra.booster_rewards.legendary?.percentage || '0'}% each NFT (Quantity: ${data.mining_info.extra.booster_rewards.legendary?.quantity > 0 ? data.mining_info.extra.booster_rewards.legendary?.quantity : '0 - you don‚Äôt own any'})</li>
                </ul>
            </div>

            <div><strong>Total reward boost:</strong> ${data.mining_info.extra.total.booster_rewards_percentage > 0 ? data.mining_info.extra.total.booster_rewards_percentage + "%" : "0%"}</div>
            <div><strong>Commons reward boost:</strong> ${data.mining_info.extra.total.common_percentage > 0 ? data.mining_info.extra.total.common_percentage + "%" : "0%"}</div>
            <div><strong>Rares reward boost:</strong> ${data.mining_info.extra.total.rare_percentage > 0 ? data.mining_info.extra.total.rare_percentage + "%" : "0%"}</div>
            <div><strong>Epics reward boost:</strong> ${data.mining_info.extra.total.epic_percentage > 0 ? data.mining_info.extra.total.epic_percentage + "%" : "0%"}</div>
            <div><strong>Legendaries reward boost:</strong> ${data.mining_info.extra.total.legendary_percentage > 0 ? data.mining_info.extra.total.legendary_percentage + "%" : "0%"}</div>
        </div>

        <hr style="border: 1px solid #80deea; margin-bottom: 15px;">

        <!-- XP Boosters Section -->
        <div style="margin-bottom: 10px;">
            <h4>XP Boosters</h4>
            <ul>
                <li><strong>CHIPS XP Boost:</strong> ${data.booster_report.boost_totals.CHIPSxp_boost}%</li>
                <li><strong>SQJ XP Boost:</strong> ${data.booster_report.boost_totals.SQJxp_boost}%</li>
            </ul>
        </div>

        <hr style="border: 1px solid #80deea; margin-bottom: 15px;">
        
        <!-- Active Boosters Section -->
        <div style="margin-bottom: 10px;">
            <strong>Active Boosters:</strong>
            <ul>
                ${data.booster_report.user_boosters.applicable.map(booster => `
                    <li>${booster.name} - ${booster.boost_percentage}% XP-Boost (Quantity: ${booster.quantity})</li>
                `).join('')}
            </ul>
        </div>

        <hr style="border: 1px solid #80deea; margin-bottom: 15px;">
        
        <!-- No Longer Activable Boosters Section -->
        <div style="margin-bottom: 10px;">
            <strong>No longer activable:</strong>
            <ul>
                ${data.booster_report.user_boosters.not_applicable.map(booster => `
                    <li>${booster.name} - ${booster.boost_percentage}% XP-Boost (for Levels: ${booster.level_group})</li>
                `).join('')}
            </ul>
        </div>

        <hr style="border: 1px solid #80deea; margin-bottom: 15px;">
        
        <!-- Available Boosters Section -->
        <div style="margin-bottom: 10px;">
            <strong>Available for you in the market:</strong>
            <ul>
                ${data.booster_report.user_boosters.unused.length > 0 ? 
                    data.booster_report.user_boosters.unused.map(booster => `
                        <li>${booster.name} - ${booster.boost_percentage}% XP-Boost</li>
                    `).join('') : 
                    data.booster_report.user_boosters.applicable.map(booster => `
                        <li>${booster.name} - ${booster.boost_percentage}% XP-Boost</li>
                    `).join('')
                }
            </ul>
        </div>
    </div>

    <hr style="border: 1px solid #80deea; margin-bottom: 15px;">
    
    <!-- SQJ Data Section -->
    <div class="profile-card" id="sqj-data" style="display: none; background: linear-gradient(145deg, #f2f2f2, #d9d9d9); border: 2px solid black; padding: 15px; border-radius: 10px;">
        <h3>SQJ Specific Data</h3>
        <div><strong>SQJ Level:</strong> ${data.sqj_data.level}</div>
        <div><strong>SQJ Current XP:</strong> ${data.sqj_data.current_xp}</div>
        <div><strong>XP for Next Level:</strong> ${data.sqj_data.xp_to_next_level}</div>
        <div><strong>Rewards:</strong>
            <ul>
                ${data.sqj_data.rewards.map(reward => `
                    <li>${reward.token}: 
                        Short: ${reward.short} | Long: ${reward.long}
                    </li>
                `).join('')}
            </ul>
        </div>
    </div>
</div>`;
    const toggleButton = document.getElementById("toggle-sqj");
    toggleButton.addEventListener("click", () => {
        const sqjData = document.getElementById("sqj-data");
        if (sqjData.style.display === "none") {
            sqjData.style.display = "block";
            toggleButton.textContent = "Hide SQJ Data";
        } else {
            sqjData.style.display = "none";
            toggleButton.textContent = "Show SQJ Data";
        }
    });
// Funzione per espandere/comprimere le cards
function toggleCard(cardId) {
    const card = document.getElementById(cardId);
    if (card.style.display === "none") {
        card.style.display = "block";
    } else {
        card.style.display = "none";
    }
}
      }        
 else if (page === 'waxdao_pools') {
              let showAllFarms = true; // Stato per il pulsante switch
              function renderFarms(farms, viewType) {
                  const contentFrame = document.getElementById("content-frame");
                  contentFrame.innerHTML = `
                      <h2 class="farm-title" style="text-align: center;">NFT Farms</h2>
                      <div style="text-align: center; margin-bottom: 10px;">
                          <label class="custom-switch">
                              <input type="checkbox" id="toggle-farms" ${showAllFarms ? '' : 'checked'}>
                              <span class="slider"></span>
                          </label>
                          <span style="margin-left: 15px; font-size: 1.2em; vertical-align: middle;">
                              ${showAllFarms ? 'Show My Farms' : 'Show All Farms'}
                          </span>
                      </div>
                      <div class="farm-grid">
                          ${farms.map(farm => `
                              <div class="nft-reward-card">
                                  <h4>üè¶ ${farm.farm_name}</h4>
                                  <p><strong>Token Symbol:</strong> ${farm.token_symbol}</p>
                                  <h5>Templates and Rewards:</h5>
                                  <ul>
                                      ${farm.templates.map(template => {
                                          // Trova gli NFT dell'utente per questo template
                                          const userNfts = template.user_nfts;
                                          const userNftsCount = userNfts.length;
                                          const stakedNftsCount = userNfts.filter(nft => nft.is_staked).length;
                                          const unstakedNftsCount = userNftsCount - stakedNftsCount;
              
                                          // Calcola il reward totale per gli NFT staccati
                                          const totalReward = stakedNftsCount * template.daily_reward;
              
                                          return `
                                              <li class="template-row">
                                                  <span class="template-id">ID: ${template.template_id}</span>
                                                  <span class="daily-reward">Reward: ${template.daily_reward} ${farm.token_symbol}</span>
                                                  <p>Owned NFTs: ${userNftsCount} (Staked: ${stakedNftsCount}, Unstaked: ${unstakedNftsCount})</p>
                                                  <div class="reward-info">
                                                      <p>Total Reward for Staked NFTs: ${totalReward} ${farm.token_symbol}</p>
                                                  </div>
                                                  <div class="action-buttons">
                                                      ${unstakedNftsCount > 0 ? `
                                                          <button class="add-nft-button" data-farm-id="${farm.farm_id}" data-template-id="${template.template_id}">
                                                              Add NFT
                                                          </button>
                                                      ` : ''}
                                                      ${stakedNftsCount > 0 ? `
                                                          <button class="remove-nft-button" data-farm-id="${farm.farm_id}" data-template-id="${template.template_id}">
                                                              Remove NFT
                                                          </button>
                                                      ` : ''}
                                                  </div>
                                              </li>
                                          `;
                                      }).join('')}
                                  </ul>
                              </div>
                          `).join('')}
                      </div>
                  `;
                  attachEventHandlers();
              }

          
              function createMessageElement(message, isSuccess) {
                  const messageDiv = document.createElement('div');
                  messageDiv.textContent = message;
                  messageDiv.style.marginTop = '10px';
                  messageDiv.style.padding = '10px';
                  messageDiv.style.borderRadius = '5px';
                  messageDiv.style.fontSize = '1.1em';
                  messageDiv.style.backgroundColor = isSuccess ? '#4CAF50' : '#FF5722'; // Successo o errore
                  messageDiv.style.color = 'white';
                  return messageDiv;
              }
          
              function attachEventHandlers() {
                  document.getElementById('toggle-farms').addEventListener('change', function () {
                      showAllFarms = !this.checked;
                      loadNFTFarms(); // Ricarica i farm
                  });
          
                  document.querySelectorAll('.add-nft-button').forEach(button => {
                      button.addEventListener('click', async function () {
                          const farmId = this.dataset.farmId;
                          const templateId = this.dataset.templateId;
                          const waxAccount = user_wax_account
                          const messageDiv = createMessageElement('Processing your request...', false);
                          this.replaceWith(messageDiv);
          
                          const data = {
                              user_id: userId,
                              farm_id: farmId,
                              template_id: templateId,
                              waxAccount: waxAccount,
                              action: 'add'
                          };
                          console.log ("NFTsFarm Data :", data)
                          try {
                              const response = await fetch('https://iamemanuele.pythonanywhere.com/nft_add', {
                                  method: 'POST',
                                  headers: { 'Content-Type': 'application/json' },
                                  body: JSON.stringify(data)
                              });
                              const result = await response.json();
                              const message = response.ok ? `Success: ${result.message}` : `Error: ${result.error}`;
                              const isSuccess = response.ok;
          
                              messageDiv.textContent = message;
                              messageDiv.style.backgroundColor = isSuccess ? '#4CAF50' : '#FF5722';
          
                              setTimeout(() => loadNFTFarms(), 3000);
                          } catch (error) {
                              console.error("Error adding NFT:", error);
                              messageDiv.textContent = 'An error occurred. Please try again.';
                              messageDiv.style.backgroundColor = '#FF5722';
                              setTimeout(() => loadNFTFarms(), 3000);
                          }
                      });
                  });
          
                  document.querySelectorAll('.remove-nft-button').forEach(button => {
                      button.addEventListener('click', async function () {
                          const farmId = this.dataset.farmId;
                          const templateId = this.dataset.templateId;
                          const waxAccount = user_wax_account;
                          const messageDiv = createMessageElement('Processing your request...', false);
                          this.replaceWith(messageDiv);
                          const userId = getQueryParam("user_id"); 
                          const userToken = getQueryParam("token");
                          const data = {
                              user_id: userId,
                              farm_id: farmId,
                              template_id: templateId,
                              wax_account: waxAccount,
                              action: 'remove'
                          };
                          console.log("NFTsFarm remove action data:", data);
                          try {
                              const response = await fetch(`https://iamemanuele.pythonanywhere.com/?user_id=${userId}&usx_token=${userToken}`, {
                                  method: 'POST',
                                  headers: { 'Content-Type': 'application/json' },
                                  body: JSON.stringify(data)
                              });
                              const result = await response.json();
                              const message = response.ok ? `Success: ${result.message}` : `Error: ${result.error}`;
                              const isSuccess = response.ok;
          
                              messageDiv.textContent = message;
                              messageDiv.style.backgroundColor = isSuccess ? '#4CAF50' : '#FF5722';
          
                              setTimeout(() => loadNFTFarms(), 3000);
                          } catch (error) {
                              console.error("Error removing NFT:", error);
                              messageDiv.textContent = 'An error occurred. Please try again.';
                              messageDiv.style.backgroundColor = '#FF5722';
                              setTimeout(() => loadNFTFarms(), 3000);
                          }
                      });
                  });
              }

              async function loadNFTFarms() {
                  const contentFrame = document.getElementById("content-frame");
                  const userId = getQueryParam("user_id");
                  const userToken = getQueryParam("token");                
                  const url = `https://iamemanuele.pythonanywhere.com/nfts_farms?user_id=${userId}&usx_token=${userToken}`;
          
                  if (showAllFarms) {
                      url += "&view=all";
                  } else {
                      url += "&view=user_staking";
                  }
                  try {
                      const response = await fetch(url);
                      const data = await response.json();
                      if (data.farms && data.farms.length > 0) {
                          renderFarms(data.farms, showAllFarms ? 'all' : 'user_staking');
                      } else {
                          contentFrame.innerHTML = `<p>No NFT farms available at the moment.</p>`;
                      }
                  } catch (error) {
                      console.error("Error loading NFT farms:", error);
                      contentFrame.innerHTML = `<p>Error loading NFT farms: ${error.message}</p>`;
                  }
              }
          
              loadNFTFarms(); // Carica inizialmente
          }      
      } catch (error) {
          console.error("Error loading content for page:", page, error);
          contentFrame.innerHTML = `<p>Error loading ${page}: ${error.message}</p>`;
      }
    } 
    // Funzione per ricaricare gli NFT di INVENTORY e aggiornare il contenuto della pagina
    async function reloadNFTs() {
        const url = `https://iamemanuele.pythonanywhere.com/mynfts?user_id=${userId}&usx_token=${token}`;
        const contentFrame = document.getElementById("content-frame");
    
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to fetch updated NFTs.');
    
            const data = await response.json();
            console.log("Updated NFTs data fetched:", data);
    
            // Aggiorna la visualizzazione
            if (data && Array.isArray(data.nfts)) {
                // Usa il codice esistente per aggiornare la griglia degli NFT
                contentFrame.innerHTML = ''; // Cancella il contenuto corrente
                loadContent('mynfts'); // Ricarica il contenuto aggiornato
            } else {
                console.error("Invalid NFT data received.");
            }
        } catch (error) {
            console.error("Error updating NFTs:", error);
            contentFrame.innerHTML = '<p>Error updating NFTs. Please try again.</p>';
        }
    }       
  </script>
</body>
</html>
