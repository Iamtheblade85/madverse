<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Dwarfs Cave — Goblin Expeditions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="description" content="Dwarfs Cave: send your Goblins on expeditions, open chests, equip items, use consumables, and progress the Season Pass." />
  <meta name="theme-color" content="#111111" />

  <!-- Preconnects & Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;800&family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Styles -->
  <link rel="stylesheet" href="styles_goblin_game.css" />

  <!-- Minimal inline helpers for overlay mode (rest of styling lives in styles_goblin_game.css) -->
  <style>
    html, body { background:#0b0b0b; color:#e7e7e7; }
    /* Hide “non-overlay” blocks when embedded for streaming */
    body.embed-overlay .hide-when-embed { display: none !important; }
    body.embed-overlay .only-when-embed { display: block !important; }
    .only-when-embed { display: none; }

    /* Ensure canvas container expands cleanly in overlays */
    .overlay-canvas-frame { position: relative; width: 100%; max-width: 1400px; margin: 0 auto; }
    .overlay-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: .75rem; }
    /* Visually separate content regions */
    .cv-section { margin: 1.25rem 0; }
  </style>

  <!-- Base URL (optional): override per environment by setting window.BASE_URL before app.js -->
  <script>
    window.BASE_URL = "https://iamemanuele.pythonanywhere.com";
    // If you want to pre-inject user auth from your app shell, set window.userData before app.js loads:
    // window.userData = { wax_account: "name.wam", userId: "123", usx_token: "..." };

    // Overlay detection for streaming
    (function(){
      const p = new URLSearchParams(location.search);
      if (p.get("overlay")==="1" || p.get("embed")==="1") {
        document.documentElement.classList.add("overlay");
        document.body.classList.add("embed-overlay");
      }
    })();
  </script>
</head>
<body>
  <!-- ============ TOP TABS NAV ============ -->
  <nav id="cv-tabs" class="cv-tabs">
    <button class="cv-tab is-active" data-tab="tab-cave">Cave</button>
    <button class="cv-tab" data-tab="tab-nfts">NFTs</button>
    <button class="cv-tab" data-tab="tab-equipment">Equipment</button>
    <button class="cv-tab" data-tab="tab-consumables">Consumables</button>
    <button class="cv-tab" data-tab="tab-season">Season Pass</button>
    <button class="cv-tab" data-tab="tab-leaderboard">Leaderboard</button>
    <button class="cv-tab" data-tab="tab-admin" data-role-required="admin">Admin</button>
    <button class="cv-tab" data-tab="tab-moderation" data-role-required="moderator">Moderation</button>
  </nav>
  
  <noscript>
    <div style="padding:12px; background:#4a0000; color:#fff; text-align:center;">
      JavaScript is required to run Dwarfs Cave. Please enable it and reload.
    </div>
  </noscript>

  <!-- App Shell -->
  <div id="app" class="app-root">
    <!-- Top Bar -->
    <header class="app-header hide-when-embed" role="banner">
      <div class="header-inner">
        <div class="brand">
          <span class="brand-mark">⛏️</span>
          <span class="brand-text">Dwarfs Cave</span>
        </div>
        <nav class="nav-tabs" aria-label="Primary">
          <button class="tab-btn is-active" data-tab="cave" id="tab-btn-cave" aria-controls="tab-cave" aria-selected="true" role="tab">Cave</button>
          <button class="tab-btn" data-tab="season" id="tab-btn-season" aria-controls="tab-season" aria-selected="false" role="tab">Season Pass</button>
        </nav>
        <div class="header-actions">
          <!-- Placeholder for future auth/controls -->
          <span class="hdr-chip">Live</span>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <!-- ============ TABS CONTAINERS ============ -->
    <main id="cv-tabs-host">
    
      <!-- —— TAB: CAVE (gioco) —— -->
      <section id="tab-cave" class="cv-tabpanel is-visible" role="tabpanel" aria-labelledby="Cave">
        <!-- Lascia invariata tutta la tua attuale struttura “Dwarfs Cave” qui dentro -->
        <div id="goblin-content">
    
          <!-- TOAST host -->
          <div id="cv-toast-host" class="cv-toast-host" aria-live="polite"></div>
    
          <!-- top header + toolbar (già esistente) -->
          <header class="cv-header">
            <div class="cv-title">Dwarfs Cave</div>
            <div class="cv-subtitle">Live overlay-ready (Twitch compatible)</div>
          </header>
    
          <!-- video/canvas -->
          <section id="cv-video-or-canvas" class="cv-canvas-wrap">
            <canvas id="caveCanvas" width="1280" height="720" aria-label="Cave scene"></canvas>
          </section>
    
          <!-- action toolbar -->
          <section class="cv-toolbar">
            <div class="left">
              <input id="cv-search" class="cv-input" placeholder="Search goblins by name or ID" />
              <select id="cv-rarity" class="cv-select">
                <option value="">All rarities</option>
                <option>Common</option><option>Rare</option><option>Epic</option><option>Legendary</option><option>Mythic</option>
              </select>
              <div class="cv-range">
                <label>Min Power <span id="cv-power-val">0</span></label>
                <input id="cv-power" type="range" min="0" max="500" step="5" value="0" />
              </div>
            </div>
            <div class="right">
              <div id="cv-sort-segment" class="cv-segment">
                <button class="cv-seg-btn is-active" data-sort="rarity">Rarity</button>
                <button class="cv-seg-btn" data-sort="level">Level</button>
                <button class="cv-seg-btn" data-sort="daily_power">Power</button>
              </div>
              <div id="cv-duration-segment" class="cv-segment">
                <button class="cv-seg-btn is-active" data-dur="1h">1h</button>
                <button class="cv-seg-btn" data-dur="10m">10m</button>
                <button class="cv-seg-btn" data-dur="30m">30m</button>
                <button class="cv-seg-btn" data-dur="6h">6h</button>
                <button class="cv-seg-btn" data-dur="24h">24h</button>
              </div>
              <button class="cv-btn" id="cv-select-100" title="Select first 100 available">First 100</button>
              <button class="cv-btn" id="cv-select-best" title="Auto-pick best 100 by level+main attribute">Best 100</button>
              <button class="cv-btn ghost" id="cv-deselect">Clear</button>
            </div>
          </section>
    
          <!-- selection summary -->
          <section id="cv-summary" class="cv-summary"></section>
          <section id="cv-active-filters" class="cv-badges"></section>
    
          <!-- twin columns: goblins + side panels  -->
          <section class="cv-grid">
            <div class="col main">
              <div id="cv-goblin-list" class="cv-cards"></div>
            </div>
            <aside class="col side">
              <div class="cv-card">
                <div class="cv-card-title">Global expeditions</div>
                <div id="cv-global-cards" class="cv-cards-grid"></div>
              </div>
    
              <div class="cv-card">
                <div class="cv-card-title">Recent expeditions</div>
                <div id="cv-recent-grid" class="cv-cards"></div>
              </div>
    
              <div class="cv-card">
                <div class="cv-card-title">Bonus chests & winners</div>
                <div id="cv-bonus-grid" class="cv-cards"></div>
                <button id="cv-chest-btn" class="cv-btn" title="Try a perk drop (!chest on Twitch)">Try perk</button>
              </div>
    
              <div id="cv-exp-consumables" class="cv-card"></div>
            </aside>
          </section>
    
          <section id="expedition-summary-block" class="cv-summary-block"></section>
        </div>
      </section>
    
      <!-- —— TAB: NFTs —— -->
      <section id="tab-nfts" class="cv-tabpanel" role="tabpanel" aria-labelledby="NFTs">
        <header class="cv-header">
          <div class="cv-title">Your NFTs</div>
          <div class="cv-subtitle">Goblins, Equipment (on-chain), snapshots & history</div>
        </header>
        <div class="cv-grid">
          <div class="col main">
            <div class="cv-card">
              <div class="cv-card-title">Goblins</div>
              <div id="nfts-goblins-list" class="cv-cards"></div>
            </div>
            <div class="cv-card">
              <div class="cv-card-title">Equipment</div>
              <div id="nfts-equipment-list" class="cv-cards"></div>
            </div>
          </div>
          <aside class="col side">
            <div class="cv-card">
              <div class="cv-card-title">Ownership history</div>
              <div id="nfts-history" class="cv-cards"></div>
            </div>
          </aside>
        </div>
      </section>
    
      <!-- —— TAB: Equipment global management —— -->
      <section id="tab-equipment" class="cv-tabpanel" role="tabpanel" aria-labelledby="Equipment">
        <header class="cv-header">
          <div class="cv-title">Equipment Manager</div>
          <div class="cv-subtitle">Assign, move, or remove items across goblins</div>
        </header>
        <div class="cv-grid">
          <div class="col main">
            <div id="equip-manager" class="cv-card"></div>
          </div>
          <aside class="col side">
            <div class="cv-card">
              <div class="cv-card-title">Quick actions</div>
              <div id="equip-quick-actions"></div>
            </div>
          </aside>
        </div>
      </section>
    
      <!-- —— TAB: Consumables —— -->
      <section id="tab-consumables" class="cv-tabpanel" role="tabpanel" aria-labelledby="Consumables">
        <header class="cv-header">
          <div class="cv-title">Consumables</div>
          <div class="cv-subtitle">Inventory, usage logs, crafting (if enabled)</div>
        </header>
        <div class="cv-grid">
          <div class="col main">
            <div class="cv-card">
              <div class="cv-card-title">Inventory</div>
              <div id="cons-list" class="cv-cards"></div>
            </div>
            <div class="cv-card">
              <div class="cv-card-title">Usage history</div>
              <div id="cons-usage" class="cv-cards"></div>
            </div>
          </div>
          <aside class="col side">
            <div class="cv-card">
              <div class="cv-card-title">Info</div>
              <div class="cv-note">Max 3 per expedition (run-wide), and max 1 per goblin.</div>
            </div>
          </aside>
        </div>
      </section>
    
      <!-- —— TAB: Season Pass —— -->
      <section id="tab-season" class="cv-tabpanel" role="tabpanel" aria-labelledby="Season Pass">
        <header class="cv-header">
          <div class="cv-title">Season Pass</div>
          <div class="cv-subtitle">Progress, dual track rewards (Standard & Elite), claims</div>
        </header>
        <div id="season-root" class="cv-card"></div>
      </section>
    
      <!-- —— TAB: Leaderboard —— -->
      <section id="tab-leaderboard" class="cv-tabpanel" role="tabpanel" aria-labelledby="Leaderboard">
        <header class="cv-header">
          <div class="cv-title">Leaderboard</div>
          <div class="cv-subtitle">Top players for the active season</div>
        </header>
        <div id="lb-root" class="cv-card"></div>
      </section>
    
      <!-- —— TAB: Admin (solo admin) —— -->
      <section id="tab-admin" class="cv-tabpanel" data-role-required="admin" role="tabpanel" aria-labelledby="Admin">
        <header class="cv-header">
          <div class="cv-title">Admin Center</div>
          <div class="cv-subtitle">Seasons, tiers, expeditions, rewards, Twitch & perks</div>
        </header>
        <div class="cv-grid">
          <div class="col main">
            <div class="cv-card">
              <div class="cv-card-title">Expeditions (all users)</div>
              <div id="admin-exp-list" class="cv-cards"></div>
            </div>
            <div class="cv-card">
              <div class="cv-card-title">Seasons & tiers</div>
              <div id="admin-seasons" class="cv-cards"></div>
            </div>
            <div class="cv-card">
              <div class="cv-card-title">Spawn chest / Perks</div>
              <div id="admin-perks" class="cv-cards"></div>
            </div>
          </div>
          <aside class="col side">
            <div class="cv-card">
              <div class="cv-card-title">VIP & Roles</div>
              <div id="admin-roles" class="cv-cards"></div>
            </div>
          </aside>
        </div>
      </section>
    
      <!-- —— TAB: Moderation (solo moderator) —— -->
      <section id="tab-moderation" class="cv-tabpanel" data-role-required="moderator" role="tabpanel" aria-labelledby="Moderation">
        <header class="cv-header">
          <div class="cv-title">Moderation</div>
          <div class="cv-subtitle">View all expeditions, spawn perks (rate-limited), review logs</div>
        </header>
        <div id="mod-root" class="cv-card"></div>
      </section>
    
    </main>


    <!-- Footer -->
    <footer class="app-footer hide-when-embed" role="contentinfo">
      <div class="footer-inner">
        <span>© <span id="year"></span> Dwarfs Cave</span>
        <span class="sep">•</span>
        <span>Built for explorers, streamers & mobile.</span>
      </div>
    </footer>
  </div>

  <!-- Scripts -->
  <script defer src="app.js"></script>
  <script>
    // Lightweight boot script: tabs + initializers + overlay polish
    (function(){
      const $ = (s, r=document)=>r.querySelector(s);
      const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

      // Footer year
      $("#year").textContent = new Date().getFullYear();

      // Tab wiring
      const tabs = {
        cave: { btn: $("#tab-btn-cave"), panel: $("#tab-cave"), init: () => window.renderDwarfsCave && window.renderDwarfsCave() },
        season: { btn: $("#tab-btn-season"), panel: $("#tab-season"), init: () => window.renderSeasonPass && window.renderSeasonPass() }
      };

      function activate(tabKey){
        Object.entries(tabs).forEach(([k,o])=>{
          if (!o.btn || !o.panel) return;
          const active = (k === tabKey);
          o.btn.classList.toggle("is-active", active);
          o.btn.setAttribute("aria-selected", active ? "true":"false");
          o.panel.hidden = !active;
        });
        // Init on first view
        const t = tabs[tabKey];
        if (t && !t.panel.dataset.inited){
          t.panel.dataset.inited = "1";
          try { t.init(); } catch(e){ console.warn("Init error:", e); }
        }
        // Reflect hash
        history.replaceState(null, "", `#${tabKey}`);
      }

      // Click handlers
      Object.entries(tabs).forEach(([k,o])=>{
        o.btn && o.btn.addEventListener("click", ()=> activate(k));
      });

      // Auto-activate based on hash or default
      const initial = (location.hash || "").replace("#","") || "cave";
      activate(tabs[initial] ? initial : "cave");

      // Sync Duration segmented control with saved value
      const saved = (JSON.parse(localStorage.getItem("caveDuration") || "{}").key) || "1h";
      $$("#cv-duration-segment .cv-seg-btn").forEach(b=>{
        const on = (b.dataset.dur === saved);
        b.classList.toggle("is-active", on);
        b.setAttribute("aria-selected", on ? "true":"false");
      });

      // If overlay mode, you can optionally make the canvas full-bleed height
      if (document.body.classList.contains("embed-overlay")) {
        // Optional tweak: expand canvas section a bit
        const wrap = $("#cv-video-or-canvas");
        if (wrap) wrap.style.marginTop = "0";
      }
    })();
  </script>
</body>
</html>
