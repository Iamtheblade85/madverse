<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Dwarfs Cave – Goblins, Orcs & Weekly Pass</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #02030a;
      color: #f5f5f5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }
    body {
      display: flex;
      align-items: stretch;
      justify-content: center;
    }
    .page-shell {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div class="page-shell">
    <div id="goblin-content"></div>
  </div>

  <!-- Config: backend base URL and user auth data -->
  <script>
    window.CAVE_API_BASE = "https://iamemanuele.pythonanywhere.com";

    window.userData = {
      wax_account: "agoscry4ever",
      user_id: "5235038223",
      usx_token: "9o0B6EGF9CJxXMqKyZPtcGEcRifzP9Yeil5S1zuRGjZehKoyy9ZDcIEe26OgmiGuYAgFgqYletGoHVhFATQjrtP6ZPLuU9UvGYSki0rYw7kjCEw6q6of4xO0VPgt6WE0"
    };

    // Set to true if this page is used as a read-only overlay (OBS, stream, etc.)
    window.CAVE_OVERLAY = false;
  </script>

  <!-- Frontend logic: use the JS file you already have, unchanged -->
  <!-- Option 1: external file (recommended) -->
  <!--
  Option 2: inline script
  If you prefer inline, paste here EXACTLY the <script>...</script> code
  I gave you in the previous message, instead of the src above.
  -->
<script>
(() => {
  "use strict";

  const BASE_URL = window.CAVE_API_BASE || "";
  const ROOT_ID = "goblin-content";
  const REFRESH_ALL_MS = 23000;
  const COMMAND_POLL_MS = 31000;
  const EVENTS_POLL_MS = 4000;
  const CHEST_TTL_MS = 10 * 60 * 1000;

  const Game = {
    root: null,
    user: {
      wax_account: "",
      user_id: "",
      usx_token: ""
    },
    ui: {
      mainCanvas: null,
      mainCtx: null,
      mainDpr: 1,
      mainWidth: 0,
      mainHeight: 0,
      mainRafId: 0,
      mainRunning: false,
      focusOrcCanvas: null,
      focusOrcCtx: null,
      focusOrcDpr: 1,
      toastContainer: null,
      statsHeader: null,
      goblinList: null,
      goblinFilterInput: null,
      goblinDurationSelect: null,
      goblinSelectAllBtn: null,
      goblinStartBtn: null,
      goblinSummary: null,
      orcList: null,
      orcDetails: null,
      equipFilterInput: null,
      equipSlotFilter: null,
      equipRarityFilter: null,
      equipList: null,
      equipResetBtn: null,
      passProgressBar: null,
      passQuestsList: null,
      passRewardsList: null,
      passBuyBtn: null,
      globalLiveList: null,
      recentList: null,
      winnersList: null
    },
    state: {
      overlay: !!window.CAVE_OVERLAY,
      eventsSince: 0,
      eventsSource: null,
      pollingEvents: false,
      commandPolling: false,
      userNFTsLoaded: false,
      userNFTsRetry: false,
      goblins: [],
      goblinSelection: new Set(),
      goblinDuration: 1800,
      reinforcementCount: 0,
      currentLimit: 50,
      allExpeditions: [],
      recentExpeditions: [],
      recentWinners: [],
      orcs: [],
      activeOrcId: null,
      equips: [],
      equippedSlots: {},
      weeklyPass: null,
      actors: new Map(),
      chests: new Map(),
      lastFrameTime: 0,
      userExpedition: null,
      userExpRemainingSec: 0,
      userExpTimerId: 0
    }
  };

  function injectStyles() {
    const css = `
      #${ROOT_ID} { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; color:#f5f5f5; }
      .cv-root { display:flex; flex-direction:column; gap:0.75rem; padding:0.75rem; background:#050608; border-radius:16px; border:1px solid #181827; box-shadow:0 14px 40px rgba(0,0,0,0.75); }
      .cv-layout { display:grid; grid-template-columns:minmax(0,2.4fr) minmax(0,1.6fr); gap:0.75rem; min-height:520px; }
      .cv-main-panel, .cv-side-panel { background:radial-gradient(circle at top,#171828 0,#050608 60%); border-radius:14px; padding:0.75rem; border:1px solid #22233a; display:flex; flex-direction:column; gap:0.6rem; }
      .cv-main-panel { position:relative; overflow:hidden; }
      .cv-header { display:flex; justify-content:space-between; align-items:center; gap:0.5rem; font-size:0.8rem; }
      .cv-stat-pill { display:inline-flex; align-items:center; gap:0.25rem; padding:0.15rem 0.5rem; border-radius:999px; background:rgba(15,189,145,.12); border:1px solid rgba(15,189,145,.4); color:#9fffe0; font-size:0.72rem; }
      .cv-stat-pill strong { font-weight:600; }
      .cv-tag { font-size:0.7rem; padding:0.15rem 0.4rem; border-radius:999px; border:1px solid rgba(255,255,255,.1); text-transform:uppercase; letter-spacing:.08em; opacity:.8; }
      .cv-canvas-wrap { position:relative; flex:1 1 auto; border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,.06); background:#030308; }
      .cv-canvas { width:100%; height:100%; display:block; }
      .cv-main-overlay { position:absolute; inset:0; pointer-events:none; display:flex; flex-direction:column; justify-content:space-between; padding:0.5rem; }
      .cv-main-overlay-top { display:flex; justify-content:space-between; gap:0.5rem; }
      .cv-main-overlay-bottom { display:flex; justify-content:space-between; gap:0.5rem; align-items:flex-end; }
      .cv-chip-row { display:flex; gap:0.3rem; flex-wrap:wrap; font-size:0.7rem; opacity:.8; }
      .cv-chip-pill { display:inline-flex; align-items:center; gap:0.2rem; padding:0.1rem 0.5rem; border-radius:999px; background:rgba(0,0,0,.65); font-size:0.7rem; }
      .cv-section-title { font-size:0.75rem; font-weight:600; letter-spacing:.12em; text-transform:uppercase; opacity:.9; display:flex; align-items:center; justify-content:space-between; gap:0.4rem; }
      .cv-section-sub { font-size:0.7rem; opacity:.7; }
      .cv-scroll { flex:1 1 auto; min-height:0; max-height:220px; overflow:auto; padding-right:0.25rem; }
      .cv-scroll::-webkit-scrollbar { width:5px; }
      .cv-scroll::-webkit-scrollbar-thumb { background:rgba(255,255,255,.14); border-radius:999px; }
      .cv-card { border-radius:10px; border:1px solid rgba(255,255,255,.06); padding:0.5rem; background:radial-gradient(circle at top,#171828 0,#050608 55%); display:flex; flex-direction:column; gap:0.35rem; margin-bottom:0.35rem; }
      .cv-card-header { display:flex; justify-content:space-between; align-items:center; gap:0.3rem; }
      .cv-card-title { font-size:0.78rem; font-weight:600; }
      .cv-card-meta { font-size:0.7rem; opacity:.75; display:flex; gap:0.4rem; flex-wrap:wrap; }
      .cv-pill { border-radius:999px; padding:0.12rem 0.45rem; border:1px solid rgba(255,255,255,.12); font-size:0.68rem; opacity:.9; }
      .cv-pill-positive { border-color:rgba(15,189,145,.7); color:#9fffe0; }
      .cv-pill-warning { border-color:#ffb74d; color:#ffe0b2; }
      .cv-pill-danger { border-color:#ff5252; color:#ffb3b3; }
      .cv-grid { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:0.35rem; }
      .cv-grid-3 { display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:0.35rem; }
      .cv-grid-4 { display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:0.25rem; }
      .cv-badge { display:inline-flex; align-items:center; gap:0.2rem; padding:0.1rem 0.4rem; border-radius:999px; border:1px solid rgba(255,255,255,.12); font-size:0.68rem; }
      .cv-input, .cv-select { width:100%; border-radius:999px; border:1px solid rgba(255,255,255,.14); background:rgba(3,3,8,.9); color:#f5f5f5; padding:0.28rem 0.6rem; font-size:0.75rem; outline:none; }
      .cv-input::placeholder { opacity:.55; }
      .cv-btn { border-radius:999px; border:1px solid rgba(15,189,145,.9); background:linear-gradient(120deg,#0fb991,#0f7ab9); color:#050608; font-size:0.75rem; padding:0.3rem 0.75rem; cursor:pointer; font-weight:600; display:inline-flex; align-items:center; justify-content:center; gap:0.3rem; }
      .cv-btn-secondary { border-color:rgba(255,255,255,.16); background:rgba(6,6,16,.9); color:#f5f5f5; }
      .cv-btn-ghost { border-color:rgba(255,255,255,.14); background:transparent; color:#f5f5f5; }
      .cv-btn-small { padding:0.2rem 0.5rem; font-size:0.7rem; }
      .cv-btn:disabled { opacity:.6; cursor:not-allowed; }
      .cv-toast-area { position:fixed; right:1rem; bottom:1rem; display:flex; flex-direction:column; gap:0.4rem; z-index:9999; }
      .cv-toast { min-width:220px; max-width:320px; border-radius:10px; padding:0.55rem 0.6rem; background:#151524; border:1px solid rgba(255,255,255,.18); font-size:0.76rem; box-shadow:0 12px 32px rgba(0,0,0,.6); }
      .cv-toast-title { font-weight:600; margin-bottom:0.15rem; }
      .cv-toast.ok { border-color:#00e676; }
      .cv-toast.err { border-color:#ff5252; }
      .cv-toast.warn { border-color:#ffb300; }
      .cv-tabs { display:flex; gap:0.3rem; border-radius:999px; background:rgba(7,7,18,.9); padding:0.15rem; }
      .cv-tab { flex:1 1 0; text-align:center; border-radius:999px; font-size:0.72rem; padding:0.2rem 0.3rem; cursor:pointer; border:1px solid transparent; opacity:.7; }
      .cv-tab.active { background:rgba(15,189,145,.15); border-color:rgba(15,189,145,.8); opacity:1; }
      .cv-flex-row { display:flex; align-items:center; justify-content:space-between; gap:0.4rem; }
      .cv-flex { display:flex; gap:0.4rem; }
      .cv-badge-small { font-size:0.65rem; padding:0.1rem 0.35rem; border-radius:999px; border:1px solid rgba(255,255,255,.12); }
      .cv-progress-wrap { height:0.45rem; border-radius:999px; background:rgba(255,255,255,.06); overflow:hidden; }
      .cv-progress-bar { height:100%; width:0%; border-radius:999px; background:linear-gradient(120deg,#0fb991,#0f7ab9); transition:width .25s ease-out; }
      .cv-orc-focus-wrap { border-radius:12px; border:1px solid rgba(255,255,255,.1); background:radial-gradient(circle at top,#1b1b2b 0,#050608 60%); padding:0.4rem; display:flex; flex-direction:column; gap:0.25rem; }
      .cv-orc-canvas-wrap { border-radius:10px; overflow:hidden; border:1px solid rgba(255,255,255,.08); background:#020209; }
      .cv-orc-meta { display:flex; justify-content:space-between; font-size:0.7rem; opacity:.85; }
      .cv-pill-rarity-common { color:#e0e0e0; border-color:#9e9e9e; }
      .cv-pill-rarity-rare { color:#90caf9; border-color:#42a5f5; }
      .cv-pill-rarity-epic { color:#ce93d8; border-color:#ab47bc; }
      .cv-pill-rarity-legendary { color:#ffe082; border-color:#ffca28; }
      .cv-equip-tag-slot, .cv-equip-tag-duration { font-size:0.65rem; padding:0.05rem 0.4rem; border-radius:999px; border:1px solid rgba(255,255,255,.16); }
      .cv-muted { opacity:.6; }
      @media (max-width:980px){ .cv-layout{grid-template-columns:1fr;} }
    `;
    const style = document.createElement("style");
    style.textContent = css;
    document.head.appendChild(style);
  }

  function fetchJSON(url, options, timeoutMs) {
    return new Promise((resolve, reject) => {
      const c = new AbortController();
      const id = setTimeout(() => c.abort(), timeoutMs || 15000);
      fetch(url, { ...(options || {}), signal: c.signal })
        .then(r => r.json().catch(() => ({})).then(data => ({ ok: r.ok, status: r.status, data })))
        .then(r => {
          clearTimeout(id);
          resolve(r);
        })
        .catch(err => {
          clearTimeout(id);
          reject(err);
        });
    });
  }

  const API = {
    post(path, body, timeout) {
      return fetchJSON(`${BASE_URL}${path}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body || {})
      }, timeout || 15000);
    },
    get(path, timeout) {
      return fetchJSON(`${BASE_URL}${path}`, {}, timeout || 15000);
    }
  };

  function syncUser() {
    const mem = window.userData || JSON.parse(localStorage.getItem("userData") || "{}");
    Game.user.wax_account = mem?.wax_account || "";
    Game.user.user_id = mem?.user_id ?? mem?.userId ?? "";
    Game.user.usx_token = mem?.usx_token || "";
  }

  function requireAuth() {
    syncUser();
    if (!Game.user.wax_account || !Game.user.user_id || !Game.user.usx_token) throw new Error("Missing auth data");
  }

  function toast(title, text, type) {
    if (!Game.ui.toastContainer) return;
    const box = document.createElement("div");
    box.className = "cv-toast " + (type || "ok");
    const h = document.createElement("div");
    h.className = "cv-toast-title";
    h.textContent = title;
    const p = document.createElement("div");
    p.textContent = text;
    box.appendChild(h);
    box.appendChild(p);
    Game.ui.toastContainer.appendChild(box);
    setTimeout(() => {
      box.style.opacity = "0";
      box.style.transform = "translateY(6px)";
      setTimeout(() => box.remove(), 250);
    }, 3500);
  }

  function buildLayout() {
    const root = document.getElementById(ROOT_ID);
    if (!root) return;
    Game.root = root;
    root.innerHTML = "";
    const wrap = document.createElement("div");
    wrap.className = "cv-root";

    const header = document.createElement("div");
    header.className = "cv-header";
    const left = document.createElement("div");
    left.innerHTML = `<div class="cv-section-title">Dwarfs Cave Live<span class="cv-tag">Goblin Expeditions</span></div><div class="cv-section-sub">Send goblins, empower your orc, chase chests and climb weekly rewards.</div>`;
    const right = document.createElement("div");
    right.className = "cv-flex";
    const pill1 = document.createElement("div");
    pill1.className = "cv-stat-pill";
    pill1.innerHTML = `<span>Active players</span><strong id="cv-stat-players">0</strong>`;
    const pill2 = document.createElement("div");
    pill2.className = "cv-stat-pill";
    pill2.innerHTML = `<span>Payout multiplier</span><strong id="cv-stat-multiplier">1.00x</strong>`;
    const pill3 = document.createElement("div");
    pill3.className = "cv-stat-pill";
    pill3.innerHTML = `<span>Weekly pass</span><strong id="cv-stat-pass">0%</strong>`;
    right.appendChild(pill1);
    right.appendChild(pill2);
    right.appendChild(pill3);
    header.appendChild(left);
    header.appendChild(right);
    Game.ui.statsHeader = { players: pill1.querySelector("strong"), multiplier: pill2.querySelector("strong"), pass: pill3.querySelector("strong") };

    const layout = document.createElement("div");
    layout.className = "cv-layout";

    const mainPanel = document.createElement("div");
    mainPanel.className = "cv-main-panel";
    const mainTop = document.createElement("div");
    mainTop.className = "cv-flex-row";
    mainTop.innerHTML = `<div class="cv-section-title">World Canvas</div><div class="cv-chip-row"><div class="cv-badge-small">Live expeditions</div><div class="cv-badge-small">Chests & perks</div></div>`;
    const canvasWrap = document.createElement("div");
    canvasWrap.className = "cv-canvas-wrap";
    const c = document.createElement("canvas");
    c.className = "cv-canvas";
    canvasWrap.appendChild(c);
    const overlay = document.createElement("div");
    overlay.className = "cv-main-overlay";
    overlay.innerHTML = `
      <div class="cv-main-overlay-top">
        <div class="cv-chip-row">
          <div class="cv-chip-pill" id="cv-live-expeditions-pill"><strong>0</strong><span>Expeditions</span></div>
          <div class="cv-chip-pill" id="cv-live-goblins-pill"><strong>0</strong><span>Goblins</span></div>
        </div>
        <div class="cv-chip-row">
          <div class="cv-chip-pill" id="cv-live-chests-pill"><strong>0</strong><span>Chests</span></div>
        </div>
      </div>
      <div class="cv-main-overlay-bottom">
        <div class="cv-chip-row">
          <div class="cv-chip-pill"><span>Use perks to spawn chests and boost rewards.</span></div>
        </div>
        <div class="cv-chip-row">
          <button class="cv-btn cv-btn-small" id="cv-btn-perk">Try a perk drop</button>
        </div>
      </div>
    `;
    canvasWrap.appendChild(overlay);
    mainPanel.appendChild(mainTop);
    mainPanel.appendChild(canvasWrap);

    const sidePanel = document.createElement("div");
    sidePanel.className = "cv-side-panel";
    const tabs = document.createElement("div");
    tabs.className = "cv-tabs";
    tabs.innerHTML = `
      <button class="cv-tab active" data-tab="goblins">Goblins</button>
      <button class="cv-tab" data-tab="orcs">Orc & equips</button>
      <button class="cv-tab" data-tab="pass">Weekly pass</button>
      <button class="cv-tab" data-tab="activity">Activity</button>
    `;
    const content = document.createElement("div");
    content.style.flex = "1 1 auto";
    content.style.minHeight = "0";
    content.style.marginTop = "0.4rem";
    sidePanel.appendChild(tabs);
    sidePanel.appendChild(content);

    layout.appendChild(mainPanel);
    layout.appendChild(sidePanel);

    const toastArea = document.createElement("div");
    toastArea.className = "cv-toast-area";

    wrap.appendChild(header);
    wrap.appendChild(layout);
    wrap.appendChild(toastArea);

    root.appendChild(wrap);
    Game.ui.toastContainer = toastArea;
    Game.ui.mainCanvas = c;
    Game.ui.mainCtx = c.getContext("2d");

    setupTabs(tabs, content);
    initMainCanvas();
    bindGlobalButtons();
  }

  function setupTabs(tabs, content) {
    function setTab(name) {
      tabs.querySelectorAll(".cv-tab").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === name);
      });
      content.innerHTML = "";
      if (name === "goblins") renderGoblinTab(content);
      else if (name === "orcs") renderOrcTab(content);
      else if (name === "pass") renderPassTab(content);
      else if (name === "activity") renderActivityTab(content);
    }
    tabs.querySelectorAll(".cv-tab").forEach(btn => {
      btn.addEventListener("click", () => setTab(btn.dataset.tab));
    });
    setTab("goblins");
  }

  function renderGoblinTab(container) {
    const wrap = document.createElement("div");
    wrap.style.display = "flex";
    wrap.style.flexDirection = "column";
    wrap.style.gap = "0.5rem";

    const header = document.createElement("div");
    header.className = "cv-section-title";
    header.innerHTML = `Your goblins<span class="cv-section-sub">Select goblins, choose duration and start expeditions.</span>`;
    wrap.appendChild(header);

    const controlsRow = document.createElement("div");
    controlsRow.className = "cv-flex-row";
    const left = document.createElement("div");
    left.className = "cv-flex";
    left.style.flex = "1 1 auto";
    const filter = document.createElement("input");
    filter.type = "search";
    filter.placeholder = "Search goblins by id or rarity";
    filter.className = "cv-input";
    left.appendChild(filter);
    const right = document.createElement("div");
    right.className = "cv-flex";
    const durationSelect = document.createElement("select");
    durationSelect.className = "cv-select cv-btn-small";
    [["1800","30 min"],["3600","60 min"],["7200","2 hours"],["14400","4 hours"]].forEach(([v,l]) => {
      const o = document.createElement("option");
      o.value = v;
      o.textContent = l;
      durationSelect.appendChild(o);
    });
    const selectAllBtn = document.createElement("button");
    selectAllBtn.className = "cv-btn cv-btn-secondary cv-btn-small";
    selectAllBtn.textContent = "Select best";
    right.appendChild(durationSelect);
    right.appendChild(selectAllBtn);
    controlsRow.appendChild(left);
    controlsRow.appendChild(right);
    wrap.appendChild(controlsRow);

    const listWrap = document.createElement("div");
    listWrap.className = "cv-scroll";
    const list = document.createElement("div");
    list.className = "cv-grid";
    listWrap.appendChild(list);
    wrap.appendChild(listWrap);

    const bottomRow = document.createElement("div");
    bottomRow.className = "cv-flex-row";
    const summary = document.createElement("div");
    summary.className = "cv-section-sub";
    summary.id = "cv-goblin-summary";
    summary.textContent = "0 goblins selected • base payout 0.00";
    const startBtn = document.createElement("button");
    startBtn.className = "cv-btn";
    startBtn.textContent = "Start expedition";
    bottomRow.appendChild(summary);
    bottomRow.appendChild(startBtn);
    wrap.appendChild(bottomRow);

    container.appendChild(wrap);

    Game.ui.goblinList = list;
    Game.ui.goblinFilterInput = filter;
    Game.ui.goblinDurationSelect = durationSelect;
    Game.ui.goblinSelectAllBtn = selectAllBtn;
    Game.ui.goblinStartBtn = startBtn;
    Game.ui.goblinSummary = summary;

    filter.addEventListener("input", () => renderGoblinList());
    durationSelect.addEventListener("change", () => {
      Game.state.goblinDuration = parseInt(durationSelect.value, 10) || 1800;
      updateGoblinSummary();
    });
    selectAllBtn.addEventListener("click", () => {
      autoSelectBestGoblins();
      renderGoblinList();
      updateGoblinSummary();
    });
    startBtn.addEventListener("click", () => startUserExpedition());

    renderGoblinList();
    updateGoblinSummary();
    updateGoblinControlsState();
  }

  function renderOrcTab(container) {
    const wrap = document.createElement("div");
    wrap.style.display = "flex";
    wrap.style.flexDirection = "column";
    wrap.style.gap = "0.5rem";

    const header = document.createElement("div");
    header.className = "cv-section-title";
    header.innerHTML = `Orc commander<span class="cv-section-sub">Select an orc and manage your equips.</span>`;
    wrap.appendChild(header);

    const orcRow = document.createElement("div");
    orcRow.className = "cv-grid";
    const orcListCol = document.createElement("div");
    const orcListHeader = document.createElement("div");
    orcListHeader.className = "cv-flex-row";
    orcListHeader.innerHTML = `<div class="cv-section-sub">Owned orcs</div>`;
    const orcListScroll = document.createElement("div");
    orcListScroll.className = "cv-scroll";
    orcListScroll.style.maxHeight = "180px";
    const orcList = document.createElement("div");
    orcList.className = "cv-grid";
    orcListScroll.appendChild(orcList);
    orcListCol.appendChild(orcListHeader);
    orcListCol.appendChild(orcListScroll);

    const orcDetailCol = document.createElement("div");
    const orcFocusWrap = document.createElement("div");
    orcFocusWrap.className = "cv-orc-focus-wrap";
    const orcMeta = document.createElement("div");
    orcMeta.className = "cv-orc-meta";
    orcMeta.innerHTML = `<span id="cv-orc-name" class="cv-card-title cv-muted">No orc selected</span><span id="cv-orc-rarity" class="cv-pill cv-pill-rarity-common cv-muted">None</span>`;
    const orcCanvasWrap = document.createElement("div");
    orcCanvasWrap.className = "cv-orc-canvas-wrap";
    const oc = document.createElement("canvas");
    oc.className = "cv-canvas";
    orcCanvasWrap.appendChild(oc);
    const slotsRow = document.createElement("div");
    slotsRow.className = "cv-grid-3";
    slotsRow.id = "cv-orc-slots";
    const resetBtn = document.createElement("button");
    resetBtn.className = "cv-btn cv-btn-ghost cv-btn-small";
    resetBtn.textContent = "Reset equips";

    orcFocusWrap.appendChild(orcMeta);
    orcFocusWrap.appendChild(orcCanvasWrap);
    orcFocusWrap.appendChild(slotsRow);
    orcFocusWrap.appendChild(resetBtn);
    orcDetailCol.appendChild(orcFocusWrap);

    orcRow.appendChild(orcListCol);
    orcRow.appendChild(orcDetailCol);
    wrap.appendChild(orcRow);

    const equipHeader = document.createElement("div");
    equipHeader.className = "cv-section-title";
    equipHeader.innerHTML = `Equips inventory<span class="cv-section-sub">Filter and equip items on your active orc.</span>`;
    wrap.appendChild(equipHeader);

    const equipFilters = document.createElement("div");
    equipFilters.className = "cv-flex-row";
    const efLeft = document.createElement("div");
    efLeft.className = "cv-flex";
    efLeft.style.flex = "1 1 auto";
    const efSearch = document.createElement("input");
    efSearch.type = "search";
    efSearch.placeholder = "Search equips by name or id";
    efSearch.className = "cv-input";
    efLeft.appendChild(efSearch);
    const efRight = document.createElement("div");
    efRight.className = "cv-flex";
    const slotSel = document.createElement("select");
    slotSel.className = "cv-select cv-btn-small";
    [["","All slots"],["helm","Helm"],["chest","Chest"],["weapon","Weapon"],["trinket","Trinket"],["belt","Belt"],["boots","Boots"]].forEach(([v,l]) => {
      const o = document.createElement("option");
      o.value = v;
      o.textContent = l;
      slotSel.appendChild(o);
    });
    const rarSel = document.createElement("select");
    rarSel.className = "cv-select cv-btn-small";
    [["","All rarities"],["common","Common"],["rare","Rare"],["epic","Epic"],["legendary","Legendary"]].forEach(([v,l]) => {
      const o = document.createElement("option");
      o.value = v;
      o.textContent = l;
      rarSel.appendChild(o);
    });
    efRight.appendChild(slotSel);
    efRight.appendChild(rarSel);
    equipFilters.appendChild(efLeft);
    equipFilters.appendChild(efRight);
    wrap.appendChild(equipFilters);

    const equipListWrap = document.createElement("div");
    equipListWrap.className = "cv-scroll";
    const equipList = document.createElement("div");
    equipList.className = "cv-grid";
    equipListWrap.appendChild(equipList);
    wrap.appendChild(equipListWrap);

    container.appendChild(wrap);

    Game.ui.orcList = orcList;
    Game.ui.orcDetails = {
      name: orcMeta.querySelector("#cv-orc-name"),
      rarity: orcMeta.querySelector("#cv-orc-rarity"),
      slots: slotsRow
    };
    Game.ui.focusOrcCanvas = oc;
    Game.ui.focusOrcCtx = oc.getContext("2d");
    Game.ui.equipFilterInput = efSearch;
    Game.ui.equipSlotFilter = slotSel;
    Game.ui.equipRarityFilter = rarSel;
    Game.ui.equipList = equipList;
    Game.ui.equipResetBtn = resetBtn;

    efSearch.addEventListener("input", () => renderEquipList());
    slotSel.addEventListener("change", () => renderEquipList());
    rarSel.addEventListener("change", () => renderEquipList());
    resetBtn.addEventListener("click", () => resetAllEquips());

    updateOrcView();
    renderEquipList();
  }

  function renderPassTab(container) {
    const wrap = document.createElement("div");
    wrap.style.display = "flex";
    wrap.style.flexDirection = "column";
    wrap.style.gap = "0.5rem";

    const header = document.createElement("div");
    header.className = "cv-section-title";
    header.innerHTML = `Weekly pass<span class="cv-section-sub">Complete quests, hit thresholds and unlock rewards.</span>`;
    wrap.appendChild(header);

    const topRow = document.createElement("div");
    topRow.className = "cv-flex-row";
    const left = document.createElement("div");
    const title = document.createElement("div");
    title.className = "cv-section-sub";
    title.id = "cv-pass-status-text";
    title.textContent = "Loading...";
    const progressWrap = document.createElement("div");
    progressWrap.className = "cv-progress-wrap";
    const progBar = document.createElement("div");
    progBar.className = "cv-progress-bar";
    progressWrap.appendChild(progBar);
    left.appendChild(title);
    left.appendChild(progressWrap);
    const right = document.createElement("div");
    const buyBtn = document.createElement("button");
    buyBtn.className = "cv-btn";
    buyBtn.textContent = "Buy weekly pass";
    right.appendChild(buyBtn);
    topRow.appendChild(left);
    topRow.appendChild(right);
    wrap.appendChild(topRow);

    const questsHeader = document.createElement("div");
    questsHeader.className = "cv-section-title";
    questsHeader.innerHTML = `Quests<span class="cv-section-sub">Earn points by playing and using perks/equips.</span>`;
    wrap.appendChild(questsHeader);
    const questsList = document.createElement("div");
    questsList.className = "cv-scroll";
    questsList.style.maxHeight = "150px";
    wrap.appendChild(questsList);

    const rewardsHeader = document.createElement("div");
    rewardsHeader.className = "cv-section-title";
    rewardsHeader.innerHTML = `Threshold rewards<span class="cv-section-sub">Reach thresholds to claim NFTs and token rewards.</span>`;
    wrap.appendChild(rewardsHeader);
    const rewardsList = document.createElement("div");
    rewardsList.className = "cv-scroll";
    wrap.appendChild(rewardsList);

    container.appendChild(wrap);

    Game.ui.passProgressBar = progBar;
    Game.ui.passQuestsList = questsList;
    Game.ui.passRewardsList = rewardsList;
    Game.ui.passBuyBtn = buyBtn;

    buyBtn.addEventListener("click", () => buyWeeklyPass());
    renderWeeklyPass();
  }

  function renderActivityTab(container) {
    const wrap = document.createElement("div");
    wrap.style.display = "flex";
    wrap.style.flexDirection = "column";
    wrap.style.gap = "0.5rem";

    const liveHeader = document.createElement("div");
    liveHeader.className = "cv-section-title";
    liveHeader.textContent = "Live expeditions";
    wrap.appendChild(liveHeader);
    const liveScroll = document.createElement("div");
    liveScroll.className = "cv-scroll";
    const liveList = document.createElement("div");
    liveScroll.appendChild(liveList);
    wrap.appendChild(liveScroll);

    const recentHeader = document.createElement("div");
    recentHeader.className = "cv-section-title";
    recentHeader.textContent = "Recent results";
    wrap.appendChild(recentHeader);
    const recentScroll = document.createElement("div");
    recentScroll.className = "cv-scroll";
    const recentList = document.createElement("div");
    recentScroll.appendChild(recentList);
    wrap.appendChild(recentScroll);

    const winnersHeader = document.createElement("div");
    winnersHeader.className = "cv-section-title";
    winnersHeader.textContent = "Latest chest rewards";
    wrap.appendChild(winnersHeader);
    const winnersScroll = document.createElement("div");
    winnersScroll.className = "cv-scroll";
    const winnersList = document.createElement("div");
    winnersScroll.appendChild(winnersList);
    wrap.appendChild(winnersScroll);

    container.appendChild(wrap);

    Game.ui.globalLiveList = liveList;
    Game.ui.recentList = recentList;
    Game.ui.winnersList = winnersList;

    renderGlobalExpeditionsList();
    renderRecentList();
    renderWinnersList();
  }

  function initMainCanvas() {
    const c = Game.ui.mainCanvas;
    if (!c) return;
    const resize = () => {
      const rect = c.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      Game.ui.mainDpr = dpr;
      Game.ui.mainWidth = rect.width;
      Game.ui.mainHeight = rect.height;
      c.width = rect.width * dpr;
      c.height = rect.height * dpr;
      Game.ui.mainCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
    };
    resize();
    window.addEventListener("resize", () => resize());
    Game.ui.mainRunning = true;
    Game.state.lastFrameTime = performance.now();
    const loop = (ts) => {
      if (!Game.ui.mainRunning) return;
      const dt = Math.min(0.05, (ts - Game.state.lastFrameTime) / 1000);
      Game.state.lastFrameTime = ts;
      tickActors(dt);
      drawCanvas();
      Game.ui.mainRafId = requestAnimationFrame(loop);
    };
    Game.ui.mainRafId = requestAnimationFrame(loop);
  }

  function bindGlobalButtons() {
    const perkBtn = document.getElementById("cv-btn-perk");
    if (perkBtn) perkBtn.addEventListener("click", () => tryPerkDrop());
  }

  function tickActors(dt) {
    const actors = Game.state.actors;
    const now = Date.now();
    actors.forEach((a, id) => {
      if (a.type === "orc") {
        a.t += dt;
        if (!a.target || distance(a.x, a.y, a.target.x, a.target.y) < 4) {
          a.target = { x: Math.random() * Game.ui.mainWidth, y: Math.random() * Game.ui.mainHeight };
        }
        const dx = a.target.x - a.x;
        const dy = a.target.y - a.y;
        const len = Math.max(0.001, Math.hypot(dx, dy));
        const speed = 20 + (a.speed || 0) * 2;
        a.x += (dx / len) * speed * dt;
        a.y += (dy / len) * speed * dt;
      } else if (a.type === "chest") {
        a.t += dt;
        if (now - a.spawnAt > CHEST_TTL_MS) {
          actors.delete(id);
          Game.state.chests.delete(a.chest_id);
          const ch = document.getElementById("cv-live-chests-pill")?.querySelector("strong");
          if (ch) ch.textContent = String(Game.state.chests.size);
        }
      } else if (a.type === "perk") {
        a.t += dt;
        if (a.t > 4) actors.delete(id);
      }
    });
  }

  function drawCanvas() {
    const ctx = Game.ui.mainCtx;
    if (!ctx) return;
    const w = Game.ui.mainWidth;
    const h = Game.ui.mainHeight;
    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = "#080812";
    ctx.fillRect(0, 0, w, h);
    drawGrid(ctx, w, h);
    const actors = Array.from(Game.state.actors.values()).sort((a, b) => a.y - b.y);
    actors.forEach(a => {
      if (a.type === "orc") drawOrcActor(ctx, a);
      else if (a.type === "chest") drawChestActor(ctx, a);
      else if (a.type === "perk") drawPerkActor(ctx, a);
    });
  }

  function drawGrid(ctx, w, h) {
    ctx.save();
    ctx.strokeStyle = "rgba(255,255,255,0.04)";
    ctx.lineWidth = 1;
    const step = 32;
    for (let x = 0; x < w; x += step) {
      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x, h);
      ctx.stroke();
    }
    for (let y = 0; y < h; y += step) {
      ctx.beginPath();
      ctx.moveTo(0, y);
      ctx.lineTo(w, y);
      ctx.stroke();
    }
    ctx.restore();
  }

  function drawOrcActor(ctx, a) {
    const size = 20 + (a.scale || 1) * 4;
    ctx.save();
    ctx.translate(a.x, a.y);
    ctx.fillStyle = "#263238";
    ctx.beginPath();
    ctx.arc(0, 0, size * 0.7, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = a.owner === Game.user.wax_account ? "#00e676" : "#90caf9";
    ctx.beginPath();
    ctx.arc(0, -size * 0.2, size * 0.55, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = "#000";
    ctx.beginPath();
    ctx.arc(-size * 0.25, -size * 0.25, size * 0.1, 0, Math.PI * 2);
    ctx.arc(size * 0.25, -size * 0.25, size * 0.1, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = "#ffca28";
    ctx.fillRect(-size * 0.25, size * 0.15, size * 0.5, size * 0.25);
    ctx.restore();
  }

  function drawChestActor(ctx, a) {
    const size = 14;
    ctx.save();
    ctx.translate(a.x, a.y);
    const pulse = 0.8 + Math.sin(a.t * 4) * 0.2;
    ctx.fillStyle = "#4e342e";
    ctx.fillRect(-size * pulse, -size * pulse / 2, size * 2 * pulse, size * pulse);
    ctx.fillStyle = "#ffca28";
    ctx.fillRect(-size * pulse, -size * pulse / 2, size * 2 * pulse, 3);
    ctx.restore();
  }

  function drawPerkActor(ctx, a) {
    const size = 18;
    ctx.save();
    ctx.translate(a.x, a.y);
    const r = size * (0.7 + Math.sin(a.t * 3) * 0.15);
    ctx.fillStyle = "rgba(15,189,145,0.18)";
    ctx.beginPath();
    ctx.arc(0, 0, r * 1.6, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = "#0fb991";
    ctx.beginPath();
    ctx.arc(0, 0, r, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  }

  function distance(x1, y1, x2, y2) {
    const dx = x1 - x2;
    const dy = y1 - y2;
    return Math.hypot(dx, dy);
  }

  function autoSelectBestGoblins() {
    Game.state.goblinSelection.clear();
    const { goblins, currentLimit } = Game.state;
    const sorted = [...goblins].sort((a, b) => (b.daily_power || 0) - (a.daily_power || 0));
    for (let i = 0; i < sorted.length && i < currentLimit; i++) {
      Game.state.goblinSelection.add(sorted[i].asset_id);
    }
  }

  function renderGoblinList() {
    const list = Game.ui.goblinList;
    if (!list) return;
    list.innerHTML = "";
    const q = (Game.ui.goblinFilterInput?.value || "").toLowerCase();
    const { goblins, goblinSelection } = Game.state;
    const filtered = goblins.filter(g => {
      if (!q) return true;
      const id = String(g.asset_id || "").toLowerCase();
      const rar = String(g.rarity || "").toLowerCase();
      return id.includes(q) || rar.includes(q);
    });
    filtered.forEach(g => {
      const card = document.createElement("div");
      card.className = "cv-card";
      const head = document.createElement("div");
      head.className = "cv-card-header";
      const title = document.createElement("div");
      title.className = "cv-card-title";
      title.textContent = `Goblin #${g.asset_id}`;
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = goblinSelection.has(g.asset_id);
      checkbox.addEventListener("change", () => {
        if (checkbox.checked) {
          if (goblinSelection.size < Game.state.currentLimit) goblinSelection.add(g.asset_id);
          else {
            checkbox.checked = false;
            toast("Limit reached", `You can send up to ${Game.state.currentLimit} goblins.`, "warn");
          }
        } else {
          goblinSelection.delete(g.asset_id);
        }
        updateGoblinSummary();
      });
      head.appendChild(title);
      head.appendChild(checkbox);
      card.appendChild(head);

      const meta = document.createElement("div");
      meta.className = "cv-card-meta";
      const rar = document.createElement("span");
      rar.className = "cv-pill";
      rar.textContent = g.rarity || "Unknown";
      const power = document.createElement("span");
      const hasPower = (g.daily_power || 0) > 0;
      power.className = hasPower ? "cv-pill cv-pill-positive" : "cv-pill cv-pill-danger";
      power.textContent = hasPower ? `Power ${Number(g.daily_power || 0).toFixed(2)}` : "No power";
      const stats = document.createElement("span");
      stats.className = "cv-pill";
      const s = g.speed || 0;
      const l = g.loot_hungry || 0;
      const a = g.accuracy || 0;
      const r = g.resistance || 0;
      stats.textContent = `S ${s} • L ${l} • A ${a} • R ${r}`;
      meta.appendChild(rar);
      meta.appendChild(power);
      meta.appendChild(stats);
      card.appendChild(meta);

      list.appendChild(card);
    });
  }

  function updateGoblinSummary() {
    const el = Game.ui.goblinSummary;
    if (!el) return;
    if (Game.state.userExpedition && Game.state.userExpRemainingSec > 0) {
      const min = Math.floor(Game.state.userExpRemainingSec / 60);
      const sec = Game.state.userExpRemainingSec % 60;
      el.textContent = `Expedition in progress • ${min}m ${sec}s remaining`;
      return;
    }
    const selected = [...Game.state.goblinSelection].map(id => Game.state.goblins.find(g => g.asset_id === id)).filter(Boolean);
    const totalPower = selected.reduce((sum, g) => sum + (g.daily_power || 0), 0);
    const duration = Game.state.goblinDuration;
    const durationHours = duration / 3600;
    const basePayout = totalPower * durationHours / 24;
    el.textContent = `${selected.length} goblins selected • base payout ${basePayout.toFixed(2)} • duration ${Math.round(duration / 60)} min • limit ${Game.state.currentLimit}`;
  }

  function updateGoblinControlsState() {
    const btn = Game.ui.goblinStartBtn;
    const durationSelect = Game.ui.goblinDurationSelect;
    const selectBest = Game.ui.goblinSelectAllBtn;
    const isRunning = Game.state.userExpedition && Game.state.userExpRemainingSec > 0;
    if (!btn || !durationSelect || !selectBest) return;
    btn.disabled = isRunning;
    durationSelect.disabled = isRunning;
    selectBest.disabled = isRunning;
  }

  function renderGlobalExpeditionsList() {
    if (!Game.ui.globalLiveList) return;
    const list = Game.ui.globalLiveList;
    list.innerHTML = "";
    Game.state.allExpeditions.forEach(e => {
      const card = document.createElement("div");
      card.className = "cv-card";
      const head = document.createElement("div");
      head.className = "cv-card-header";
      const title = document.createElement("div");
      title.className = "cv-card-title";
      title.textContent = e.wax_account || "Unknown";
      const badge = document.createElement("div");
      badge.className = "cv-pill";
      badge.textContent = `${e.goblins || 0} goblins`;
      head.appendChild(title);
      head.appendChild(badge);
      card.appendChild(head);
      const meta = document.createElement("div");
      meta.className = "cv-card-meta";
      const t = document.createElement("span");
      t.textContent = `Time left ${Math.max(0, Math.round(e.seconds_remaining || 0))}s`;
      const ch = document.createElement("span");
      ch.textContent = `Chests ${e.chests || 0}`;
      meta.appendChild(t);
      meta.appendChild(ch);
      card.appendChild(meta);
      list.appendChild(card);
    });
  }

  function renderRecentList() {
    if (!Game.ui.recentList) return;
    const list = Game.ui.recentList;
    list.innerHTML = "";
    Game.state.recentExpeditions.forEach(e => {
      const card = document.createElement("div");
      card.className = "cv-card";
      const head = document.createElement("div");
      head.className = "cv-card-header";
      const title = document.createElement("div");
      title.className = "cv-card-title";
      title.textContent = e.wax_account || "Unknown";
      const chips = document.createElement("div");
      chips.className = "cv-pill cv-pill-positive";
      const amount = e.stats?.tokens?.CHIPS || 0;
      const amt = typeof amount === "number" ? amount.toFixed(2) : amount;
      chips.textContent = `${amt} CHIPS`;
      head.appendChild(title);
      head.appendChild(chips);
      card.appendChild(head);
      const meta = document.createElement("div");
      meta.className = "cv-card-meta";
      const info = document.createElement("span");
      info.textContent = `${e.goblins || 0} goblins • ${e.nfts || 0} NFTs`;
      meta.appendChild(info);
      card.appendChild(meta);
      list.appendChild(card);
    });
  }

  function renderWinnersList() {
    if (!Game.ui.winnersList) return;
    const list = Game.ui.winnersList;
    list.innerHTML = "";
    Game.state.recentWinners.forEach(w => {
      const card = document.createElement("div");
      card.className = "cv-card";
      const head = document.createElement("div");
      head.className = "cv-card-header";
      const title = document.createElement("div");
      title.className = "cv-card-title";
      title.textContent = w.wax_account || "Unknown";
      card.appendChild(head);
      const meta = document.createElement("div");
      meta.className = "cv-card-meta";
      const chips = w.stats?.tokens?.CHIPS || 0;
      const t1 = document.createElement("span");
      const amt = typeof chips === "number" ? chips.toFixed(2) : chips;
      t1.textContent = `${amt} CHIPS`;
      const t2 = document.createElement("span");
      t2.textContent = `${w.nfts || 0} NFTs`;
      meta.appendChild(t1);
      meta.appendChild(t2);
      card.appendChild(meta);
      list.appendChild(card);
    });
  }

  function updateOrcView() {
    const list = Game.ui.orcList;
    if (list) {
      list.innerHTML = "";
      Game.state.orcs.forEach(orc => {
        const card = document.createElement("div");
        card.className = "cv-card";
        const head = document.createElement("div");
        head.className = "cv-card-header";
        const title = document.createElement("div");
        title.className = "cv-card-title";
        title.textContent = orc.name || `Orc #${orc.id}`;
        const badge = document.createElement("div");
        badge.className = "cv-pill cv-pill-rarity-" + (orc.rarity || "common").toLowerCase();
        badge.textContent = orc.rarity || "Common";
        head.appendChild(title);
        head.appendChild(badge);
        card.appendChild(head);
        const meta = document.createElement("div");
        meta.className = "cv-card-meta";
        const s = document.createElement("span");
        s.textContent = `S ${orc.stats?.speed || 0} • L ${orc.stats?.loot_hungry || 0} • A ${orc.stats?.accuracy || 0} • R ${orc.stats?.resistance || 0}`;
        meta.appendChild(s);
        card.appendChild(meta);
        card.style.cursor = "pointer";
        card.addEventListener("click", () => {
          Game.state.activeOrcId = orc.id;
          updateOrcView();
        });
        if (Game.state.activeOrcId === orc.id) card.style.borderColor = "rgba(15,189,145,.9)";
        list.appendChild(card);
      });
    }
    const details = Game.ui.orcDetails;
    if (details) {
      const orc = Game.state.orcs.find(o => o.id === Game.state.activeOrcId) || null;
      if (!orc) {
        details.name.textContent = "No orc selected";
        details.name.classList.add("cv-muted");
        details.rarity.textContent = "None";
        details.rarity.className = "cv-pill cv-pill-rarity-common cv-muted";
      } else {
        details.name.textContent = orc.name || `Orc #${orc.id}`;
        details.name.classList.remove("cv-muted");
        details.rarity.textContent = orc.rarity || "Common";
        details.rarity.className = "cv-pill cv-pill-rarity-" + (orc.rarity || "common").toLowerCase();
      }
      if (details.slots) {
        details.slots.innerHTML = "";
        const slots = ["helm","chest","weapon","trinket","belt","boots"];
        slots.forEach(slot => {
          const box = document.createElement("div");
          box.className = "cv-card";
          const head = document.createElement("div");
          head.className = "cv-card-header";
          const t = document.createElement("div");
          t.className = "cv-card-title";
          const equipped = Game.state.equippedSlots[slot] || null;
          t.textContent = equipped ? equipped.name : slot;
          head.appendChild(t);
          box.appendChild(head);
          const meta = document.createElement("div");
          meta.className = "cv-card-meta";
          if (equipped) {
            const r = document.createElement("span");
            r.className = "cv-pill cv-pill-rarity-" + (equipped.rarity || "common").toLowerCase();
            r.textContent = equipped.rarity;
            const stats = document.createElement("span");
            stats.textContent = `S ${equipped.stats?.speed || 0} • L ${equipped.stats?.loot_hungry || 0} • A ${equipped.stats?.accuracy || 0} • R ${equipped.stats?.resistance || 0}`;
            meta.appendChild(r);
            meta.appendChild(stats);
          } else {
            const em = document.createElement("span");
            em.className = "cv-muted";
            em.textContent = "Empty slot";
            meta.appendChild(em);
          }
          box.appendChild(meta);
          details.slots.appendChild(box);
        });
      }
    }
    drawOrcFocusCanvas();
  }

  function drawOrcFocusCanvas() {
    const canvas = Game.ui.focusOrcCanvas;
    const ctx = Game.ui.focusOrcCtx;
    if (!canvas || !ctx) return;
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    Game.ui.focusOrcDpr = dpr;
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    ctx.clearRect(0, 0, rect.width, rect.height);
    ctx.fillStyle = "#05070a";
    ctx.fillRect(0, 0, rect.width, rect.height);
    const orc = Game.state.orcs.find(o => o.id === Game.state.activeOrcId);
    if (!orc) return;
    const cx = rect.width / 2;
    const cy = rect.height / 2 + 10;
    ctx.save();
    ctx.translate(cx, cy);
    ctx.fillStyle = "#263238";
    ctx.beginPath();
    ctx.arc(0, -28, 22, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = "#00e676";
    ctx.beginPath();
    ctx.arc(0, -28, 16, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = "#000";
    ctx.beginPath();
    ctx.arc(-6, -30, 2.4, 0, Math.PI * 2);
    ctx.arc(6, -30, 2.4, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = "#37474f";
    ctx.fillRect(-20, -6, 40, 24);
    const slots = ["helm","chest","weapon","trinket","belt","boots"];
    slots.forEach((slot, i) => {
      const equip = Game.state.equippedSlots[slot];
      if (!equip) return;
      const a = (i / slots.length) * Math.PI * 2;
      const ex = Math.cos(a) * 40;
      const ey = Math.sin(a) * 40;
      ctx.fillStyle = equip.rarity === "legendary" ? "#ffd54f" : equip.rarity === "epic" ? "#ce93d8" : equip.rarity === "rare" ? "#90caf9" : "#e0e0e0";
      ctx.beginPath();
      ctx.arc(ex, ey - 10, 6, 0, Math.PI * 2);
      ctx.fill();
    });
    ctx.restore();
  }

  function renderEquipList() {
    const list = Game.ui.equipList;
    if (!list) return;
    list.innerHTML = "";
    const q = (Game.ui.equipFilterInput?.value || "").toLowerCase();
    const slot = Game.ui.equipSlotFilter?.value || "";
    const rar = (Game.ui.equipRarityFilter?.value || "").toLowerCase();
    const filtered = Game.state.equips.filter(eq => {
      if (slot && eq.slot !== slot) return false;
      if (rar && (eq.rarity || "").toLowerCase() !== rar) return false;
      if (!q) return true;
      const id = String(eq.asset_id || "").toLowerCase();
      const n = String(eq.name || "").toLowerCase();
      return id.includes(q) || n.includes(q);
    });
    filtered.forEach(eq => {
      const card = document.createElement("div");
      card.className = "cv-card";
      const head = document.createElement("div");
      head.className = "cv-card-header";
      const title = document.createElement("div");
      title.className = "cv-card-title";
      title.textContent = eq.name || `Equip #${eq.asset_id}`;
      const badge = document.createElement("div");
      badge.className = "cv-pill cv-pill-rarity-" + (eq.rarity || "common").toLowerCase();
      badge.textContent = eq.rarity || "Common";
      head.appendChild(title);
      head.appendChild(badge);
      card.appendChild(head);
      const meta = document.createElement("div");
      meta.className = "cv-card-meta";
      const slotTag = document.createElement("span");
      slotTag.className = "cv-equip-tag-slot";
      slotTag.textContent = eq.slot || "slot";
      const stats = document.createElement("span");
      stats.textContent = `S ${eq.stats?.speed || 0} • L ${eq.stats?.loot_hungry || 0} • A ${eq.stats?.accuracy || 0} • R ${eq.stats?.resistance || 0}`;
      const durTag = document.createElement("span");
      durTag.className = "cv-equip-tag-duration";
      const remaining = eq.seconds_remaining ?? eq.duration_seconds ?? 0;
      if (remaining > 0) durTag.textContent = `${Math.round(remaining / 3600)}h left`;
      else durTag.textContent = "Expired";
      meta.appendChild(slotTag);
      meta.appendChild(stats);
      meta.appendChild(durTag);
      card.appendChild(meta);
      const actions = document.createElement("div");
      actions.className = "cv-flex-row";
      const equipBtn = document.createElement("button");
      equipBtn.className = "cv-btn cv-btn-small";
      equipBtn.textContent = "Equip";
      equipBtn.disabled = !Game.state.activeOrcId;
      equipBtn.addEventListener("click", () => equipItem(eq));
      const repairBtn = document.createElement("button");
      repairBtn.className = "cv-btn-secondary cv-btn cv-btn-small";
      repairBtn.textContent = "Repair";
      repairBtn.disabled = remaining > 0;
      repairBtn.addEventListener("click", () => repairItem(eq));
      actions.appendChild(equipBtn);
      actions.appendChild(repairBtn);
      card.appendChild(actions);
      list.appendChild(card);
    });
  }

  function renderWeeklyPass() {
    const pass = Game.state.weeklyPass;
    const bar = Game.ui.passProgressBar;
    const questsList = Game.ui.passQuestsList;
    const rewardsList = Game.ui.passRewardsList;
    const buyBtn = Game.ui.passBuyBtn;
    const statusText = document.getElementById("cv-pass-status-text");
    if (!bar || !questsList || !rewardsList || !buyBtn || !statusText) return;
    if (!pass) {
      bar.style.width = "0%";
      statusText.textContent = "Not active";
      buyBtn.disabled = false;
      questsList.innerHTML = "";
      rewardsList.innerHTML = "";
      if (Game.ui.statsHeader?.pass) Game.ui.statsHeader.pass.textContent = "0%";
      return;
    }
    const pct = Math.min(100, (pass.points / pass.max_points) * 100);
    bar.style.width = `${pct.toFixed(1)}%`;
    statusText.textContent = pass.active ? `Active • ${pass.points}/${pass.max_points} points` : "Not active";
    buyBtn.disabled = pass.active;
    questsList.innerHTML = "";
    pass.quests.forEach(q => {
      const card = document.createElement("div");
      card.className = "cv-card";
      const head = document.createElement("div");
      head.className = "cv-card-header";
      const title = document.createElement("div");
      title.className = "cv-card-title";
      title.textContent = q.label;
      const badge = document.createElement("div");
      badge.className = "cv-pill";
      badge.textContent = `${q.points} pts`;
      head.appendChild(title);
      head.appendChild(badge);
      card.appendChild(head);
      const meta = document.createElement("div");
      meta.className = "cv-card-meta";
      const progress = document.createElement("span");
      progress.textContent = `${q.current}/${q.target}`;
      meta.appendChild(progress);
      card.appendChild(meta);
      questsList.appendChild(card);
    });
    rewardsList.innerHTML = "";
    pass.thresholds.forEach(th => {
      const card = document.createElement("div");
      card.className = "cv-card";
      const head = document.createElement("div");
      head.className = "cv-card-header";
      const title = document.createElement("div");
      title.className = "cv-card-title";
      title.textContent = `Threshold ${th.points} pts`;
      const badge = document.createElement("div");
      badge.className = "cv-pill";
      badge.textContent = th.claimed ? "Claimed" : pass.points >= th.points ? "Ready" : "Locked";
      head.appendChild(title);
      head.appendChild(badge);
      card.appendChild(head);
      const meta = document.createElement("div");
      meta.className = "cv-card-meta";
      const detail = document.createElement("span");
      detail.textContent = th.label;
      meta.appendChild(detail);
      card.appendChild(meta);
      if (!th.claimed && pass.points >= th.points) {
        const claimBtn = document.createElement("button");
        claimBtn.className = "cv-btn cv-btn-small";
        claimBtn.textContent = "Claim";
        claimBtn.addEventListener("click", () => claimWeeklyReward(th.id));
        card.appendChild(claimBtn);
      }
      rewardsList.appendChild(card);
    });
    if (Game.ui.statsHeader?.pass) Game.ui.statsHeader.pass.textContent = `${pct.toFixed(0)}%`;
  }

  async function loadUserNFTs() {
    if (Game.state.userNFTsLoaded || Game.state.userNFTsRetry) return;
    Game.state.userNFTsRetry = true;
    try {
      requireAuth();
      const payload = {
        wax_account: Game.user.wax_account,
        user_id: Game.user.user_id,
        usx_token: Game.user.usx_token
      };
      const r = await API.post("/user_nfts", payload, 15000);
      if (r.ok && Array.isArray(r.data?.nfts)) {
        Game.state.goblins = r.data.nfts || [];
        Game.state.userNFTsLoaded = true;
        Game.state.userNFTsRetry = false;
        await refreshReinforcement();
        if (Game.ui.goblinList) {
          autoSelectBestGoblins();
          renderGoblinList();
          updateGoblinSummary();
        }
        toast("Goblins loaded", `You have ${Game.state.goblins.length} goblins.`, "ok");
      } else {
        throw new Error("Unexpected response");
      }
    } catch (e) {
      setTimeout(() => {
        Game.state.userNFTsRetry = false;
        loadUserNFTs();
      }, 8000);
    }
  }

  async function refreshReinforcement() {
    try {
      const wax = Game.user.wax_account;
      if (!wax) return;
      const r = await API.post("/reinforcement_count", { wax_account: wax }, 10000);
      if (r.ok && typeof r.data?.count === "number") Game.state.reinforcementCount = r.data.count;
      const base = 50;
      const boost = Game.state.reinforcementCount * 5;
      Game.state.currentLimit = Math.min(base + boost, 250);
      updateGoblinSummary();
    } catch (e) {}
  }

  function filterValidGoblinsForExpedition() {
    const selected = [...Game.state.goblinSelection].map(id => Game.state.goblins.find(g => g.asset_id === id)).filter(Boolean);
    const valid = [];
    const invalid = [];
    selected.forEach(g => {
      if ((g.daily_power || 0) > 0) valid.push(g);
      else invalid.push(g);
    });
    if (invalid.length) {
      invalid.forEach(g => Game.state.goblinSelection.delete(g.asset_id));
      if (invalid.length === 1) toast("Goblin removed", "1 goblin has no daily power and was removed from selection.", "warn");
      else toast("Goblins removed", `${invalid.length} goblins have no daily power and were removed.`, "warn");
    }
    return valid;
  }

  async function startUserExpedition() {
    try {
      requireAuth();
      if (Game.state.userExpedition && Game.state.userExpRemainingSec > 0) {
        toast("Expedition running", "You already have an active expedition.", "warn");
        return;
      }
      const validGoblins = filterValidGoblinsForExpedition();
      if (!validGoblins.length) {
        toast("No goblins ready", "Select goblins with daily power greater than zero.", "warn");
        renderGoblinList();
        updateGoblinSummary();
        return;
      }
      if (validGoblins.length > Game.state.currentLimit) {
        toast("Limit exceeded", `You can send up to ${Game.state.currentLimit} goblins.`, "warn");
        return;
      }
      const ids = validGoblins.map(g => g.asset_id);
      const payload = {
        wax_account: Game.user.wax_account,
        user_id: Game.user.user_id,
        usx_token: Game.user.usx_token,
        goblin_ids: ids,
        duration_seconds: Game.state.goblinDuration
      };
      const r = await API.post("/start_expedition", payload, 15000);
      if (!r.ok || !r.data?.expedition) {
        toast("Expedition failed", "Could not start expedition.", "err");
        return;
      }
      Game.state.userExpedition = r.data.expedition;
      Game.state.userExpRemainingSec = Math.max(0, r.data.expedition.seconds_remaining || Game.state.goblinDuration);
      startUserExpeditionTimer();
      toast("Expedition started", "Your goblins are now exploring the cave.", "ok");
      updateGoblinSummary();
      updateGoblinControlsState();
      loadWeeklyPass();
    } catch (e) {
      toast("Error", "Could not start expedition.", "err");
    }
  }

  function startUserExpeditionTimer() {
    if (Game.state.userExpTimerId) {
      clearInterval(Game.state.userExpTimerId);
      Game.state.userExpTimerId = 0;
    }
    if (!Game.state.userExpedition) return;
    Game.state.userExpTimerId = window.setInterval(async () => {
      if (Game.state.userExpRemainingSec > 0) {
        Game.state.userExpRemainingSec--;
        updateGoblinSummary();
        if (Game.state.userExpRemainingSec <= 0) {
          clearInterval(Game.state.userExpTimerId);
          Game.state.userExpTimerId = 0;
          await finalizeUserExpedition();
        }
      }
    }, 1000);
  }

  async function finalizeUserExpedition() {
    try {
      requireAuth();
      const exp = Game.state.userExpedition;
      if (!exp) return;
      const statusPayload = {
        wax_account: Game.user.wax_account,
        user_id: Game.user.user_id,
        usx_token: Game.user.usx_token
      };
      const s = await API.post("/expedition_status", statusPayload, 12000);
      if (!s.ok || !s.data?.expedition) {
        Game.state.userExpedition = null;
        Game.state.userExpRemainingSec = 0;
        updateGoblinSummary();
        updateGoblinControlsState();
        return;
      }
      const endPayload = {
        wax_account: Game.user.wax_account,
        user_id: Game.user.user_id,
        usx_token: Game.user.usx_token,
        expedition_id: s.data.expedition.expedition_id
      };
      const r = await API.post("/end_expedition", endPayload, 15000);
      Game.state.userExpedition = null;
      Game.state.userExpRemainingSec = 0;
      updateGoblinSummary();
      updateGoblinControlsState();
      if (r.ok && r.data) {
        const chips = r.data.stats?.tokens?.CHIPS || 0;
        const amt = typeof chips === "number" ? chips.toFixed(2) : chips;
        toast("Expedition complete", `You earned ${amt} CHIPS and ${r.data.nfts || 0} NFTs.`, "ok");
      } else {
        toast("Expedition closed", "Expedition ended, but rewards could not be loaded.", "warn");
      }
      await refreshGlobalData(false);
      loadWeeklyPass();
    } catch (e) {
      toast("Error", "Could not finalize expedition.", "err");
    }
  }

  async function refreshGlobalData(initial) {
    try {
      const [all, recent, winners] = await Promise.all([
        API.post("/all_expeditions", {}, 10000),
        API.get("/recent_expeditions", 10000),
        API.get("/recent_winners", 10000)
      ]);
      if (all.ok && Array.isArray(all.data?.expeditions)) {
        Game.state.allExpeditions = all.data.expeditions;
        updateCanvasActorsFromExpeditions();
        renderGlobalExpeditionsList();
      }
      if (recent.ok && Array.isArray(recent.data?.expeditions)) {
        Game.state.recentExpeditions = recent.data.expeditions.slice(0, 12);
        renderRecentList();
      }
      if (winners.ok && Array.isArray(winners.data?.winners)) {
        Game.state.recentWinners = winners.data.winners.slice(0, 10);
        renderWinnersList();
      }
      updateLiveStats(initial);
    } catch (e) {}
  }

  function updateCanvasActorsFromExpeditions() {
    const actors = Game.state.actors;
    const used = new Set();
    Game.state.allExpeditions.forEach(e => {
      const id = `orc-${e.wax_account || ""}`;
      used.add(id);
      let a = actors.get(id);
      if (!a) {
        a = {
          id,
          type: "orc",
          owner: e.wax_account,
          x: Math.random() * Game.ui.mainWidth,
          y: Math.random() * Game.ui.mainHeight,
          t: 0,
          target: null,
          speed: e.speed || 0,
          scale: 1 + Math.min(1.2, (e.goblins || 0) / 100)
        };
        actors.set(id, a);
      } else {
        a.speed = e.speed || 0;
        a.scale = 1 + Math.min(1.2, (e.goblins || 0) / 100);
      }
    });
    Array.from(actors.keys()).forEach(id => {
      const a = actors.get(id);
      if (a?.type === "orc" && !used.has(id)) actors.delete(id);
    });
    const chestCount = Array.from(actors.values()).filter(a => a.type === "chest").length;
    const liveExp = document.getElementById("cv-live-expeditions-pill")?.querySelector("strong");
    const liveGob = document.getElementById("cv-live-goblins-pill")?.querySelector("strong");
    const liveCh = document.getElementById("cv-live-chests-pill")?.querySelector("strong");
    if (liveExp) liveExp.textContent = String(Game.state.allExpeditions.length);
    if (liveGob) {
      const totalGoblins = Game.state.allExpeditions.reduce((s, e) => s + (e.goblins || 0), 0);
      liveGob.textContent = String(totalGoblins);
    }
    if (liveCh) liveCh.textContent = String(chestCount);
  }

  function updateLiveStats(initial) {
    const multEl = Game.ui.statsHeader?.multiplier;
    if (multEl) {
      const totalSpeed = Game.state.allExpeditions.reduce((s, e) => s + (e.speed || 0), 0);
      const mult = 1 + totalSpeed / 1000;
      multEl.textContent = `${mult.toFixed(2)}x`;
    }
    if (initial && Game.ui.statsHeader?.players) {
      const uniquePlayers = new Set(Game.state.allExpeditions.map(e => e.wax_account)).size;
      Game.ui.statsHeader.players.textContent = String(uniquePlayers);
    }
  }

  async function tryPerkDrop() {
    try {
      requireAuth();
      const payload = {
        wax_account: Game.user.wax_account,
        user_id: Game.user.user_id,
        usx_token: Game.user.usx_token
      };
      const r = await API.post("/try_chest_perk", payload, 10000);
      if (r.status === 429) {
        const left = r.data?.seconds_remaining || 0;
        toast("Perk on cooldown", `Try again in ${Math.round(left)} seconds.`, "warn");
        return;
      }
      if (!r.ok || !r.data?.perk_awarded) {
        toast("No perk", "No perk drop this time.", "warn");
        return;
      }
      spawnLocalPerk(r.data.perk_type || "generic");
      toast("Perk activated", "Watch the canvas for new chests.", "ok");
      loadWeeklyPass();
    } catch (e) {
      toast("Error", "Could not trigger perk.", "err");
    }
  }

  function spawnLocalPerk(type) {
    const id = `perk-${Date.now()}-${Math.random().toString(16).slice(2)}`;
    const a = {
      id,
      type: "perk",
      kind: type,
      x: Game.ui.mainWidth * 0.5,
      y: Game.ui.mainHeight * 0.4,
      t: 0
    };
    Game.state.actors.set(id, a);
  }

  function handleRealtimeEvent(ev) {
    if (!ev || !ev.type) return;
    if (ev.type === "chest_spawned") {
      const idStr = String(ev.chest_id);
      const chest = {
        id: `chest-${idStr}`,
        chest_id: ev.chest_id,
        type: "chest",
        x: ev.x || Math.random() * Game.ui.mainWidth,
        y: ev.y || Math.random() * Game.ui.mainHeight,
        t: 0,
        spawnAt: Date.now()
      };
      Game.state.actors.set(chest.id, chest);
      Game.state.chests.set(ev.chest_id, chest);
      const ch = document.getElementById("cv-live-chests-pill")?.querySelector("strong");
      if (ch) ch.textContent = String(Game.state.chests.size);
    } else if (ev.type === "chest_claimed") {
      const chest = Game.state.chests.get(ev.chest_id);
      if (chest) Game.state.actors.delete(chest.id);
      Game.state.chests.delete(ev.chest_id);
      const ch = document.getElementById("cv-live-chests-pill")?.querySelector("strong");
      if (ch) ch.textContent = String(Game.state.chests.size);
      if (ev.wax_account && ev.stats?.tokens?.CHIPS) {
        const amount = ev.stats.tokens.CHIPS;
        const amt = typeof amount === "number" ? amount.toFixed(2) : amount;
        toast("Chest claimed", `${ev.wax_account} just claimed ${amt} CHIPS`, "ok");
      }
      loadWeeklyPass();
    }
  }

  function startRealtime() {
    if (Game.state.overlay || document.hidden) {
      startEventsPolling();
    } else {
      startEventsSSE();
    }
    if (!Game.state.commandPolling) {
      Game.state.commandPolling = true;
      setInterval(() => checkPerkCommand(), COMMAND_POLL_MS);
    }
  }

  function startEventsSSE() {
    if (!("EventSource" in window)) {
      startEventsPolling();
      return;
    }
    try {
      if (Game.state.eventsSource) {
        Game.state.eventsSource.close();
        Game.state.eventsSource = null;
      }
      const src = new EventSource(`${BASE_URL}/events?cv=1`);
      Game.state.eventsSource = src;
      src.onmessage = (e) => {
        const data = JSON.parse(e.data || "{}");
        if (Array.isArray(data.events)) data.events.forEach(handleRealtimeEvent);
      };
      src.onerror = () => {
        src.close();
        Game.state.eventsSource = null;
        startEventsPolling();
      };
    } catch (e) {
      startEventsPolling();
    }
  }

  function startEventsPolling() {
    if (Game.state.pollingEvents) return;
    Game.state.pollingEvents = true;
    const poll = async () => {
      if (!Game.state.pollingEvents) return;
      try {
        const r = await API.get(`/events/poll?since=${Game.state.eventsSince || 0}`, 10000);
        if (r.ok && Array.isArray(r.data?.events)) {
          r.data.events.forEach(ev => {
            Game.state.eventsSince = Math.max(Game.state.eventsSince, ev.id || 0);
            handleRealtimeEvent(ev);
          });
        }
      } catch (e) {}
      setTimeout(poll, EVENTS_POLL_MS);
    };
    poll();
  }

  async function checkPerkCommand() {
    try {
      requireAuth();
      const r = await API.post("/check_perk_command", { wax_account: Game.user.wax_account }, 8000);
      if (r.ok && r.data?.perk) {
        spawnLocalPerk(r.data.perk.perk_type || "generic");
        loadWeeklyPass();
      }
    } catch (e) {}
  }

  async function loadOrcsAndEquips() {
    try {
      requireAuth();
      const wax = Game.user.wax_account;
      const [orcs, equips] = await Promise.all([
        API.get(`/user_orcs?wax_account=${encodeURIComponent(wax)}`, 12000),
        API.get(`/user_equips?wax_account=${encodeURIComponent(wax)}`, 12000)
      ]);
      if (orcs.ok && Array.isArray(orcs.data?.orcs)) {
        Game.state.orcs = orcs.data.orcs;
        Game.state.activeOrcId = Game.state.activeOrcId || orcs.data.orcs[0]?.id || null;
      }
      if (equips.ok && Array.isArray(equips.data?.equips)) Game.state.equips = equips.data.equips;
      if (orcs.ok && orcs.data?.equipped) Game.state.equippedSlots = orcs.data.equipped;
      updateOrcView();
      renderEquipList();
    } catch (e) {}
  }

  async function resetAllEquips() {
    try {
      requireAuth();
      const orcId = Game.state.activeOrcId;
      if (!orcId) {
        toast("No orc selected", "Select an orc first.", "warn");
        return;
      }
      const r = await API.post("/unequip_all", { wax_account: Game.user.wax_account, orc_id: orcId }, 12000);
      if (r.ok) {
        Game.state.equippedSlots = {};
        updateOrcView();
        toast("Equips cleared", "All equips removed from your orc.", "ok");
        loadWeeklyPass();
      } else {
        toast("Reset failed", "Could not reset equips.", "err");
      }
    } catch (e) {
      toast("Error", "Could not reset equips.", "err");
    }
  }

  async function equipItem(eq) {
    try {
      requireAuth();
      const orcId = Game.state.activeOrcId;
      if (!orcId) {
        toast("No orc selected", "Select an orc first.", "warn");
        return;
      }
      const r = await API.post("/equip_item", {
        wax_account: Game.user.wax_account,
        orc_id: orcId,
        equip_id: eq.asset_id,
        slot: eq.slot
      }, 12000);
      if (r.ok && r.data?.equipped) {
        Game.state.equippedSlots = r.data.equipped;
        updateOrcView();
        toast("Equipped", `${eq.name || "Item"} equipped.`, "ok");
        loadWeeklyPass();
      } else {
        toast("Equip failed", "Backend did not confirm equip.", "err");
      }
    } catch (e) {
      toast("Error", "Could not equip item.", "err");
    }
  }

  async function repairItem(eq) {
    try {
      requireAuth();
      const r = await API.post("/repair_equip", {
        wax_account: Game.user.wax_account,
        equip_id: eq.asset_id
      }, 12000);
      if (r.ok) {
        toast("Repaired", `${eq.name || "Item"} repaired using CHIPS.`, "ok");
        await loadOrcsAndEquips();
        loadWeeklyPass();
      } else {
        toast("Repair failed", "Could not repair item.", "err");
      }
    } catch (e) {
      toast("Error", "Could not repair item.", "err");
    }
  }

  async function loadWeeklyPass() {
    try {
      requireAuth();
      const r = await API.get(`/weekly_pass_status?wax_account=${encodeURIComponent(Game.user.wax_account)}`, 12000);
      if (r.ok && r.data) {
        Game.state.weeklyPass = r.data;
        renderWeeklyPass();
      }
    } catch (e) {}
  }

  async function buyWeeklyPass() {
    try {
      requireAuth();
      const r = await API.post("/weekly_pass_buy", { wax_account: Game.user.wax_account }, 15000);
      if (r.ok) {
        toast("Weekly pass activated", "You can now complete quests for extra rewards.", "ok");
        loadWeeklyPass();
      } else {
        toast("Purchase failed", "Could not buy weekly pass.", "err");
      }
    } catch (e) {
      toast("Error", "Could not buy weekly pass.", "err");
    }
  }

  async function claimWeeklyReward(thresholdId) {
    try {
      requireAuth();
      const r = await API.post("/weekly_pass_claim", {
        wax_account: Game.user.wax_account,
        threshold_id: thresholdId
      }, 15000);
      if (r.ok) {
        toast("Reward claimed", "Weekly pass reward delivered.", "ok");
        loadWeeklyPass();
      } else {
        toast("Claim failed", "Could not claim reward.", "err");
      }
    } catch (e) {
      toast("Error", "Could not claim reward.", "err");
    }
  }

  async function initialUserExpeditionStatus() {
    try {
      requireAuth();
      const payload = {
        wax_account: Game.user.wax_account,
        user_id: Game.user.user_id,
        usx_token: Game.user.usx_token
      };
      const r = await API.post("/expedition_status", payload, 12000);
      if (r.ok && r.data?.expedition) {
        Game.state.userExpedition = r.data.expedition;
        Game.state.userExpRemainingSec = Math.max(0, r.data.expedition.seconds_remaining || 0);
        if (Game.state.userExpRemainingSec > 0) {
          startUserExpeditionTimer();
        } else {
          Game.state.userExpedition = null;
          Game.state.userExpRemainingSec = 0;
        }
      }
      updateGoblinSummary();
      updateGoblinControlsState();
    } catch (e) {}
  }

  function boot() {
    injectStyles();
    buildLayout();
    startRealtime();
    loadUserNFTs();
    loadOrcsAndEquips();
    loadWeeklyPass();
    initialUserExpeditionStatus();
    refreshGlobalData(true);
    setInterval(() => refreshGlobalData(false), REFRESH_ALL_MS);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", boot);
  } else {
    boot();
  }
})();
</script>
  
</body>
</html>
