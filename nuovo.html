<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Login con Wax e Anchor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #333; }
    button { margin: 5px; padding: 10px 20px; cursor: pointer; }
    #result { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Login con Wax e Anchor</h1>
  <button id="btnWax">Login con Wax</button>
  <button id="btnAnchor">Login con Anchor</button>
  <div id="result"></div>

  <!-- Usiamo il type="module" per importare le librerie da CDN -->
  <script type="module">
    // Importiamo le librerie da Skypack (assicurati di avere una versione che supporti gli ES Modules)
    import { WaxJS } from "https://cdn.skypack.dev/@waxio/waxjs/dist";
    import AnchorLink from "https://cdn.skypack.dev/anchor-link";
    import AnchorLinkBrowserTransport from "https://cdn.skypack.dev/anchor-link-browser-transport";

    // Classe per gestire il login e il recupero del bilancio
    class User {
      constructor() {
        this.appName = 'Chaos Marketplace';
        // Configurazione WAX: puoi usare il nodo di testnet o mainnet a seconda delle tue necessità
        this.rpcEndpoint = 'https://wax.pink.gg'; // per mainnet (oppure usa https://wax-testnet.pink.gg per testnet)
        this.wax = null;
        this.anchorSession = null;
        // Configurazione per Anchor
        this.transport = new AnchorLinkBrowserTransport();
        this.anchorLink = new AnchorLink({
          transport: this.transport,
          chains: [
            {
              chainId: '1064487b3cd1a897ce03ae5b6a865651747e2e152090f99c1d19d44e01aea5a4',
              nodeUrl: 'https://wax.eosphere.io' // oppure, per testnet: 'https://wax-testnet.eosphere.io'
            }
          ]
        });
      }

      // Login con Wax Cloud Wallet
      async waxLogin() {
        try {
          this.wax = new WaxJS({ rpcEndpoint: this.rpcEndpoint, tryAutoLogin: true });
          const userAccount = await this.wax.login();
          return userAccount;
        } catch (e) {
          console.error("Errore in waxLogin:", e.message);
          return null;
        }
      }

      // Login con Anchor
      async anchorConnect() {
        try {
          // Inizializziamo anche WaxJS (necessario per effettuare le chiamate RPC)
          this.wax = new WaxJS({ rpcEndpoint: this.rpcEndpoint, tryAutoLogin: true });
          const identity = await this.anchorLink.login('mydapp');
          this.anchorSession = identity.session;
          // L'account è disponibile in identity.session.auth.actor
          return identity.session.auth.actor.toString();
        } catch (e) {
          console.error("Errore in anchorConnect:", e);
          return null;
        }
      }

      // Recupera il bilancio (core_liquid_balance) dell’account WAX
      async getWaxBalance(account) {
        if (!account) return null;
        try {
          const accountData = await this.wax.rpc.get_account(account);
          return accountData.core_liquid_balance || "0 WAX";
        } catch (e) {
          console.error("Errore in getWaxBalance:", e);
          return null;
        }
      }
    }

    // Istanza del nostro UserService
    const userService = new User();
    const resultDiv = document.getElementById("result");

    // Funzione per visualizzare i dati dell'account e il bilancio
    function displayResult(account, balance) {
      resultDiv.innerHTML = `<p><strong>Account:</strong> ${account}</p>
                             <p><strong>Bilancio:</strong> ${balance}</p>`;
    }

    // Gestione login con Wax
    document.getElementById("btnWax").addEventListener("click", async () => {
      resultDiv.innerHTML = "<p>Login con Wax in corso...</p>";
      const account = await userService.waxLogin();
      if (account) {
        const balance = await userService.getWaxBalance(account);
        displayResult(account, balance);
      } else {
        resultDiv.innerHTML = "<p>Errore durante il login con Wax.</p>";
      }
    });

    // Gestione login con Anchor
    document.getElementById("btnAnchor").addEventListener("click", async () => {
      resultDiv.innerHTML = "<p>Login con Anchor in corso...</p>";
      const account = await userService.anchorConnect();
      if (account) {
        const balance = await userService.getWaxBalance(account);
        displayResult(account, balance);
      } else {
        resultDiv.innerHTML = "<p>Errore durante il login con Anchor.</p>";
      }
    });
  </script>
</body>
</html>
